<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Cache-Control" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>SuperMap iServer Manager</title>

<link type="text/css" href="http://192.168.10.244:8090/iserver/manager/static/jquery-ui/smoothness/jquery-ui-1.10.3.custom.min.css" rel="stylesheet"/>
<link type="text/css" href="http://192.168.10.244:8090/iserver/manager/static/bootstrap/css/bootstrap.min.css" rel="stylesheet"/>
<link type="text/css" href="http://192.168.10.244:8090/iserver/manager/static/css/jquery.dataTables.css" rel="stylesheet"/>
<link type="text/css" href="http://192.168.10.244:8090/iserver/manager/static/css/iServer.css" rel="stylesheet" />
<!--[if !IE]><!-->
<link type="text/css" href="http://192.168.10.244:8090/iserver/manager/static/css/iServer_FF.css" rel="stylesheet"/>
<!--<![endif]-->
<!--[if gt IE 6]>
<link type="text/css" href="http://192.168.10.244:8090/iserver/manager/static/css/iServer_IE.css" rel="stylesheet"/>
<![endif]-->
<!--[if lte IE 6]>
<link type="text/css" href="http://192.168.10.244:8090/iserver/manager/static/css/iServer_IE6.css" rel="stylesheet"/>
<![endif]-->
<script type="text/javascript" src="http://192.168.10.244:8090/iserver/manager/static/jquery/jquery-1.10.2.min.js"></script>
<script type="text/javascript" src="http://192.168.10.244:8090/iserver/manager/static/js/iepatch.js"></script>
<script type="text/javascript" src="http://192.168.10.244:8090/iserver/manager/static/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="http://192.168.10.244:8090/iserver/manager/static/js/jquery.browser.js" ></script>
<script type="text/javascript" src="http://192.168.10.244:8090/iserver/manager/static/jquery-ui/jquery-ui-1.10.3.custom.min.js"></script>
<script type="text/javascript" src="http://192.168.10.244:8090/iserver/manager/static/js/jquery.pagination.js"></script>
<script type="text/javascript" src="http://192.168.10.244:8090/iserver/manager/static/js/jquery.dataTables.iserver.min.js"></script>
<script type="text/javascript" src="http://192.168.10.244:8090/iserver/manager/static/js/resource_zh_CN.js"></script>
<script type="text/javascript" src="http://192.168.10.244:8090/iserver/manager/static/libs/json_parse.js"></script>
<script type="text/javascript" src="http://192.168.10.244:8090/iserver/manager/static/js/utility.js"></script>
<script type="text/javascript" src="http://192.168.10.244:8090/iserver/manager/static/js/config.js"></script>
<script type="text/javascript" src="http://192.168.10.244:8090/iserver/manager/includeJs.js"></script>
<script type="text/javascript" src="http://192.168.10.244:8090/iserver/manager/static/js/updateURI.js"></script>

<script>
   $(document).ready(function() {
	$.ajaxSetup({cache:false});
   });
   var productType = "iServer";
</script>

<style type="text/css">
	.helpLink {
		background: url("http://192.168.10.244:8090/iserver/manager/static/img/helpLink.gif") no-repeat left center;
		margin-right: 20px;
		padding: 0 0 2px 18px;
	}
</style>
<link type="text/css" href="http://192.168.10.244:8090/iserver/manager/static/css/servicesManager.css"
              rel="stylesheet"/>
<script>
/*
function initFream(curTabId) {
	addTabsLink();
	$('#security_tab').addClass('selected');
	initSecurityTabsNav(curTabId);
}

function initSecurityTabsNav(curTabId) {
	var tabsNavContent = //"<li id='overview'><a href='"+ getSecurityRootUrl() + "'>概述</a></li>" +
	"<li id='user'><a href='"+ getSecurityRootUrl() +"/users'>用户管理</a></li>" +
	"<li id='role'><a href='"+ getSecurityRootUrl() +"/roles'>角色管理</a></li>" ;+
	"<li id='permission'><a href='"+ getSecurityRootUrl() +"/permissions'>权限管理</a></li>" +
	"<li id='urlrule'><a href='"+ getSecurityRootUrl() +"/urlrules'>url规则</a></li>";
	$(".tabs-nav").append(tabsNavContent);
	$(".tabs-nav #" + curTabId).addClass('tabs-selected');
}
 */
var isie = document.all ? true : false;
function getSecurityRootUrl() {
    return "http://192.168.10.244:8090/iserver/manager/security";
}

function initUnusedPermissions(permissionArray) {
    setOptionsByID(permissionArray, "unusedPerms");
}

function initUsedPermissions(permissionArray) {
    setOptionsByID(permissionArray, "usedPerms");
}

// 根据select标签的id设置options
function setOptionsByID(optionArray, selectID) {
    var optionObj = document.getElementById(selectID);
    optionObj.length = 0;
    if (optionArray && optionArray.length > 0) {
        for ( var i = 0; i < optionArray.length; i++) {
            var newOption = new Option(optionArray[i]);
            newOption.value = optionArray[i];
            optionObj.options.add(newOption);
        }
    }
}

function createRole() {
    if (roleNameCheck() && descriptionCheck()) {
        var entry = {};
        entry.name = $.trim($("#roleName").val());
        entry.description = $.trim($("#description").val());
        entry.permissions = getPermissions();
        entry.users = getContainedUsers();
        entry.userGroups = getSelectedUserGroups();
        return entry;
    }
}

function createUrlRule() {
    var entry = {};
    entry.id = $.trim($("#ruleID").val());
    entry.template = $.trim($("#urlAdd").val());
    entry.permissions = getPermissions();
    return entry;
}

// 获取包含的合法用户
function getContainedUsers() {
    return getAllOptionsByID("usedUsers");
}

function getPermissions() {
    var permissions = {};
    permissions.publishEnabled = $("#ServiceAdmin").prop("checked");
    return permissions;
}

function getAllowedRoles() {
    return getAllOptionsByID("usedRoles");
}

function getSelectedUserGroups() {
    return getAllOptionsByID("usedUserGroups");
}

function getAllOptionsByID(optionID) {
    var trs = document.getElementById(optionID);
    var perms = [];
    for ( var i = 0; i < trs.options.length; i++) {
        var perm = trs.options[i].value;
        perms.push(perm);
    }
    return perms;
}

function getAllRoles() {
    var rolesURI = getSecurityRootUrl() + "/roles.json";
    var response = sendRequestWithResponse("GET", rolesURI, "");
    return response;
}

function getAllsUser() {
    var usersURI = null;
    var response = null;
    if("iServer" !== "iPortal"){
        usersURI = getSecurityRootUrl() + "/users.json";
        response = sendRequestWithResponse("GET", usersURI, "");

    }else{
        usersURI = getSecurityRootUrl() + "/portalusers.json";
        var portalUsers = sendRequestWithResponse("GET", usersURI, "");
        response = [];
        for(var i=0;i<portalUsers.length;i++){
            var item = [];
            item.push(portalUsers[i].name);
            if (portalUsers[i].departmentNames != null) {
                item.push(portalUsers[i].departmentNames.reverse().join(" -> "));
            } else {
                item.push("");
            }
            item.push(portalUsers[i].roles.join(","));
            item.push(String(portalUsers[i].isLocked));
            item.push(portalUsers[i].maxDataCapacity);
            item.push(portalUsers[i].expirationTime);
            response.push(item);
        }
    }
    return response;
}

function getRolesByInstance(instanceName) {
    var rolesURI = getSecurityRootUrl() + "/roles.json?instance=" + instanceName;
    var response = sendRequestWithResponse("GET", rolesURI, "");
    return response;
}

function getRolesByNotInstance(instanceName) {
    var rolesURI = getSecurityRootUrl() + "/roles.json?notInstance=" + instanceName;
    var response = sendRequestWithResponse("GET", rolesURI, "");
    return response;
}

/**
 * 检查用户密码是否合法 ，检查规则如下：
 * 1，包含大写字母
 * 2，包含小写字母
 * 3，包含数字
 * 4，包含特殊字符
 * 密码字符串必须至少满足三条规则。
 * @returns {Boolean}
 */
function passwordValidCheck() {
    var password = $.trim($("#password").val());
    var userName = $.trim($("#userName").val());
    var errorObj = document.getElementById("verifyInfo");
    var roles = null;
    if (isie) {
        roles = document.getElementById("userAllRoles").innerText.split(" , ");
    } else {
        roles = document.getElementById("userAllRoles").textContent.split(" , ");
    }
    var hasUpperCasePattern = /[A-Z]+/g;
    var hasNumCasePattern = /\d+/g;
    var hasSpecialCasePattern = /[\W_]+/g;
    var hasLowerCasePattern = /[a-z]+/g;

    // 0表示没有匹配到字符；1表示匹配到了。
    var hasUpperCaseFlag = password.match(hasUpperCasePattern) == null ? 0 : 1;
    var hasNumCaseFlag = password.match(hasNumCasePattern) == null ? 0 : 1;
    var hasSpecialCaseFlag = password.match(hasSpecialCasePattern) == null ? 0 : 1;
    var hasLowerCaseFlag = password.match(hasLowerCasePattern) == null ? 0 : 1;
    var matchCount = hasUpperCaseFlag + hasNumCaseFlag + hasSpecialCaseFlag + hasLowerCaseFlag;
    var name = changeName(userName);
    if (roles.contains("SYSTEM")) {
        return false;
    }
    if(!checkPasword(password,errorObj,matchCount,userName,name)){
    	return false;
    }
    clearErrorInfo("verifyInfo");
    return true;
}

function checkPasword(password,errorObj,matchCount,userName,name){
	if (password.length < 8 || password.length > 18) {
        if (isie) {
            errorObj.innerText = securityManagerRes.PasswordInvalid;
        } else {
            errorObj.textContent = securityManagerRes.PasswordInvalid;
        }
        return false;
    } else if (matchCount < 3) {
        if (isie) {
            errorObj.innerText = securityManagerRes.PasswordIllegal1;
        } else {
            errorObj.textContent = securityManagerRes.PasswordIllegal1;
        }
        return false;
    } else if (password === userName || password === name) {
        if (isie) {
            errorObj.innerText = securityManagerRes.PasswordIllegal2;
        } else {
            errorObj.textContent = securityManagerRes.PasswordIllegal2;
        }
        return false;
    }
	return true;
}

function changeName(name) {
    var reverse = "";
    for ( var i = name.length - 1; i >= 0; i--) {
        reverse += name[i];
    }
    return reverse;
}
/**
 * 检查三维数据密码是否合法 ，检查规则：
 * 包含大小写字母、数字、特殊字符（不包含空格）
 * @returns {Boolean}
 */
function realSpacePasswordValidCheck() {
    if (!realspacePasswordContentValidCheck()) {
        return false;
    }
    clearErrorInfo("errorInfo_password");
    return true;
}
function realSpacePassword2ValidCheck() {
    var password = document.getElementById("password").value;
    var password2 = $.trim($("#password2").val());
    var errorObj = document.getElementById("errorInfo_password2");
    if (!realspacePasswordContentValidCheck(password2, errorObj)) {
        return false;
    }
    if (password !== password2) {
        if (isie) {
            errorObj.innerText = securityManagerRes.PasswordDifference;
        } else {
            errorObj.textContent = securityManagerRes.PasswordDifference;
        }
        return false;
    }
    clearErrorInfo("errorInfo_password2");
    return true;
}
// 三维密码修改验证 未传值默认获取id为password的值 id为errorInfo_password的节点对象
function realspacePasswordContentValidCheck(passwordValue, errorObject) {
    var password, errorObj;
    if (passwordValue || passwordValue === "") {
        password = passwordValue;
    } else {
        password = document.getElementById("password").value;
    }
    if (errorObject) {
        errorObj = errorObject;
    } else {
        errorObj = document.getElementById("errorInfo_password");
    }
    var hasSpace = /\s+/g;
    var hasSpaces = password.match(hasSpace);
    var hasLerrer = /[A-Za-z]+/g;
    var hasLetters = password.match(hasLerrer);
    var hasNum = /\d+/g;
    var hasNums = password.match(hasNum);
    var hasSpecialCase = /[\W_]+/g;
    var hasSpecialCases = password.match(hasSpecialCase);
    if (password.length < 6 || password.length > 18) {
        if (isie) {
            errorObj.innerText = securityManagerRes.PasswordInvalid1;
        } else {
            errorObj.textContent = securityManagerRes.PasswordInvalid1;
        }
        return false;
    }
    if (hasSpaces || !hasLetters || !hasNums || !hasSpecialCases) {
        if (isie) {
            errorObj.innerText = securityManagerRes.PasswordIllegal;
        } else {
            errorObj.textContent = securityManagerRes.PasswordIllegal;
        }
        return false;
    }
    return true;
}

function password2Check() {
    var password = $.trim($("#password").val());
    var password2 = $.trim($("#confirmPassword").val());
    var errorObj = document.getElementById("verifyInfo");
    if (!passwordValidCheck()) {
        return;
    }
    if (password !== password2) {
        if (isie) {
            errorObj.innerText = securityManagerRes.PasswordDifference;
        } else {
            errorObj.textContent = securityManagerRes.PasswordDifference;
        }
        return false;
    }
    clearErrorInfo("verifyInfo");
    return true;
}

function clearErrorInfo(id) {
    var info = document.getElementById(id);
    if (info == null) {
        return;
    }
    if (info.innerText !== "") {
        if (isie) {
            info.innerText = "";
        } else {
            info.textContent = "";
        }
    }
}

// 设置用户选择框的disabled属性
function setUsersDisabled(disabled) {
    if (disabled) {
        $("#unusedUsers").attr('disabled', true);
        $("#usedUsers").attr('disabled', true);
    } else {
        $("#unusedUsers").removeAttr('disabled');
        $("#usedUsers").removeAttr('disabled');
    }
    setOptionOperateDisabled(disabled);
}

// 设置角色选择框的disabled属性
function setRolesDisabled(disabled) {
    if (disabled) {
        $("#unusedRoles").attr('disabled', true);
        $("#usedRoles").attr('disabled', true);
    } else {
        $("#unusedRoles").removeAttr('disabled');
        $("#usedRoles").removeAttr('disabled');
    }
    setOptionOperateDisabled(disabled);
}

// 设置用户组选择框的disabled属性
function setUserGroupsDisabled(disabled) {
    if (disabled) {
        $("#unusedUserGroups").attr('disabled', true);
        $("#usedUserGroups").attr('disabled', true);
        $("#addSingleUserGroup").attr('disabled', true);
        $("#removeSingleUserGroup").attr('disabled', true);
    } else {
        $("#unusedUserGroups").removeAttr('disabled');
        $("#unusedUserGroups").removeAttr('disabled');
        $("#addSingleUserGroup").removeAttr('disabled');
        $("#addSingleUserGroup").removeAttr('disabled');
    }
}

// 设置用户/角色选择框的disabled属性
function setOptionOperateDisabled(disabled) {
    if (disabled) {
        $("#addSingle").attr('disabled', true);
        $("#removeSingle").attr('disabled', true);
    } else {
        $("#addSingle").removeAttr('disabled');
        $("#removeSingle").removeAttr('disabled');
    }
}

function getRoleDescription(roleName, roleDescription) {
    var description = ShiroConfig.roleDescription[roleName],
        PLACEHOLDER = /\{PRODUCT_TYPE\}/gi;//用 相应产品类型  变量替换占位
    if (roleName === "ADMIN"){
        description = description.replace(PLACEHOLDER, productType);
    }
    if (description == null) {
        return roleDescription;
    }
    return description;
}

//用户查询功能
function SearchUser(slectId, iptSelector, arr){
    this.elemId = slectId;
    if(!Array.isArray(arr)){
        throw new Error("The third argument must be an array!");
    }
    this.userArr = [].concat(arr);
    this.bindEvent(iptSelector);
}
SearchUser.prototype = {
    bindEvent: function(selector){
        var lastTime = null,
            my = this;
        $(selector).keyup(function(e){
            if(e.keyCode === 13){
                return;
            }
            var me = this;
            lastTime = e.timeStamp; //timeStamp 返回事件发生的日期毫秒数
            setTimeout(function(){
                if(e.timeStamp - lastTime === 0){ //如果相减等于0说明0.5s内没有输入
                    my.getSearchValue($(me).val().trim());
                }
            },500)
        })
    },
    getSearchValue: function(kw){
        var getValues = [];
        if(kw){
            for(var i=0,arr=this.userArr; i<arr.length; i++){
                arr[i].indexOf(kw) !== -1 && getValues.push(arr[i]);
            }
        }else{
           getValues = null;
        }
        this.showOptions(getValues);
    },
    showOptions: function(names){
        var arr = names? names: this.userArr,
            selectElem = document.getElementById(this.elemId),
            frag = document.createDocumentFragment();
        selectElem.length = 0;
        for(var i=0; i<arr.length; i++){
            var opt = new Option(arr[i], arr[i]);
            frag.appendChild(opt);
        }
        selectElem.appendChild(frag);
    },
    dealUserArr: function(targetArr){
        var selectedOpt = $("#"+this.elemId+" :selected");
        for(var i=0; i<selectedOpt.length; i++){
            targetArr.push(selectedOpt[i].value);
            var index = this.userArr.indexOf(selectedOpt[i].value);
            index !== -1 && this.userArr.splice(index, 1);
        }
    }
};
function usernameCheck() {
    var username = $.trim($("#userName").val());
    var errorObj = document.getElementById("errorInfo_userName");
    if (username === '') {
        if (isie) {
            errorObj.innerText = securityManagerRes.UserNameIsNull;
        } else {
            errorObj.textContent = securityManagerRes.UserNameIsNull;
        }
        return false;
    }

    if (!SuperMapServer.Util.isAlpha(username)) {
        if (isie) {
            errorObj.innerText = securityManagerRes.UserNameInvalid;
        } else {
            errorObj.textContent = securityManagerRes.UserNameInvalid;
        }
        return false;
    }
    clearErrorInfo("errorInfo_userName");
    return true;
}

function roleNameCheck() {
    var roleName = $.trim($("#roleName").val());
    var errorObj = document.getElementById("errorInfo_roleName");
    if (roleName === '') {
        if (isie) {
            errorObj.innerText = securityManagerRes.RoleNameIsNull;
        } else {
            errorObj.textContent = securityManagerRes.RoleNameIsNull;
        }
        return false;
    }

    if (!SuperMapServer.Util.isAlpha(roleName)) {
        if (isie) {
            errorObj.innerText = securityManagerRes.RoleNameInvalid;
        } else {
            errorObj.textContent = securityManagerRes.RoleNameInvalid;
        }
        return false;
    }
    clearErrorInfo("errorInfo_roleName");
    return true;
}
function descriptionCheck() {
    var description = $.trim($("#description").val());
    var errorObj = document.getElementById("errorInfo_description");

    if (!SuperMapServer.Util.xSSFilterCheck(description)) {
        if (isie) {
            errorObj.innerText = securityManagerRes.descriptionInvalid;
        } else {
            errorObj.textContent = securityManagerRes.descriptionInvalid;
        }
        return false;
    }
    clearErrorInfo("errorInfo_roleName");
    return true;
}

// 根据select标签的id设置options
function setOptionsByID(optionArray, selectID) {
    var optionObj = document.getElementById(selectID);
    optionObj.length = 0;
    if (optionArray && optionArray.length > 0) {
        for ( var i = 0; i < optionArray.length; i++) {
            var newOption = new Option(optionArray[i]);
            newOption.value = optionArray[i];
            optionObj.options.add(newOption);
        }
    }
}

// 根据select标签的id和要过滤掉的值设置options
function setOptionsByFilterAndID(optionArray, selectID, filters) {
    var optionObj = document.getElementById(selectID);
    optionObj.length = 0;
    if (optionArray && optionArray.length > 0) {
        var isAdd = true;
        for ( var i = 0; i < optionArray.length; i++) {
            isAdd = true;
            var newOption = new Option(optionArray[i]);
            newOption.value = optionArray[i];
            for ( var j = 0; j < filters.length; j++) {
                if (optionArray[i] === filters[j]) {
                    isAdd = false;
                    break;
                }
            }
            if (isAdd) {
                optionObj.options.add(newOption);
            }
        }
    }
}

function initUnusedRoles(roleArray) {
    setOptionsByID(roleArray, "unusedRoles");
}

function initUnusedUsers(userArray) {
    setOptionsByID(userArray, "unusedUsers");
}

function initUnusedUserGroups(userGroupArray) {
    setOptionsByID(userGroupArray, "unusedUserGroups");
}

function initUsedUserGroups(userGroupArray) {
    setOptionsByID(userGroupArray, "usedUserGroups");
}

function initUsedRoles(roleArray) {
    var filters = [];
    filters.push("SYSTEM");
    setOptionsByFilterAndID(roleArray, "usedRoles", filters);
}

function initUsedUsers(userArray) {
    setOptionsByID(userArray, "usedUsers");
}

function createUser() {
    if (usernameCheck() && passwordValidCheck() && password2Check()) {
        var entry = {};
        entry.name = $.trim($("#userName").val());
        entry.password = $.trim($("#password").val());
        entry.description = $.trim($("#description").val());
        entry.roles = getAllowedRoles();
        entry.userGroups = getSelectedUserGroups();
        if("iServer" === "iPortal"){
            entry.type = $.trim($("#iPortalUserTypeSelect").val());
        }
        // entry.permissions = getAllowedPerms();
        return entry;
    }
}

function getRolesBySelectedOptions(userGroups) {
    var roles = getAllowedRoles();
    var selectedUserGroups = getSelectedUserGroups();
    if (selectedUserGroups) {
        for ( var i = 0; i < selectedUserGroups.length; i++) {
            for ( var j = 0; j < userGroups.length; j++) {
            	if (selectedUserGroups[i] == userGroups[j]["name"]) {
            		putToArray(roles, userGroups[j]["roles"]);
            	}
            }
        }
    }
    return roles.join(" , ");
}

function putToArray(roles, roleArray) {
    for ( var i = 0; roleArray && i < roleArray.length; i++) {
        if (roleArray[i].trim().length > 0 && jQuery.inArray(roleArray[i], roles) === -1) {
            roles.push(roleArray[i]);
        }
    }
}var setting;
var serviceSetUtilty ;
var serviceProvidersUtilty ;
var serviceCacheUtilty ;
var serviceHomeUtilty;
var serviceSecurityUtilty;
var serviceInterfacesUtilty;

$(document).ready(function () {
	$('#server_tab').addClass('selected');
	fillConfigs();
    updateRes();
    setting = {"isStreamingService":false,"interfaceTypes":"com.supermap.services.rest.JaxrsServletForJersey,com.supermap.services.wps.WPSServlet","isSet":false,"instances":[{"interfaceType":"com.supermap.services.wps.WPSServlet","componentType":"com.supermap.services.components.impl.SpatialAnalystImpl","name":"spatialanalyst-changchun/wps100","componentSetName":null,"authorizeSetting":{"permittedRoles":[],"deniedRoles":[],"type":"PUBLIC"},"id":null,"componentName":"spatialanalyst-changchun","interfaceName":"wps100","enabled":true,"status":"OK"},{"interfaceType":"com.supermap.services.rest.JaxrsServletForJersey","componentType":"com.supermap.services.components.impl.SpatialAnalystImpl","name":"spatialanalyst-changchun/restjsr","componentSetName":null,"authorizeSetting":{"permittedRoles":[],"deniedRoles":[],"type":"PUBLIC"},"id":null,"componentName":"spatialanalyst-changchun","interfaceName":"restjsr","enabled":true,"status":"OK"}],"isClusterService":false,"type":"com.supermap.services.components.impl.SpatialAnalystImpl","interfaceNames":"restjsr,wps100","clusterInterfaceNames":"","isDataflowService":false,"component":{"isScSet":false,"scSetSetting":null,"scSetting":{"disabledInterfaceNames":"","initPriority":0,"instanceCount":0,"name":"spatialanalyst-changchun","alias":"","interfaceNames":"restjsr,wps100","type":"com.supermap.services.components.impl.SpatialAnalystImpl","config":null,"providers":"ugcSpatialProvider-Changchun","enabled":false}},"providerNames":"ugcSpatialProvider-Changchun","name":"spatialanalyst-changchun","alias":"","isDistributedanalystService":false,"providers":[{"spsetSetting":null,"isSPSet":false,"spSetting":{"name":"ugcSpatialProvider-Changchun","alias":null,"innerProviders":null,"type":"com.supermap.services.providers.UGCSpatialAnalystProvider","config":{"workspacePath":"../../samples/data/NetworkAnalyst/Changchun.sxwu","tmpDatasourceName":null,"multiInstance":false,"datasourceInfos":null,"datasourceNames":null},"enabled":false}}]};
    serviceHomeUtilty = new ServiceHomeUtilty(setting);
    serviceHomeUtilty.initHomePage();
    if(setting.isClusterService){
    	filterProvidersPage();
    	filterCachePage();
    	filterServiceSetPage();
    }else{
    	if(setting.isSet){
    		// 服务集合
    		filterProvidersPage();
    		filterDataFlowServerPage();
    		filterStreamingServerPage();
    		serviceSetUtilty = new ServiceSetUtilty(setting);
            serviceSetUtilty.initServiceSetPage();	
        }else{
        	filterServiceSetPage();
    	    // 空间建模服务不支持Provider
    		if(setting.type=="com.supermap.geoprocessor.services.providers.GeoprocessorComponent"){
    			filterProvidersPage();
    			filterDataFlowServerPage();
    			filterStreamingServerPage();
    			// 分布式空间处理服务只可以看到基本信息,且不支持修改操作
    		}else if(setting.type=="com.supermap.processing.jobserver.ProcessingServer"){
    			filterDataFlowServerPage();
    			filterStreamingServerPage();
    			filterServiceSetPage();
    			filterInterfacesPage();
    			filterProvidersPage();
    			filterCachePage();
    			// 地理处理服务没有提供者和组件，所以不支持修改
			}else if(setting.type=="com.supermap.server.host.webapp.handlers.geoprocessing.GeoprocessingServer"){
				filterDataFlowServerPage();
				filterStreamingServerPage();
				filterServiceSetPage();
				filterInterfacesPage();
				filterProvidersPage();
				filterCachePage();
				$("#button_Save").attr("disabled","disabled");
				// 机器学习服务没有提供者和组件，所以不支持修改
			}else if(setting.type=="com.supermap.machinelearning.handler.MachineLearningServer"){
				filterDataFlowServerPage();
				filterStreamingServerPage();
				filterServiceSetPage();
				filterInterfacesPage();
				filterProvidersPage();
				filterCachePage();
				$("#button_Save").attr("disabled","disabled");
				// 数据目录服务没有提供者和组件，所以不支持修改
    		}else if(setting.type=="com.supermap.services.components.impl.DataCatalogImpl"){
    			filterDataFlowServerPage();
    			filterStreamingServerPage();
    			filterServiceSetPage();
    			filterInterfacesPage();
    			filterProvidersPage();
    			filterSecurityPage();
    			filterCachePage();
    			$("#button_Save").attr("disabled","disabled");
    			// web打印没有提供者和组件，所以不支持修改
    		}else if(setting.type=="com.supermap.services.components.impl.WebPrintingImpl"){
                filterDataFlowServerPage();
                filterStreamingServerPage();
                filterServiceSetPage();
                filterInterfacesPage();
                filterProvidersPage();
                filterSecurityPage();
                filterCachePage();
                $("#button_Save").attr("disabled","disabled");
                // 数据流服务没有提供者和组件，所以不支持修改
            }else if(setting.type == "com.supermap.service.dataflow.DataFlowServiceInstance") {
    			// 因为DataFlowServerPage页面是DataFlow服务特有的，所以只有DataFlow服务不过滤掉DataFlowServerPage，即不执行filterDataFlowServerPage();
    			filterStreamingServerPage();
    			filterServiceSetPage();
    			filterProvidersPage();
    			filterCachePage();
    			showDataFlowServerPage();
    			showDataFlowServerSettingDiv(setting.dataFlowServerSetting,"#dataFlowServerSettingDiv");
    		}else if(setting.type == "com.supermap.processing.jobserver.StreamingServiceServer"){
    			// 因为StreamingServerPage页面是Streaming服务特有的，所以只有Streaming服务不过滤掉StreamingServerPage，即不执行filterStreamingServerPage();
    			filterDataFlowServerPage();
    			filterServiceSetPage();
    			filterInterfacesPage();
    			filterProvidersPage();
    			filterSecurityPage();
    			filterCachePage();
    			showStreamingServerPage();
    			showStreamingServerSettingDiv(setting,"#streamingServerSettingDiv");
    			showStreamingApplicationDiv(setting,"#streamingapplicationDiv");
    		}else{
    			filterStreamingServerPage();
    			filterDataFlowServerPage();
    			serviceProvidersUtilty = new ServiceProvidersUtilty();
    			serviceProvidersUtilty.initProvidersPage();
    		}
        }
    	serviceCacheUtilty = new ServiceCacheUtilty();
    	serviceCacheUtilty.initCachePage();
    }
    if(setting.instances){
    	serviceSecurityUtilty = new ServiceSecurityUtilty(setting.instances,["PUBLISHER","NOPASSWORD","UNAUTHORIZED","PORTAL_USER","ADMIN"]);
    	serviceSecurityUtilty.initSecurityPage();
    }
    if(setting.interfaceNames){
    	serviceInterfacesUtilty = new ServiceInterfacesUtilty(setting.interfaceNames,setting.type,setting.isClusterService);
    	serviceInterfacesUtilty.initInterfacesPage();
    }
	bindEvent();
	// ================================liucy20140425=======================================================
	var scrollFixed=160;
	var scrollTop; 
	var clickIndex;
	var index=new Array("home","provider","serviceSet","dataflowserver", "streamingapplication", "streamingserver", "interfaces","cache","security");	
	var scroll_now=0;
	$("#menu_home").addClass("active");	
	// 左侧菜单样式控制
    var left_menu_a=$("#tabLeft").find("li");
    left_menu_a.click(function(){
    	left_menu_a.removeClass("active");
    	$(this).addClass("active"); 
    }); 
	// scroll事件
	$(window).bind('scroll', function () {
		var menu = $("#menu");
        var left_menu=$("#left-menu");
        var content=$("#tabContent");
        scrollTop = $(this).scrollTop(); 
        // 滑动左侧菜单索引
        var ifHide;  
        var lastMinus=-1;       
        var indexNow=0;
        for(var i=0;i<index.length;i++){
        	var obj=$("#"+index[i]);        	
        	if(obj.length>0){        		
        		ifHide=obj[0].offsetTop-scrollTop+143;
        		// console.log("offset="+obj[0].offsetTop+"
				// scrollTop="+scrollTop+" 差值"+ifHide);
        		indexNow++;
        		if(ifHide<0){
        			lastMinus=indexNow;
        		}
        	}        	
        }
        scroll_now=lastMinus<0?0:lastMinus-1;
        left_menu_a.removeClass("active");        
        $("#tabLeft li:eq("+scroll_now+")").addClass("active");        
        // 菜单浮动
        if (scrollTop > scrollFixed) {
            // menu.addClass("menu");
            left_menu.addClass("left-menu");
            left_menu.css("top",$(document).scrollTop()-$("#tabContent").offset().top);
        }
        else{     
        	// menu.removeClass("menu");
            left_menu.removeClass("left-menu");
            left_menu.css("top",0);
            
        }
	});
	
    // 自适应tabContent底部空白（避免菜单无法滑到最后一项）
    var window_height=$(window).height();
    var lastBlock_id="#"+$("#tabLeft li:last").children("a").attr("id").split("_")[1];
    var lastBlock_height=$(lastBlock_id+"Div").height();
    var pb=window_height-lastBlock_height-70;
    // 最后一个模块不足一屏
    if(pb>0){
    	$(".tabContent").attr('style','padding-bottom:'+pb+'px');
    }
});
// ===============================================================================================================

function filterProvidersPage(){
	$("#providerTab").remove();
	$("#providerHead").remove();
	$("#providerDiv").remove();
}
function filterCachePage(){
	$("#cacheTab").remove();
	$("#cacheHeader").remove();
	$("#cacheDiv").remove();
}
function filterServiceSetPage(){
	$("#serviceSetTab").remove();
	$("#setHeader").remove();
	$("#serviceSetDiv").remove();
}
function filterInterfacesPage(){
	$("#interfacesTab").remove();
	$("#interfacesHeader").remove();
	$("#interfacesDiv").remove();
}
function filterSecurityPage(){
	$("#securityTab").remove();
	$("#securityHeader").remove();
	$("#securityDiv").remove();
}
// dataFlowServerPage是数据流服务特有的
function filterDataFlowServerPage(){
	$("#dataflowserverTab").remove();
	$("#dataflowserverHead").remove();
	$("#dataFlowServerSettingDiv").remove();
}
function showDataFlowServerPage() {
	$("#dataflowserverTab").show();
	$("#dataflowserverHead").show();
	$("#dataFlowServerSettingDiv").show();
}

//StreamingServerPag是流数据服务特有的
function filterStreamingServerPage(){
	filterStreamingApplicationPage();
	$("#streamingserverTab").remove();
	$("#streamingserverHead").remove();
	$("#streamingServerSettingDiv").remove();
}
function filterStreamingApplicationPage(){
	$("#streamingapplicationTab").remove();
	$("#streamingapplicationHead").remove();
	$("#streamingapplicationDiv").remove();
}
function showStreamingServerPage(){
	showStreamingApplicationPage();
	$("#streamingserverTab").show();
	$("#streamingserverHead").show();
	$("#streamingServerSettingDiv").show();
}
function showStreamingApplicationPage(){
	$("#streamingapplicationTab").show();
	$("#streamingapplicationHead").show();
	$("#streamingapplicationDiv").show();
}
function bindEvent() {
 // 单击返回和保存变更后的响应
	$("#button_Save").click(function() {
		var msg = serviceHomeUtilty.checkInstanceCount();
		if(msg){
			SuperMapServer.Dialog.alert(msg);
			return;
		}
		var uri=getRootUrl()+"services/"+setting.name;
		serviceHomeUtilty.fillSetting(setting);
		// DataFlow服务不做提供者参数设置，因为DataFlow没有提供者，但是DataFlow服务有特有WSS配置
		if("com.supermap.service.dataflow.DataFlowServiceInstance" == setting.type) {
			// 获取WSS配置参数
			setDataFlowServerSetting(setting, "#dataFlowServerSettingDiv");
		} else if("com.supermap.processing.jobserver.StreamingServiceServer" == setting.type) {
			setStreamingServerSetting(setting, "#streamingServerSettingDiv");			
		} else if("com.supermap.processing.jobserver.ProcessingServer" == setting.type) {
			setting.isDistributedanalystService = true;
		}else {
			if(!setting.isClusterService){
				if(setting.isSet){
					serviceSetUtilty.fillSetting(setting);
				}else{
					serviceProvidersUtilty.fillSetting(setting);
				}
				serviceCacheUtilty.fillSetting(setting);
			}
		}
		if(serviceInterfacesUtilty){
			//分布式分析服务没有接口更改设置
			if("com.supermap.processing.jobserver.ProcessingServer" !== setting.type){
				msg = serviceInterfacesUtilty.checkInterfaceSettingAvailable();
				if(msg){
					SuperMapServer.Dialog.alert(msg);
					return;
				}
				serviceInterfacesUtilty.fillSetting(setting);	
			}
		}
		// mapconfig中关于clip参数的设置已经废弃，组件设置更新默认不发送clip参数
		if(!setting.isSet && setting.component != null && setting.component.scSetting.config){
			delete setting.component.scSetting.config.clip;
		}
		// 136行的fillSetting方法会检测延迟提交参数是否合法，但是不会抛出异常，只是会使provider.spSetting为false，
		// 所以这里需要检测提供者是否为false，若为false，则不向后台发请求，且打印提示信息
		if(!checkDelayCommitSettingValidOrNot(setting)) {
			return;
		}
		var succeed = sendRequest("PUT", uri + ".rjson", setting);
		if(succeed){
			window.location.reload();
		}
	});


	$("#button_Cancel").click(function() {
		window.location.href=getRootUrl() + "services";
	});
	
}

// 检测延迟提交参数是否合法；
// 136行的fillSetting方法已经做了参数检测，若检测不合法，会使provider.spSetting为false，所以这里只需要检测是否为false就可以了
function checkDelayCommitSettingValidOrNot(setting) {
	// 服务组件集合对应的服务，没有服务提供者
	if (!setting.providers) {
		return true;
	}
	for (var i = 0; i < setting.providers.length; i++) {
		var provider = setting.providers[i];
		if(provider.spSetting === false) {
			return false;
		}
	}
	return true;
}
function removeService(serviceName) {
	SuperMapServer.Dialog.confirm(null, instancesRes.deleteConfirm, function() {
		var delUrl = getRootUrl() + "services/" + serviceName + ".rjson";
		sendRequestWithResponse("DELETE", delUrl, null);
		window.location.href = getRootUrl() + "services";
	});
}
function startOrStopInstance(instance, start) {
	var toOperate = [];
	toOperate.put(instance);
	this.startOrStopInstances(toOperate, start);
}
function startOrStopInstances(instances, start) {
	if (instances.length > 0) {
		var selectedStopedInstance = [];
		var instanceUri = getRootUrl() + "services" + ".rjson";
		var hasClusterInstances = false;
		var toOperates = [];
		for ( var i = 0; i < instances.length; i++) {
			toOperates.push(instances[i]);
			var entry = {};
			entry.name = instances[i];
			entry.enabled = start;
			selectedStopedInstance.push(entry);
		}
		if (selectedStopedInstance.length > 0) {
			var succeed = sendRequest("PUT", instanceUri,
					selectedStopedInstance);
			changeElementClass(succeed,start,instances);
			if(succeed) {
				// 服务管理的主页面和服务管理子页面都调用startOrStopInstances方法来切换服务的停止/启用;
				// 由于子页面需要在切换时，重新刷新页面，而主页面不需要刷新页面，所以这里判断下当前url
				var locations = window.location.href.split("/");
			}
			if(succeed&&locations.length > 0 && locations[locations.length - 1] != "services"){
				location.reload(true);
			}
			
		}

	}
};
function changeElementClass(succeed,start,instances){
	if (succeed && start) {
		$("#availableImg_" + instances).attr('style','display:none');
		$("#availableImg_" + instances).attr('class', 'glyphicon glyphicon-stop instanceIconStop stopEvent');
		$("#stopSpan_" + instances).removeClass("instanceIconStop");
		$("#stopSpan_" + instances).addClass("instanceIcon");
		$("#startSpan_" + instances).removeClass("instanceIcon");
		$("#startSpan_" + instances).addClass("instanceIconStop");
	} else if(succeed&&!start) {
    	var imgUrl = getRootUrl()+"static/img/stopped.gif";
    	$("#availableImg_" + instances).attr('title', ServiceManagerRes.serviceUseless);
    	$("#availableImg_" + instances).attr('src',imgUrl);
    	$("#availableImg_" + instances).attr('style','display:')
		$("#startSpan_" + instances)
				.removeClass("instanceIconStop");
		$("#startSpan_" + instances).addClass("instanceIcon");
		$("#stopSpan_" + instances).removeClass("instanceIcon");
		$("#stopSpan_" + instances).addClass("instanceIconStop");
	}
}
function getServiceStatistics(name) {
	var instanceCountUri = getRootUrl()
			+ "serverstatus/requests/statistics.json";
	var response = sendRequestWithResponse("GET", instanceCountUri, null);
	var count = 0;
	for ( var prop in response) {
		if (prop.split("/")[0] == name) {
			count += response[prop];
		}
	}
	return count;
};var mapInfos=[];
var serviceStatisticsUtilty ;
var ServiceHomeUtilty  = function (setting) {
    this.initHomePage = function () {
    	serviceStatisticsUtilty = new ServiceStatisticsUtilty();
    	this.initFunctiobar(setting);
    	mapInfos=[];
        $("#serviceName").text(setting.name);
        // DataFlow服务和Streaming服务没有别名，不支持修改
        if(setting.type == "com.supermap.service.dataflow.DataFlowServiceInstance" || setting.type == "com.supermap.processing.jobserver.StreamingServiceServer"){
        	$("#serviceAlias").parent().hide()
        } else {
        	$("#serviceAlias").text(setting.alias?setting.alias:"");
        }
        if(setting.isSet){//服务集合
        	$("#serviceType").text(ServiceManagerTypeRes["serviceSet"]);
        }else{
        	$("#serviceType").text(ServiceManagerTypeRes[setting.type]);
        }
        var instanceNames = [];
        if(setting.interfaceNames){
        	instanceNames = setting.interfaceNames.split(",");
    	}
        if(instanceNames.length == 0){
    		// 当实例列表instances为空时，服务地址是没有的，隐藏掉“服务地址”的label
    		$("#instanceAddress").parent().hide(); 	
        }
        for (var i = 0; i < instanceNames.length; i++) {
        	if (setting.instances[i]) {
        		var address = getServiceRootUrl() + setting.name + "/"
        		+ setting.instances[i].interfaceName;
        		//分布式分析服务时，服务地址增加“/v1”，规避无法成功跳转问题
        		if("com.supermap.processing.jobserver.ProcessingServer" == setting.type){
        			address += "/v1";
        		}

        		if(setting.instances.length == 0 || setting.instances[i].enabled == false || setting.instances[i].status == "FAILED") {
        			$("#instanceAddress").append("<a style='color:#A8A8A8' title='"+ ServiceManagerRes.serviceLinkUseless +"' target='_blank'>" + address + "</a>");
        			$("#instanceAddress").append("<br/>");
        		}else{
        			$("#instanceAddress").append("<a href='" + address + "' target='_blank'>" + address + "</a>");
        			//地理处理服务时，追加地理处理建模地址
					if ("com.supermap.server.host.webapp.handlers.geoprocessing.GeoprocessingServer" === setting.type) {
						var gpmodelerpth = getIServerUrl() + "/apps/gpmodeler/index.html";
						$("#instanceAddress").parent().after("<div class='parameter'><label>地理处理建模：</label><div style='margin-left:231px'><a href='" + gpmodelerpth + "' target='_blank'>" + gpmodelerpth + "</a></div></div>");
					}
        			if(setting.isClusterService){
        				$("#instanceAddress").append("<span style='margin-left:5px;padding: .1em .3em .1em;'class='label label-info'>"+ServiceManagerRes.cluster+"</span>");
        			}
        			$("#instanceAddress").append("<br/>");
        		}
        	} else {
        		// 当实例列表instances为空时，服务地址是没有的，隐藏掉“服务地址”的label
        		$("#instanceAddress").parent().hide();
        	}
        }
        if(!setting.isSet && !setting.isClusterService && setting.clusterInterfaceNames){
        	 var clusterInterfaceNames = setting.clusterInterfaceNames.split(",");
             for (var i = 0; i < clusterInterfaceNames.length; i++) {
                 var address = getServiceRootUrl() + setting.name + "/"
                     + clusterInterfaceNames[i];
                 $("#instanceAddress").append("<a href='" + address + "' target='_blank'>" + address + "</a>");
                 $("#instanceAddress").append("<span style='margin-left:5px;padding: .1em .3em .1em;'class='label label-info'>"+ServiceManagerRes.cluster+"</span>");
                 $("#instanceAddress").append("<br/>");
                }
        }
        if(setting.isSet && mapInfos.length>0){
        	 var mapServices=[];
        	 for(var i=0;i<setting.services.length;i++){
        		 if(setting.services[i].type=="com.supermap.services.components.impl.MapImpl"){
        			 mapServices.push(setting.services[i].serviceName);
        		 }
        	 }
        	 this.showThumbnails(setting.name);
             if(setting.interfaceTypes.containsIgnoreCase("com.supermap.services.rest.RestServlet")&&setting.instances.length > 0 && setting.instances[0].status == "OK"){
             	this.fillMapsDiv(setting);
             }
        }
        if (setting.type == "com.supermap.services.components.impl.MapImpl") {
        	this.showThumbnails(setting.name);
        	// 地图服务用restjsr接口实现了矢量瓦片服务
            if((setting.interfaceTypes.containsIgnoreCase("com.supermap.services.rest.JaxrsServletForJersey") || setting.interfaceTypes.containsIgnoreCase("com.supermap.services.rest.RestServlet"))
            		&&mapInfos.length>0&&setting.instances[0].enabled == true){          
            	this.fillMapsDiv(setting);
            }

        }
        if(setting.type == "com.supermap.services.components.impl.DataImpl"){
            if(!setting.isClusterService){
                var $configDiv=$("#configDiv");
                $configDiv.show();
                $configDiv.append("<div class='parameter'><label for='editable'>"+ServiceManagerRes.editable+"</label><input type='checkbox' id='editable' name='editable' /></div>");

                if(setting.component.scSetting.config.editable){
                    $("#editable").prop("checked",true);
                }
            }

        }
        if(setting.type == "com.supermap.services.components.impl.AddressMatchImpl") {
        	this.showUpdateIndexContainer(setting);
        }
       

        if(setting.isClusterService){
            $("button#button_Save").attr("disabled","disabled");
        }
        $(".lazy").lazyload();
        $("#testModal").on("shown.bs.modal",function (e) {
	    	serviceStatisticsUtilty.initStatisticsPage(setting.name);
	    });
        // 地址匹配服务暂不支持多实例
        if(!setting.isSet){
        	if(setting.type != "com.supermap.services.components.impl.AddressMatchImpl"){
        		if(setting.component != null && setting.component.scSetting != null){
        			$("#instanceCount").val(setting.component.scSetting.instanceCount);
            		if(0==setting.component.scSetting.instanceCount){
            			$("#instanceCountSpan").html(ServiceManagerRes.unset);
            		}else{
            			$("#instanceCountSpan").html(setting.component.scSetting.instanceCount);
            		}
        		}

        		if(false == false){
        			$(".instanceCount").css("display","none");
        		}else{
        			$(".instanceCount").css("display","block");
        		}
        	} else {
        		$("#instanceCount").val(0);
        		$(".instanceCount").css("display","none");
        	}
        }
    };

    this.initFunctiobar = function(setting){
    	var spanBarDiv = $("<div style='float:right;margin-top: 10px;'><span style='margin-right:5px' title='"+ServiceManagerRes.serviceStatisticsInfo+"' id='insCountSpan_"+setting.name+"' class='glyphicon glyphicon-eye-open instanceIcon '></span><small></small></div>");
        $("#home").append(spanBarDiv);
    	var $count = $("#insCountSpan_"+setting.name).siblings("small");
    	var count = getServiceStatistics(setting.name);
    	$count.append($("<span>"+count+"</span>"));
    	var elementStart = $("<span title='"+ServiceManagerRes.serviceStart+"'></span>");
        var elementStop = $("<span title='"+ServiceManagerRes.serviceStop+"'></span>");
        elementStart.attr('id', 'startSpan_' + setting.name);
        elementStop.attr('id', 'stopSpan_' + setting.name);
        var isStart  = this.isServiceStartOrNot(setting);
        if (!isStart) {
            elementStart.attr('class', 'glyphicon glyphicon-play instanceIcon startEvent');
            elementStop.attr('class', 'glyphicon glyphicon-stop instanceIconStop stopEvent');
        } else {
            elementStart.attr('class', 'glyphicon glyphicon-play instanceIconStop startEvent');
            elementStop.attr('class', 'glyphicon glyphicon-stop instanceIcon stopEvent');
        }
        spanBarDiv.append(elementStart);
        spanBarDiv.append(elementStop);

        var elementRemove = $("<span title='"+ServiceManagerRes.serviceRemove+"'></span>");
        //分布式空间处理、大数据处理、地理处理、机器学习服务不支持停止启动删除等操作
        if("com.supermap.processing.jobserver.ProcessingServer" == setting.type
			||"com.supermap.services.components.impl.DataCatalogImpl" == setting.type
            ||"com.supermap.services.components.impl.WebPrintingImpl" == setting.type
			||"com.supermap.server.host.webapp.handlers.geoprocessing.GeoprocessingServer" == setting.type
			||"com.supermap.machinelearning.handler.MachineLearningServer" == setting.type){
        	elementStart.attr('class', 'glyphicon glyphicon-play instanceIconStop');
        	elementStop.attr('class', 'glyphicon glyphicon-stop instanceIconStop')
        	elementRemove.attr('class', 'glyphicon glyphicon-remove instanceIconIconStop');	
        }else{
        	elementRemove.attr('class', 'glyphicon glyphicon-remove instanceIcon removeEvent');
        }
        elementRemove.attr('id', 'removeSpan_' + setting.name);
        spanBarDiv.append(elementRemove);
        
        $(".startEvent").click(function () {
	        if ($(this).hasClass("instanceIconStop")) {
	            return;
	        }
	        startOrStopInstance(this.id.replace("startSpan_", ""), true);
	    });
	    $(".stopEvent").click(function () {
	        if ($(this).hasClass("instanceIconStop")) {
	            return;
	        }
	        startOrStopInstance(this.id.replace("stopSpan_", ""), false);
	    });

	    $(".removeEvent").click(function () {
	    	var serviceName = this.id.replace("removeSpan_", "");
	    	removeService(serviceName);
	    });
	    $(".aliasIcon").click(function () {
	    	var value=$("#serviceAlias").text();
	    	$("#serviceAlias").hide();
	    	$("#componentAlias").show();
	    	$("#componentAlias").val(value);
	    	$(".aliasIcon").hide();
	    });
	    $("#componentAlias").blur(function () {
	    	var value=$("#componentAlias").val();
	    	$("#componentAlias").hide();
	    	$("#serviceAlias").show();
	    	$("#serviceAlias").text(value);
	    	$(".aliasIcon").show();
	    });
	    $("#insCountSpan_"+setting.name).click(function () {
	    	$("#testModal").modal({backdrop:"static"}).modal("show");
	    });

	    $(".instanceCountIcon").click(function () {
	    	$("#instanceCountSpan").hide();
	    	$("#instanceCount").show();
	    	$(".instanceCountIcon").hide();
	    });
    };


    this.isServiceStartOrNot=function(setting){
    	var isStart=true;
        if(setting.isSet){
        	for(var i=0;i<setting.instances.length;i++){
        		if(!setting.instances.get(i).enabled){
        			return false;
        		}
        	}
        }
        if(!setting.isClusterService == true){
        	if(!setting.isSet){
        		if(setting.component != null && setting.component.scSetting != null && setting.component.scSetting.disabledInterfaceNames){
        			return false;
        		}
        	}
        }
        // dataflow是没有服务组件的，只能根据服务实例来判断服务是否可用
        if (setting.isDataflowService === true) {
        	if (setting.instances) { 
        		var length = setting.instances.length;
        		for (var i = 0; i < length; i++) {
        			if (setting.instances[i].enabled === false) {
        				return false;
        			}
        		}
        	}
        }
        // StreamingService是没有服务组件，也没有服务接口和服务实例的，只能根据服务的运行状态来判断服务是否可用
        if (setting.isStreamingService === true) {
        	if (setting.status === "UnSubmit") {
        		return false;
        	}
        }
        return isStart;
    }
    
    this.showUpdateIndexContainer = function(setting) {
    	var show=true;
    	var providerNames = [];
    	if(setting.isClusterService){
            return;
        }
    	if(setting.providers) {
    		for(var i = 0; i < setting.providers.length; i++) {
    			var provider = setting.providers[i];
    			var spSetting = provider.spSetting;
    			if(spSetting && ("com.supermap.services.providers.RestAddressMatchProvider" === spSetting.type)){
    				show=false;
    				break;
    			}
    			if(spSetting && ("com.supermap.services.providers.UGCAddressMatchProvider" === spSetting.type)){
    				providerNames.push(spSetting.name);
    			}
    		}
    	}
    	if(show && !setting.isClusterService){
    		$("#updateIndexContainer").show();
        	initAppendIndexDiv("#updateIndexContainer",providerNames);
    	}
    	
    }
    
    this.showThumbnails = function(name){
    	$("#HomeDiv").attr("style","width:80%;display: inline-block;");
    	$("#HomeDiv").addClass("pull-left");

    	var thumbnailsAddress = getRootUrl() + "services/" + name
    	+ "/thumbnails";
    	$("#thumbnailsDiv").attr("style","width:20%;display: inline-block;");
    	$("#thumbnails").attr('class', 'lazy');
    	$("#thumbnails").attr('src', getRootUrl() + "static/img/loading256.gif");
    	$("#thumbnails").attr('data-original', thumbnailsAddress+".png");
    }
    this.fillVectorTileMap=function(current, mapInfo, restJsrInterfaceName){
		var mapUrl = getServiceRootUrl() + setting.name + "/" + restJsrInterfaceName + "/v1/vectortile/maps/" + mapInfo.mapName;;
		var $td=$("<td valign='top' align='left' style='width: 221px;'><a href='"+mapUrl+"'>"+mapInfo.mapName+"</a> &nbsp;&nbsp;&nbsp;&nbsp;</td>");
		current.append($td);
		if(mapInfo.supportMBStyle){
			var $span=$("<span style='font-size:80%;text-align:right'>"+ServiceManagerRes.browse+"</span>");
			$span.append(" iClient for openlayers3");
			$span.append(" <a class='viewer' href='"+mapUrl+".ol3' target='_blank'>(with MVT)</a>");
			// mapbox表述当前只支持3857,4326,4490,4214,4610的地图
			if(mapInfo.epsgCode == 3857 || mapInfo.epsgCode == 4326 || mapInfo.epsgCode == 4490 || mapInfo.epsgCode == 4214 || mapInfo.epsgCode == 4610) {
				if(!browserIsSupportMBStyle()){
					$span.append(" , <span title='" + ServiceManagerRes.notSupportMapboxGL + "'>for MapboxGL</span>");
				} else {
					$span.append(" , <a class='viewer' href='"+mapUrl+".mbgl' target='_blank'> for MapboxGL</a>");
				}
			}
			current.append($("<td></td>").append($span));
		} else {
			var $span=$("<span style='font-size:80%;text-align:right'>"+ServiceManagerRes.browse+"</span>");
			$span.append(" iClient for openlayers3");
			$span.append(" (with MVT)");
			current.append($("<td></td>").append($span));
		}
    }
    this.fillMapsDiv=function(setting){
    	var $mapsDiv=$("<div id='mapsDiv'style='padding-left:10px;'></div>");
    	for(var i=0;i<mapInfos.length;i++){
    		var $tr=$("<div class='parameter'></div>");
    		var mapInfo=mapInfos[i];
    		var restInterfaceName, restJsrInterfaceName;
    		for (var j = 0; mapInfo.instanceInfos != null && j < mapInfo.instanceInfos.length; j++) {
    			if (mapInfo.instanceInfos[j].interfaceType === "com.supermap.services.rest.RestServlet") {
    				restInterfaceName = mapInfo.instanceInfos[j].interfaceName;
    			}
    			if (mapInfo.instanceInfos[j].interfaceType === "com.supermap.services.rest.JaxrsServletForJersey"){
    				restJsrInterfaceName = mapInfo.instanceInfos[j].interfaceName;
    			}
    		}
    		if(!restInterfaceName && restJsrInterfaceName) {
    			this.fillVectorTileMap($tr, mapInfo, restJsrInterfaceName);
    			$mapsDiv.append($tr);
    			continue;
    		}
    		var mapUrl=getServiceRootUrl() + setting.name + "/" + restInterfaceName + "/maps/"+mapInfo.mapName;
    		var $td=$("<td valign='top' align='left' style='width: 221px;'><a href='"+mapUrl+"'>"+mapInfo.mapName+"</a> &nbsp;&nbsp;&nbsp;&nbsp;</td>");
    		var $span=$("<span style='font-size:80%;text-align:right'>"+ServiceManagerRes.browse+"</span>");
    		if(mapInfo.supportMapImage){
    			$span.append(" <a class='viewer' href='"+mapUrl+".leaflet' target='_blank'>iClient for Leaflet</a>");
    			if(mapInfo.supportCache){
    				$span.append(" <a class='viewer' href='"+mapUrl+".leaflet?isSingleImage=true' target='_blank'>(with SingleImage)</a>");
    			}
    			$span.append(" , <a class='viewer' href='"+mapUrl+".ol3' target='_blank'>for openlayers3</a>");
    		}
    		if(mapInfo.supportMBStyle){
    			if(mapInfo.supportMapImage){
    				$span.append(" <a class='viewer' href='"+mapUrl+".ol3?isMvt=true' target='_blank'>(with MVT)</a>");
    			}else{
    				$span.append(" for openlayers3<a class='viewer' href='"+mapUrl+".ol3?isMvt=true' target='_blank'>(with MVT)</a>");
    			}
    			// mapbox表述当前只支持3857,4326,4490,4214,4610的地图
    			if(mapInfo.epsgCode == 3857 || mapInfo.epsgCode == 4326 || mapInfo.epsgCode == 4490 || mapInfo.epsgCode == 4214 || mapInfo.epsgCode == 4610){
    				if(!browserIsSupportMBStyle()){
    					$span.append(" , <span title='" + ServiceManagerRes.notSupportMapboxGL + "'>for MapboxGL</span>");
    				} else {
    					$span.append(" , <a class='viewer' href='"+mapUrl+".mbgl' target='_blank'> for MapboxGL</a>");
    				}
    			}
    		}
    		if(mapInfo.supportMapImage){
    			$span.append( " , <a class='viewer' href='"+mapUrl+".ijs' target='_blank'>for Classic</a>");
    			if(mapInfo.supportVectorTile){
        			$span.append(" <a class='viewer' href='"+mapUrl+".vt' target='_blank'>(with Vector Tile)</a>");
        		}
    			if (mapInfo.supportWebGL3D){
    				$span.append( " , <a class='viewer' href='"+mapUrl+".webgl3d' target='_blank'>for WebGL3D</a>");
    			}
    			if(mapInfo.supportMapImage && mapInfo.containPrj4326){
    		    	$span.append(" , <a class='viewer' href='"+mapUrl+".tdt' target='_blank'>Tianditu.com</a>");
    		    }
    		}else if(mapInfo.supportVectorTile){
    			$span.append(" for Classic<a class='viewer' href='"+mapUrl+".vt' target='_blank'>(with Vector Tile)</a>");
    		}
			 
    		$tr.append($td).append($("<td></td>").append($span));
    		$mapsDiv.append($tr);
    	}
    	
    	 $("#HomeDiv").append($("<div class='parameter'><label>"+ServiceManagerRes.mapsList+"</label><label></label></div>"))
    	 $("#HomeDiv").append($mapsDiv);

    };
    
    function browserIsSupportMBStyle () {
	    var userAgent = navigator.userAgent; //取得浏览器的userAgent字符串  
	    var isIE = userAgent.indexOf("compatible") > -1 && userAgent.indexOf("MSIE") > -1; //判断是否IE<11浏览器  
	    var isEdge = userAgent.indexOf("Edge") > -1 && !isIE; //判断是否IE的Edge浏览器  
	    var isIE11 = userAgent.indexOf('Trident') > -1 && userAgent.indexOf("rv:11.0") > -1;
	    if(isIE) { // ie10及以下
	        return false;  
	    } else if(isEdge || isIE11) {// edge或者ie11
	        return true;
	    } else {// 不是ie浏览器
	        return true;
	    }
    }
    
    this.fillSetting = function (setting) {
    	setting.alias= $("#serviceAlias").text();
    	if(setting.component != null) {
    		if(setting.type == "com.supermap.services.components.impl.DataImpl"){
    			setting.component.scSetting.config.editable=$("#editable").prop("checked");
    		}
    		if(!setting.isSet){
    			setting.component.scSetting.instanceCount = $("#instanceCount").val();
    		}
    	}
    };
    this.checkInstanceCount = function(){
    	var instanceCount = $("#instanceCount").val();
    	if(instanceCount == ""){
			instanceCount = "0";
    	}
    	if(!isNumber(instanceCount) || instanceCount < 0){
    		return componentRes.instanceCountInvalid;
    	}
    }
};
var ServiceSetUtilty = function(setting){
	this.initServiceSetPage =function (){
		for(var i=0;i<setting.services.length;i++){
			var ser=setting.services[i];
			this.appendServiceDiv(ser.serviceName,ServiceManagerTypeRes[ser.type]);
			}
		// 添加服务组件到服务组件集对话框的初始化
		$('#addToComponentDialog').dialog({
					title : componentSetRes.addToComponentDialogTitle,
					autoOpen : false,
					width : 650,
					minWidth : 650,
					modal : true,
					position : 'center'
				});
		this.bindEvent();
		
		
		}
	this.appendServiceDiv=function(serviceName,type){
		var $serviceSetDiv = $("#serviceSetDiv");
		var $childDiv = $("<div style='margin-left:20px;margin-top:10px'></div>");
		var url=getRootUrl()+"services/"+serviceName;
		$childDiv.attr("id", serviceName);
		$childDiv.append("<span class='service' style='width:80%;display:inline' id='service_"
						+ serviceName
						+ "'><a href='"+url+"' >"
						+ serviceName
						+ "</a></span>(<span id='serviceType_"+serviceName+"'>"
						+ type
						+ "</span>)<a class='removeServiceA' style='float:right' id='removeServiceA_"
						+ serviceName + "'>"+ServiceManagerRes.remove+"</a>");
		$serviceSetDiv.append($childDiv)
	}
	this.bindEvent=function(){
		var serviceSetUtilty=this;
		// 点击添加服务到服务集合
		$('#bindService').click(function() {
			$('#addToComponentDialog').dialog('open');
			serviceSetUtilty.loadComponent();
			return false;
		});
		//从当前服务集合中移除服务
		$('.removeServiceA').click(function() {
			var todo = this.id.replace("removeServiceA_", "");
			SuperMapServer.Dialog.confirm(null, ServiceManagerRes.sureRemoveService, function() {
				$("#serviceSetDiv #" + todo).empty();
			})
		});
		// 添加服务到当前集合对话框，确定后更新显示
		$('#addToComponentDialog .dialogOK').click(function() {
			var checkedBox = $("#componentNotInSet input:checked").filter(".isUsed");
			for (var i = 0; i < checkedBox.length; i++) {
				
				var serviceName = $(checkedBox.eq(i)).attr("id");
				var type=$(checkedBox.eq(i)).attr("tag");
				serviceSetUtilty.appendServiceDiv(serviceName,type);
			}
			$('#addToComponentDialog').dialog('close');
		});

		$('#addToComponentDialog .dialogCancel').click(function() {
			$('#addToComponentDialog').dialog('close');
		});
		checkAll("#componentNotInSet .allSelect","#componentNotInSet .isUsed");

	}
	this.loadComponent=function(){
		var componentsUrl = getRootUrl() + "components.rjson";
		var msg = sendRequestWithResponse("GET",componentsUrl+".rjson",null);
		$("#componentNotInSet tbody").empty();
		var namesNotInSet = this.findComponentNotInSet(msg);
		for (var i = 0; i < namesNotInSet.length; i++) {
			if(enToZh(namesNotInSet[i].type) == componentSetRes.loadComponentType){
				continue;
			}
			$("#addToComponentDialog #componentNotInSet").append("<tr><td>"+ namesNotInSet[i].name+ "</td><td>"+ ServiceManagerTypeRes[namesNotInSet[i].type]+ "</td><td><input type='checkbox' id='"+namesNotInSet[i].name+"' tag='"+ServiceManagerTypeRes[namesNotInSet[i].type]+"' class='isUsed'/></td></tr>");
		}
	}
	this.fillSetting = function(setting) {
		var trs = $(".service");
		var services=[];
		for ( var i = 0; i < trs.length; i++) {
			var name = $(trs.get(i)).attr("id").replace("service_","");
			var type=this.getFullTypeName($(trs.get(i)).siblings("span").text());
			var serviceTag={};
			serviceTag.serviceName=name;
			serviceTag.type=type;
			services.push(serviceTag);
		}
		setting.services=services;
	}
	this.getFullTypeName=function(name){
		for(var item in ServiceManagerTypeRes){
			if(ServiceManagerTypeRes[item]==name){
				return item;
			}
		}
	}
	// 用来获得不在component集合中的component名称列表
	this.findComponentNotInSet=function(allMsg) {
		var trs = $(".service");
		var namesInSet = [];
		for ( var i = 0; i < trs.length; i++) {
			var name = $(trs.get(i)).attr("id").replace("service_","");
			namesInSet.push(name);
		}

		var namesNotInSet = [];
		for (var i = 0; i < allMsg.length; i++) {
			var exist = false;
			for (var j = 0; j < namesInSet.length; j++) {
				if (allMsg[i].name == namesInSet[j]) {
					exist = true;
				}
			}
			if (!exist) {
				namesNotInSet.push(allMsg[i]);
			}
		}
		return namesNotInSet;
	}

	};var serviceProvidersUtilty;
var objectCount = 0;
var allProviders;
var curProviderSettings = [];
var workspaceToolUrl = getRootUrl() + "workspaceTool.rjson";
var wmtsUrl;
var namesInSet;
var ServiceProvidersUtilty = serviceProvidersUtilty = function() {
    this.initProvidersPage = function() {
        var $providerDiv = $("#providerDiv");
        var providerUrl = getRootUrl() + "providers.rjson";
        allProviders = sendRequestWithResponse("GET", providerUrl, null);
        for ( var i = 0; i < setting.providers.length; i++) {
            var providerSetting = setting.providers.get(i);
            if (providerSetting.isSPSet) {
                this.addProviderSetDiv(providerSetting);
                curProviderSettings.push(providerSetting);
            } else {
                curProviderSettings.push(providerSetting.spSetting);
                this.addProviderDiv(providerSetting.spSetting.name,
                        providerSetting.spSetting.type,
                        providerSetting.spSetting.config,
                        providerSetting.spSetting.innerProviders);
            }
        }

        // 绑定服务提供者集合对话框的初始化
        $('#bindProviderDialog').dialog({
            title : componentRes.addProviderDialogTitle,
            autoOpen : false,
            width : 400,
            minWidth : 400,
            modal : true,
            position : 'center'
        });
        this.bindEvents();
    }
    this.fillSetting = function(setting) {
        var trs = $(".provider");
        var providerNames = [];
        var providers = [];
        for ( var i = 0; i < trs.length; i++) {
            var name = $(trs.get(i)).text();
            var type = $(trs.get(i)).parent().siblings(".providerType").attr(
                    "name")
            var curSetting = this.createProviderSetting(name, type);
            var spSetting = {};
            if (type == "providerSet") {
                spSetting.isSPSet = true;
                spSetting.spSetting = null;
                spSetting.spsetSetting = curSetting;
            } else {
                spSetting.isSPSet = false;
                spSetting.spSetting = curSetting;
                spSetting.spsetSetting = null;
            }
            providers.push(spSetting);
            providerNames.push(name);
        }
        setting.providers = providers;
        setting.providerNames = providerNames.join(",");
        setting.component.scSetting.providers = setting.providerNames;
    }
    this.createProviderSetting = function(name, type) {
    	var entry = this.getProviderSetting(name);
    	// entry可能为空
    	if (!entry) {
    		return false;
    	}
        entry.name = name;
    	if (!isValidName(entry.name)) {
            SuperMapServer.Dialog
                    .alert(providerRes.createProviderSettingAlert1);
            return null;
        }
        entry.enabled = true;
        // 如果是聚合服务提供者，需要设置innerProviders
        if (typeToDisplayMapping[type] == providerRes.providerTypeAggMap
                || typeToDisplayMapping[type] == providerRes.providerTypeAggData) {
            entry.innerProviders = this.getDependProvider();
        }
        if (entry.config == null) {
            entry.config = {};
        }
        // 为配置类中的属性赋值
        if (!isCustomType(type)) {
            entry.type = type;
            if (!constructConfig(type, entry.config, "", "#" + name + " ",
                    false)) {
                return false;
            }
        } else {
            var jsonText = $("#config").val();
            try {
                entry.config = JSON.parse(jsonText);
            } catch (e) {
                SuperMapServer.Dialog.alert(providerRes.configAlert);
                return false;
            }
            entry.type = chType;
        }
        if (entry.config == null) {
            entry.config = {};
        }
        return entry;
    };
    
   this.getProviderSetting = function(name){
        var beforSetting;
        for ( var i = 0; i < curProviderSettings.length; i++) {
            var providerSetting = curProviderSettings.get(i);
            if (providerSetting.isSPSet) {
                if (providerSetting.spsetSetting.name == name) {
                    // 不支持对providerSet的配置进行修改
                    beforSetting = providerSetting;
                    return beforSetting;
                }
            }
            if (providerSetting.name == name) {
                beforSetting = providerSetting;
                break;
            }
        }
        return beforSetting;
    }
    
    this.addProviderSetDiv = function(providerSetting) {
        var name = providerSetting.spsetSetting.name;
        var $providerDiv = $("#providerDiv");
        var $childDiv = $("<div></div>");
        $childDiv.attr("id", name);
        var url = getRootUrl() + "providerSets/" + name;
        $childDiv.append("<span><a class='provider' href='" + url + "'>" + name
                + "</a></span><span class='providerType' name='providerSet'>("
                + spsAndspsetsRes.spsetTypeName + ")</span>");
        $providerDiv.append($childDiv);
        $("#bindProvider").remove();
    }
    this.addProviderDiv = function(name, type, config, innerProviders) {
        var $providerDiv = $("#providerDiv");
        var $childDiv = $("<div></div>");
        $childDiv.attr("id", name);
        $childDiv
                .append("<div><h3 style='width:80%;display:inline' id='provider_"
                        + name
                        + "'><small style='color:#333' class='provider'>"
                        + name
                        + "</small></h3><span class='providerType' name='"
                        + type
                        + "'>("
                        + enToZh(type)
                        + ")</span><a class='removeProviderA' style='float:right' id='removeProviderA_"
                        + name + "'>" + ServiceManagerRes.remove + "</a></div>");
        if (convertProviderTypeToLocalDisplay(type) == providerRes.providerTypeAggMap
                || convertProviderTypeToLocalDisplay(type) == providerRes.providerTypeAggData) {
            $childDiv
                    .append("<div id='dependProviders' name='dependProviders'><label>"
                            + ServiceManagerRes.providerNamesList
                            + "</label><div style='margin-top:10px;'>"
                            + "<table id='usedProviders' class='dataTable' style='clear:none;width:760px;'><thead><tr><th width='330px' class='text-left'>"
                            + ServiceManagerRes.choosingProviders
                            + "</th><th width='100px'></th>"
                            + "<th width='330px' class='text-left'>"
                            + ServiceManagerRes.choosenProviders
                            + "</th></tr></thead><tbody><td><select name='unSelectedProviders' id='unSelectedProviders' size=10 multiple='true' style='width:100%'></select></td>"
                            + "<td class='text-center' style='padding:0;'><button id='addSingle'  class='btn btn-sm' >"
                            + ServiceManagerRes.add
                            + "<i class='glyphicon glyphicon-chevron-right glyphicon glyphicon-blank' style='margin-left:5px;'></i></button><br><br>"
                            + "<button id='removeSingle' class='btn btn-sm' ><i class='glyphicon glyphicon-chevron-left glyphicon glyphicon-blank' style='margin-right:5px;'></i>"
                            + ServiceManagerRes.remove
                            + "</button><br><br>"
                            + "<td><select name='selectedProviders' id='selectedProviders' size=10 multiple='true' style='width:100%'></select></td></tbody></table></div></div>");
        }
        $childDiv
                .append("<div class='configSettings' id='configSettings_"
                        + name
                        + "'><div class='generalSetting' >"
                        + "<div style='font-family: "
                        + providerRes.microsoftBlack
                        + ";font-size: 102%;font-weight: bold;padding: 5px;position: relative;'>"

                        + "</div>"
                        + "</div>"
                        + "<div class='advancedSettingAndHeader' style='padding-left: 5px;  margin-top: 5px;'>"
                        + "<div style='font-family:"
                        + providerRes.microsoftBlack
                        + ";font-size: 102%;padding: 10px 0pt 0pt 10px;'>"
                        + providerRes.advanceSetting
                        + "<a id='advancedSettingA_"
                        + name
                        + "' ><img style='padding-left: 5px;border-style: none;' src='"
                        + getRootUrl()
                        + "static/img/downArrowhead.png'/></a>"
                        + "</div>"
                        + "<div class='advancedSetting' style=' margin-top: 10px;'></div>"
                        + "</div></div></br>");

        $providerDiv.append($childDiv);
        $("#addSingle").bind("click", function() {
            moveSelectedItem("unSelectedProviders", "selectedProviders");
        });
        $("#removeSingle").bind("click", function() {
            moveSelectedItem("selectedProviders", "unSelectedProviders");
        });
        $(".advancedSettingAndHeader #advancedSettingA_" + name).bind("click",function() {
        	serviceProvidersUtilty.toggleImg(name);
        });
        $('.removeProviderA').click(function() {
        	var todo = this.id.replace("removeProviderA_", "");
        	SuperMapServer.Dialog.confirm(null,
        			ServiceManagerRes.sureRemoveProvider, function() {
        				$("#providerDiv #" + todo).empty();})
        });
        if (!isCustomType(type)) {
            var type = type;
            // GeometryService服务提供者没有参数，就一个名字
            if(type != "com.supermap.services.providers.UGCGeometryProvider") {
                this.updateConfigContent(type, config, name);
            }
            // 如果某个provider的设置没有高级设置,则不显示高级设置
            if ($('#configSettings_' + name + ' .advancedSetting').children().length == 0) {
                $('#configSettings_' + name + ' .advancedSettingAndHeader')
                        .empty();
            } else {
                $('#configSettings_' + name + ' .advancedSetting').hide();
            }
            // 由于地址匹配服务提供者的高级设置写在了ftl模板中，所以地址匹配服务提供者不需要原有的动态生成的高级设置，隐藏之
            if("com.supermap.services.providers.UGCAddressMatchProvider" === type) {
                $('[class=advancedSettingAndHeader]').hide();
            }
        } else {
            $("#providerType_" + name).text(type);
            var inputHtml = "<textarea cols='70' rows='20' style='padding-left:10px;' id='config'>"
                    + toJSON(providerSetting["spSetting"].config)
                    + "</textarea>";
            $("#" + name).append(
                    "<div class='parameter'>" + inputHtml + "</div>");
        }
        // 写入服务提供者依赖的服务提供者
        this.writeProviders(name,type,innerProviders);
    }
    
    this.toggleImg = function(name){
        var advancedSetting = $("#configSettings_" + name+ " .advancedSetting");
        advancedSetting.toggle(function() {
                    var hidden = advancedSetting
                            .is(":hidden");
                    if (hidden) {
                        $('.configSettings .advancedSettingAndHeader #advancedSettingA_'
                                        + name).children()
                                .get(0).src = getRootUrl()
                                + "static/img/downArrowhead.png";
                    } else {
                        $('.configSettings .advancedSettingAndHeader #advancedSettingA_'+ name).children()
                                .get(0).src = getRootUrl()+ "static/img/upArrowhead.png";
                    }
                });
    }
    
    this.writeProviders = function(name,type,innerProviders){
        if (innerProviders
                && (convertProviderTypeToLocalDisplay(type) == providerRes.providerTypeAggMap || convertProviderTypeToLocalDisplay(type) == providerRes.providerTypeAggData)) {
            var innerProviders = innerProviders;
            if (innerProviders != null) {
                for ( var i = 0; i < innerProviders.length; i++) {
                    var newOption = new Option(innerProviders[i],
                            innerProviders[i]);
                    newOption.title = innerProviders[i];
                    $("#selectedProviders")[0].options.add(newOption);
                }
            }
            var msg2 = allProviders;
            var allNames = [];
        
            for ( var j = 0;convertProviderTypeToLocalDisplay(type) == providerRes.providerTypeAggData && j < msg2.length; j++) {
                if (!isCustomType(msg2[j].type)) {
                    var dependProviderType = enToZh(msg2[j].type);
                    if (dependProviderType == providerRes.providerTypeLocalData
                            || dependProviderType == providerRes.providerTypeWFS)
                        allNames.push(msg2[j].name);
                }
            }
            if (convertProviderTypeToLocalDisplay(type) == providerRes.providerTypeAggMap) {
                for ( var j = 0; j < msg2.length; j++) {
                    if (!msg2[i].isSPSet && !isCustomType(msg2[j].type)) {
                        var dependProviderType = enToZh(msg2[j].type);
                        if ($.inArray(dependProviderType, MapProviders) >= 0)
                            allNames.push(msg2[j].name);
                    }
                }
            }

            var namesNotInSet = this.findProviderNotDepend(allNames,
                    innerProviders, name);
            if (namesNotInSet != null) {
                for ( var i = 0; i < namesNotInSet.length; i++) {
                    var newOption = new Option(namesNotInSet[i],
                            namesNotInSet[i]);
                    newOption.title = namesNotInSet[i];
                    $("#unSelectedProviders")[0].options.add(newOption);
                }
            }
        }
    }
    
    // 用来获得在Provider中依赖的Provider名称列表
    this.getDependProvider = function() {
        var trs = $("#selectedProviders");
        var names = [];
        for ( var i = 0; i < trs[0].options.length; i++) {
            var name = trs[0].options[i].value;
            names.push(name);
        }
        return names;
    }
    // 用来获得不在Provider中依赖的Provider名称列表
    this.findProviderNotDepend = function(allNames, namesInSet, curName) {
        var namesNotInSet = [];
        for ( var i = 0; i < allNames.length; i++) {
            var exist = false;		
            for ( var j = 0;namesInSet && namesInSet.length > 0 && j < namesInSet.length; j++) {
                if (allNames[i] == namesInSet[j]) {
                    exist = true;
                }
            }			
            if (!exist && allNames[i] != curName) {
                namesNotInSet.push(allNames[i]);
            }
        }
        return namesNotInSet;
    }
    this.getLastProviderSubnav = function(navid) {
        if ($("#" + navid).next().hasClass("subnav")) {
            return this.getLastProviderSubnav($("#" + navid).next().attr("id"));
        } else {
            return navid;
        }
    }
    // 根据选择的objType的中文名称来更新对话框中的配置项
    var modul;
    var curWorkspaceString;
    this.updateConfigContent = function(objType, msg, name) {
        var container = "#" + name + " ";
        modul = addConfigHtml(objType, msg, container, "", {
            containCachaConfig : false,
            objName : name
        });
        // 这一步是为了使provider得编辑页面更易用，将文本框变为下拉框
        if (convertProviderTypeToLocalDisplay(objType) == providerRes.providerTypeLocalData) {
            var requestUrl;
            if((msg.workspacePath == null || msg.workspacePath == undefined) && msg.datasourceInfos != null){
            	var datasourceInfoConn = getDatasourceInfoConnectString(container);
				if(datasourceInfoConn == null ) {
					return;
				}
				curWorkspaceString =JSON.stringify(datasourceInfoConn);
            	requestUrl = workspaceToolUrl + "?datasourceInfos="
            	+ encodeURIComponent(curWorkspaceString)
            	+ "&expected=datasources"
            	+ "&isMultiInstance=" + $(container +"#isMultiInstance").prop("checked");
            }else{
            	var tmpWorkspaceString = getWorkspaceConnectString(container);
            	if (tmpWorkspaceString == null) {
                    return;
                }
            	curWorkspaceString = tmpWorkspaceString;
            	requestUrl = workspaceToolUrl + "?workspacePath="
            	+ encodeURIComponent(curWorkspaceString)
            	+ "&expected=datasources"
            	+ "&isMultiInstance=" + $(container +"#isMultiInstance").prop("checked");
            }
            var datasourceNames;
            $.ajax({
                type : "GET",
                url : requestUrl,
                async : false,
                dataType : "json",
                success : function(msg) {
                    datasourceNames = msg;
                }
            })
            this.overwriteDatasourceNamesSetting("datasourceNamesnewButton",
                    datasourceNames, container,msg);
        }

        if (convertProviderTypeToLocalDisplay(objType) == providerRes.providerTypeTransportation) {
            // 下面这段代码是为了给从providerSetting中读取出来的权值字段信息由文本框向下拉列表的转换
            var tmpWorkspaceString = getWorkspaceConnectString(container);
            if (tmpWorkspaceString == null) {
                return;
            }
            curWorkspaceString = tmpWorkspaceString;
            // 转换数据源
            this.overwriteDatasourceNamesSetting("datasourceName",
                    msg.datasourceName, container);
            // 转换数据集
            this.overwriteNetworkDatasetNameSetting(msg.datasetName, container);
            // 检查网络数据集
            this.overwriteNetworkCheckSetting(msg.autoCheckNetwork, container);
            // 网路分析基本参数的转换
            this.overwriteNetworkFieldsSettings(msg.edgeIDField,
                    msg.edgeNameField, msg.nodeIDField, msg.nodeNameField,
                    msg.fromNodeIDField, msg.toNodeIDField, container);
            // 权值信息字段的处理(写完html就立刻转换成下拉列表)

            var datasourceName = $(container + "#datasourceName").val();
            var datasetName = $(container + "#datasetName").val();
            var requestUrl = workspaceToolUrl + "?workspacePath="
                    + encodeURIComponent(curWorkspaceString)
                    + "&datasourceName=" + encodeURIComponent(datasourceName)
                    + "&datasetName=" + encodeURIComponent(datasetName)
                    + "&expected=fields"
                    + "&isMultiInstance=" + $(container +"#isMultiInstance").prop("checked");
            var fieldNames;
            $.ajax({
                type : "GET",
                url : requestUrl,
                async : false,
                dataType : "json",
                success : function(msg) {
                    fieldNames = msg;
                }
            })

            var inputs = $(container + ".WeightFieldInfo input");
            for ( var i = 0; i < inputs.length; i++) {
                var idValue = $(inputs[i]).attr("id");
                var eachValue = idValue.substring(idValue.indexOf("_") + 1);
                var oldValue = $(inputs[i]).val().toUpperCase();
                // 给"逆向权值字段名称"字段赋值
                if (eachValue == "backWeightField") {
                    var newItemHtml = "<select id='" + idValue
                            + "' class='col-md-4'>";

                        for ( var j = 0;fieldNames != undefined && fieldNames.length > 0 && j < fieldNames.length; j++) {
                            var tmpOption = "<option value='" + fieldNames[j]
                                    + "'>" + fieldNames[j] + "</option>";
                            newItemHtml += tmpOption;
                        }
                    
                    newItemHtml += "</select>";
                    this.replaceContent(container + "#" + idValue, newItemHtml);
                    // $("#"+idValue).val(oldValue);
                    valSelect(idValue, oldValue, container);
                } else if (eachValue == "forwardWeightField") {
                    // 给"正向权值字段名称"字段赋值
                    var newItemHtml = "<select id='" + idValue
                            + "' class='col-md-4'>";
                    
                        for ( var j = 0;fieldNames != undefined && fieldNames.length > 0&& j < fieldNames.length; j++) {
                            var tmpOption = "<option value='" + fieldNames[j]
                                    + "'>" + fieldNames[j] + "</option>";
                            newItemHtml += tmpOption;
                        }
                    
                    newItemHtml += "</select>";
                    this.replaceContent(container + "#" + idValue, newItemHtml);
                    // $("#"+idValue).val(oldValue);
                    valSelect(idValue, oldValue, container);
                }
            }
            // 权值字段信息的处理end
            $(container + "#datasourceName").change(
                    function() {
                        this.overwriteNetworkDatasetNameSetting("", container);
                        this.overwriteNetworkFieldsSettings(undefined,
                                undefined, undefined, undefined, undefined,
                                undefined, container);
                        $(container + "#datasetName").change(
                                function() {
                                    overwriteNetworkFieldsSettings(undefined,
                                            undefined, undefined, undefined,
                                            undefined, undefined, container);
                                });
                    });
            // 检查网络数据集处理
            $(container + "#autoCheckNetwork").change(function() {
                if ($(container + "#autoCheckNetwork").prop("checked")) {
                    $(container + "#checkButton").hide();
                } else {
                    $(container + "#checkButton").show();
                }
            });
            $(container + "#checkButton")
                    .click(
                            function() {
                            	var info = {"isStreamingService":false,"interfaceTypes":"com.supermap.services.rest.JaxrsServletForJersey,com.supermap.services.wps.WPSServlet","isSet":false,"instances":[{"interfaceType":"com.supermap.services.wps.WPSServlet","componentType":"com.supermap.services.components.impl.SpatialAnalystImpl","name":"spatialanalyst-changchun/wps100","componentSetName":null,"authorizeSetting":{"permittedRoles":[],"deniedRoles":[],"type":"PUBLIC"},"id":null,"componentName":"spatialanalyst-changchun","interfaceName":"wps100","enabled":true,"status":"OK"},{"interfaceType":"com.supermap.services.rest.JaxrsServletForJersey","componentType":"com.supermap.services.components.impl.SpatialAnalystImpl","name":"spatialanalyst-changchun/restjsr","componentSetName":null,"authorizeSetting":{"permittedRoles":[],"deniedRoles":[],"type":"PUBLIC"},"id":null,"componentName":"spatialanalyst-changchun","interfaceName":"restjsr","enabled":true,"status":"OK"}],"isClusterService":false,"type":"com.supermap.services.components.impl.SpatialAnalystImpl","interfaceNames":"restjsr,wps100","clusterInterfaceNames":"","isDataflowService":false,"component":{"isScSet":false,"scSetSetting":null,"scSetting":{"disabledInterfaceNames":"","initPriority":0,"instanceCount":0,"name":"spatialanalyst-changchun","alias":"","interfaceNames":"restjsr,wps100","type":"com.supermap.services.components.impl.SpatialAnalystImpl","config":null,"providers":"ugcSpatialProvider-Changchun","enabled":false}},"providerNames":"ugcSpatialProvider-Changchun","name":"spatialanalyst-changchun","alias":"","isDistributedanalystService":false,"providers":[{"spsetSetting":null,"isSPSet":false,"spSetting":{"name":"ugcSpatialProvider-Changchun","alias":null,"innerProviders":null,"type":"com.supermap.services.providers.UGCSpatialAnalystProvider","config":{"workspacePath":"../../samples/data/NetworkAnalyst/Changchun.sxwu","tmpDatasourceName":null,"multiInstance":false,"datasourceInfos":null,"datasourceNames":null},"enabled":false}}]};
                            	var	name = info.providerNames;
                            	var	type;
                            	if( info.providers && info.providers.length>0 && info.providers[0].spSetting){
                            			type = info.providers[0].spSetting.type;
                            	}
                            	var entry = serviceProvidersUtilty.createProviderSetting(name,type);
                            	if (!entry) {
                            		return;
                            	}
                            	$(container + "#checkNetworkImg").css(
                                        "display", "inline");
                                var url = getRootUrl()
                                        + "workspaceTool/checkNetwork.rjson";
                                var response = sendRequestWithResponse("POST",
                                        url, entry.config);
                                if (response == null) {
                                    SuperMapServer.Dialog
                                            .alert(providerRes.checkNetworkFailed
                                                    + providerRes.illegalSetting);
                                } else {
                                    if (response.succeed) {
                                        SuperMapServer.Dialog
                                                .alert(providerRes.checkNetworkSucceed);
                                    } else {
                                        SuperMapServer.Dialog
                                                .alert(providerRes.checkNetworkFailed
                                                        + response.errorMessages
                                                                .toString());
                                    }
                                }
                                $(container + "#checkNetworkImg").css(
                                        "display", "none");
                            });
            // 点击事件的响应
            $(container + ".fillWeightInfo")
                    .click(
                            function() {
                                var inputs = $(container
                                        + ".WeightFieldInfo input");
                                for ( var i = 0; i < inputs.length; i++) {
                                    var idValue = $(inputs[i]).attr("id");
                                    var eachValue = idValue.substring(idValue
                                            .indexOf("_") + 1);
                                    // 给"逆向权值字段名称"字段赋值
                                    if (eachValue == "backWeightField") {
                                        var newItemHtml = "<select id='"
                                                + idValue
                                                + "' class='col-md-4'>";
                                        
                                            for ( var j = 0; fieldNames != undefined&& fieldNames.length > 0&&j < fieldNames.length; j++) {
                                                var tmpOption = "<option value='"
                                                        + fieldNames[j]
                                                        + "'>"
                                                        + fieldNames[j]
                                                        + "</option>";
                                                newItemHtml += tmpOption;
                                            }
                                        
                                        newItemHtml += "</select>"
                                        serviceProvidersUtilty.replaceContent(
                                                container + "#" + idValue,
                                                newItemHtml);
                                        // $("#"+idValue).val("SMLENGTH");
                                        valSelect(idValue, "SMLENGTH",
                                                container);
                                    } else if (eachValue == "forwardWeightField") {
                                        // 给"正向权值字段名称"字段赋值
                                        var newItemHtml = "<select id='"
                                                + idValue
                                                + "' class='col-md-4'>";
                                        if (fieldNames != undefined&& fieldNames.length > 0) {
                                            for ( var j = 0;fieldNames != undefined && fieldNames.length > 0 && j < fieldNames.length; j++) {
                                                var tmpOption = "<option value='"
                                                        + fieldNames[j]
                                                        + "'>"
                                                        + fieldNames[j]
                                                        + "</option>";
                                                newItemHtml += tmpOption;
                                            }
                                        }
                                        newItemHtml += "</select>";
                                        serviceProvidersUtilty.replaceContent(
                                                container + "#" + idValue,
                                                newItemHtml);
                                        // $("#"+idValue).val("SMLENGTH");
                                        valSelect(idValue, "SMLENGTH",
                                                container);
                                    }
                                }

                            });
            // 高级部分设置
            // 交通规则
            var ruleFieldOldValue = $(container + "#TARuleConfig_ruleField")
                    .val().toUpperCase();
            this.replaceFieldSetting("TARuleConfig_ruleField", fieldNames,
                    container);
            // $("#TARuleConfig_ruleField").val(ruleFieldOldValue);
            valSelect("TARuleConfig_ruleField", ruleFieldOldValue, container);
            // 转向表数据集
            var turnDatasetInfo_datasourceName = $(
                    container + "#turnDatasetInfo_datasourceName").val();
            this.overwriteDatasourceNamesSetting(
                    "turnDatasetInfo_datasourceName",
                    turnDatasetInfo_datasourceName, container);
            this.overwriteNetworkDatasetNameSettingWithDatasource(
                    "turnDatasetInfo_datasourceName",
                    "turnDatasetInfo_datasetName", container);
            this.overwriteTurnDatasetFieldsSettings(container);
            $(container + "#turnDatasetInfo_datasourceName").change(
                    function() {
                        this.overwriteNetworkDatasetNameSettingWithDatasource(
                                "turnDatasetInfo_datasourceName",
                                "turnDatasetInfo_datasetName", container);
                        this.overwriteTurnDatasetFieldsSettings(container);
                    });
            $(container + "#turnDatasetInfo_datasetName").change(function() {
                serviceProvidersUtilty.overwriteTurnDatasetFieldsSettings(container);
            });
            if (msg.ruleField && msg.ruleField.length > 0) {
                $(container + ".advancedSetting #TARuleConfig-isFilled")[0].checked = "checked";
            }
            if (msg.turnDatasetInfo && msg.turnDatasetInfo.datasetName
                    && msg.turnDatasetInfo.datasetName.length > 0) {
                $(container + ".advancedSetting #turnDatasetInfo-isFilled")[0].checked = "checked";
            } else {
                msg.turnDatasetInfo = null;
            }
            if ((msg.barrierEdges && msg.barrierEdges.length > 0)
                    || (msg.barrierNodes && msg.barrierNodes.length > 0)) {
                $(container + ".advancedSetting #TABarrierConfig-isFilled")[0].checked = "checked";
            }
        }

        if (convertProviderTypeToLocalDisplay(objType) == providerRes.providerTypeTrafficTransfer) {
            var tmpWorkspaceString = getWorkspaceConnectString(container);
            if (tmpWorkspaceString == null) {
                return;
            }
            // 工作空间连接串中如果有"=",替换成"$eq;"
            curWorkspaceString = tmpWorkspaceString;
            var requestUrl = workspaceToolUrl + "?workspacePath="
                    + encodeURIComponent(curWorkspaceString)
                    + "&expected=datasources"
                    + "&isMultiInstance=" + $(container +"#isMultiInstance").prop("checked");
            var datasourceNames;
            $.ajax({
                type : "GET",
                url : requestUrl,
                async : false,
                dataType : "json",
                success : function(msg) {
                    datasourceNames = msg;
                }
            })

            $(container + "#transferLineSettings").click(function() {
                this.overwriteTransferLineSettings(container);
            });
            $("#transferStopSettings").click(function() {
                this.overwriteTransferStopSettings(container);
            });
            $("#transferRelationSettings").click(function() {
                this.overwriteTransferRelationSettings(container);
            });

            this.overwriteTransferLineSettings(container);
            this.overwriteTransferStopSettings(container);
            this.overwriteTransferRelationSettings(container);
            this.overwriteTransferNetWorkSettings(container);
            this.overwriteTransferpathDatasetsSettings(container);
        }
        if (convertProviderTypeToLocalDisplay(objType) == providerRes.providerTypeSpatialAnalyst) {
            var tmpWorkspaceString = getWorkspaceConnectString(container);
            if (tmpWorkspaceString == null) {
                return;
            }
            curWorkspaceString = tmpWorkspaceString;
            var requestUrl = workspaceToolUrl + "?workspacePath="
                    + encodeURIComponent(curWorkspaceString)
                    + "&expected=datasources"
                    + "&isMultiInstance=" + $(container +"#isMultiInstance").prop("checked");
            var datasourceNames;
            $.ajax({
                type : "GET",
                url : requestUrl,
                async : false,
                dataType : "json",
                success : function(msg) {
                    datasourceNames = msg;
                }
            })
            this.overwriteDatasourceNamesSetting("datasourceNamesnewButton",
                    datasourceNames, container);
        }
        if (convertProviderTypeToLocalDisplay(objType) == providerRes.providerTypeGeopkgMap) {
            $(container + "#epsgCode")
                    .focus(
                            function() {
                                var filePath = $
                                        .trim($(container + "#filePath").val());
                                var Url = getRootUrl()
                                        + "geopackageinfo.rjson?expected=prjcoordsys&filePath="
                                        + filePath;
                                var prjs = sendRequestWithResponse("GET", Url,
                                        null);
                                for ( var i = 0; i < prjs.length; i++) {
                                    $(container + "#epsgCode").append(
                                            "<option value='" + prjs[i] + "'>"
                                                    + prjs[i] + "</option>");
                                }
                            });
        }
        if(convertProviderTypeToLocalDisplay(objType)  == providerRes.providerTypeAddressMatchProvider){
            serviceProvidersUtilty.overwriteConfigItems(objType, container);
        }
        if (this.isNeedAutoSetting(objType)) {
            if(objType != "com.supermap.services.providers.UGCTrafficTransferAnalystProvider") {
                var autoSettingHtml = "<div class='parameter'><a id='computerLink'>"
                    + providerRes.autoComputFromWorkspace
                    + "</a><span id='verifyInfo' style='padding-left: 50px; width: 90%'></span></div><div style='clear:both;'/>";
            $(container + "#sqlWorkspace").parent().after(autoSettingHtml);
            }
            $(container + '.parameter #computerLink').click(
                    function() {
                        if(convertProviderTypeToLocalDisplay(objType)  == providerRes.providerTypeAddressMatchProvider){
                            var tmpWorkspaceString = getWorkspaceConnectString(container);
                            if(tmpWorkspaceString != null){
                                setDefaultAddressMatchIndex(container, curWorkspaceString);
                            }
                        }
                        serviceProvidersUtilty.overwriteConfigItems(objType,
                                container);
                    });
        }
    }
    this.getProviderNamesInComponent = function() {
        var trs = $(".provider");
        var names = [];
        for ( var i = 0; i < trs.length; i++) {
            var name = $(trs.get(i)).text();
            names.push(name);
        }
        return names;
    }

    this.isNeedAutoSetting = function(providerTypeChName) {
        var providerFlag=providerTypeChName == "com.supermap.services.providers.UGCDataProvider"
                || providerTypeChName == "com.supermap.services.providers.UGCTransportationAnalystProvider"
                || providerTypeChName == "com.supermap.services.providers.UGCSpatialAnalystProvider";
        providerFlag = providerFlag || providerTypeChName == "com.supermap.services.providers.UGCAddressMatchProvider";
        if (providerFlag
                || providerTypeChName == "com.supermap.services.providers.UGCNetworkAnalyst3DProvider"
                || providerTypeChName == "com.supermap.services.providers.UGCTrafficTransferAnalystProvider") {
            return true;
        } else {
            return false;
        }
    }

    this.overwriteConfigItems = function(providerTypeChName, container) {
        var tmpWorkspaceString = getWorkspaceConnectString(container);
        if (tmpWorkspaceString == null) {
            return;
        }
        curWorkspaceString = tmpWorkspaceString;
        var displayName = convertProviderTypeToLocalDisplay(providerTypeChName);// 其实我不明白为啥一定要转成界面显示的文字再比较，直接比较"com.supermap.services.provider.****"不更好嘛。
        if (displayName == providerRes.providerTypeLocalData) {
            this.overwriteDatasourceNamesSetting("datasourceNamesnewButton",
                    "", container);
        } else if (displayName == providerRes.providerTypeTransportation) {
        	this.overwriteTransportationConfigItems(container);
        } else if (displayName == providerRes.providerTypeSpatialAnalyst) {
            this.overwriteDatasourceNamesSetting("datasourceNamesnewButton",
                    "", container);
        } else if (displayName == providersRes.providerTypeUGCNetworkAnalyst3DProvider) {
            new SuperMapServer.Manager.NetWork3DUIAssistant(
                    getWorkspaceConnectString(container), container).updateUI();
        } else if (displayName == providersRes.providerTypeAddressMatchProvider) {
        	this.overwriteAddressMatchProviderConfigItems(container,curWorkspaceString);
        } else{
            this.overwriteTransferLineSettings(container);
            this.overwriteTransferStopSettings(container);
            this.overwriteTransferRelationSettings(container);
        }
    }
    
    this.overwriteTransportationConfigItems = function(container){
        this.overwriteDatasourceNamesSetting("datasourceName", "",
                container);
        this.overwriteNetworkDatasetNameSetting("", container);
        this.overwriteNetworkFieldsSettings(undefined, undefined,
                undefined, undefined, undefined, undefined, container);
        $("#datasourceName").change(
                function() {
                    this.overwriteNetworkDatasetNameSetting("", container);
                    this.overwriteNetworkFieldsSettings(undefined,
                            undefined, undefined, undefined, undefined,
                            undefined, container);
                    $("#datasetName").change(
                            function() {
                                this.overwriteNetworkFieldsSettings(
                                        undefined, undefined, undefined,
                                        undefined, undefined, undefined,
                                        container);
                            });
                });
    }
    
    this.overwriteAddressMatchProviderConfigItems = function (container,curWorkspaceString){
        var providerName = $(container).prop("id");
        var datasetNamesBySelected = "";
        var datasourceNameBySelected = "";
        var searchFieldsBySelected = "";
        var filterFieldsNamesBySelected = "";
        for(var i = 0; i < curProviderSettings.length; i++) {
            if(providerName === curProviderSettings[i].name){
                datasourceNameBySelected = curProviderSettings[i].config.datasourceName;
                if(curProviderSettings[i].config.datasetNames){
                    datasetNamesBySelected = curProviderSettings[i].config.datasetNames.split(",");
                }
                if(curProviderSettings[i].config.searchFields) {
                    searchFieldsBySelected = curProviderSettings[i].config.searchFields.split(",");
                }
                if(curProviderSettings[i].config.filterFields) {
                    filterFieldsNamesBySelected = curProviderSettings[i].config.filterFields.split(",");
                }
            }
        }
        overwriteAddressMatchDatasourceNames(container, curWorkspaceString, datasourceNameBySelected);
        overwriteAddressMatchDatasetNames(container, curWorkspaceString, datasetNamesBySelected, searchFieldsBySelected, filterFieldsNamesBySelected);
    }
    // 数据源从文本框到下拉列表的转换
    this.overwriteDatasourceNamesSetting = function(datasourceNamesSettingId,
            datasourceName, container,msg) {
        if (!container) {
            container = "";
        } else {
            container += " ";
        }
        var requestUrl;
        if(msg != null || msg != undefined){
        	if((msg.workspacePath == null || msg.workspacePath == undefined) &&  msg.datasourceInfos != null){
        		requestUrl = workspaceToolUrl + "?datasourceInfos="
        		+ encodeURIComponent(curWorkspaceString)
        		+ "&expected=datasources"
        		+ "&isMultiInstance=" + $(container +"#isMultiInstance").prop("checked");
        	}else{
        		requestUrl = workspaceToolUrl + "?workspacePath="
            	+ encodeURIComponent(curWorkspaceString)
            	+ "&expected=datasources"
            	+ "&isMultiInstance=" + $(container +"#isMultiInstance").prop("checked");
        	}
        }else{
        	requestUrl = workspaceToolUrl + "?workspacePath="
        	+ encodeURIComponent(curWorkspaceString)
        	+ "&expected=datasources"
        	+ "&isMultiInstance=" + $(container +"#isMultiInstance").prop("checked");
        }
        var datasourceNames;
        $.ajax({
            type : "GET",
            url : requestUrl,
            async : false,
            dataType : "json",
            success : function(msg) {
                datasourceNames = msg;
            }
        })
        if (!datasourceName || datasourceName.length < 0 && datasourceNames
                && datasourceNames.length > 0) {
            datasourceName = datasourceNames[0];
        }
        var newItemHtml = "<select id='" + datasourceNamesSettingId
                + "' class='col-md-4'>";
        if (datasourceNames != undefined && datasourceNames.length > 0) {
            for ( var i = 0; i < datasourceNames.length; i++) {
                var tmpOption;
                if (datasourceNames[i] == datasourceName) {
                    tmpOption = "<option selected='selected' value='"
                            + datasourceNames[i] + "'>" + datasourceNames[i]
                            + "</option>";
                } else {
                    tmpOption = "<option value='" + datasourceNames[i] + "'>"
                            + datasourceNames[i] + "</option>";
                }
                newItemHtml += tmpOption;
            }
        }
        newItemHtml += "</select>";
        this.replaceContent(container + "#" + datasourceNamesSettingId,
                newItemHtml);
    }

    this.overwriteNetworkDatasetNameSetting = function(datasetName, container) {
        if (!container) {
            container = "";
        } else {
            container += " ";
        }
        var datasourceName = $(container + "#datasourceName").val();
        var requestUrl = workspaceToolUrl + "?workspacePath="
                + encodeURIComponent(curWorkspaceString) + "&datasourceName="
                + encodeURIComponent(datasourceName)
                + "&expected=networkDatasets"
                + "&isMultiInstance=" + $(container +"#isMultiInstance").prop("checked");
        var datasetNames;
        $.ajax({
            type : "GET",
            url : requestUrl,
            async : false,
            dataType : "json",
            success : function(msg) {
                datasetNames = msg;
            }
        })
        var newItemHtml = "<select id='datasetName' class='col-md-4'>";
        if (datasetNames != undefined && datasetNames.length > 0) {
            $(container + "#verifyInfo").text("");
            for ( var i = 0; i < datasetNames.length; i++) {
                var tmpOption
                if (datasetNames[i] == datasetName) {
                    tmpOption = "<option selected='selected' value='"
                            + datasetNames[i] + "'>" + datasetNames[i]
                            + "</option>";
                } else {
                    tmpOption = "<option value='" + datasetNames[i] + "'>"
                            + datasetNames[i] + "</option>";
                }
                newItemHtml += tmpOption;
            }
        } else {
            $("#verifyInfo").css("color", "#FF0000");
            $("#verifyInfo").text(
                    providersRes.datasource + datasourceName
                            + providersRes.noNetworkDatasets);
        }
        newItemHtml += "</select>";
        this.replaceContent(container + "#datasetName", newItemHtml);
    }

    // 转向表
    this.overwriteNetworkDatasetNameSettingWithDatasource = function(
            datasourceSettingId, datasetSettingId, container) {
        if (!container) {
            container = "";
        } else {
            container += " ";
        }
        var selectedDatasetName = $(container + "#" + datasetSettingId).val();
        var datasourceName = $(container + "#" + datasourceSettingId).val();
        var requestUrl = workspaceToolUrl + "?workspacePath="
                + encodeURIComponent(curWorkspaceString) + "&datasourceName="
                + encodeURIComponent(datasourceName)
                + "&expected=tabularDatasets"
                + "&isMultiInstance=" + $(container +"#isMultiInstance").prop("checked");
        var datasetNames;
        $.ajax({
            type : "GET",
            url : requestUrl,
            async : false,
            dataType : "json",
            success : function(msg) {
                datasetNames = msg;
            }
        })
        var newItemHtml = "<select id='" + datasetSettingId
                + "' class='col-md-4'>";
        if (datasetNames != undefined && datasetNames.length > 0) {
            // $("#verifyInfo").text("");
            for ( var i = 0; i < datasetNames.length; i++) {
                if (i == 0) {
                    var tmpOption = "<option selected='selected' value='"
                            + datasetNames[i] + "'>" + datasetNames[i]
                            + "</option>";
                    newItemHtml += tmpOption;
                } else {
                    var tmpOption = "<option value='" + datasetNames[i] + "'>"
                            + datasetNames[i] + "</option>";
                    newItemHtml += tmpOption;
                }
            }
        } else {
            // $("#verifyInfo").css("color", "#FF0000");
            // $("#verifyInfo").text(providersRes.datasource + datasourceName +
            // providersRes.noNetworkDatasets);
        }
        newItemHtml += "</select>";
        this.replaceContent(container + "#" + datasetSettingId, newItemHtml);
        if (selectedDatasetName != undefined && selectedDatasetName != "") {
            // $("#" + datasetSettingId).val(selectedDatasetName);
            valSelect(datasetSettingId, selectedDatasetName, container);
        }
    }

    this.overwriteNetworkCheckSetting = function(autoCheckNetwork, container) {
        if (!container) {
            container = "";
        } else {
            container += " ";
        }
        if (autoCheckNetwork == null) {
            autoCheckNetwork = true;
        }
        var newItemHtml = "<input type='checkbox' id='autoCheckNetwork'";
        if (autoCheckNetwork) {
            newItemHtml += "checked>";
        } else {
            newItemHtml += ">";
        }
        var tmpOption = "<button id='checkButton' class='btn' style='margin-left:30px'>"
                + providerRes.checkNetworkButton
                + "</button><img style='vertical-align:text-bottom;display:none;' id='checkNetworkImg' src='http://192.168.10.244:8090/iserver/manager/static/img/running_green.gif' />";
        newItemHtml += tmpOption;
        this.replaceContent(container + "#autoCheckNetwork", newItemHtml);
        if ($(container + "#autoCheckNetwork").prop("checked")) {
            $(container + "#checkButton").hide();
        } else {
            $(container + "#checkButton").show();
        }
    }

    this.overwriteNetworkFieldsSettings = function(edgeIDField, edgeNameField,
            nodeIDField, nodeNameField, fromNodeIDField, toNodeIDField,
            container) {
        if (!container) {
            container = "";
        } else {
            container += " ";
        }
        var datasourceName = $(container + "#datasourceName").val();
        var datasetName = $(container + "#datasetName").val();
        
        var requestUrl = workspaceToolUrl + "?workspacePath="
        + encodeURIComponent(curWorkspaceString) + "&datasourceName="
        + encodeURIComponent(datasourceName) + "&datasetName="
        + encodeURIComponent(datasetName) + "&expected=fields"
        + "&isMultiInstance=" + $(container +"#isMultiInstance").prop("checked");
        
        var childRequestUrl = workspaceToolUrl + "?workspacePath="
        + encodeURIComponent(curWorkspaceString) + "&datasourceName="
        + encodeURIComponent(datasourceName) + "&datasetName="
        + encodeURIComponent(datasetName) + "&expected=fieldsOfChild"
        + "&isMultiInstance=" + $(container +"#isMultiInstance").prop("checked");
        
        var fieldNames=getFieldNames(requestUrl);
        var fieldNamesOfChild=getFieldNames(childRequestUrl);

        // 替换edgeIDField
        this.replaceFieldSetting("edgeIDField", fieldNames, container);
        if (edgeIDField != undefined) {
            // $("#edgeIDField").val(edgeIDField.toUpperCase());
            valSelect("edgeIDField", edgeIDField.toUpperCase(), container);
        } else {
            valSelect("edgeIDField", "SMEDGEID", container);
        }
        // 替换edgeNameField
        this.replaceFieldSetting("edgeNameField", fieldNames, container);
        if (edgeNameField != undefined) {
            // $("#edgeNameField").val(edgeNameField.toUpperCase());
            valSelect("edgeNameField", edgeNameField.toUpperCase(), container);
        } else {
            valSelect("edgeNameField", "SMEDGEID", container);
        }
        // 替换nodeIDField
        this.replaceFieldSetting("nodeIDField", fieldNamesOfChild, container);
        if (nodeIDField != undefined) {
            // $("#nodeIDField").val(nodeIDField.toUpperCase());
            valSelect("nodeIDField", nodeIDField.toUpperCase(), container);
        } else {
            valSelect("nodeIDField", "SMNODEID", container);
        }
        // 替换nodeNameField
        this.replaceFieldSetting("nodeNameField", fieldNamesOfChild, container);
        if (nodeNameField != undefined) {
            // $("#nodeNameField").val(nodeNameField.toUpperCase());
            valSelect("nodeNameField", nodeNameField.toUpperCase(), container);
        } else {
            valSelect("nodeNameField", "SMNODEID", container);
        }
        // 替换fromNodeIDField
        this.replaceFieldSetting("fromNodeIDField", fieldNames, container);
        if (fromNodeIDField != undefined) {
            // $("#fromNodeIDField").val(fromNodeIDField.toUpperCase());
            valSelect("fromNodeIDField", fromNodeIDField.toUpperCase(),
                    container);
        } else {
            valSelect("fromNodeIDField", "SMFNODE", container);
        }
        // 替换toNodeIDField
        this.replaceFieldSetting("toNodeIDField", fieldNames, container);
        if (toNodeIDField != undefined) {
            // $("#toNodeIDField").val(toNodeIDField.toUpperCase());
            valSelect("toNodeIDField", toNodeIDField.toUpperCase(), container);
        } else {
            valSelect("toNodeIDField", "SMTNODE", container);
        }

        // 将"权重字段"信息由文本框变成下拉列表
        this.WeightFieldChangeSelectBox(container,fieldNames);
    }
    
    function getFieldNames(requestUrl){
        var fieldNames;
        $.ajax({
            type : "GET",
            url : requestUrl,
            async : false,
            dataType : "json",
            success : function(msg) {
                fieldNames = msg;
            }
        });

        // 解决http://192.168.115.2:8090/browse/ISJ-2870
        for ( var i = 0; i < fieldNames.length; i++) {
            fieldNames[i] = fieldNames[i].toUpperCase();
        }
        return fieldNames;
    }
    
    this.WeightFieldChangeSelectBox = function (container,fieldNames){
        var inputs = $(container + ".WeightFieldInfo input");
        for ( var i = 0; i < inputs.length; i++) {
            var idValue = $(inputs[i]).attr("id");
            var eachValue = idValue.substring(idValue.indexOf("_") + 1);
            var oldValue = $(inputs[i]).val().toUpperCase();
            // 给"逆向权值字段名称"字段赋值
            if (eachValue == "backWeightField") {
                var newItemHtml = "<select id='" + idValue
                        + "' class='col-md-4'>";
                if (fieldNames != undefined && fieldNames.length > 0) {
                    for ( var j = 0; j < fieldNames.length; j++) {
                        var tmpOption = "<option value='" + fieldNames[j]
                                + "'>" + fieldNames[j] + "</option>";
                        newItemHtml += tmpOption;
                    }
                }
                newItemHtml += "</select>";
                this.replaceContent(container + "#" + idValue, newItemHtml);
                // $("#"+idValue).val(oldValue);
                valSelect(idValue, oldValue, container);
            } else if (eachValue == "forwardWeightField") {
                // 给"正向权值字段名称"字段赋值
                var newItemHtml = "<select id='" + idValue
                        + "' class='col-md-4'>"
                if (fieldNames != undefined && fieldNames.length > 0) {
                    for ( var j = 0; fieldNames != undefined && fieldNames.length > 0 && j < fieldNames.length; j++) {
                        var tmpOption = "<option value='" + fieldNames[j]
                                + "'>" + fieldNames[j] + "</option>";
                        newItemHtml += tmpOption;
                    }
                }
                newItemHtml += "</select>"
                this.replaceContent(container + "#" + idValue, newItemHtml);
                // $("#"+idValue).val(oldValue);
                valSelect(idValue, oldValue, container);
            }
        }
    }

    this.overwriteTurnDatasetFieldsSettings = function(container) {
        if (!container) {
            container = "";
        } else {
            container += " ";
        }
        var datasourceName = $(container + "#turnDatasetInfo_datasourceName")
                .val();
        var datasetName = $(container + "#turnDatasetInfo_datasetName").val();
        var requestUrl = workspaceToolUrl + "?workspacePath="
                + encodeURIComponent(curWorkspaceString) + "&datasourceName="
                + encodeURIComponent(datasourceName) + "&datasetName="
                + encodeURIComponent(datasetName) + "&expected=fields"
                + "&isMultiInstance=" + $(container +"#isMultiInstance").prop("checked");
        var fieldNames;
        $.ajax({
            type : "GET",
            url : requestUrl,
            async : false,
            dataType : "json",
            success : function(msg) {
                fieldNames = msg;
            }
        })
        var turnDatasetInfo_fromEdgeIDField = $(
                container + "#turnDatasetInfo_fromEdgeIDField").val();
        this.replaceFieldSetting("turnDatasetInfo_fromEdgeIDField", fieldNames,
                container);
        // $("#turnDatasetInfo_fromEdgeIDField").val(turnDatasetInfo_fromEdgeIDField.toUpperCase());
        valSelect("turnDatasetInfo_fromEdgeIDField",
                turnDatasetInfo_fromEdgeIDField.toUpperCase(), container);

        var turnDatasetInfo_nodeIDField = $("#turnDatasetInfo_nodeIDField")
                .val();
        this.replaceFieldSetting("turnDatasetInfo_nodeIDField", fieldNames,
                container);
        // $("#turnDatasetInfo_nodeIDField").val(turnDatasetInfo_nodeIDField.toUpperCase());
        valSelect("turnDatasetInfo_nodeIDField", turnDatasetInfo_nodeIDField
                .toUpperCase(), container);

        var turnDatasetInfo_toEdgeIDField = $("#turnDatasetInfo_toEdgeIDField")
                .val();
        this.replaceFieldSetting("turnDatasetInfo_toEdgeIDField", fieldNames,
                container);
        // $("#turnDatasetInfo_toEdgeIDField").val(turnDatasetInfo_toEdgeIDField.toUpperCase());
        valSelect("turnDatasetInfo_toEdgeIDField",
                turnDatasetInfo_toEdgeIDField.toUpperCase(), container);

        // var turnDatasetInfo_weightFieldsnewButton =
        // $("#turnDatasetInfo_weightFieldsnewButton").val();
        this.replaceFieldSetting("turnDatasetInfo_weightFieldsnewButton",
                fieldNames, container);
        // $("#turnDatasetInfo_weightFieldsnewButton").val(turnDatasetInfo_weightFieldsnewButton);
    }

    this.replaceFieldSetting = function(fieldSettingId, fieldNames, container) {
        if (!container) {
            container = "";
        } else {
            container += " ";
        }
        var newItemHtml = "<select id='" + fieldSettingId
                + "' class='col-md-4'>";
        // newItemHtml += "<option></option>";
        if (fieldNames != undefined && fieldNames.length > 0) {
            for ( var i = 0; i < fieldNames.length + 1; i++) {
                if (i == 0) {
                    var tmpOption = "<option value='" + "" + "'>" + ""
                            + "</option>";
                    newItemHtml += tmpOption;
                } else {
                    var tmpOption = "<option value='" + fieldNames[i - 1]
                            + "'>" + fieldNames[i - 1] + "</option>";
                    newItemHtml += tmpOption;
                }
            }
        }
        newItemHtml += "</select>";
        this.replaceContent(container + "#" + fieldSettingId,newItemHtml);
    }

    this.isNeedAutoSetting = function(providerTypeChName) {
        var judgeFlag=providerTypeChName == "com.supermap.services.providers.UGCDataProvider"
                || providerTypeChName == "com.supermap.services.providers.UGCTransportationAnalystProvider"
                || providerTypeChName == "com.supermap.services.providers.UGCSpatialAnalystProvider";
        judgeFlag = judgeFlag || providerTypeChName == "com.supermap.services.providers.UGCAddressMatchProvider";
        if (judgeFlag
                || providerTypeChName == "com.supermap.services.providers.UGCNetworkAnalyst3DProvider"
                || providerTypeChName == "com.supermap.services.providers.UGCTrafficTransferAnalystProvider") {
            return true;
        } else {
            return false;
        }
    }

    this.overwriteTransferLineSettings = function(container) {
        if (!container) {
            container = "";
        } else {
            container += " ";
        }
        var parameters = [ "lineIDField", "nameField", "aliasField",
                "lineTypeField", "firstTimeField", "lastTimeField",
                "intervalField" ];// "speedField"暂不支持
        var transferLineSettingLength = $(container + '#transferLineSetting').length;
        for ( var index = 0; index < transferLineSettingLength; index++) {
            var containerName = $(container + '#transferLineSetting')[index].id;
            this.overwriteTransferSetting(containerName, "lineDatasets",
                    parameters, container);
        }
    }
	this.getTransferLineSetting = function(container, parameterName){
		var providerName = $(container).prop("id");
		for(var i = 0; i < curProviderSettings.length; i++) {
			if(providerName === curProviderSettings[i].name){
				return curProviderSettings[i].config.transferLineSetting;
			}
		}
	}
	
	this.getTransferStopSetting = function(container, parameterName){
		var providerName = $(container).prop("id");
		for(var i = 0; i < curProviderSettings.length; i++) {
			if(providerName === curProviderSettings[i].name){
				return curProviderSettings[i].config.transferStopSetting;
			}
		}
	}
	
	this.getTransferRelationSetting = function(container, parameterName){
		var providerName = $(container).prop("id");
		for(var i = 0; i < curProviderSettings.length; i++) {
			if(providerName === curProviderSettings[i].name){
				return curProviderSettings[i].config.transferRelationSetting;
			}
		}
	}
	
    this.overwriteTransferStopSettings = function(container) {
        if (!container) {
            container = "";
        } else {
            container += " ";
        }
        var parameters = [ "stopIDField", "nameField", "aliasField" ];
        var transferStopSettingLength = $(container + '#transferStopSetting').length;
        for ( var index = 0; index < transferStopSettingLength; index++) {
            var containerName = $(container + '#transferStopSetting')[index].id;
            this.overwriteTransferSetting(containerName, "pointDatasets",
                    parameters, container);
        }
    }

    this.overwriteTransferNetWorkSettings = function(container) {
        if (!container) {
            container = "";
        } else {
            container += " ";
        }
        var parameters = [ "edgeIDField", "nodeIDField", "fNodeIDField",
                "tNodeIDField" ]
        var transferRelationSettingLength = $(container
                + '#transferRelationSetting').length;
        for ( var index = 0; index < transferRelationSettingLength; index++) {
            var containerName = $(container + '#transferRelationSetting')[index].id;
            this.overwriteTransferSetting(containerName, "networkDatasets",
                    parameters, container);
        }
    }

    this.overwriteTransferpathDatasetsSettings = function(container) {
        if (!container) {
            container = "";
        } else {
            container += " ";
        }
        var parameters = [ "exitIDField", "exitNameCField", "exitNamePYField",
                "stationIDField" ]
        var transferRelationSettingLength = $(container
                + '#transferRelationSetting').length;
        for ( var index = 0; index < transferRelationSettingLength; index++) {
            var containerName = $(container + '#transferRelationSetting')[index].id;
            this.overwriteTransferSetting(containerName, "pathDatasets",
                    parameters, container);
        }
    }

    this.overwriteTransferRelationSettings = function(container) {
        if (!container) {
            container = "";
        } else {
            container += " ";
        }
        var parameters = [ "lineIDField", "stopIDField", "serialNumField" ];
        var transferRelationSettingLength = $(container
                + '#transferRelationSetting').length;
        for ( var index = 0; index < transferRelationSettingLength; index++) {
            var containerName = $(container + '#transferRelationSetting')[index].id;
            this.overwriteTransferSetting(containerName, "tabularDatasets",
                    parameters, container);
        }
    }

    this.overwriteTransferSetting = function(containerName,
            expectedDatasetType, parameters, container) {
        if (!container) {
            container = "";
        } else {
            container += " ";
        }
        var datasourceName = $(
                container + "#" + containerName + "_datasourceName").val();

        this.overwriteDatasourceNamesSetting(containerName + "_datasourceName",
                datasourceName, container);
        $(container + "#" + containerName + "_datasourceName").change(
                function() {
                    updataTransferSetting_Dataset(containerName,
                            expectedDatasetType, parameters);
                });
        this.overwriteTransferSetting_Dataset(containerName,
                expectedDatasetType, parameters, container);
    }

    this.overwriteTransferSetting_Dataset = function(containerName,
            expectedDatasetType, parameters, container) {
        if (!container) {
            container = "";
        } else {
            container += " ";
        }
        var requestUrl;
        var datasourceName = $(
                container + "#" + containerName + "_datasourceName").val();
        requestUrl = workspaceToolUrl + "?workspacePath="
                + encodeURIComponent(curWorkspaceString) + "&datasourceName="
                + encodeURIComponent(datasourceName) + "&expected="
                + expectedDatasetType
                + "&isMultiInstance=" + $(container +"#isMultiInstance").prop("checked");
        var datasetNames=getDatasetNames(requestUrl);
        // 将数据集换成下拉框
        this.datasetChangeSelectBox(parameters,container,containerName,datasetNames,datasourceName);
        this.overwriteTransferSetting_Field(containerName, parameters,
                container);
    }
    
    function getDatasetNames(requestUrl){
        var datasetNames;
        $.ajax({
            type : "GET",
            url : requestUrl,
            async : false,
            dataType : "json",
            success : function(msg) {
                datasetNames = msg;
            }
        });
        return datasetNames;
    }

    this.datasetChangeSelectBox = function (parameters,container,containerName,datasetNames,datasourceName){
        var newItemHtml = null;

        if (parameters[0] == "edgeIDField") {

            var datasetNetworkName = $(
                    container + "#" + containerName + "_datasetNetworkName")
                    .val();
            newItemHtml = "<select id='" + containerName
                    + "_datasetNetworkName" + "' class='col-md-4'>";

        } else if (parameters[0] == "exitIDField") {
            var datasetPathName = $(
                    container + "#" + containerName + "_datasetPathName").val();
            newItemHtml = newItemHtml = "<select id='" + containerName
                    + "_datasetPathName" + "' class='col-md-4'>";
        } else {
            var datasetName = $(
                    container + "#" + containerName + "_datasetName").val();
            newItemHtml = newItemHtml = "<select id='" + containerName
                    + "_datasetName" + "' class='col-md-4'>";
            if (!datasetName || datasetName.length < 0 && datasetNames
                    && datasetNames.length > 0) {
                datasetName = datasetNames[0];
            }
        }
        if (datasetNames != undefined && datasetNames.length > 0) {
            $(container + "#verifyInfo").text("");
            
            var tmpOption=addSelectBoxOption(parameters,datasetNames,datasetNetworkName,datasetPathName,datasetName);
            newItemHtml += tmpOption;
        } else {
            $(container + "#verifyInfo").css("color", "#FF0000");
            $(container + "#verifyInfo").text(
                    providersRes.datasource + datasourceName
                            + providersRes.noLineDatasets);
        }
        newItemHtml += "</select>";

        if (parameters[0] == "edgeIDField") {
            this.replaceContent(container + "#" + containerName
                    + "_datasetNetworkName", newItemHtml);
            $(container + "#" + containerName + "_datasetNetworkName").change(
                    function() {
                        serviceProvidersUtilty.overwriteTransferSetting_Field(
                                containerName, parameters, container);
                    });

        } else if (parameters[0] == "exitIDField") {
            this.replaceContent(container + "#" + containerName
                    + "_datasetPathName", newItemHtml);
            $(container + "#" + containerName + "_datasetPathName").change(
                    function() {
                        serviceProvidersUtilty.overwriteTransferSetting_Field(
                                containerName, parameters, container);
                    });
        } else {

            this.replaceContent(container + "#" + containerName
                    + "_datasetName", newItemHtml);
            $(container + "#" + containerName + "_datasetName").change(
                    function() {
                        serviceProvidersUtilty.overwriteTransferSetting_Field(
                                containerName, parameters, container);
                    });
        }
    }
    
    function addSelectBoxOption(parameters,datasetNames,datasetNetworkName,datasetPathName,datasetName){
        var tmpOption;
        var tmpOptions;
        //把网络数据集变成下拉框
        
        for ( var i = 0; parameters[0] == "edgeIDField" && i <= datasetNames.length; i++) {
            if(datasetNames[i-1] == datasetNetworkName) {
                continue;
            }
            if (datasetNames[i] == datasetNetworkName) {
                tmpOption = "<option selected='selected' value='"
                        + datasetNames[i] + "'>" + datasetNames[i]
                        + "</option>";
            } else if (i == 0 && datasetNetworkName == "") {
                tmpOption = "<option selected='selected'  value='" + ""
                        + "'>" + "" + "</option>";
            } else {
                tmpOption = "<option value='" + datasetNames[i-1] + "'>"
                        + datasetNames[i-1] + "</option>";
            }
            tmpOptions += tmpOption;
        }
            //把站点与出入口的数据集变成下拉框
        
        for ( var i = 0;parameters[0] == "exitIDField"&& i <= datasetNames.length; i++) {
            if(datasetNames[i-1] == datasetPathName) {
                continue;
            }
            if (datasetNames[i] == datasetPathName) {
                tmpOption = "<option selected='selected' value='"
                        + datasetNames[i] + "'>" + datasetNames[i]
                        + "</option>";
            } else if (i == 0 && datasetPathName == "") {
                tmpOption = "<option selected='selected' value='" + ""
                        + "'>" + "" + "</option>";
            } else {
                tmpOption = "<option value='" + datasetNames[i - 1]
                        + "'>" + datasetNames[i - 1] + "</option>";

            }
            tmpOptions += tmpOption;
        }
         if(parameters[0] != "edgeIDField"&&parameters[0] != "exitIDField") {
            for ( var i = 0; i < datasetNames.length; i++) {

                if (datasetNames[i] == datasetName) {
                    tmpOption = "<option selected='selected' value='"
                            + datasetNames[i] + "'>" + datasetNames[i]
                            + "</option>";
                } else {
                    tmpOption = "<option value='" + datasetNames[i] + "'>"
                            + datasetNames[i] + "</option>";
                }
                tmpOptions += tmpOption;
            }
        }
        return tmpOptions;
    }
    
    this.overwriteTransferSetting_Field = function(containerName, parameters,
            container) {
        if (!container) {
            container = "";
        } else {
            container += " ";
        }
        var requestUrl;
        var datasetName = null;
        var datasourceName = $(
                container + "#" + containerName + "_datasourceName").val();
        if (parameters[0] == "edgeIDField") {
            datasetName = $(
                    container + "#" + containerName + "_datasetNetworkName")
                    .val();
            if(!datasetName){
                return;
            }
            requestUrl = workspaceToolUrl + "?workspacePath="
                    + encodeURIComponent(curWorkspaceString)
                    + "&datasourceName=" + encodeURIComponent(datasourceName)
                    + "&datasetName=" + encodeURIComponent(datasetName)
                    + "&expected=fieldsOfChild"
                    + "&isMultiInstance=" + $(container +"#isMultiInstance").prop("checked");
            var fieldNames1 = getFieldNames1(requestUrl);
        } else if (parameters[0] == "exitIDField") {
            datasetName = $(
                    container + "#" + containerName + "_datasetPathName").val();
        } else {
            datasetName = $(container + "#" + containerName + "_datasetName")
                    .val();
        }

        // 将字段换成下拉框
        requestUrl = workspaceToolUrl + "?workspacePath="
                + encodeURIComponent(curWorkspaceString) + "&datasourceName="
                + encodeURIComponent(datasourceName) + "&datasetName="
                + encodeURIComponent(datasetName) + "&expected=fields"
                + "&isMultiInstance=" + $(container +"#isMultiInstance").prop("checked");
        var fieldNames = getFieldNames1(requestUrl);
        this.fieldChangeSelectBox(parameters,container,containerName,fieldNames1,fieldNames);
    }
    function getFieldNames1(requestUrl){
        var fieldNames1 = [];
        $.ajax({
            type : "GET",
            url : requestUrl,
            async : false,
            dataType : "json",
            success : function(msg) {
                fieldNames1 = msg;
            }
        })
        for ( var i = 0; i < fieldNames1.length; i++) {
            fieldNames1[i] = fieldNames1[i].toUpperCase();
        }
        return fieldNames1;
    }
    
    this.fieldChangeSelectBox = function (parameters,container,containerName,fieldNames1,fieldNames){
        if (!parameters || !parameters.length || parameters.length < 1) {
            return;
        }
        for ( var index = 0; index < parameters.length; index++) {
            var paramValue = $(
                    container + "#" + containerName + "_"
                            + parameters[index]).val();
            if (parameters[index] == "nodeIDField") {
                this.replaceFieldSetting(containerName + "_"
                        + parameters[index], fieldNames1, container);
            } else {
                this.replaceFieldSetting(containerName + "_"
                        + parameters[index], fieldNames, container);
            }
            if (paramValue != undefined && paramValue != "") {
                valSelect(containerName + "_" + parameters[index], paramValue
                        .toUpperCase(), container);
            }

            if(containerName == "transferStopSetting" ) {
				var defaultSetting = this.getTransferStopSetting(container);
				if(defaultSetting[parameters[index]] == null){
					$(container + "#" + containerName + "_" +parameters[index]).val(null);
				}else {
					$(container + "#" + containerName + "_" +parameters[index]).val(defaultSetting[parameters[index]].toUpperCase());
				}
            }

            if(containerName == "transferLineSetting") {
				var defaultSetting = this.getTransferLineSetting(container);
				if(defaultSetting[parameters[index]] == null){
					 $(container + "#" + containerName + "_" +parameters[index]).val(null);
				}else {
					$(container + "#" + containerName + "_" +parameters[index]).val(defaultSetting[parameters[index]].toUpperCase());
				}
            }

            if(containerName == "transferRelationSetting") {
				var defaultSetting = this.getTransferRelationSetting(container);
				if(defaultSetting[parameters[index]] == null){
					$(container + "#" + containerName + "_" +parameters[index]).val(null);
				}else {
					valSelect(containerName + "_" +parameters[index], defaultSetting[parameters[index]].toUpperCase(), container);
					$(container + "#" + containerName + "_" +parameters[index]).val(defaultSetting[parameters[index]].toUpperCase());
				}
            }
        }
    }
    
    //用来获得不在Component中的而类型与当前组件相匹配的Provider和ProviderSet名称列表
    this.findProviderNotInComponent = function(allNames) {
        namesInSet = this.getProviderNamesInComponent();
        var namesNotInSet = [];
        for ( var i = 0; i < allNames.length; i++) {
            var exist = false;
            for ( var j = 0; j < namesInSet.length; j++) {
                if (allNames[i] == namesInSet[j]) {
                    exist = true;
                }
            }
            if (!exist) {
                namesNotInSet.push(allNames[i]);
            }
        }
        return namesNotInSet;
    };

    this.refreshProviderNameTextField = function(type) {
        switch (convertProviderTypeToLocalDisplay(type)) {
        case providersRes.providerTypeLocalData:
            $("#providerName").val("ugcDataProvider-");
            break;
        case providersRes.providerTypeLocalMap:
            $("#providerName").val("ugcMapProvider-");
            break;
        case providersRes.providerTypeLocalRealspaceProvider:
            $("#providerName").val("realspaceProvider-");
            break;
        case providersRes.providerTypePlot:
            $("#providerName").val("plotProvider-");
            break;
        case providersRes.providerTypeWMS:
            $("#providerName").val("wmsMapProvider-");
            break;
        case providersRes.providerTypeWMTS:
            $("#providerName").val("wmtsMapProvider-");
            break;
        case providersRes.providerTypeSMTiles:
            $("#providerName").val("smTilesMapProvider-");
            break;
        case providersRes.providerTypeTPK:
            $("#providerName").val("tpkMapProvider-");
            break;
        case providersRes.providerTypeArcGISREST:
            $("#providerName").val("ArcGISRESTMapProvider-");
            break;
        case providersRes.providerTypeWFS:
            $("#providerName").val("wfsDataProvider-");
            break;
        case providersRes.providerTypeAggData:
            $("#providerName").val("aggDataProvider-");
            break;
        case providersRes.providerTypeAggMap:
            $("#providerName").val("aggMapProvider-");
            break;
        case providersRes.providerTypeTransportationAnalystProvider:
            $("#providerName").val("transportationAnalystProvider-");
            break;
        case providersRes.providerTypeTrafficTransferAnalystProvider:
            $("#providerName").val("traffictransferAnalystProvider-");
            break;
        case providersRes.providerTypeSpatialAnalystProvider:
            $("#providerName").val("ugcSpatialProvider-");
            break;
        case providersRes.providerTypeRESTData:
            $("#providerName").val("restDataProvider-");
            break;
        case providersRes.providerTypeRESTMap:
            $("#providerName").val("restMapProvider-");
            break;
        case providersRes.providerTypeBingMaps:
            $("#providerName").val("bingMapsMapProvider-");
            break;
        case providersRes.providerTypeGoogleMaps:
            $("#providerName").val("googleMapsMapProvider-");
            break;
        case providersRes.providerTypeTianditu:
            $("#providerName").val("tiandituMapProvider-");
            break;
        case providersRes.providerTypeCloud:
            $("#providerName").val("supermapCloudMapProvider-");
            break;
        case providersRes.providerTypeBaidu:
            $("#providerName").val("baiduMapProvider-");
            break;
        case providersRes.providerTypeOSM:
            $("#providerName").val("openStreetMapMapProvider-");
            break;
        case providersRes.providerTypeRESTRealspaceProvider:
            $("#providerName").val("restRealspaceProvider-");
            break;
        case providersRes.providerTypeRESTSpatialAnalystProvider:
            $("#providerName").val("restSpatialAnalystProvider-");
            break;
        case providersRes.providerTypeRESTTrafficTransferAnalystProvider:
            $("#providerName").val("restTrafficTransferAnalystProvider-");
            break;
        case providerRes.providerTypeRESTTransportationAnalyst:
            $("#providerName").val("restTransportationAnalystProvider-");
            break;
        case providerRes.providerTypeRESTAddressMatch:
            $("#providerName").val("restAddressMatch-");
            break;
        case providerRes.providerTypeGDPMap:
            $("#providerName").val("gdpMapProvider-");
            break;
        case providerRes.providerTypeSVTilesMap:
            $("#providerName").val("svtilesProvider-");
            break;
        case providersRes.providerTypeUGCNetworkAnalyst3DProvider:
            $("#providerName").val("networkAnalyst3D-");
            break;
        default:
            $("#providerName").val("");
            break;
        }
    };

    // 新增WMTSMapProvider时，输入WMTS服务地址发生改变时，需要刷新每个图层对应的比例尺集
    this.configWMTSMapProviderTileMatrixSets = function() {
        $("#serviceRoot")
                .focusout(
                        function() {
                            var url = $.trim($(this).val());
                            if (wmtsUrl != null
                                    && wmtsUrl == url
                                    && $(".generalSetting .parameter[name=wmtsTileMatrixSets]").length > 0) {
                                return;
                            }
                            wmtsUrl = url;
                            $(
                                    ".generalSetting .parameter[name=wmtsTileMatrixSets]")
                                    .remove();
                            var info = getWMTSInfo(wmtsUrl, "1.0.0");
                            if (info == null) {
                                return;
                            }
                            var layers = info.layers;
                            for ( var i = 0; i < layers.length; i++) {
                                var layer = layers[i];
                                var label = layer.identifier
                                        + providerRes.tileMatrixSetLabel;
                                var id = layer.identifier;
                                var div = $("<div class='parameter' name='wmtsTileMatrixSets'></div>");
                                div.append($('<label nowrap;" for="' + id
                                        + '">' + label + '</label>'));
                                // select id代表Layer的Identifier
                                var select = $("<select class='textField' id='"
                                        + layer.identifier
                                        + "' name='wmtsTileMatrixSets' ></select>");
                                for ( var j = 0; j < layer.tileMatrixSets.length; j++) {
                                    // 每个option的value代表其比例尺集
                                    var value = layer.tileMatrixSets[j];
                                    select.append($("<option value='" + value
                                            + "'>" + layer.tileMatrixSets[j]
                                            + "</option>"));
                                }
                                div.append(select);
                                $('.generalSetting').append(div);
                            }
                        });
    };
    this.replaceContent = function(targetElement, content) {
        if ($(targetElement)[0].outerHTML == undefined) {
            $(targetElement).replaceWith(content);
        } else {
            $(targetElement)[0].outerHTML = content;
        }
    }

    this.bindEvents = function() {
        $('.removeProviderA').click(
                function() {
                    var todo = this.id.replace("removeProviderA_", "");
                    SuperMapServer.Dialog.confirm(null,
                            ServiceManagerRes.sureRemoveProvider, function() {
                                $("#providerDiv #" + todo).empty();
                            })
                });
        $('#bindProvider')
                .click(
                        function() {
                            $('#bindProviderDialog').dialog('open');
                            var type = $('#serviceType').text();
                            var match1 = getMatchProviders(type, allProviders);
                            var allNames = [];
                            for ( var i = 0; i < match1.length; i++) {
                                allNames.push(match1[i].name);
                            }

                            var namesNotInSet = serviceProvidersUtilty
                                    .findProviderNotInComponent(allNames);
                            $("#unuseProviders tbody").empty();
                            for ( var k = 0; k < namesNotInSet.length; k++) {
                                $("#unuseProviders")
                                        .append(
                                                "<tr><td>"
                                                        + namesNotInSet[k]
                                                        + "</td><td><input type='checkbox' id='"
                                                        + namesNotInSet[k]
                                                        + "' class='isUsed'/></td></tr>");
                            }
                        });
        // 添加服务提供者到组件对话框，确定后更新显示
        $('#bindProviderDialog .dialogOK').click(
                function() {
                    var checkedBox = $("#unuseProviders input:checked").filter(
                            ".isUsed");
                    for ( var i = 0; i < checkedBox.length; i++) {
                        var providerName = $(checkedBox.eq(i))[0].id;
                        var providersUrl = getRootUrl() + "providers/"
                                + providerName + ".rjson";
                        var msg = sendRequestWithResponse("GET", providersUrl,
                                null);
                        curProviderSettings.push(msg);
                        serviceProvidersUtilty.addProviderDiv(msg["name"],
                                msg["type"], msg["config"]);
                    }
                    $('#bindProviderDialog').dialog('close');
                });

        $('#bindProviderDialog .dialogCancel').click(function() {
            $('#bindProviderDialog').dialog('close');
        });
        $('#bindProviderDialog .dialogCancel').click(function() {
            $('#bindProviderDialog').dialog('close');
        });

        // 全选操作
        checkAll("#usedProviders .allSelect", "#usedProviders .isUsed");
        checkAll("#unuseProviders .allSelect", "#unuseProviders .isUsed");
    }

};﻿
var supportedCaches={} ;
var supportedCache=false;

var ServiceCacheUtilty = function(){};
ServiceCacheUtilty.prototype.initCachePage =function (){
	if(!supportedCache){
		$("#cacheTab").remove();
		$("#cacheHeader").remove();
		$("#cacheDiv").remove();
		return ;
	}
	var $cacheTab = $("#cacheTab");
	for(var cacheType in supportedCaches){
		// 显示导航栏，及内容。
		$("#cache"+cacheType).show();
		$("li a[href='#cache"+cacheType+"']").parent().show();
		if(cacheType=="Image"){
			this.fillImageCacheInfosToUI(supportedCaches[cacheType]);
		} else if(cacheType=="UTFGrid"){
			this.fillCacheInfosToUI(supportedCaches[cacheType],"#cacheUTFGrid","#useUTFGridCache");
		} else if(cacheType=="Vector"){
			this.fillVectorCacheInfosToUI(supportedCaches[cacheType],"#cacheVector","#useVectorCache");
		} else if(cacheType=="RestRequest"){
			this.fillCacheInfosToUI(supportedCaches[cacheType],"#cacheRestRequest","#useRestRequestCache");
		}else if(cacheType=="RealSpace"){
			this.updateConfigToUI(supportedCaches[cacheType][0],"#cacheRealSpace");
		}
	}
	this.fillAdvanceSettingsToUI();
	this.setEvents();
	$("#cacheImage #selectImageCacheType").change();
	$("#cacheDiv img.tipmark").each(function(){
		$(this).attr("src",getRootUrl()+"static/img/popUpControl.gif").tooltip({placement:"right",title:$(this).attr("title")});
	});
	$("#useImageCache").change();
	var compoentName = getFileName(window.location.pathname);
	$("a#newPrecacheJobLink").attr("href","../tileservice/precachejobs?getMethodForm=true&component="+compoentName);
	$("a#importTilesLink").attr("href",getIServerUrl()+"/manager/tilesetupdatejobs?getMethodForm=true&targetComponent="+compoentName);
	this.initNewCacheTaskDialog();
};

ServiceCacheUtilty.prototype.fillImageCacheInfosToUI=function(imageCacheInfos){
	var userImageCacheInfo = false;
	for(var i=0;i<imageCacheInfos.length;i++){
		var imageCacheInfo = imageCacheInfos[i];
		$("select#selectImageCacheType").append($("<option value='"+imageCacheInfo.name+"'>"+imageCacheInfo.name+"</option>"));
		this.updateConfigToUI(imageCacheInfo,"#cacheImage")
	}
	var cacheInfo=this.getPriorityImageCacheInfo(imageCacheInfos)
	if(cacheInfo){
		$("#cacheImage .cacheSwitch").prop("checked",true);
		this.setJQueryValue( $("select#selectImageCacheType"),cacheInfo.name);
		this.switchImageCacheType(cacheInfo.name);
	}
};
// 初始化填充Vector信息到页面
ServiceCacheUtilty.prototype.fillVectorCacheInfosToUI=function(vectorCacheInfos){
	var userImageCacheInfo = false;
	for(var i=0;i<vectorCacheInfos.length;i++){
		var vectorCacheInfo = vectorCacheInfos[i];
		$("select#selectVectorCacheType").append($("<option value='"+vectorCacheInfo.name+"'>"+vectorCacheInfo.name+"</option>"));
		this.updateConfigToUI(vectorCacheInfo,"#cacheVector")
	}
	var cacheInfo=this.getPriorityImageCacheInfo(vectorCacheInfos)
	if(cacheInfo){
		$("#cacheVector .cacheSwitch").prop("checked",true);
		this.setJQueryValue( $("select#selectVectorCacheType"),cacheInfo.name);
		this.switchVectorCacheType(cacheInfo.name);
	}
};

ServiceCacheUtilty.prototype.getPriorityImageCacheInfo=function(imageCacheInfos){
	//获取优先显示的缓存，组件层缓存优先于UGC缓存显示
	var componentCacheInfo=null;
	var UGCCacheInfo=null;

	for(var i=0;i<imageCacheInfos.length;i++){
		var imageCacheInfo = imageCacheInfos[i];
		var useCache = this.useCache(imageCacheInfo.targetObj,imageCacheInfo.targetSwitch);
		if(useCache){
			if(imageCacheInfo.name=="UGC"){
				UGCCacheInfo=imageCacheInfo;
			}else{
				var config = this.getConfig(imageCacheInfo.targetObj);
				cacheConfig = config[imageCacheInfo.targetConfig]
				if(cacheConfig&&cacheConfig.type==imageCacheInfo.name){
					componentCacheInfo=imageCacheInfo;
				}
			}
		}
	}
	if(componentCacheInfo){
		return componentCacheInfo;
	}
	if(UGCCacheInfo){
		return UGCCacheInfo;
	}
	return null;

}
/**
 * 界面中重新指定栅格缓存类型
 *
 * @param cacheType
 *            UGC/FastDFS/MongoDB/SMTiles
 */
ServiceCacheUtilty.prototype.switchImageCacheType = function(cacheType){
	$("#cacheImage .form-group").hide();
	$("#cacheImage .allwaysShow").show();
	$("#cacheImage ."+cacheType).show();
	$("#cacheImage #selectImageCacheType").parents(".form-group").show();

	// FastDFS & MongoDB & OTS
	if(cacheType!="FastDFS"&&cacheType!="MongoDB"&&cacheType!="OTS"){
		$("a#importStorageLink").hide();
	}

	var description;
	if(cacheType=="UGC"){
	    $("#advanceSettingsDiv #cacheReadOnlyDiv").hide();
	    $("#advanceSettingsDiv #expiredDiv").hide();
	}else{
	    $("#advanceSettingsDiv #cacheReadOnlyDiv").show();
	    $("#advanceSettingsDiv #expiredDiv").show();
	}

	// desc
	if(cacheType=="UGC"){
		description = updateResourceRes.ugcDescripttion;
	}else if(cacheType=="SMTiles"){
		description = updateResourceRes.description = updateResourceRes.smtilesDescription;;
	}else if(cacheType=="MongoDB"){
		description = updateResourceRes.mongoDBDescription;
	}else if(cacheType=="OTS"){
		description = updateResourceRes.oTSDescription;
	}else if(cacheType=="FastDFS"){
		description = updateResourceRes.fastDFSDescription;
	}else if(cacheType=="GDP"){
		description = updateResourceRes.gdpDescription;
	}
	enableToolTip($("#cacheImage #selectImageCacheType"),description);
}
// 切换Vector缓存类型
ServiceCacheUtilty.prototype.switchVectorCacheType = function(cacheType){
	$("#cacheVector .form-group").hide();
	$("#cacheVector .allwaysShow").show();
	$("#cacheVector ."+cacheType).show();
	$("#cacheVector #selectVectorCacheType").parents(".form-group").show();

	var description;
	$("#advanceSettingsDiv #cacheReadOnlyDiv").show();
	$("#advanceSettingsDiv #expiredDiv").show();
	// desc
	if(cacheType=="SVTiles"){
		$("#cacheVector #importStorageLink").hide();
		description = updateResourceRes.svtilesDescription;;
	}else if(cacheType=="MongoDB"){
		$("#cacheVectorMongoDBCard").show();
		description = updateResourceRes.mongoDBDescription;
	}
	enableToolTip($("#cacheVector #selectVectorCacheType"),description);
}

/**
 * 把后端的配置参数更新到界面上。
 */
ServiceCacheUtilty.prototype.updateConfigToUI=function(cacheInfo,container){
	var config = this.getConfig(cacheInfo.targetObj);
	if(config){
		var cacheConfig =config;
		if(cacheInfo.targetConfig){
			cacheConfig = config[cacheInfo.targetConfig];
		}
		if(!cacheConfig){
			return false;
		}
		if(cacheConfig.type&&cacheConfig.type!=cacheInfo.name){
			return false;
		}
		if(cacheInfo.name=="FastDFS"||cacheInfo.name=="MongoDB"||cacheInfo.name=="OTS"){
			$(container+" #fDsMDBStrageDes").html(this.getStorageInfoHtml(cacheConfig));
			return true;
		}
		for(var pro in cacheConfig){
			var exp = container+" ."+cacheInfo.name+" #"+pro;
			if(cacheConfig[pro]!=null&&cacheConfig[pro]!=undefined){
				this.setJQueryValue($(exp),cacheConfig[pro]);
			}
		}
		return true;
	}
}

/**
 * 把缓存信息更新到界面中。
 */
ServiceCacheUtilty.prototype.fillCacheInfosToUI = function(cacheInfos,container,onOff){
	var cacheInfo = cacheInfos[0];
	var useCache  = this.useCache(cacheInfo.targetObj,cacheInfo.targetSwitch);
	$(container+" input.cacheSwitch").prop("checked",useCache);
	if(useCache){
		$(container+" .form-group").show();
	}else{
		$(container+" .form-group").hide();
		$(container+" .allwaysShow").show();
	}
	this.updateConfigToUI(cacheInfo,container);
}

ServiceCacheUtilty.prototype.fillAdvanceSettingsToUI = function(){
	var hasAdvanceSettings = false;
	for(var configName in ServiceCacheResource.AdvanceSettings){
		var config = this.getConfig(configName);
		if(!config){
			continue;
		}
		hasAdvanceSettings = true;
		var parameters = ServiceCacheResource.AdvanceSettings[configName];
		for(var i=0;i<parameters.length;i++){
			var propertyName = parameters[i].name
			var uiId = parameters[i].id;
			var $uiObject = $("#advanceSettingsDiv #"+uiId);
			$uiObject.parents(".form-group").show();
			this.setJQueryValue($uiObject,config[propertyName]);
		}
	}
	if(hasAdvanceSettings){
		$("#advanceSettingsDiv").show();
	}
}


/**
 * 判断是否启用了缓存。
 *
 * @param type
 *            组件/Provider类名
 * @param swtichName
 *            开关的属性名
 */
ServiceCacheUtilty.prototype.useCache=function(type,swtichName){
	var config = this.getConfig(type);
	if(!config){
		return false;
	}
	var proName = swtichName;
	if(proName[0]=="!"){
		proName = proName.substring(1);
		return !config[proName];
	}
	return config[proName];
}

/**
 * 通过组件或Provider 类名获取配置信息
 */
ServiceCacheUtilty.prototype.getConfig=function(type,serviceSetting){
	if(!serviceSetting){
		serviceSetting=setting;
	}
	if(serviceSetting.component&&setting.component.scSetting.type==type){
		return serviceSetting.component.scSetting.config;
	}
	if(serviceSetting.providers){
		for(var i=0; i<serviceSetting.providers.length;i++){
			var spSetting = serviceSetting.providers[i].spSetting;
			if(spSetting.type==type){
				return spSetting.config;
			}
		}
	}
	// TODO ComponentSet and ProviderSet
	return null;
}

ServiceCacheUtilty.prototype.setEvents = function(){
	var me = this;
	// 栅格缓存开关
	$("#cacheImage #useImageCache").change(function(){
		var useCache = $(this).prop("checked");
		if(useCache){
			var cacheType = $("#cacheImage #selectImageCacheType").parents(".form-group").show().end().val();
			$("#cacheImage ."+cacheType).show();
		}else{
			$("#cacheImage .form-group").hide();
		}
		$("#cacheImage .allwaysShow").show();
	});
	// 矢量缓存开关
	$("#cacheVector #useVectorCache").change(function(){
		var useCache = $(this).prop("checked");
		if(useCache){
			var cacheType = $("#cacheVector #selectVectorCacheType").parents(".form-group").show().end().val();
			$("#cacheVector ."+cacheType).show();
		}else{
			$("#cacheVector .form-group").hide();
		}
		$("#cacheVector .allwaysShow").show();
	});
	// 栅格缓存类型变化事件
	$("#cacheImage #selectImageCacheType").change(function(){
		var cacheType = $(this).val();
		$("#cacheImage #fDsMDBStrageDes").html("");
		var imageCacheInfo = me.getCacheInfo("Image", cacheType);
		if(!imageCacheInfo){
			return;
		}
		me.updateConfigToUI(imageCacheInfo,"#cacheImage");
		me.switchImageCacheType(cacheType);
	});
	// 监听Vector缓存类型变化事件
	$("#cacheVector #selectVectorCacheType").change(function(){
		var cacheType = $(this).val();
		$("#cacheVector #fDsMDBStrageDes").html("");
		var vectorCacheInfo = me.getCacheInfo("Vector", cacheType);
		if(!vectorCacheInfo){
			return;
		}
		me.updateConfigToUI(vectorCacheInfo,"#cacheVector");
		me.switchVectorCacheType(cacheType);
	});

	// 导入MongoDB&FastDFS设置
	$("#cacheImage #importStorageLink").click(function(){
		var $storageIDGroup = $("#cacheImage #importStorageID").parents(".form-group");
		$storageIDGroup.toggle();
		if($storageIDGroup.is(":visible")){
			me.getStoageIDs();
			me.fillStorageID();
		}
	})
	// Vector缓存导入存储位置链接
	$("#cacheVector #importStorageLink").click(function(){
		var $storageIDGroup = $("#cacheVector #importVectorStorageID").parents(".form-group");
		$storageIDGroup.toggle();
		if($storageIDGroup.is(":visible")){
			me.getStoageIDs();
			me.fillVectorStorageID();
		}
	})

	$("#cacheImage #importStorageID").change(function(){
		// 刷新页面显示
		var storageID = $('#cacheImage #importStorageID').val();
		me.currentStorageID = storageID;
		var result = sendRequestWithResponse("GET", getRootUrl()+"storages/"+storageID+".json", null);
		if(result){
			if(result.error&&result.error.errorMsg){
				SuperMapServer.Dialog.alert(result.error.errorMsg);
			}
			else{
				var storageConfig = result.tileSourceInfo;
				if(storageConfig.type != $("#cacheImage #selectImageCacheType").val()){
					SuperMapServer.Dialog.alert(storageID + componentRes.importStorageTip1 + $("#cacheImage #selectImageCacheType").val() + componentRes.importStorageTip2)
					return;
				}
				me.currentStorageInfo = toJSON(storageConfig);
				$("#cacheImage #fDsMDBStrageDes").html(me.getStorageInfoHtml(storageConfig));
				me._storageConfig=storageConfig;
			}
		}
	})

	$("#cacheVector #importVectorStorageID").change(function(){
		// 刷新页面显示
		var storageID = $('#cacheVector #importVectorStorageID').val();
		me.currentVectorStorageID = storageID;
		var result = sendRequestWithResponse("GET", getRootUrl()+"storages/"+storageID+".json", null);
		if(result){
			if(result.error&&result.error.errorMsg){
				SuperMapServer.Dialog.alert(result.error.errorMsg);
			}
			else{
				var storageConfig = result.tileSourceInfo;
				if(storageConfig.type != $("#cacheVector #selectVectorCacheType").val()){
					SuperMapServer.Dialog.alert(storageID + componentRes.importStorageTip1 + $("#cacheVector #selectVectorCacheType").val() + componentRes.importStorageTip2)
					return;
				}
				me.currentVectorStorageInfo = toJSON(storageConfig);
				$("#cacheVector #fDsMDBStrageDes").html(me.getStorageInfoHtml(storageConfig));
				me._vectorStorageConfig=storageConfig;
			}
		}
	})

	$('#cacheImage #addStorageLink').click(function(){
		openAddStorageDlg([$('#selectImageCacheType').val()],$("#importStorageID"));
	});

	// 监听 添加存储位置链接
	$('#cacheVector #addStorageLink').click(function(){
		openAddStorageDlg([$('#selectVectorCacheType').val()],$("#importVectorStorageID"));
	});

	$("#cacheDiv input.cacheSwitch").change(function(){
		if($(this).attr("id")=="useImageCache" || $(this).attr("id")=="useVectorCache"){
			return ;
		}
		var useCache = $(this).prop("checked");
		var $container = $(this).parents("form");
		if(useCache){
			$container.find(".form-group").show();
		}else{
			$container.find(".form-group").hide();
			$container.find(".allwaysShow").show();
		}
	});

	// 栅格缓存开关
	$("#cacheImage #useImageCache").change(function(){
		var useCache = $(this).prop("checked");
		if(useCache){
			var cacheType = $("#cacheImage #selectImageCacheType").parents(".form-group").show().end().val();
			$("#cacheImage ."+cacheType).show();
		}else{
			$("#cacheImage .form-group").hide();
		}
		$("#cacheImage .allwaysShow").show();
	});

	// 高级选项开关
	$("#advanceSettingsDiv .header a").click(function(){
		var $content = $(this).parents("#advanceSettingsDiv").find("div#advanceSettingsContent");
		$content.toggle();
		if($content.is(":visible")){
			$(this).parents("#advanceSettingsDiv").find(".header img").attr("src",getRootUrl()+"static/img/upArrowhead.png");
		}else{
			$(this).parents("#advanceSettingsDiv").find(".header img").attr("src",getRootUrl()+"static/img/downArrowhead.png");
		}
	});
}

ServiceCacheUtilty.prototype.setJQueryValue=function($obj,value){
	// IE中 $("select").val(value)是无效的，固加此方法。
	if($obj.length>0&&jQuery.nodeName($obj[0],"select")){
		$obj.children("option[value='"+value+"']").prop("selected",value);
		return ;
	}
	if(this.isJQueryCheckBox($obj)){
		$obj.prop("checked",value);
	}
	return $obj.val(value);
}

ServiceCacheUtilty.prototype.getStoageIDs = function(){
	this.storageSettings = sendRequestWithResponse("GET", getRootUrl()+"storages.json", null);
}

ServiceCacheUtilty.prototype.fillStorageID = function(){
	$("#cacheImage #importStorageID").empty();
	var storageOpt = document.getElementById("importStorageID");
	var selectedIndex = 0;
	if(this.storageSettings != null && this.storageSettings.length > 0){
		for(var i = 0; i < this.storageSettings.length; i++){
			if(this.storageSettings[i].tileSourceInfo.type!= $("#cacheImage #selectImageCacheType").val()){
				continue;
			}
			if(this.currentStorageID == this.storageSettings[i].id || toJSON(this.currentStorageInfo) == toJSON(this.storageSettings[i].tileSourceInfo)){
				selectedIndex = i;
			}
			storageOpt.options.add(new Option(this.storageSettings[i].id, this.storageSettings[i].id));
		}
		storageOpt.selectedIndex = selectedIndex;
		$(storageOpt).change();
	}
}
// 填充服务端拿到的StorageID到下拉框
ServiceCacheUtilty.prototype.fillVectorStorageID = function(){
	$("#cacheVector #importVectorStorageID").empty();
	var storageOpt = document.getElementById("importVectorStorageID");
	var selectedIndex = 0;
	var storageSettings = sendRequestWithResponse("GET", getRootUrl()+"storages.json", null);
	if(storageSettings != null && storageSettings.length > 0){
		for(var i = 0; i < storageSettings.length; i++){
			if(storageSettings[i].tileSourceInfo.type!= $("#cacheVector #selectVectorCacheType").val()){
				continue;
			}
			if(this.currentVectorStorageID == storageSettings[i].id || toJSON(this.currentVectorStorageInfo) == toJSON(storageSettings[i].tileSourceInfo)){
				selectedIndex = i;
			}
			storageOpt.options.add(new Option(storageSettings[i].id, storageSettings[i].id));
		}
		storageOpt.selectedIndex = selectedIndex;
		$(storageOpt).change();
	}
}

ServiceCacheUtilty.prototype.getStorageInfoHtml=function(tilesourceInfo){
	if(tilesourceInfo.type==="FastDFS"){
		return '<div style="color:grey;word-break:break-all;width:390px;display:inline-block"><p>FastDFS Trackers:<span id="dfs">'+toJSON(tilesourceInfo.fdfsTrackers)+'</span></p>'+
		'<p>FastDHT Groups:<span id="dht">'+toJSON(tilesourceInfo.fdhtGroups)+'</span></p></div>';
	}
	if(tilesourceInfo.type==="MongoDB"){
	    var $elem = $("<div>").attr("style","color:grey;word-break:break-all;width:390px;display:inline-block");
	    $elem.append('<p>MongoDB ServerAdresses:<span id="dfs">'+toJSON(tilesourceInfo.serverAdresses)+'</span></p>');
	    if(tilesourceInfo.database){
	        $elem.append("<p>MongoDB database:"+tilesourceInfo.database+"</p>")
	    }
	    if(tilesourceInfo.username){
	        $elem.append("<p>MongoDB username:"+tilesourceInfo.username+"</p>")
	    }
	    return $("<div>").append($elem).html();
// return '<div style="color:grey;word-break:break-all;width:390px;display:inline-block"><p>MongoDB ServerAdresses:<span id="dfs">'+toJSON(tilesourceInfo.serverAdresses)+'</span></p></div>';
	}
	if(tilesourceInfo.type==="OTS"){
	    var $elem = $("<div>").attr("style","color:grey;word-break:break-all;width:390px;display:inline-block");
	    if(tilesourceInfo.instanceName){
	        $elem.append("<p>OTS InstanceName:"+tilesourceInfo.instanceName+"</p>")
	    }
	    if(tilesourceInfo.nodeName){
	        $elem.append("<p>OTS NodeName:"+tilesourceInfo.nodeName+"</p>")
	    }
	    $elem.append("<p>OTS FromPublic:"+tilesourceInfo.fromPublic+"</p>")
	    return $("<div>").append($elem).html();
	}
	if(tilesourceInfo.type==="SMTiles"){
		return this.getSMTilesHtml(tilesourceInfo);
	}
	return "";
};

/**
 * 缓存信息更新到配置中去。
 */
ServiceCacheUtilty.prototype.fillSetting = function(setting){
	var $cacheSwtichs = $("#cacheDiv input.cacheSwitch");
	for(var i=0;i<$cacheSwtichs.length;i++){
		var $cacheSwitch = $($cacheSwtichs[i]);
		var useCache = $cacheSwitch.prop("checked");
		var cacheType = $cacheSwitch.attr("name");
		var cacheInfos = supportedCaches[cacheType];
		if(!cacheInfos ){
			continue;
		}
		var storageType = cacheInfos[0].name;
		var $selectStorageType =$cacheSwitch.parents("form").find("select.selectStorage");
		if($selectStorageType.length==1){
			storageType = $selectStorageType.val();
		}
		var currentCacheInfo = this.getCacheInfo(cacheType,storageType);
		for(var j=0;j<cacheInfos.length;j++){
			var cacheInfo = cacheInfos[j];
			var tempUseCache = useCache;
			//当缓存选择UGC时，不启用组件层缓存
			if(storageType == "UGC" && useCache && cacheInfo.name!="UGC"){
				tempUseCache=false;
			}
			//当缓存选择组件层缓存时，不改变UGC是否使用缓存的状态
			if(storageType!="UGC" && cacheInfo.name=="UGC"){
				var config = this.getConfig(cacheInfo.targetObj,setting);
				tempUseCache=!(config.cacheDisabled);
			}
			if(cacheInfo.name!=storageType){
				if(currentCacheInfo.targetObj==cacheInfo.targetObj){
					continue;
				}
			}
			this.updateUIToConfig(setting,tempUseCache,cacheInfo,$cacheSwitch.parents("form"));
		}
	}
	var $realSpaceSetting = $("#cacheDiv #cacheRealSpace");
	if($realSpaceSetting.length>0 ){
		this.updateRealSpaceCacheToConfig(setting);
	}
	var $advanceSetting=$("#cacheDiv #advanceSettingsDiv");
	if($advanceSetting.length>0){
		this.updateAdvanceSettingsToConfig(setting);
	}
};

/**
 * 获取缓存信息。
 * @param cacheType 缓存类型(image,vector,utfgrid)
 * @param cacheName 缓存名（SMTiles，UTFGrid，MongoDB，UGCV5）
 * @return 返回缓存信息  {name: "SMTiles", targetSwitch: "useCache", targetConfig: "tileCacheConfig", targetObj: "com.supermap.services.components.impl.MapImpl"}
 */
ServiceCacheUtilty.prototype.getCacheInfo=function(cacheType,cacheName){
	var cacheInfos = supportedCaches[cacheType];
	if(!cacheInfos ){
		return null;
	}
	for(var j=0;j<cacheInfos.length;j++){
		var cacheInfo = cacheInfos[j];
		if(cacheInfo.name==cacheName){
			return cacheInfo;
		}
	}
	return null;
};

/**
 * 从将UI中的缓存参数更新到config中去。
 */
ServiceCacheUtilty.prototype.updateUIToConfig = function(setting,useCache,cacheInfo,$uiContainer){
	var config = this.getConfig(cacheInfo.targetObj,setting);
	if(!config){
		return;
	}
	// targetSwitch "useCache" String
	if(cacheInfo.targetSwitch[0]=="!"){
		config[cacheInfo.targetSwitch.substring(1)] = !useCache;
	}else{
		config[cacheInfo.targetSwitch] = useCache;
	}
	if(cacheInfo.name=="FastDFS"||cacheInfo.name=="MongoDB"||cacheInfo.name=="OTS"){
	    if(this._storageConfig||this._vectorStorageConfig){//MongoDB和FastDFS都是外部选择的，所以不存在界面元素。 外部选择的配置放在_storageConfig中。。如果它为空，则可能是该组件最初就使用的MongoDB， 用户 没有选择过外部的配置，所以也不用赋值了。
	        if(cacheInfo.targetConfig == "vectorTileCacheConfig") {
	        	config[cacheInfo.targetConfig] = this._vectorStorageConfig;
	        } else if(cacheInfo.targetConfig == "tileCacheConfig") {
	        	config[cacheInfo.targetConfig] = this._storageConfig;
	        }
	    }
		return ;
	}
	if(cacheInfo.name=="SMTiles"){
		config[cacheInfo.targetConfig] = {
				type:"SMTiles",
				outputPath:$uiContainer.find(".SMTiles #outputPath").val()
		}
		return ;
	}
	if(cacheInfo.name=="GDP"){
		config[cacheInfo.targetConfig] = {
				type:"GDP",
				directoryPath:$uiContainer.find(".GDP #directoryPath").val(),
				cacheVersion:$uiContainer.find(".GDP #cacheVersion").val()
		}
		return ;
	}
	var cacheConfig = config;
	if(cacheInfo.targetConfig){
		cacheConfig = config[cacheInfo.targetConfig];
		if(!cacheConfig){
			config[cacheInfo.targetConfig]=cacheConfig={};
		}
	}
	var $cacheParameters = $uiContainer.find("."+cacheInfo.name+" .cacheParameter");
	for(var i=0;i<$cacheParameters.length;i++){
		var $cacheParameter = $($cacheParameters[i]);
		var proName = $cacheParameter.attr("id");
		if(this.isJQueryCheckBox($cacheParameter)){
			cacheConfig[proName] = $cacheParameter.prop("checked");
		}else{
			cacheConfig[proName] = $cacheParameter.val();
		}
	}
	if(cacheInfo.name=="SVTiles"||cacheInfo.name=="UTFGrid"){
		cacheConfig.type=cacheInfo.name;
	}
};

ServiceCacheUtilty.prototype.updateRealSpaceCacheToConfig=function(setting){
	for(var configName in ServiceCacheResource.RealSpace){
		var config = this.getConfig(configName);
		if(config==null){
			continue;
		}
		var parameters = ServiceCacheResource.RealSpace[configName];
		for(var i=0;i<parameters.length;i++){
			var $parameter = $("#cacheRealSpace #"+parameters[i].id);
			var proName = parameters[i].name;
			if(this.isJQueryCheckBox($parameter)){
				config[proName] = $parameter.prop("checked");
			}else{
				config[proName] = $parameter.val();
			}
		}
	}
};

ServiceCacheUtilty.prototype.updateAdvanceSettingsToConfig = function(setting){
	for(var configName in ServiceCacheResource.AdvanceSettings){
		var config = this.getConfig(configName);
		if(config == null){
			continue;
		}
		var parameters = ServiceCacheResource.AdvanceSettings[configName];
		for(var i=0;i<parameters.length;i++){
			var $parameter = $("#advanceSettingsDiv #"+parameters[i].id);
			var proName = parameters[i].name;
			if(this.isJQueryCheckBox($parameter)){
				config[proName] = $parameter.prop("checked");
			}else{
				config[proName] = $parameter.val();
			}
		}
	}
};

ServiceCacheUtilty.prototype.isJQueryCheckBox=function($obj){
	return $obj.attr("type")&&$obj.attr("type").toLowerCase()=="checkbox";
};

ServiceCacheUtilty.prototype.initNewCacheTaskDialog=function(){
	$("#newComponentCacheTaskDiv").dialog({
		title : serviceCacheRes.newCacheTask,
		autoOpen : false,
		width : 600,
		minWidth : 600,
		maxHeight : 500,
		modal : true,
		position : "center",
		resizable:false
	});
};


var ServiceCacheResource = {
		AdvanceSettings:{
			"com.supermap.services.components.impl.MapImpl":[
			                                                 {"name":"cacheReadOnly",id:"cacheReadOnly"},
			                                                 {"name":"expired",id:"expired"}
			                                                 ]
		},
		RealSpace:{
			"com.supermap.services.providers.UGCRealspaceProvider":[
																	{"name":"output","id":"output"},
																	{"name":"cacheKey","id":"cachekey"},
																	{"name":"extraSetting","id":"extraSetting"}
																	]
		}
};

/*
*/
var allInstances;
var serviceSecurityUtilty;
var ServiceSecurityUtilty = serviceSecurityUtilty = function(instances, roles) {

	this.initSecurityPage = function() {
		$("#authenticateDialog").dialog({
			title : SecurityRes.authorization,
			autoOpen : false,
			width : 700,
			minWidth : 700,
			maxHeight : 700,
			modal : true,
			position : "center",
			resizable : false
		});
		this._instanceAuthorisationForm = new SuperMapServer.Manager.InstanceAuthorisationForm(
				getRootUrl(), instances, roles);
		this.allInstances = instances;
		this.fillinstanceDiv();
		$(".authenticateEvent").click(
				function() {
					serviceSecurityUtilty.showAuthenticateDialog(this.id
							.replace("authenticateSpan_", ""));
				});
		$("#authorize_selectedInstances").click(
				function() {
					var checkedInstances = $("input:checked").filter(
							"#authenticateDiv .isUsed");
					if (checkedInstances.length < 1) {
						return;
					}
					var toOperate = [];
					for ( var i = 0; i < checkedInstances.length; i++) {
			 			toOperate.put(checkedInstances[i].id);
					}
					serviceSecurityUtilty.showChangeAuthenticateDialog(toOperate);
				});
		selectCheckBox("#authenticateDiv .allSelect","#authenticateDiv .isUsed",null,false);
		selectCheckBox("#authenticateDiv #selectReverse","#authenticateDiv .isUsed","selectAll",true);
	};
	this.fillinstanceDiv = function() {
		var $authenticateDiv = $("#authenticateDiv");
		$authenticateDiv
				.append("<div><div class='col-xs-3 col-sm-3 col-md-3 col-lg-3' style='padding-left:0px'><input type='checkbox' id='selectAll' class='allSelect' style='margin-right:5px'><button id='selectReverse' class='btn btn-default btn-sm'>"+DynamicTable.selectReverse+"</button></div><div class='col-xs-9 col-sm-9 col-md-9 col-lg-9 text-right'><button id='authorize_selectedInstances' class='btn btn-default btn-sm'>"+ServiceManagerRes.batchAuthorize+"</button></div></div><hr class='miniline'/>");
		for ( var i = 0; i < this.allInstances.length; i++) {
			var instance = this.allInstances[i];
			var $instanceDiv = $("<div id='" + instance["interfaceName"]
					+ "'></div>");
			$instanceDiv
					.append("<div class='col-xs-3 col-sm-3 col-md-3 col-lg-3' style='padding-left:0px'><input type='checkbox' name='tagForSearch' id='"
							+ instance["name"]
							+ "' class='isUsed ' style='height:25px'><div>");
			var instanceUrl = getServiceRootUrl() + instance["name"];
			var $instanceName = $("<span style='text-align:center' class='col-xs-6 col-sm-6 col-md-6 col-lg-6'><a  href='"
					+ instanceUrl + "'>" + instance["name"] + "</a></span>");
			$instanceDiv.append($instanceName);
			var $elementAuthenticateDiv=$("<div class='col-xs-3 col-sm-3 col-md-3 col-lg-3 text-right'></div>") 
			var $elementAuthenticate = $("<span title='"+ServiceManagerRes.authenticate+"' style='margin-right:35px'></span>");

			$elementAuthenticate.attr('id', 'authenticateSpan_'
					+ instance["name"]);
			if (instance["authorizeSetting"]["type"] != "PUBLIC") {
				$elementAuthenticate
						.attr('class',
								'glyphicon glyphicon-lock instanceIcon authenticateEvent ');
			} else {
				$elementAuthenticate
						.attr('class',
								'glyphicon glyphicon-lock instanceIconWaitting authenticateEvent');
			}
			$elementAuthenticateDiv.append($elementAuthenticate);
			$instanceDiv.append($elementAuthenticateDiv);
			$instanceDiv.append("<hr class='miniline'/>");
			$authenticateDiv.append($instanceDiv);
		}
	}
	this.showAuthenticateDialog = function(instanceName) {
		var toOperate = [];
		toOperate.put(instanceName);
		this.showChangeAuthenticateDialog(toOperate);
	};
	this.showChangeAuthenticateDialog = function(instancesName) {
		var firstInstance;
		var secondInstance;
		var authorizeSetting;
		for ( var i = 0; i < instancesName.length; i++) {
			if (i == 0) {
				firstInstance = this._instanceAuthorisationForm._instanceByName[instancesName[i]];
				authorizeSetting = SuperMapServer.Util
						.clone(firstInstance.authorizeSetting);
			} else {
				secondInstance = this._instanceAuthorisationForm._instanceByName[instancesName[i]];
				if (!this.equal(firstInstance.authorizeSetting,
						secondInstance.authorizeSetting)) {
					authorizeSetting.type = null;
					authorizeSetting.permittedRoles = [];
					authorizeSetting.deniedRoles = [];
					break;
				}
			}
		}
		this._instanceAuthorisationForm.show(instancesName, authorizeSetting);
		return false;
	};
	this.equal = function(objA, objB){
		if(typeof objA !== typeof objB){
			return false;
		}
		var result = true;
		for(var o in objA){
		    if(typeof objA[o] == 'number' || typeof objA[o] == 'string'){
		    	result = objA[ o ] === objB[ o ];
		    	if(!result){
		    	   break;
		    	}
		    }
		}
		return result;
	};
	SuperMapServer.Manager.InstanceAuthorisationForm = function(root,
			instances, roles) {
		this._root = root;
		this._instances = instances;
		this._roles = roles;
		this._instanceByName = [];
		this._PUBLIC = "PUBLIC";
		this._PRIVATE = "PRIVATE";
		this._AUTHENTICATED = "AUTHENTICATED";
		this._IDS = {
			'USEDROLE' : "usedRoles",
			'UNUSEDROLE' : "unusedRoles",
			'DENIEDROLESDIV' : "deniedRolesDiv"
		};
		this._typeFunctions = {
			"PUBLIC" : SuperMapServer.Util.createCallback(this, this.setPublic),
			"PRIVATE" : SuperMapServer.Util.createCallback(this,
					this.setPrivate),
			"AUTHENTICATED" : SuperMapServer.Util.createCallback(this,
					this.setAuthenticated)
		};
		this._typeIds = {
			"PUBLIC" : "typePublic",
			"PRIVATE" : "typePrivate",
			"AUTHENTICATED" : "typeAuthenticated"
		};
		this._bindEvent("typePublic", "onclick", SuperMapServer.Util
				.createCallback(this, this.setPublic));
		this._bindEvent("typeAuthenticated", "onclick", SuperMapServer.Util
				.createCallback(this, this.setAuthenticated));
		this._bindEvent("typePrivate", "onclick", SuperMapServer.Util
				.createCallback(this, this.setPrivate));
		this._bindEvent("instanceRoledialogOK", "onclick", SuperMapServer.Util
				.createCallback(this, this.onOkClick));
		this._bindEvent("instanceDialogCancel", "onclick", SuperMapServer.Util
				.createCallback(this, this.onCancleClick));
		this._bindEvent("deniedRolesCheckBox", "onclick", SuperMapServer.Util
				.createCallback(this, this.onDeniedRolesCheckBoxClick));
		this._newAuthorisation = {};
		this._oldAuthorisation = {};

		for ( var i = 0; i < this._instances.length; i++) {
			this._instanceByName[this._instances[i].name] = this._instances[i];
		}
	};
	/**
	 * 使用指定的参数初始化对话框并显示 instanceName,实例名称 curAuthorisation,实例当前安全设置
	 */
	SuperMapServer.Manager.InstanceAuthorisationForm.prototype.show = function(
			instanceName, curAuthorisation) {
		openAuthenticateDialog(instanceName);

		var type = curAuthorisation.type;
		if (type) {
			$("#authorizeTips").text('');
		} else {
			$("#authorizeTips").text(securityManagerRes.AuthorizeTip);
		}

		this._instanceName = instanceName;
		this._newAuthorisation = SuperMapServer.Util.clone(curAuthorisation);
		this._oldAuthorisation = curAuthorisation;
		if (type) {
			if (type === this._PUBLIC) {
				$("#typePublic").click();
			} else {
				$("#typePrivate").click();
				if (type === this._AUTHENTICATED) {
					$("#typeAuthenticated").attr('checked', true);
				} else {
					$("#typeAuthenticated").attr('checked', false);
				}
				this.setAuthenticated();
			}
		} else {
			$("#typePublic").click();
			document.getElementById(this._typeIds[this._PUBLIC]).checked = "";
			$("#typeAuthenticated").attr('checked', false);
			this._disableRoleConfig();
		}

		var deniedRolesArray = curAuthorisation.deniedRoles;
		if (deniedRolesArray && deniedRolesArray.length > 0) {
			$("#deniedRolesCheckBox").attr('checked', true);
		} else {
			$("#deniedRolesCheckBox").attr('checked', false);
		}
		this.onDeniedRolesCheckBoxClick();

		this._initRoleConfigDialog();
		$("#instanceDialogCancel").focus();
	};
	
	function openAuthenticateDialog(instanceName){
		$("#authenticateDialog").dialog("open");
		if (instanceName.length == 1) {
			$("#instanceName").text(instanceName[0]);
		} else {
			$("#instanceName").text('');
		}
	}

	SuperMapServer.Manager.InstanceAuthorisationForm.prototype.onDeniedRolesCheckBoxClick = function() {
		if ($("#deniedRolesCheckBox").prop('checked')) {
			this._showDeniedRolesDiv();
		} else {
			this._hideDeniedRolesDiv();
		}
	};

	SuperMapServer.Manager.InstanceAuthorisationForm.prototype._showDeniedRolesDiv = function() {
		$("#" + this._IDS.DENIEDROLESDIV).show();
	};

	SuperMapServer.Manager.InstanceAuthorisationForm.prototype._hideDeniedRolesDiv = function() {
		$("#" + this._IDS.DENIEDROLESDIV).hide();
	};

	SuperMapServer.Manager.InstanceAuthorisationForm.prototype._bindEvent = function(
			id, event, callback) {
		document.getElementById(id)[event] = callback;
	};

	SuperMapServer.Manager.InstanceAuthorisationForm.prototype.setPublic = function() {
		$("#assignUsersAccess").hide();
		this._newAuthorisation.type = this._PUBLIC;
	};

	SuperMapServer.Manager.InstanceAuthorisationForm.prototype.setAuthenticated = function() {
		if ($("#typeAuthenticated").prop('checked')) {
			this._disableRoleConfig();
			this._newAuthorisation.type = this._AUTHENTICATED;
		} else {
			this._enableRoleConfig();
			this._newAuthorisation.type = this._PRIVATE;
		}
	};

	SuperMapServer.Manager.InstanceAuthorisationForm.prototype.setPrivate = function() {
		$("#assignUsersAccess").show();
		this.setAuthenticated();
		this._newAuthorisation.type = this._PRIVATE;
	};

	SuperMapServer.Manager.InstanceAuthorisationForm.prototype._disableRoleConfig = function() {
		setRolesDisabled(true);
	};

	SuperMapServer.Manager.InstanceAuthorisationForm.prototype._enableRoleConfig = function() {
		setRolesDisabled(false);
	};

	SuperMapServer.Manager.InstanceAuthorisationForm.prototype._getSelectedOptions = function(
			sourceId) {
		var options = document.getElementById(sourceId).options;
		var result = [];
		for ( var i = 0; i < options.length; i++) {
			result[i] = options[i].value;
		}
		return result;
	};

	SuperMapServer.Manager.InstanceAuthorisationForm.prototype.onOkClick = function() {
		var entityObject = {};
		entityObject.instances = this._instanceName;
		if (($("#deniedRolesCheckBox").prop('checked'))) {
			this._newAuthorisation.deniedRoles = this
					._getSelectedOptions("deniedRoles");
		} else {
			this._newAuthorisation.deniedRoles = [];
		}

		this._newAuthorisation.permittedRoles = this
				._getSelectedOptions("usedRoles");

		entityObject.authorizeSetting = this._newAuthorisation;
		var entity = toJSON(entityObject);
		var rootUrl = getRootUrl();
		var url = rootUrl + "instances/authorize.json";
		var result;
		$.ajax({
			type : "POST",
			url : url,
			async : false,
			data : entity,
			dataType : "json",
			success : function(msg) {
				result = msg;
			}
		})
		if (!result.succeed) {
			SuperMapServer.Dialog.alert(SuperMapServer.Util.formatMsg(
					securityManagerRes.ChangeInstanceAuthorisationFailed,
					this._instanceName));
		}
		this._closeDialog();
		for ( var i = 0; i < this._instances.length; i++) {
			for ( var j = 0; j < this._instanceName.length; j++) {
				if (this._instanceName[j] == this._instances[i].name) {
					this._instances[i].authorizeSetting = this._newAuthorisation;
					this._instanceByName[this._instances[i].name] = this._instances[i];
					$(document.getElementById(this._instanceName[j])).attr(
							'checked', false);
				}
			}
		}
		$("#selectAll").attr('checked', false);
		this.refreshLockStatus(this._instanceName, this._newAuthorisation.type);
	};

	SuperMapServer.Manager.InstanceAuthorisationForm.prototype.setStatus = function(
			instanceNames, value) {
		for ( var i = 0; i < this._instances.length; i++) {
			for ( var j = 0; j < instanceNames.length; j++) {
				if (instanceNames[j] === this._instances[i].name) {
					this._instances[i].enabled = value;
				}
			}
		}
	};

	SuperMapServer.Manager.InstanceAuthorisationForm.prototype.getStatus = function(
			instanceName) {
		for ( var i = 0; i < this._instances.length; i++) {
			if (instanceName === this._instances[i].name) {
				return this._instances[i].enabled;
			}
		}
	};

	SuperMapServer.Manager.InstanceAuthorisationForm.prototype.refreshLockStatus = function(
			instanceNames, type) {
		for ( var j = 0; j < instanceNames.length; j++) {
			var img = $("[id = 'authenticateSpan_" + instanceNames[j] + "']");
			if (type == "PUBLIC") {
				img.removeClass("instanceIcon");
				img.addClass("instanceIconWaitting");
			} else {
				img.removeClass("instanceIconWaitting");
				img.addClass("instanceIcon");
			}
		}
	};

	SuperMapServer.Manager.InstanceAuthorisationForm.prototype.onCancleClick = function() {
		this._closeDialog();
	};

	SuperMapServer.Manager.InstanceAuthorisationForm.prototype._closeDialog = function() {
		$("#authenticateDialog").dialog("close");
	};

	SuperMapServer.Manager.InstanceAuthorisationForm.prototype._initRoleConfigDialog = function() {
		var usedRoleArray;
		if (this._oldAuthorisation) {
			usedRoleArray = this._oldAuthorisation.permittedRoles;
		}

		var roles = this._roles;
		if (usedRoleArray) {
			// 过滤掉在实例中配置了，但是在所有Role中没有的（可能是删除的时候没有同步导致）
			usedRoleArray = $.grep(usedRoleArray, function(value) {
				return $.inArray(value, roles) > -1;
			});
		} else {
			usedRoleArray = [];
		}

		var deniedRoleArray;
		if (this._oldAuthorisation) {
			deniedRoleArray = this._oldAuthorisation.deniedRoles;
		}

		if (deniedRoleArray) {
			// 过滤掉在实例中配置了，但是在所有Role中没有的（可能是删除的时候没有同步导致）
			deniedRoleArray = $.grep(deniedRoleArray, function(value) {
				return $.inArray(value, roles) > -1;
			});
		} else {
			deniedRoleArray = [];
		}

		var unusedRoleArray;
		// 从所有Role中过滤掉已经配置给服务实例的。
		if (usedRoleArray && usedRoleArray.length > 0) {
			unusedRoleArray = $.grep(roles, function(value) {
				return $.inArray(value, usedRoleArray) == -1;
			});
		} else {
			unusedRoleArray = roles;
		}

		var allRoleArray;
		// 从所有Role中过滤掉已经配置给服务实例的。
		if (deniedRoleArray && deniedRoleArray.length > 0) {
			allRoleArray = $.grep(roles, function(value) {
				return $.inArray(value, deniedRoleArray) == -1;
			});
		} else {
			allRoleArray = roles;
		}

		var filters = [];
		filters.push("ADMIN");

		initUnusedRoles(unusedRoleArray);
		initUsedRoles(usedRoleArray);
		setOptionsByFilterAndID(allRoleArray, "allRoles", filters);
		setOptionsByID(deniedRoleArray, "deniedRoles");
	};
};var match;
var ServiceInterfacesUtilty = function(interfaces, serviceType,
		isClusterService) {
	// 初始化
	this.initInterfacesPage = function() {
		this.initinstanceDiv(serviceType);
		this.choseCheckedInterface(interfaces);
	};

	var minterfaces = interfaces;
	// 初始化接口设置Div，根据服务类型选取适合所有的接口
	this.initinstanceDiv = function(serviceType) {
		var allNames = [];
		var interfacesUrl;
		if (isClusterService) {
			allNames = minterfaces.split(",");
		} else {
			// 如果是数据流服务，需要单独处理
			if("com.supermap.service.dataflow.DataFlowServiceInstance" === serviceType){
				interfacesUrl = getRootUrl() + "dataflowinterfaces.rjson";
				var interfaces = sendRequestWithResponse("GET", interfacesUrl, null);
				for(var i = 0; i < interfaces.length; i++) {
					match = interfaces;
					allNames.push(interfaces[i]["name"]);
				}
			} else {
				interfacesUrl = getRootUrl() + "interfaces.rjson";
				var msg = sendRequestWithResponse("GET", interfacesUrl, null);
				if (!serviceType) {// 服务集合,支持所有接口
					match = msg;
				} else {
					match = getMatchInterfaces(enToZhMapping[serviceType], msg);
				}
				for ( var i = 0; i < match.length; i++) {
					allNames.push(match[i].name);
				}
			}
		}

		var $interfacesDiv = $("#interfacesDiv");
		for ( var i = 0; i < allNames.length; i++) {
			var interfaceName = allNames[i];
			var $interfaceDiv = $("<div id='" + allNames[i]
					+ "' class='fl' style='display:block;width:220px;'></div>");
			var input = $("<input type='checkbox' id='interfaceCheckbox_"
					+ allNames[i] + "' class='checkInterface' style='display:block; float:left;margin-top:5px;' >")
			if (isClusterService) {
				input.attr("disabled", true);
			}
			$interfaceDiv.append(input);
			var $interfaceName = $("<label  for='interfaceCheckbox_"
					+ allNames[i] + "' style='width:207px;display:inline-block;float:left;' id='interfaceLabel_"
					+ allNames[i] + "' title=''>" + allNames[i] + "</label>");
			$interfaceDiv.append($interfaceName);
			$interfacesDiv.append($interfaceDiv);
			if (!isClusterService) {
				$("#interfaceLabel_" + allNames[i]).tooltip(
						{
							content : this.getInterfaceInfo(allNames[i],
									serviceType, match)
						}, {
							position : {
								my : "left+15 center",
								at : "left+50 bottom+30"
							}
						});
			}
		}
		//设置不可用的接口
		var  filteInterfaces= unavailableInterfaces;
		if($.inArray(filteInterfaces, allNames)){
			for(var i = 0; i < filteInterfaces.length; i++){
				if (productType == ProductType.iEdge || license.iServerEnterprise) {
					$("#interfaceCheckbox_" + filteInterfaces[i]).removeAttr("disabled");
				} else {
					$("#interfaceCheckbox_" + filteInterfaces[i]).attr("disabled",
							"disabled");
				}
			}
		}
		// $interfacesDiv.append($("<hr style=';border: 0px;'/>"));
	};

	// 选中当前服务已绑定的接口
	this.choseCheckedInterface = function(interfaces) {
		var checkedInterfaces = interfaces.split(",");
		for ( var i = 0; i < checkedInterfaces.length; i++) {
			$("#interfaceCheckbox_" + checkedInterfaces[i]).attr("checked",
					true);
		}
	};

	// 获取接口描述信息
	this.getInterfaceInfo = function(name, serviceType, match) {
		var interfaceSetting;
		for ( var i = 0; i < match.length; i++) {
			if (match[i].name == name) {
				interfaceSetting = match[i];
			}
		}
		return interfaceInfosRes[this.getInterfaceInfoName(interfaceSetting,
				serviceType)];
	};

	// 获取接口Name以便在interfaceInfosRes获取相应描述信息
	this.getInterfaceInfoName = function(interfaceSetting, serviceType) {
		var interfaceInfoName="";
		switch(interfaceSetting.type){
		case "com.supermap.services.wms.WMSServlet":{
			interfaceInfoName= getWMSInterfaceInfoName(interfaceSetting);
			break;
		}
		case "com.supermap.services.wfs.WFSServlet":{
			interfaceInfoName= getWFSInterfaceInfoName(interfaceSetting);
			break;
		}
		case "com.supermap.services.handler.HandlerServlet":{
			interfaceInfoName= "Handler";
			break;
		}
		case "com.supermap.services.rest.RestServlet":{
			interfaceInfoName= getRestInterfaceInfoName(serviceType);
			break;
		}
		case "com.supermap.services.rest.JaxrsServletForJersey":{
			interfaceInfoName= getRestSpatilaName(serviceType);
			break;
		}
		case "com.supermap.services.wmts.WMTSServlet":{
			interfaceInfoName= getWMTInterfaceInfoName(interfaceSetting);
			break;
		}
		case "com.supermap.services.wcs.WCSServlet":{
			interfaceInfoName= getWCSInterfaceInfoName(interfaceSetting);
			break;
		}
		case "com.supermap.services.wps.WPSServlet":{
			interfaceInfoName= "WPS100";
			break;
		}
		default:{
			break;
		}
		}
		return interfaceInfoName;
	}
	// 更新interface配置到setting中
	this.fillSetting = function(setting) {
		var checkedInterfaces = $("input:checked").filter(".checkInterface");
		var interfaceNames = [];
		for ( var i = 0; i < checkedInterfaces.length; i++) {
			interfaceNames.push(checkedInterfaces[i].id.split("_")[1]);
		}
		setting.interfaceNames = interfaceNames.join(",");
	}
	// 检查服务接口配置是否正确
	this.checkInterfaceSettingAvailable = function() {
		var checkedInterfaces = $("input:checked").filter(".checkInterface");
		if (checkedInterfaces.length < 1) {
			return componentRes.createComponentSettingAlert3;
		}
		return null;
	}
};

function getWMSInterfaceInfoName(interfaceSetting){
	if (interfaceSetting["config"]["version"] == "1.1.1") {
		return "WMS111";
	} else if (interfaceSetting["config"]["version"] == "1.3.0") {
		return "WMS130";
	}
}
function getWFSInterfaceInfoName(interfaceSetting){
	if (interfaceSetting.config&&interfaceSetting.config.version == "2.0.0") {
		return "WFS200";
	} else {
		return "WFS100";
	}
}
function getRestInterfaceInfoName(serviceType){
	if (serviceType == "com.supermap.services.components.impl.MapImpl") {
		return "REST-Map";
	}
	if (serviceType == "com.supermap.services.components.impl.DataImpl") {
		return "REST-Data";
	}
	if (serviceType == "com.supermap.services.components.impl.DataHistoryImpl") {
		return "REST-DataHistory";
	}
	if (serviceType == "com.supermap.services.components.impl.TransportationAnalystImpl") {
		return "REST-Transportation";
	}
	if (serviceType == "com.supermap.services.components.impl.RealspaceImpl") {
		return "REST-3D";
	}
}

function getRestSpatilaName(serviceType){
	if (serviceType == "com.supermap.services.components.impl.TrafficTransferAnalystImpl") {
		return "REST-TrafficTransfer";
	}
	if (serviceType == "com.supermap.services.components.impl.SpatialAnalystImpl") {
		return "REST-Spatial";
	}
}

function getWMTInterfaceInfoName(interfaceSetting){
	if (interfaceSetting.name == "wmts-china") {
		return "WMTS-China";
	} else {
		return "WMTS100";
	}
}
function getWCSInterfaceInfoName(interfaceSetting){
	if (interfaceSetting["config"]["version"] == "1.1.1") {
		return "WCS111";
	} else if (interfaceSetting["config"]["version"] == "1.1.2") {
		return "WCS112";
	}
}var currentStartRecord = 0;
var ServiceStatisticsUtilty = function(){
	this.initStatisticsPage =function (name){
		$("#statisticsDiv_InstanceName").html("");
    	$("#statisticsDiv_UserName").html("");
		var queryParameter = new SuperMapServer.Manager.InstanceRequestsQueryParameter({
			//统计还不支持按时间
			startTime : new Date().getTime() - 6 * 60 * 60	* 1000,// 默认请求前6小时的记录
			endTime : new Date().getTime()
		});

		var requestsManager = new SuperMapServer.Manager.InstanceRequestsManager({
			chartDiv : $("#graphDiv"),
			queryParameter : queryParameter,
			queryResult : null,
			statisticsResult : null,
			url : getRootUrl() + "serverstatus/requests",
			serviceName:name
		});
		requestsManager.query();
	}

	var clientPageStartTime = new Date().getTime();
	SuperMapServer.Manager.InstanceRequestsQueryParameter = SuperMapServer.Class({
		startTime : 0,
		endTime : 0,
		userName : null,
		startRecord : 0,
		initialize : function(options) {
			if (options) {
				SuperMapServer.Util.extend(this, options);
			}
		},
		CLASS_NAME : "SuperMapServer.Manager.InstanceRequestsQueryParameter"
	});

	SuperMapServer.Manager.InstanceRequestsManager = SuperMapServer
			.Class({
				chartDiv : null,
				url : null,
				colorHelper : null,
				onlyGraph : false,
				statisticsResult : null,
				needShowStatistics : true,
				queryParameter : null,
				queryResult : null,
				serviceName:null,
				lastQueryTime : clientPageStartTime,
				initialize : function(options) {
					if (options) {
						SuperMapServer.Util.extend(this, options);
					}
					if (this.statisticsResult) {
						if (!this.statisticsResult.byUsers) {
							this.getStatisticsByType("UserName");
						}
					}

				},
				labelFormatter : function(label, series) {
					if (label.length > 18) {
						var length = label.length;
						var startStr = label.substring(0, 9);
						var endStr = label.substring(length - 7);
						var indexSep = label.indexOf("/");
						if (indexSep > -1) {
							endStr = label.substring(indexSep + 1, label.length);
						}
						label = startStr + "..." + endStr;
					}
					return "<div style='font-size:6pt; font-weight:normal; text-align:center; padding:1px; color:white;'>"
							+ label + "<br/>" + series.data[0][1] + "</div>";
				},
				labelFormatterWithoutRecord : function(label, series) {
					return "<div style='font-size:10pt; font-weight:bloder; text-align:center; padding:1px; color:white;'>" + label + "</div>";
				},
				getStatisticsByType : function(statisticsType) {
					var clientStayTime = this.lastQueryTime - clientPageStartTime;
					var queryStringParameter = new Object();
					queryStringParameter.startTime = this.queryParameter.startTime + clientStayTime;
					queryStringParameter.endTime = this.queryParameter.endTime + clientStayTime;
					queryStringParameter.startIndex = this.queryParameter.startIndex;
					queryStringParameter.expectCount = this.queryParameter.expectCount;

					queryStringParameter.serviceName = this.serviceName;
					var tempURL = this.url + "/statistics.json";
					if (statisticsType == "UserName") {
						tempURL = getRootUrl() + "serverstatus/users/statistics.json";
						queryStringParameter.userName = null;
					}
					queryStringParameter.statisticsType = statisticsType;
					SuperMapServer.Util
							.committer({
								url : tempURL,
								params : queryStringParameter,
								method : "GET",
								timeout : 60,
								scop : this,
								success : function(data) {this.updateStatisticsResult(statisticsType,data);
								},
								failure : function() {
									SuperMapServer.Dialog.alert("",ServerMonitorRes.InstanceRequests.QueryInstanceRequestsStatisticsFailed);
								}
							});
				},

				updateStatisticsResult : function(statisticsType,statisticsResultItem) {
					if (statisticsType == "InstanceName") {
						this.statisticsResult.byInstanceName = statisticsResultItem;
					} else if (statisticsType == "UserName") {
						this.statisticsResult.byUserName = statisticsResultItem;
					}
					if (this.needShowStatistics) {
						this.showStatistics(statisticsResultItem, statisticsType);
					}
				},
				query : function() {
					this.lastQueryTime = new Date().getTime();
					if (this.queryParameter.startTime >= this.queryParameter.endTime) {
						SuperMapServer.Dialog.alert("",ServerMonitorRes.InstanceRequests.EndTimeMustGreaterThanStartTime);
						return;
					}
					if (!this.statisticsResult) {
						this.statisticsResult = new Object();
					}
					currentStartRecord = 0;
					this.statisticsResult.byComponentType = null;
					this.statisticsResult.byInstanceName = null;
					this.statisticsResult.byUserName = null;
					this.getStatisticsByType("InstanceName");
					this.getStatisticsByType("UserName");
				},

				showStatistics : function(statisticsObject, statisticsType) {
					if (!statisticsObject) {
						return;
					}
					var statisticsData = [];
					for ( var prop in statisticsObject) {
						if(statisticsObject[prop]!=0){
							statisticsData
							.push({
								data : statisticsObject[prop],
								label : statisticsType == "ComponentType" ? SuperMapServer.Util.getServiceType(prop) : prop,
								color : ""
							});
						}

					}
					statisticsData.sort(function sortStatisticsResult(obj1, obj2) {
						return obj2.data - obj1.data;
					});
					if (!this.colorHelper || this.colorHelper.colorCount < statisticsData.length) {
						this.colorHelper = new SuperMapServer.Util.ColorHelper(statisticsData.length);
					}
					var colors = this.colorHelper.getDefaultColors();
					if (statisticsType === "ComponentType") {
						for ( var index = 0; index < statisticsData.length; index++) {
							statisticsData[index].color = colors[statisticsData.length - index - 1];
						}
					} else {
						for ( var index = 0; index < statisticsData.length; index++) {
							statisticsData[index].color = colors[index];
						}
					}
					var combineThreshold = 0.04;
					var labelFormatter = $.proxy(this.labelFormatter, this);
					if (statisticsData.length == 0) {
						statisticsData.Other = 1;
						statisticsData
								.push({
									data : 1,
									label : ServerMonitorRes.InstanceRequests.NoQueryResult,
									color : "#87cefa"
								});
						var labelFormatter = $.proxy(this.labelFormatterWithoutRecord, this);
					} else {
						// 控制最多显示9项有效数据
						var maxItemCount = 9;
						if (statisticsData.length > maxItemCount) {
							if (statisticsData[maxItemCount - 2].data == statisticsData[maxItemCount - 1].data) {
								// 如果第maxItemCount-1项和第maxItemCount项值相同，则将第maxItemCount-1项及后面的都归为Others
								combineThreshold = 0;
								var othersItemsValue = 0;
								for ( var index = maxItemCount - 1; index < statisticsData.length; index++) {
									othersItemsValue = othersItemsValue + statisticsData[index].data;
								}
								var othersItem = {
									label : ServerMonitorRes.InstanceRequests.Others,
									color : "#D050E0",
									data : othersItemsValue
								};
								var tempStatisticsData = statisticsData.slice(0,maxItemCount - 1);

								var totalValue = othersItem.data;
								for ( var index = 0; index < tempStatisticsData.length; index++) {
									totalValue = totalValue	+ tempStatisticsData[index].data;
								}
								statisticsData = [];
								var combineValue = totalValue * 0.04; // 比例小于4%的一律放到Others中
								for ( var index = 0; index < tempStatisticsData.length; index++) {
									if (tempStatisticsData[index].data < combineValue) {
										othersItem.data += tempStatisticsData[index].data;
									} else {
										statisticsData.push(tempStatisticsData[index]);
									}
								}
								statisticsData.push(othersItem);
							} else {
								// 验证计算combineThreshold
								var totalValue = 0;
								for ( var index = 0; index < statisticsData.length; index++) {
									totalValue = totalValue	+ statisticsData[index].data;
								}
								combineThreshold = statisticsData[maxItemCount - 1].data / totalValue;
								if (combineThreshold < 0.04) {
									combineThreshold = 0.04;
								}
							}
						}
					}
					var textValue = "";
					$.plot($("#statisticsDiv_" + statisticsType),statisticsData,{
										series : {
											pie : {
												show : true,
												radius : 0.8,
												innerRadius : 0,
												tilt : this.tilt,
												label : {
													show : !this.onlyGraph,
													radius : 0.3,
													formatter : labelFormatter,
													background : {
														opacity : 0
													},
													threshold : 0.15
												},
												combine : {
													threshold : combineThreshold,
													color : "#D5E",
													label : ServerMonitorRes.InstanceRequests.Others,
													opacity : 0.5
												},
												highlight : {
													opacity : 0.5
												}
											}
										},
										legend : {
											show : false
										},
										grid : {
											hoverable : true,
											clickable : true
										}
									});
					$("#statisticsDiv_" + statisticsType).bind("plothover",
							$.proxy(this.showStatisticsItemTip, this));
				},

				showStatisticsItemTip : function(envent, pos, item) {
					var statisticsType = envent.currentTarget.id;
					if (item) {
						if (item.datapoint[0] >= 15 && !this.onlyGraph) {
							$("#statisticsItemTip_" + statisticsType).remove();
							return;
						}
						$("#statisticsItemTip_" + statisticsType).remove();
						var x = pos.pageX;
						var y = pos.pageY;
						var contents = item.series.label + "<br/>"
								+ item.series.data[0][1];

						var style1 = "display:block;overflow:hidden;";
						var style2 = "height:1px;";
						var style3 = "margin:0 5px;";
						var style4 = "margin:0 3px;"
						var style5 = "margin:0 2px;";
						var style6 = "margin:0 1px;height:2px;";
						var style7 = "background:#777777;opacity:0.7;filter:alpha(opacity = 70);-moz-opacity:0.7;";// #2A6600";//#8DB6CD";//#4A708B";//#388E8E";//'567300;
						var style8 = "height:35px;";

						var div = "<div id='statisticsItemTip_"
								+ statisticsType
								+ "' style='z-index:2000;height:35px;font-size:10pt; font-weight:normal; text-align:center;color:white;'><b style='"
								+ style1 + style2 + style3 + "'></b><b style='"
								+ style1 + style2 + style4 + style7
								+ "'></b><b style='" + style1 + style2 + style5
								+ style7 + "'></b><b style='" + style1 + style6
								+ style7
								+ "'></b><div style=' padding:1px 10px 1px 10px;"
								+ style1 + style8 + style7 + "'>" + contents
								+ "</div><b style='" + style1 + style6 + style7
								+ "'></b><b style='" + style1 + style2 + style5
								+ style7 + "'></b><b style='" + style1 + style2
								+ style4 + style7 + "'></b><b style='" + style1
								+ style2 + style3 + "'></b></div>";
						$(div).css({
							position : "absolute",
							display : "none",
							top : y - 10,
							left : x + 2
						}).appendTo("body").fadeIn(200);
					} else {
						$("#statisticsItemTip_" + statisticsType).remove();
					}
				}
			});
}

SuperMapServer.Manager = SuperMapServer.Manager ? SuperMapServer.Manager : {};
SuperMapServer.Manager.Table = function(){};

//初始化Table
SuperMapServer.Manager.Table.prototype.init = function(divID,dataSource,aoColumnDefs,tableID,displayLength,fnServerParams,sAjaxSource,fnServerData,sDom){
	var asInitVals = [];
	var asInitSelectVals = [];
	var _tableID = tableID ? tableID : "dynamicTable";
	var _iDisplayLength = displayLength ? displayLength : 10;
	var _bServerSide = sAjaxSource ? true : false;
	$("#"+divID).html( '<table style="width:100%;max-width:100%;" id="'+_tableID+'"></table>' );
	var oTable = $('#'+_tableID).dataTable( {
		"aaData":  dataSource,
		"aoColumnDefs" : aoColumnDefs,
		"sDom" : sDom ? sDom : 'rt<"bottom"ip<"clear">lf>',
		"bJqueryUI" : false,
		"bLengthChange" : true,
		"bFilter" :true,
		"bSort" : true,
		"bProcessing" :_bServerSide,
		"bServerSide": _bServerSide,
		"bServiceSide": _bServerSide,
		"bSortClasses" :false,
		"sPaginationType" : "full_numbers",
		"iDisplayLength" :_iDisplayLength,
		"aLengthMenu" :[[5,10,15,25,50,-1],[5,10,15,25,50,DynamicTable.aLengthMenu]],
		"bAutoWidth" : false,
		"headerClickable" : false,
		"sScrollX" : "100%",
		"bScrollCollapse" : true,
		"oLanguage": DynamicTable.oLanguage,
		"fnServerParams": fnServerParams,
		"sAjaxSource": sAjaxSource,
		"fnServerData": fnServerData
		} );

		$("thead th").each( function (i) {
			var width = $(this.children).css("width");
			if(width){
				width = Number(width.split('px')[0]) + 5;
				$(this).css("backgroundPosition",""+width+"px 50%");
			}
		} );

		$("thead select").each( function (i) {
			asInitSelectVals[i] = this.value;
		} );

		$("thead input").each( function (i) {
			asInitVals[i] = this.value;
		} );

		$("thead input[type=text]").click( function () {
			return false;
		} );

		$("thead select").click( function () {
			var i = $("thead select").index($("thead select[id='"+this.id+"']"));
			if(asInitSelectVals[i] == this.value){
				return false;
			}else{
				asInitSelectVals[i] = this.value;
				return true;
			}
		} );

		$("thead input").keyup( function () {
			oTable.fnFilter( this.value, $("thead th").index($("thead th:has(input[id='"+this.id+"'])")));
		} );

		$("thead input").focus( function () {
			if ( this.className == "inputTip" )
			{
			  this.className = "inputSearch";
			  this.value = "";
		   }
		} );

		 $("thead input").blur( function (i) {
			 if ( this.value == "" )
				{
				   this.className = "inputTip";
				   this.value = asInitVals[$("thead input").index(this)];
				}
		 } );
         
		 return oTable;
}

//数组扩展,在使用DataTables插件时,对数据源进行扩展,多出的列可自定义,比如check,img等,value为扩展列的值
function arrayExpand(paramArray,value){
	var expandedArray = [];
	for(var i = 0; i < paramArray.length; i++){
		var item = [];
		item.push(value);
		for(var j = 0; j < paramArray[i].length; j++){
			item.push(paramArray[i][j]);
		}
		expandedArray.push(item);
	}
	return expandedArray;
}

//选择/反选一组checkBox.并检查是否全部全选来设置全选按钮的选中状态
function selectCheckBox(checkSelector,groupSelector, selectAllId, reverse){
	$(checkSelector).click(function(){
		var checked = $(this).prop('checked');
		$(groupSelector).each(function(){
			var displayed=$(this).parent().parent().css('display');
			var disabled = $(this)[0].disabled;
			if(displayed == null || displayed !== "none" && !disabled){
				$(this).prop('checked',reverse ? !$(this).prop('checked') : checked );
			}
		});
		if(selectAllId != null && selectAllId.length > 0){
			var isSelected=isSelectAll(groupSelector);
			if(isSelected != null){
				$("#"+selectAllId).prop('checked',isSelected);
			}
		}
	})
}

//是否全选
function isSelectAll(groupSelector){
		var selects = false;
		var unSelects = false;
		$(groupSelector).each(function(){
			if($(this).prop('checked')){
				selects = true;
			}else{
				unSelects = true;
			}
		})
		if(selects && unSelects){
			return null;
		}else{
			return selects;
		}
}
//初始化全选设置
function initSelectAll(checkSelector){
    $(document).ready(function(){
        $('#dynamicTable_paginate').bind('click',function(e){
            var target=e.target || e.srcElement;
            if(target.nodeName === 'A'){
                $(checkSelector).prop('checked',false);
                $("#dynamicTable input[type='checkbox']").each(function(){
                    $(this).prop('checked',false);
                })
            }
        })
    })
}
//调整数据显示条数后初始化全选设置
function refreshSelectAllSet(dataLenSelector,checkSelector){
	$(dataLenSelector).change(function(){
		$(checkSelector).prop('checked',false);
	})
}function resetTilePackagePath(obj) {
	var tilePackagePath = readFilePath('tpkFileBrowser');
	tilePackagePath = tilePackagePath.replace('//', '/');
	$(obj).siblings("#tpkFilePath").val(tilePackagePath);
}

function setTilePackagePath(connStr,container) {
	var parent="";
	if(container){
		parent=container+" ";
	}
	$(parent+"#tpkFilePath").val(connStr);
}
function setTmpFile(tmpFile,container) {
	var parent="";
	if(container){ 
		parent=container+" ";
	}
	if(tmpFile){
		$(parent+"#tmpFile").attr('checked', 'checked');
	}
}
function selectTPKFile(obj){
	var tpkFilePath=$(obj).parents("#remoteTilePackageSystem").find("#tpkFilePath").val();
	selectFileByRemote("tpk",function(tpkPath){
		$(obj).parents("#remoteTilePackageSystem").find("#tpkFilePath").val(tpkPath);
	},tpkFilePath);
}
function getTPKConnectString(container) {
	var parent="";
	if(container){
		parent=container+" "
	}
	var result = $(parent+'#tpkFilePath').val();
	if (result != "" && !isFullPath(result)) {
		SuperMapServer.Dialog.alert(publishServiceRes.securityWarings);
		return null;
	}
	if (!isTPK(result)) {
		return null;
	}
	return result;
}

function getTmpFile(container) {
	var parent="";
	if(container){
		parent=container+" "
	}
	var result = $(parent+'#tmpFile').is(":checked");
	return result;
}

function tpkBrowseLocally(obj){
	$(obj).parent().siblings("#tpkFileBrowser").attr("disabled",false);
	$(obj).parent().siblings("#tpkFileBrowser").click();
}function resetVectorTilePackagePath(obj) {
	var vectorTilePackagePath = readFilePath('vtpkFileBrowser');
	vectorTilePackagePath = vectorTilePackagePath.replace('//', '/');
	$(obj).siblings("#vtpkFilePath").val(vectorTilePackagePath);
}

function setVectorTilePackagePath(connStr,container) {
	var parent="";
	if(container){
		parent=container+" ";
	}
	$(parent+"#vtpkFilePath").val(connStr);
}
function selectVTPKFile(obj){
	var vtpkFilePath=$(obj).parents("#remoteVectorTilePackageSystem").find("#vtpkFilePath").val();
	selectFileByRemote("vtpk",function(vtpkPath){
		$(obj).parents("#remoteVectorTilePackageSystem").find("#vtpkFilePath").val(vtpkPath);
	},vtpkFilePath);
}
function getVTPKConnectString(container) {
	var parent="";
	if(container){
		parent=container+" "
	}
	var result = $(parent+'#vtpkFilePath').val();
	if (result != "" && !isFullPath(result)) {
		SuperMapServer.Dialog.alert(publishServiceRes.securityWarings);
		return null;
	}
	if (!isVTPK(result)) {
		return null;
	}
	return result;
}

function vtpkBrowseLocally(obj){
	$(obj).parent().siblings("#vtpkFileBrowser").attr("disabled",false);
	$(obj).parent().siblings("#vtpkFileBrowser").click();
}jQuery.cookie=function(name,value,options){if(typeof value!='undefined'){options=options||{};if(value===null){value='';options.expires=-1}var expires='';if(options.expires&&(typeof options.expires=='number'||options.expires.toUTCString)){var date;if(typeof options.expires=='number'){date=new Date();date.setTime(date.getTime()+(options.expires*24*60*60*1000))}else{date=options.expires}expires='; expires='+date.toUTCString()}var path=options.path?'; path='+(options.path):'';var domain=options.domain?'; domain='+(options.domain):'';var secure=options.secure?'; secure':'';document.cookie=[name,'=',encodeURIComponent(value),expires,path,domain,secure].join('')}else{var cookieValue=null;if(document.cookie&&document.cookie!=''){var cookies=document.cookie.split(';');for(var i=0;i<cookies.length;i++){var cookie=jQuery.trim(cookies[i]);if(cookie.substring(0,name.length+1)==(name+'=')){cookieValue=decodeURIComponent(cookie.substring(name.length+1));break}}}return cookieValue}};/**/
SuperMapServer.TileSourceInfoConfig = function(container){
	this.container=container+" ";
	this.groupIndex = 0;
	this.fdhtGroupsDialogIsEdit = false;
	this.currentEditGroupIndex=-1;
	this.fdhtGroups = [];
	this.fdhtGroups_abandonIndexs = [];
	this.outputPath = "/home/SuperMap/supermap-iserver-10.1.0-linux64/webapps/iserver/output";
	this.v5TempOutPutPath = this.outputPath+"/cache";
	this.sqliteTempOutPutPath = this.outputPath+"/sqlite";
	this.fdhtGroupsDialogId = null;
	this.$fdhtGroupsDialog = null;
	this.ugcv5SCIFileHandler = null;//function(scifile)
	this.tileSourceChangedHandler = null;//function()
	this.tileStorages=null;
	this.tileStoragesUrl = getIServerUrl()+"/manager/storages.json";
};
SuperMapServer.TileSourceInfoConfig.prototype = {
	init:function(){
		this.$fdhtGroupsDialog = $(this.container+"#fdhtGroupsDialog");
		this.fdhtGroupsDialogId = this.trimAll(this.container)+"_"+this.$fdhtGroupsDialog.attr("id");
		this.$fdhtGroupsDialog.attr("id",this.fdhtGroupsDialogId)
		var oldHelpLink=$(this.container+'#pageHelp').attr('href');
		$(this.container+'#pageHelp').attr('href',oldHelpLink+this.container+"#Server_Service_Management/CacheConfig/distributedCache.htm#prepareCacheStorage");
		this.loadPage();
		this.initEvents();
		var $isReplicationSetLabel = $(this.container+"#isReplicationSetLabel");
		var replicationSetTip = $isReplicationSetLabel.attr("title");
		$isReplicationSetLabel.removeAttr("title");
		enableToolTip($isReplicationSetLabel ,replicationSetTip,"top");
		$(this.container+"#mbtilesUTFGridSVtilesStoreConfig #outputPath").val(this.sqliteTempOutPutPath);
	},
	initEvents:function(){
		var me = this;
		this.$fdhtGroupsDialog.dialog({
			autoOpen : false,
			width : 370,
			minWidth : 300,
			modal : true,
			position : 'center',
			resizable : false
		});

		$('#hostTip').hide();
		$ ('#mongoDBServer').bind("input propertychange", function(){
			var mongdbServer = $(this).val();
			if(mongdbServer.indexOf("localhost")!=-1){
				$('#hostTip').show();
			}else{
				$('#hostTip').hide();
			}
		});

		$(this.container+"#fastdfsStoreConfig #addTracker").click(function() {
			$(me.container+"#fastdfsStoreConfig #tracker").focus();
			var value=$(me.container+"#fastdfsStoreConfig #tracker").val();
			//验证value 是否为合法的IP+端口
			var msg = me.validateIPwithPort(value);
			if(msg.succeed == true){
				me.addFDSTrackerToUI(value);
			}else{
				SuperMapServer.Dialog.alert(msg.error);
			}
		});
		$(this.container+"#fastdfsStoreConfig #delTracker").click(function() {
			$(me.container+"#fastdfsStoreConfig #fdfsTrackers option:selected").remove();
			me.tileSoucheChange();
		});

		$(this.container+'#addGroup').click(function() {
			var addGroupDialogTitle = TileServerRes.addFDHTGroup + me.groupIndex;
			me.$fdhtGroupsDialog.find("#groupElement").attr("value","");
			me.$fdhtGroupsDialog.find("#fdhtGroupRow").empty();
			//打开前，标识 fdhtGroupsDialog  为添加（而非编辑）的对话框
			me.fdhtGroupsDialogIsEdit = false;
			me.$fdhtGroupsDialog.dialog("option","title",addGroupDialogTitle);
			me.$fdhtGroupsDialog.dialog("option","position",[550,400]);
			me.$fdhtGroupsDialog.dialog('open');
			me.$fdhtGroupsDialog.find('#groupElement')[0].blur();
			return false;
		});

		this.$fdhtGroupsDialog.find("#addGroupElement").click(function() {
			me.$fdhtGroupsDialog.find("#groupElement").focus();
			var value=me.$fdhtGroupsDialog.find("#groupElement").val();
			//验证value 是否为合法的IP+端口
			var msg = me.validateIPwithPort(value);
			if(msg.succeed == true){
				me.addFDSGroupToUI(value);
			}else{
				SuperMapServer.Dialog.alert(msg.error);
			}
		});
		this.$fdhtGroupsDialog.find("#delGroupElement").click(function() {
			me.$fdhtGroupsDialog.find("#fdhtGroupRow option:selected").remove();
		});
		this.$fdhtGroupsDialog.find('.dialogOK').click(function() {
			//点击OK时，赋fdhtGroupRow多选框的值给fdhtGroups[groupIndex]
			var groupArray = $.makeArray(me.$fdhtGroupsDialog.find('#fdhtGroupRow > option'));
			groupArray = $.map(groupArray, function(element){ return element.value;});
			if(groupArray == null || groupArray.length == 0){
				SuperMapServer.Dialog.alert(TileServerRes.pleaseAddFDHTGroup);
				return;
			}
			if(true == me.fdhtGroupsDialogIsEdit){
				//编辑时的逻辑
				me.fdhtGroups[currentEditGroupIndex] = groupArray;
			} else {
				//添加时的逻辑
				me.addGroupArrayToUI(groupArray);

			}
			me.$fdhtGroupsDialog.dialog('close');
			return false;
		});
		me.$fdhtGroupsDialog.find('#dialogCancelForfdhtGroupsDialog').click(function() {
			me.$fdhtGroupsDialog.dialog('close');
		});

		$(this.container+"#mongoDBStoreConfig #addMongoDBServer").click(function() {
			$(me.container+"#mongoDBStoreConfig #mongoDBServer").focus();
			var value=$(me.container+"#mongoDBStoreConfig #mongoDBServer").val();
			//验证value 是否为合法的IP+端口
			var msg = me.validateIPwithPort(value);
			if(msg.succeed == true){
				me.addMongoDBAddressToUI(value);
			}else{
				SuperMapServer.Dialog.alert(msg.error);
			}
		});
		$(this.container+"#mongoDBStoreConfig #delMongoDBServer").click(function() {
			$(me.container+"#mongoDBStoreConfig #mongoDBServers option:selected").remove();
		});

		$(this.container+"#mbtilesUTFGridSVtilesStoreConfig #outputPath").change(function(){
			var tileSourceType = $(me.container+"#tileSourceType").val();
			if("SMTiles" == tileSourceType||"SVTiles" == tileSourceType||"UTFGrid" == tileSourceType){
				me.sqliteTempOutPutPath = $(this.container+"#outputPath").val();
			}else if("UGCV5" == tileSourceType){
				me.v5TempOutPutPath = $(this.container+"#outputPath").val();
			}
		});



		$(this.container+"#tileSourceType").change(function() {
			var tileSourceType = $(me.container+"#tileSourceType").val();
			$(["UGCV5","MongoDB","OTS","FastDFS","UGCV5Tileset","SMTilesTileset","GDPTileset","LocalCacheOSGBTileset","LocalCacheTerrainTileset"]).each(function(index,type){
				if(type==tileSourceType){
					if($(me.container+"."+type)){
						$(me.container+"."+type).show();
					}
				}else{
					if($(me.container+"."+type)){
						$(me.container+"."+type).hide();
					}
				}
			});
			if("SMTiles"==tileSourceType||"UTFGrid"==tileSourceType||"SVTiles"==tileSourceType){
				$(me.container+"#mbtilesUTFGridSVtilesStoreConfig").show();
			}else{
				$(me.container+"#mbtilesUTFGridSVtilesStoreConfig").hide();
			}
			me.tileSoucheChange();
		});
		$(this.container+"#isReplicationSet").change(function(){
			if($(this)[0].checked){
				$(".replicationSet").show();
			}else{
				$(".replicationSet").hide();
			}
		});
		$(this.container+"#browserUGCSCIFile").click(function(){//浏览UGCV5缓存目录
			selectFileByRemote("sci|inf",function(sciFile){
				var index = sciFile.lastIndexOf("/");
				if(index<0){
					index = sciFile.lastIndexOf("\\");
				}
				if(index>0){
					var outputPath = sciFile.substring(0,index);
					$(me.container+"#ugcV5OutputPath").val(outputPath);
					if(me.ugcv5SCIFileHandler){
						me.ugcv5SCIFileHandler(sciFile);
					}
				}
			},$(me.container+"#ugcV5OutputPath").val());
		});
		$(this.container+"#ugcV5OutputPath").blur(function(){
			me.tileSoucheChange();
		});
		$(this.container+"#mongoDBServer,#mongoDBUsername,#mongoDBPassword,#mongoDBPassword").change(function(){
			if(!$(me.container+"#isReplicationSet").is(":checked")){
				me.tileSoucheChange();
			}
		});
		$(this.container+"#tileSourceType").change(function(){
			me.refreshStorageByTileSourceType($(this).val());
		});
		$(this.container+"#storageSelectDiv #storagesSelect").change(function(){
			var storageId = $(this).val();
			if(!storageId){
				me.setInputDisable(false);
				if(me.providerConfig){
					var tileSourceInfo = $.extend({"type":$(me.container+"#tileSourceType").val()},me.providerConfig);
					me.updateTileSourceInfoToUI(tileSourceInfo);
					me.tileSoucheChange();
					return;
				}
				me.clear($(me.container+"#tileSourceType").val());
				me.tileSoucheChange();
				return;
			}
			me.updateTileSourceInfoToUI(me.getTileSourceInfoById(storageId));
			me.setInputDisable(true);
			me.tileSoucheChange();
			if(me.container == " #tilesetSelectView #tileSourceInfoDiv "){
				SuperMapServer.Manager.AddTilesetUpdateJob.prototype._refreshTilesets();
			}
		});
		$(this.container+"#ugcv5TilesetConfig #broswerConfigFileBtn").on("click",function(){
			selectFileByRemote("sci|inf",function(sciFile){
				$(me.container+"#ugcV5ConfigFilePath").val(sciFile);
			},$(me.container+"#ugcv5TilesetConfig #ugcV5ConfigFilePath").val());
		});

		$(this.container+"#LocalCacheOSGBTilesetConfig #broswerConfigFileBtn").on("click",function(){
			selectFileByRemote("scp",function(sciFile){
				$(me.container+"#LocalCacheOSGBTilesetConfig #OSGBFilePath").val(sciFile);
				refreashBounds();
			},$(me.container+"#LocalCacheOSGBTilesetConfig #OSGBFilePath").val());
		});
		
		$(this.container+"#LocalCacheTerrainTilesetConfig #broswerConfigFileBtn").on("click",function(){
			selectFileByRemote("sct",function(sciFile){
				$(me.container+"#LocalCacheTerrainTilesetConfig #TerrainFilePath").val(sciFile);
				refreashBounds();
			},$(me.container+"#LocalCacheTerrainTilesetConfig #TerrainFilePath").val());
		});

		$(this.container+"#smtilesTilesetConfig #broswerSMTilesFileBtn").on("click",function(){
			selectFileByRemote("smtiles|mbtiles",function(sciFile){
				$(me.container+"#smtilesTilesetConfig #smtilesFilePath").val(sciFile);
				me.tileSoucheChange();
			},$(me.container+"#smtilesTilesetConfig #smtilesFilePath").val());
		});
		this.refreshStorageByTileSourceType($(this.container+"#tileSourceType").val());
		if(me.container == " #tilesetSelectView #tileSourceInfoDiv "){
			SuperMapServer.Manager.AddTilesetUpdateJob.prototype._refreshTilesets();
		}
	},
	addGroupArrayToUI:function(groupArray){
		var me =this;
		this.fdhtGroups[me.groupIndex] = groupArray;
		//界面上显示Group的名字
		var onclickStr = 'onclick="editfdhtGroup(' + me.groupIndex + ');"' ;
		var fdhtGroupHtml = '<li id='+me.groupIndex +'><a><span class="edit" >Group'+ me.groupIndex +'</span>   <span class="remove-label" title="'+TileServerRes.remove+'"></span></a></li>';
		//var fdhtGroupHtml = '<li id="3"><a class = "label">Group3 <span class="remove-label" title="删除"></span></a></li>'
		$(this.container+'#fdhtGroups').append(fdhtGroupHtml).find("span .remove-label");
		$(this.container+'#fdhtGroups li#'+me.groupIndex+" a .remove-label").click(function(){
			me.delLabel($(this)[0]);
		});
		$(me.container+'#fdhtGroups li#'+me.groupIndex+' a .edit').click(function(){
			var grouptIndex = parseInt($(this).parents("li").attr("id"));
			me.editfdhtGroup(grouptIndex);
		});
		this.groupIndex++;
		this.tileSoucheChange();
	},
	initGroupElementOptions:function(cGroupIndex){
		var groupElements = this.fdhtGroups[cGroupIndex]
		this.$fdhtGroupsDialog.find("#fdhtGroupRow").empty();
		if(groupElements && groupElements.length && groupElements.length > 0){
			var fdhtGroupRow = this.$fdhtGroupsDialog.find("#fdhtGroupRow")[0];
			for(var i = 0 ;i < groupElements.length; i++){
				fdhtGroupRow.options.add(new Option(groupElements[i], groupElements[i]));
			}
		}
	},
	editfdhtGroup:function(cGroupIndex){
		var editGroupDialogTitle = TileServerRes.editFDHTGroup + cGroupIndex;
		this.fdhtGroupsDialogIsEdit = true;
		this.currentEditGroupIndex = cGroupIndex;
		this.initGroupElementOptions(cGroupIndex);
		this.$fdhtGroupsDialog.dialog("option","title",editGroupDialogTitle).dialog('open');
	},
	trimAll:function(string){
		return string.replace(/\s/g,"");
	},
	loadPage:function(){
		var me=this;
		//从cookie中读取 fastDFS 配置信息
		var tracker_config = $.cookie('tracker_config');
		var group_config = $.cookie('group_config');

		var oTSStoreTip = $(this.container+"#instanceNameLable").attr("title");
		$(this.container+"#instanceNameLable").removeAttr("title");
		enableToolTip($(this.container+"#instanceNameLable"), oTSStoreTip, "top");

		var otsNodeNameTip = $(this.container+"#otsNodeNameLable").attr("title");
		$(this.container+"#otsNodeNameLable").removeAttr("title");
		enableToolTip($(this.container+"#otsNodeNameLable"), otsNodeNameTip, "top");

		var fromPublicTip = $(this.container+"#fromPublicLable").attr("title");
		$(this.container+"#fromPublicLable").removeAttr("title");
		enableToolTip($(this.container+"#fromPublicLable"), fromPublicTip, "top");

		var mongodbServerTip = $(this.container+"#mongodbServerLable").attr("title");
		$(this.container+"#mongodbServerLable").removeAttr("title");
		enableToolTip($(this.container+"#mongodbServerLable"), mongodbServerTip, "top");

		var fastDFSTip = $(this.container+"#fastDFSTrackerLabel").attr("title");
		$(this.container+"#fastDFSTrackerLabel").removeAttr("title");
		enableToolTip($(this.container+"#fastDFSTrackerLabel"), fastDFSTip, "top");

		var fDHTGroupsTip = $(this.container+"#FDHTGroupsLable").attr("title");
		$(this.container+"#FDHTGroupsLable").removeAttr("title");
		enableToolTip($(this.container+"#FDHTGroupsLable"), fDHTGroupsTip, "top");

		var OSGBFilePathTip = $(this.container+"#OSGBFilePathLabel").attr("title");
		$(this.container+"#OSGBFilePathLabel").removeAttr("title");
		enableToolTip($(this.container+"#OSGBFilePathLabel"), OSGBFilePathTip, "top");
		
		var TerrainFilePathTip = $(this.container+"#TerrainFilePathLabel").attr("title");
		$(this.container+"#TerrainFilePathLabel").removeAttr("title");
		enableToolTip($(this.container+"#TerrainFilePathLabel"), TerrainFilePathTip, "top");

		var iedgeAddressTip = $(this.container+"#iedgeAddressLabel").attr("title");
		$(this.container+"#iedgeAddressLabel").removeAttr("title");
		enableToolTip($(this.container+"#iedgeAddressLabel"), iedgeAddressTip, "top");

		var serverNameTip = $(this.container+"#serverNameLabel").attr("title");
		$(this.container+"#serverNameLabel").removeAttr("title");
		enableToolTip($(this.container+"#serverNameLabel"), serverNameTip, "top");

		var boundsTip = $(this.container+"#boundsLabel").attr("title");
		$(this.container+"#boundsLabel").removeAttr("title");
		enableToolTip($(this.container+"#boundsLabel"), boundsTip, "top");

		//赋值，并在界面上显示
		if(null != tracker_config && null != group_config){
			var trackers =tracker_config.split(";");
			for (var i=0; i< trackers.length; i++){
				$(this.container+"#fdfsTrackers")[0].options.add(new Option(trackers[i], trackers[i]));
			}

			var groupArray = $.makeArray($(this.container+'#fdhtGroupRow > option'));
			groupArray = $.map(groupArray, function(element){ return element.value;});
			var groups = group_config.split(";");

			for(var i=0; i < groups.length; i++){
				//给Group实际赋值
				this.fdhtGroups[i] = groups[i].split(",");
				//界面上显示Group的名字
				var fdhtGroupHtml = '<li id='+ i +'><a><span class="edit" >Group'+ i +'</span>   <span class="remove-label" title="'+TileServerRes.remove+'"></span></a></li>';
				$(this.container+'#fdhtGroups').append(fdhtGroupHtml);
				$(this.container+'#fdhtGroups li#'+i+" a .remove-label").click(function(){
					me.delLabel($(this)[0]);
				});
				$(this.container+'#fdhtGroups li#'+i+" a .edit").click(function(){
					var index =$(this).parents("li").attr("id")
					me.editfdhtGroup(index);
				});
			}
			this.groupIndex = i;
		}
	},
	validateIPwithPort:function(value){
		var msg = {};
		msg.succeed = true;
		//发布或创建存储的时候都应该允许含有localhost的ip， ":"应该出现1次，且":"不应是结尾字符
		// 为了兼容IPV6，允许出现多次":"
		if(value == ""){
			msg.succeed = false;
			msg.error=TileServerRes.ipCannotBeNull;
		}else if(value.match(new RegExp(":",'g'))==null
				||value.indexOf(":")==value.length-1){
			msg.succeed = false;
			msg.error=TileServerRes.pleaseEnterAvailableIpWithHost;
		}
		return msg;
	},
	getTileSourceInfo:function (){
		var me = this;

		// var tileSourceType = $(this.container+"#3DtileSourceType").val();

		var tileSourceType = $(this.container+"#tileSourceType").val();
		var tileSourceInfo = {};
		switch(tileSourceType){
		case "UGCV5":case "SMTiles":case "UTFGrid":case "SVTiles":{
			tileSourceInfo.outputPath = $(this.container+"#ugcV5OutputPath").val();
			break;
		}
		case "FastDFS":{
			tileSourceInfo.fdfsTrackers = [];
			var fdfsTrackersElement =$(this.container+"#fdfsTrackers")[0];
			for(var j =0; j < fdfsTrackersElement.length; j++) {
				tileSourceInfo.fdfsTrackers.push(this.trimAll(fdfsTrackersElement.options[j].value));
			}
			//storeConfig.fdhtGroups = fdhtGroups;
			tileSourceInfo.fdhtGroups = $.grep(this.fdhtGroups,function(val,key){
				if($.inArray(key,me.fdhtGroups_abandonIndexs)>=0){
					return false;
				}else{
					return true;
				}
			});
			break;
		}
		case "Hazelcast":{
			break;
		}
		case "MongoDB":{
			var me = this;
			initServerAddress(me,tileSourceInfo);
			tileSourceInfo.username = $(this.container+"#mongoDBUsername").val();
			tileSourceInfo.password = $(this.container+"#mongoDBPassword").val();
			tileSourceInfo.database = $(this.container+"#mongoDBDatabase").val();
			break;
		}
		case "OTS":{
			tileSourceInfo.instanceName = $(this.container+"#instanceName").val();
			tileSourceInfo.nodeName = $(this.container+"#otsNodeName").val();
			tileSourceInfo.fromPublic = $(this.container+"#fromPublic").prop("checked");
			tileSourceInfo.accessKeyId = $(this.container+"#accessKeyId").val();
			tileSourceInfo.accessKeySecret = $(this.container+"#accessKeySecret").val();
			break;
		}
		case "UGCV5Tileset":{
			var filePath = $(this.container+"#ugcv5TilesetConfig #ugcV5ConfigFilePath").val();
			tileSourceInfo.outputPath = getFileDir(filePath);
			tileSourceInfo.tilesetIdentifier = filePath;
			tileSourceType="UGCV5";
			break;
		}
		case "LocalCacheOSGBTileset":{
			var filePath = $(this.container+"#LocalCacheOSGBTilesetConfig #OSGBFilePath").val();
			tileSourceInfo.outputPath = filePath;
			tileSourceInfo.tilesetIdentifier = filePath;
			tileSourceType="OSGB";
			break;
		}
		case "LocalCacheTerrainTileset":{
			var filePath = $(this.container+"#LocalCacheTerrainTilesetConfig #TerrainFilePath").val();
			tileSourceInfo.outputPath = filePath;
			tileSourceInfo.tilesetIdentifier = filePath;
			tileSourceType="TERRAIN";
			break;
		}
		case "SMTilesTileset":{
			var filePath = $(this.container+"#smtilesTilesetConfig #smtilesFilePath").val();
			tileSourceInfo.outputPath = getFileDir(filePath);
			tileSourceInfo.tilesetIdentifier = filePath;
			tileSourceType="SMTiles";
			break;
		}
		case "GDPTileset":{
			var dirPath = $(this.container+"#gdpTilesetConfig #gdpDirPath").val();
			tileSourceInfo.directoryPath = dirPath;
			tileSourceInfo.tilesetIdentifier = dirPath;
			tileSourceInfo.cacheVersion=$(this.container+"#gdpTilesetConfig #gdpCacheVersion").val();
			tileSourceType="GDP";
			break;
		}
		default:{
			SuperMapServer.Dialog.alert("tileSourceType " + tileSourceType + " is not supported")
			return null;
		}
		}
		tileSourceInfo.type = tileSourceType;
		//将FastDFS信息写入Cookie
		if("FastDFS" == tileSourceInfo.type){
			$.cookie('tracker_config', tileSourceInfo.fdfsTrackers.join(';'));
			$.cookie('group_config', tileSourceInfo.fdhtGroups.join(';'));
		}
		return tileSourceInfo;
	},
	addFDSTrackerToUI:function(tracker){
		var valueNoSpace = this.trimAll(tracker);
		$(this.container+"#fdfsTrackers")[0].options.add(new Option(valueNoSpace, valueNoSpace));
		$(this.container+"#fastdfsStoreConfig #tracker").prop("value","");
		this.tileSoucheChange();
	},
	addFDSGroupToUI:function(value){//增加一条group信息到UI上
		var valueNoSpace = this.trimAll(value);
		this.$fdhtGroupsDialog.find("#fdhtGroupRow")[0].options.add(new Option(valueNoSpace, valueNoSpace));
		this.$fdhtGroupsDialog.find("#groupElement").attr("value","");
	},
	addMongoDBAddressToUI:function(value){
		var valueNoSpace = this.trimAll(value);
		$(this.container+"#mongoDBServers")[0].options.add(new Option(valueNoSpace, valueNoSpace));
		$(this.container+"#mongoDBStoreConfig #mongoDBServer").prop("value","");
		this.tileSoucheChange();
	},
	delLabel:function (param){
		var li_del = param.parentNode.parentNode;
		var id = li_del.getAttribute("id");
		this.fdhtGroups_abandonIndexs.push(parseInt(id));
		var ul = li_del.parentNode;
		ul.removeChild(li_del);
	},
	validateParam:function () {
		var msg = {};
		msg.succeed = true;
		var tileSourceTypeSel = $(this.container+"#tileSourceType")[0];
		var tileSourceType = tileSourceTypeSel.options[tileSourceTypeSel.selectedIndex].value;
		if(tileSourceType == "OTS"){
			var otsinstanceName = $(this.container+"#instanceName").val();
			var otsnodeName = $(this.container+"#otsNodeName").val();
			var otsaccessKeyId = $(this.container+"#accessKeyId").val();
			var otsaccessKeySecret = $(this.container+"#accessKeySecret").val();
			if(!otsinstanceName){
				msg.succeed = false;
				msg.error = distributedCacheRes.pleaseAddOTSInstanceName;
			}else if(!otsnodeName){
				msg.succeed = false;
				msg.error = distributedCacheRes.pleaseAddOTSNodeName;
			}else if(!otsaccessKeyId){
				msg.succeed = false;
				msg.error = distributedCacheRes.pleaseAddOTSAccessKeyId;
			}else if(!otsaccessKeySecret){
				msg.succeed = false;
				msg.error = distributedCacheRes.pleaseAddOTSAccessKeySecret;
			}
		}
		if(tileSourceType == "FastDFS"){
			var trackers = $(this.container+"#fdfsTrackers")[0];
			if(trackers.length < 1) {
				msg.succeed = false;
				msg.error = distributedCacheRes.pleaseAddFDFSTrackers;
				return msg;
			}
			var fdhtGroups = $(this.container+"#fdhtGroups li");
			if(fdhtGroups.length < 1) {
				msg.succeed = false;
				msg.error = distributedCacheRes.pleaseAddFDHTGroups;
				return msg;
			}
		}
		if(tileSourceType == "MongoDB"){
			if($(this.container+ "#isReplicationSet")[0].checked){
				var mongoDBServers = $(this.container+"#mongoDBServers")[0];
				if(mongoDBServers.length < 1) {
					msg.succeed = false;
					msg.error = distributedCacheRes.pleaseAddMongoDBServerAdresses;
					return msg;
				}
			}else{
				msg = this.validateIPwithPort($(this.container+"#mongoDBServer")[0].value);
				return msg;
			}
		}
		if(tileSourceType=="UGCV5"){
			var outputPath = $(this.container+"#ugcV5OutputPath").val();
			if($.trim(outputPath)==""){
				msg.succeed = false;
				msg.error = distributedCacheRes.pleaseInputOutputPath;
			}
		}
		if(tileSourceType == "SMTiles"||tileSourceType == "SVTiles"||tileSourceType == "UTFGrid"){
			var outputPath = $(this.container+"#outputPath").val();
			if($.trim(outputPath)==""){
				msg.succeed = false;
				msg.error = distributedCacheRes.pleaseInputOutputPath;
			}
		}
		if(tileSourceType=="UGCV5Tileset"){
			var filePath = $(this.container+"#ugcv5TilesetConfig #ugcV5ConfigFilePath").val();
			if($.trim(filePath)==""){
				msg.succeed=false;
				msg.error = TilesetSelectResource.alertMsgNullUGCV5ConfigFile;
			}
		}
		if(tileSourceType=="LocalCacheOSGBTileset"){
			var filePath = $(this.container+"#LocalCacheOSGBTilesetConfig #OSGBFilePath").val();
			if($.trim(filePath)==""){
				msg.succeed=false;
				msg.error = "文件内容不能为空";
			}
		}
		if(tileSourceType=="LocalCacheTerrainTileset"){
			var filePath = $(this.container+"#LocalCacheTerrainTilesetConfig #TerrainFilePath").val();
			if($.trim(filePath)==""){
				msg.succeed=false;
				msg.error = "文件内容不能为空";
			}
		}
		if(tileSourceType=="SMTilesTileset"){
			var filePath = $(this.container+"#smtilesTilesetConfig #smtilesFilePath").val();
			if($.trim(filePath)==""){
				msg.succeed=false;
				msg.error = TilesetSelectResource.alertMsgNullSMTileFile;
			}
		}
		return msg;
	},
	clear:function(tileSourceType){
		if("FastDFS"==tileSourceType){
			$(this.container+"#fdhtGroups").html("");
			$(this.container+"#fdfsTrackers").html("");
			this.fdhtGroups = [];
			this.fdhtGroups_abandonIndexs = [];
			this.groupIndex = 0;

		}else if("MongoDB"==tileSourceType){
			$(this.container+"#mongoDBServers").html("");
			$(this.container+"#isReplicationSet").prop("checked",false).change();
			$(this.container+"#mongoDBServer").val("");
		}else if("UGCV5"==tileSourceType){

		}
	},
	setInputDisable:function(isDisable){
		$(this.container+"input").attr("disabled",isDisable);
	},
	updateTileSourceInfoToUI:function(tileSourceInfo){
		this.clear(tileSourceInfo.type);
		switch(tileSourceInfo.type){
		case "UGCV5":{
			$(this.container+"#ugcV5OutputPath").val(tileSourceInfo.outputPath);
			this.tileSoucheChange();
			break;
		}
		case "FastDFS":{
			$(this.container+"#fdfsTrackers").html("");

			for(var i=0;tileSourceInfo.fdfsTrackers&&i<tileSourceInfo.fdfsTrackers.length;i++){
				this.addFDSTrackerToUI(tileSourceInfo.fdfsTrackers[i]);
			}
			for(var i=0;tileSourceInfo.fdhtGroups&&i<tileSourceInfo.fdhtGroups.length;i++){
				this.addGroupArrayToUI(tileSourceInfo.fdhtGroups[i]);
			}
			break;
		}
		case "MongoDB":{
			if(tileSourceInfo.serverAdresses&&tileSourceInfo.serverAdresses.length>=0){
				var me = this;
				updateServerAddress(me,tileSourceInfo);
			}
			$(this.container+"#mongoDBDatabase").val(tileSourceInfo.database);
			$(this.container+"#mongoDBPassword").val(tileSourceInfo.password);
			$(this.container+"#mongoDBUsername").val(tileSourceInfo.username);
			break;
		}
		case "OTS":{
			$(this.container+"#instanceName").val(tileSourceInfo.instanceName);
			$(this.container+"#otsNodeName").val(tileSourceInfo.nodeName);
			$(this.container+"#fromPublic").prop("checked", tileSourceInfo.fromPublic);
			$(this.container+"#accessKeyId").val(tileSourceInfo.accessKeyId);
			$(this.container+"#accessKeySecret").val(tileSourceInfo.accessKeySecret);
			break;
		}
		default:{
			break;
		}
		}
	},
	tileSoucheChange:function(){
		if(this.tileSourceChangedHandler){
			this.tileSourceChangedHandler();
		}
	},
	getTileSourceInfoById:function (id){
		if(this.tileStorages==null){
			this.tileStorages=sendRequestWithResponse("GET",this.tileStoragesUrl);
		}
		for(var i=0;i<this.tileStorages.length;i++){
			if(this.tileStorages[i].id==id){
				return this.tileStorages[i].tileSourceInfo;
			}
		}
		return null;
	},
	refreshStorageByTileSourceType:function(tileSourceType){
		if($(this.container+"#storageSelectDiv").length<0){
			return  ;
		}
		$(this.container+"#storageSelectDiv #storagesSelect").html("");
		var array = this.getTileStorages(tileSourceType);

		for(var i=0;i<array.length;i++){
			$(this.container+"#storageSelectDiv #storagesSelect").append("<option value='"+array[i].id+"'>"+array[i].id+"</option>");
		}
		$(this.container+"#storageSelectDiv #storagesSelect").append("<option value=''></option>");
		if(array&&array.length>0){
			$(this.container+"#storageSelectDiv").show();
			$(this.container+"#storageSelectDiv #storagesSelect").change();
		}else{
			$(this.container+"#storageSelectDiv").hide();
			this.setInputDisable(false);
		}
	},
	getTileStorages:function(tileSourceType){// 根据切片源类型获取不同的切片位置
		if(this.tileStorages==null){
			this.tileStorages=sendRequestWithResponse("GET",this.tileStoragesUrl);
		}
		var result = [];
		for(var i=0;i<this.tileStorages.length;i++){
			if(this.tileStorages[i].tileSourceInfo.type==tileSourceType){
				result.push(this.tileStorages[i]);
			}
		}
		return result;
	}
};

function initServerAddress(me,tileSourceInfo){
	tileSourceInfo.serverAdresses = []
	if($(me.container+"#isReplicationSet")[0].checked){
		var mongoDBServersElement = $(me.container+"#mongoDBServers")[0];
		for(var j =0; j < mongoDBServersElement.length; j++) {
			tileSourceInfo.serverAdresses.push(me.trimAll(mongoDBServersElement.options[j].value));
		}
	}else{
		tileSourceInfo.serverAdresses.push(me.trimAll($(me.container+"#mongoDBServer")[0].value));
	}
}

function updateServerAddress(me,tileSourceInfo){
	if(tileSourceInfo.serverAdresses.length>1){
		for(var i=0;i<tileSourceInfo.serverAdresses.length;i++){
			me.addMongoDBAddressToUI(tileSourceInfo.serverAdresses[i]);
		}
		$(me.container+"#isReplicationSet").prop("checked",true).change();
	}else{
		$(me.container+"#mongoDBServer").val(tileSourceInfo.serverAdresses[0]);
	}
}SuperMapServer.PublishTileset = function(container){
    //	this.tileStoragesUrl = getIServerUrl()+"/manager/storages.json";
    this.tilesetInfosUrl = getIServerUrl()+"/manager/tilesetinfos.json?returnContent=true&isGetRequest=true";
    this.tileStorages = null;
    this.tileSourceInfoForPublish;
    this.mapName=null;
    this.ugcSciFile = null;
    this.tileSetName = null;
    this.tileSourceInfo= null;
    /**
     * 地图切片集集合。
     */
    this.tilesetInfos = [];
    /**
     * 三维切片集集合。
     */
    this.realspaceTilesetInfos = [];
    this.container = container+" ";
    this.tileSourceInfoChanged = false;
    this.forProviderConfig = false;
    this.providerConfig = null;
    this.tilesetCapabilities = null;
} ;

var TilesetCapability={
        Map:"Map",
        Realspace:"Realspace"
    };

var TileSourceView = {
		SMTiles:"SMTiles",
		UGCV5:"UGCV5",
        MongoDB:"MongoDB",
        OTS:"OTS",
        FastDFS:"FastDFS",
        ALL:"all"
};

SuperMapServer.PublishTileset.prototype = {
    init:function(options){
        this.tileSourceInfoForPublish = new SuperMapServer.TileSourceInfoConfig(this.container+"#tileSourceDiv");
        this.tileSourceInfoForPublish.ugcv5SCIFileHandler=this.ugcv5SCIFileHandler;
        this.tileSourceInfoForPublish.init();
        this.initEvents();
        $(this.container+"#storageSelectDiv #storagesSelect").change();
        $("#publishTilesetDiv :text").attr("class","col-xs-4 col-sm-4 col-md-4 col-lg-4");
        $("#publishTilesetDiv :password").attr("class","col-xs-4 col-sm-4 col-md-4 col-lg-4");
        $("#publishTilesetDiv select").attr("class","col-xs-4 col-sm-4 col-md-4 col-lg-4");
        if(options&&options.tilesetCapabilities&&options.tilesetCapabilities.length>0){
            this.tilesetCapabilities = options&&options.tilesetCapabilities;
        }else{
            this.tilesetCapabilities=[TilesetCapability.Map];
        }
    },
    initEvents:function(){
        var me=this;
        $(this.container+"#tileSourceDiv #tileSourceType").change(function(){
            $(me.container+"#mapsSelect").html("");
        });
        $(me.container+"#publishTileset #mapSelector #mapsSelect").change(function(){
            me.showMapInfo();
        });
        $(this.container+"#refreshMaps").click(function(){
            me.refreshTilesets();
            me.tileSourceInfoChanged = false;
        });
    },
    initEventsForProvider:function(){
        var me = this;
        this.tileSourceInfoForPublish.tileSourceChangedHandler = function(){
            me.tileSourceInfoChanged = true;
            $(me.container+"#mapsSelect").html("");
            $(me.container+"#realspaceTilesetSelector .dropdown-menu").html("");
        };
        $(this.container+"#mapsSelect").focus(function(){
            if(me.tileSourceInfoChanged&&$(this).html()==""){
                if(!me.refreshTilesets()){
                    $(this).append("<option value='_all'>"+publishServiceCommonRes.publishAllTileset+"</option>");
                }
                me.tileSourceInfoChanged = false;
            }
        });
        $(this.container+"#realspaceTilesetSelector .dropdown-menu").click(function(){
            if(me.tileSourceInfoChanged&&$(this).html()==""){
                if(!me.refreshTilesets()){
                    $(this).append("<option value='_all'>"+publishServiceCommonRes.publishAllTileset+"</option>");
                }
                me.tileSourceInfoChanged = false;
            }
        });
        me.tileSourceInfoChanged = true;
    },
    refreshTilesets:function(){
        var msg = this.tileSourceInfoForPublish.validateParam();
        if(!msg.succeed){
            SuperMapServer.Dialog.alert(msg.error);
            return false ;
        }
        this.tileSourceInfo = this.tileSourceInfoForPublish.getTileSourceInfo();
        this.initForTilesetSelect();
        return true;
    },
    show:function(){
        this.showTileSourceInfo();
        this.showTilesetSelector();
    },
    showTileSourceInfo:function(){
        $(this.container+"#tileSourceDiv").show();
        $(this.container+"#publishTileset").show();
    },
    showTilesetSelector:function(){
        $(this.container+"#publishTileset").show();

        if(this._tilesetCapabilitiy(TilesetCapability.Map)&&this.tilesetInfos&&this.tilesetInfos.length>0){
            $(this.container+"#mapSelector").show();
        }else{
            $(this.container+"#mapSelector").hide();
        }

        if(this._tilesetCapabilitiy(TilesetCapability.Realspace)&&this.realspaceTilesetInfos&&this.realspaceTilesetInfos.length>0){
            $(this.container+"#realspaceTilesetSelector").show();
        }else{
            $(this.container+"#realspaceTilesetSelector").hide();
        }
    },
    hideTileSourceInfo:function(){
        $(this.container+"#tileSourceDiv").hide();
    },
    hideTilesetSelector:function(){
        $(this.container+"#mapSelector").hide();
        $(this.container+"#realspaceTilesetSelector").hide();
    },
    ugcv5SCIFileHandler:function(sciFile){
        this.ugcSciFile = sciFile;
    },
    initForTilesetSelect:function(){
        $(this.container+"#mapSelect").html("");
        var msg = this.tileSourceInfoForPublish.validateParam();
        if(!msg.succeed){
            SuperMapServer.Dialog.alert(msg.error);
            return false;
        }
        this.tileSourceInfo = this.tileSourceInfoForPublish.getTileSourceInfo();
        var result;
        if("MongoDB" === this.tileSourceInfo.type){
        	result = sendRequestWithResponse("POST",this.tilesetInfosUrl + "&refresh=true",this.tileSourceInfo);
        } else {
        	result = sendRequestWithResponse("POST",this.tilesetInfosUrl,this.tileSourceInfo);
        }
        if(!checkResult(result)){
            return false;
        }
        var _mapTilesetInfos = [];
        var _realspaceTilesetInfos = [];
        _mapTilesetInfos=getMapTilesetInfos(result);
        _realspaceTilesetInfos = getRealspaceTilesetInfos(result);
        // 暂时OTS切片不支持发布为三维地图，这里把三维地图的存储对象_realspaceTilesetInfos置为空
        if(this.tileSourceInfo.type == "OTS"){
            _realspaceTilesetInfos = [];
        }

        var hasContent = (this._tilesetCapabilitiy(TilesetCapability.Map)&&_mapTilesetInfos.length>0)||(this._tilesetCapabilitiy(TilesetCapability.Realspace)&&_realspaceTilesetInfos.length>0);
        if(!hasContent){
            return false;
        }
        this.tilesetInfos = _mapTilesetInfos;
        this.realspaceTilesetInfos = _realspaceTilesetInfos;
        this.updateTilesetInfosToUI();

        return true;
    },
    updateTilesetInfosToUI:function(){
        if(this._tilesetCapabilitiy(TilesetCapability.Map)&&this.tilesetInfos.length>0){
            $(this.container+"#mapSelector").show();
            var $select = $(this.container+"#publishTileset #mapSelector #mapsSelect");
            $select.html("");
            $select.append("<option value='_all'>"+publishServiceCommonRes.publishAllTileset+"</option>");
            $(this.tilesetInfos).each(function(index,tileSetInfo){
                $select.append("<option value='"+index+"'>"+tileSetInfo.metaData.mapName+"</option>");
            });
        }else{
            $(this.container+"#mapSelector").hide();
        }

        if(this._tilesetCapabilitiy(TilesetCapability.Realspace)&&this.realspaceTilesetInfos.length>0){
            $(this.container+"#realspaceTilesetSelector").show();
            var $ul = $(this.container+"#realspaceTilesetSelector .dropdown-menu");
            $ul.html("");
            $(this.realspaceTilesetInfos).each(function(index,tilesetInfo){
                var displayName = tilesetInfo.metaData.mapName;
                if(!displayName){
                    displayName = tilesetInfo.metaData.tilesetName;
                }
                var title = TileTypeRes[tilesetInfo.metaData.tileType];
                var $item = $('<li role="presentation" name="'+tilesetInfo.name+'" class="checkbox"><label role="menuitem"><input type="checkbox" />'+displayName+'</label></li>');
                $item.attr("title",title);
                $ul.append($item);
            });
        }else{
            $(this.container+"#realspaceTilesetSelector").hide();
        }
    },
    getTileSourceInfo:function(){
        if(!this.tileSourceInfo){
            this.tileSourceInfo = this.tileSourceInfoForPublish.getTileSourceInfo();
        }
        return this.tileSourceInfo;
    },
    getTileSetInfos:function(){
    	return this.tilesetInfos;
    },
    getProviderConfig:function(config){
        //只是地图提供者。
        var msg=this.tileSourceInfoForPublish.validateParam();
        if(!msg.succeed){
            SuperMapServer.Dialog.alert(msg.error);
            return null;
        }
        if(!config){
            config= {};
        }
        var tileSourceInfo = this.getTileSourceInfo();
        for(var proName in tileSourceInfo){
            if(proName=="type"){
                continue;
            }
            config[proName] = tileSourceInfo[proName];
        }
        if(this._tilesetCapabilitiy(TilesetCapability.Map)){
            var tilesetIndex = $(this.container+"#publishTileset #mapSelector #mapsSelect").val();
            if(tilesetIndex=="_all"){
                config.mapName=null;
                config.tilesetName=null;
                return config;
            }
            if(tilesetIndex&&tilesetIndex>=0){
                config.mapName = this.tilesetInfos[tilesetIndex].metaData.mapName;
                config.tilesetName = this.tilesetInfos[tilesetIndex].name;
            }
        }
        if(this._tilesetCapabilitiy(TilesetCapability.Realspace)){
            config.tilesetNames = this.getRealspaceTilesetNames();
        }

        return config;
    },
    /**
     * 地图Provider初使化。
     */
    initForProviderConfig:function(providerConfig){
        this.forProviderConfig;
        this.providerConfig = providerConfig;
        this.showTilesetSelector();
        this.showTileSourceInfo();
        this.initEventsForProvider();
        $(this.container+"#refreshMaps").show();
        $(this.container+"#mapsSelect").addClass("col-xs-3");
        $(this.container+"#ugcV5OutputPath").addClass("col-xs-3");
        $(this.container+"#realspaceTilesetSelector .dropdown-menu").addClass("col-xs-3");
        if(!providerConfig){
            this.initForTilesetSelect();
            return ;
        }
        this.tileSourceInfo = $.extend({"type":$(this.container+"#tileSourceType").val()},providerConfig);
        $(this.container+"#tileSourceType").children("[value='"+this.tileSourceInfo.type+"']").attr("selected","selected");
        $(this.container+"#tileSourceType").change();
        this.tileSourceInfoForPublish.updateTileSourceInfoToUI(this.tileSourceInfo);
        $(this.container+"#storageSelectDiv #storagesSelect").val("");
        this.tileSourceInfoForPublish.setInputDisable(false);

        this.initForTilesetSelect();
        if(this._tilesetCapabilitiy(TilesetCapability.Map)){
            this.updateProviderMapNameToUI(providerConfig.mapName,providerConfig.tilesetName);
            $(this.container+"#mapsSelect").change();
        }
        if(this._tilesetCapabilitiy(TilesetCapability.Realspace)){
            this.updateRealspaceTilesetNamesToUI(providerConfig.tilesetNames);
        }

        this.tileSourceInfoChanged = false;
    },
    updateProviderMapNameToUI:function(mapName,tileSetName){
        if(this.isBlank(mapName)&&this.isBlank(tileSetName)){
            return ;
        }
        var $mapSelect = $(this.container+"#publishTileset #mapSelector #mapsSelect");
        if(this.isBlank(tileSetName)){
            $mapSelect.append("<option value='-1' selected='selected'>"+mapName+"</option>");
            return ;
        }
        if(!this.tilesetInfos){
            return ;
        }
        $(this.tilesetInfos).each(function(index,elem){
            if(elem.name==tileSetName){
                $mapSelect.find("option[value='"+index+"']").attr("selected","selected");
                return false;
            }
        });
    },
    updateRealspaceTilesetNamesToUI:function(tilesetNames){
        if(!tilesetNames||tilesetNames.length<0){
            return ;
        }
        var me = this;
        $(tilesetNames).each(function(index,tilesetName){
            $(me.container+"#realspaceTilesetSelector .dropdown-menu li[name='"+tilesetName+"'] input[type='checkbox']").prop("checked",true);
        });
    },
    isBlank:function(string){
        if(string==undefined||string==null){
            return true;
        }
        if($.trim(string)==""){
            return true;
        }
        return false;
    },
    showMapInfo:function(){
        var $mapSelect = $(this.container+"#publishTileset #mapSelector #mapsSelect");
        var tilesetIndex = $mapSelect.val();
        var des = "";
        if(tilesetIndex&&tilesetIndex>=0){
            var metaData = this.tilesetInfos[tilesetIndex].metaData;
            var bounds= [metaData.bounds.left.toFixed(3),metaData.bounds.bottom.toFixed(3),metaData.bounds.right.toFixed(3),metaData.bounds.top.toFixed(3)];
            des+=TileSetDesRes.mapBounds+PunctuationRes.Colon+"["+bounds.join(", ")+"]"+PunctuationRes.Comma;
            des+=TileSetDesRes.format+PunctuationRes.Colon+metaData.tileFormat+PunctuationRes.Comma;
            des+=TileSetDesRes.tileSize+PunctuationRes.Colon+metaData.tileWidth+"x"+metaData.tileHeight+PunctuationRes.Comma;
            des+=TileSetDesRes.transparent+PunctuationRes.Colon+this.booleanToString(metaData.transparent)+PunctuationRes.Comma;
            des+=TileSetDesRes.scalesCount+PunctuationRes.Colon+metaData.scaleDenominators.length+PunctuationRes.Period;
        }
        enableToolTip($mapSelect,des,"left");
    },
    booleanToString:function(value){
        if(value){
            return TileSetDesRes.yes;
        }
        return TileSetDesRes.no;
    },
    switchView:function(view){
        if(view==TileSourceView.SMTiles||view==TileSourceView.UGCV5||view==TileSourceView.MongoDB||view==TileSourceView.FastDFS||view==TileSourceView.OTS){
            $(this.container+"#tileSourceType option[selected='selected']").removeAttr("selected");
            $(this.container+"#tileSourceType option[value='"+view+"']").show().attr("selected","selected").show();
            $(this.container+"#tileSourceType")[0].value=view;
            $(this.container+"#tileSourceTypeParameter").hide();
        } else {
            $(this.container+"#tileSourceType").children().show();
            $(this.container+"#tileSourceTypeParameter").show();
        }
        $(this.container+"#tileSourceType").change();
    },
    _tilesetCapabilitiy:function(value){
        return this.tilesetCapabilities.contains(value);
    },
    /**
     * 是否包含地图内容。
     */
    hasMapContent:function(){
        return this.tilesetCapabilities.contains(TilesetCapability.Map)&&this.tilesetInfos&&this.tilesetInfos.length>0;
    },
    /**
     * 是否包含三维内容 。
     */
    hasRealspaceContent:function(){
        return this.tilesetCapabilities.contains(TilesetCapability.Realspace)&&this.getRealspaceTilesetNames().length>0;
    },
    getRealspaceTilesetNames:function(){
        var names = [];
        var $lis = $(this.container+"#realspaceTilesetSelector .dropdown-menu li");
        $lis.each(function(index,li){
            var $li = $(li);
            if($li.find("input[type='checkbox']").is(":checked")){
                names.push($li.attr("name"));
            }
        });
        return names;
    },
    getOneRealspaceTilesetDisplayedName:function(){
        return $(this.container+"#realspaceTilesetSelector .dropdown-menu li input[type='checkbox']:checked").parent().text();
    }

};

function checkResult(result){
    if(!result||result.succeed==false){
        this.tilesetInfos = null;
        if(!result){
            SuperMapServer.Dialog.alert(publishServiceCommonRes.alertErrorTileSourceInfoConfigError);
        }else{
            SuperMapServer.Dialog.alert(result.error.errorMsg);
        }
        return false;
    }
    if(result.length==0){
        SuperMapServer.Dialog.alert(publishServiceCommonRes.alertErrorNotContainTileSetInTileSourceInfo);
        return false;
    }
    return true;
}
function getMapTilesetInfos(result){
    var _mapTilesetInfos = [];
    for(var i=0;i<result.length;i++){
        var tilesetInfo = result[i];
        if(["Image", "Vector"].contains(tilesetInfo.metaData.tileType)){
            _mapTilesetInfos.push(tilesetInfo);
        }
    }
    return _mapTilesetInfos;
}
function getRealspaceTilesetInfos(result){
    var _realspaceTilesetInfos = [];
    for(var i=0;i<result.length;i++){
        var tilesetInfo = result[i];
        if(["Image","Terrain","RealspaceImage","OSGB","ThreeDTiles"].contains(tilesetInfo.metaData.tileType)){
            _realspaceTilesetInfos.push(tilesetInfo);
        }
    }
    return _realspaceTilesetInfos;
}
function selectGeoPackageFile(obj){
	var geoPackageFilePath=$(obj).parents("#geopkgFileDiv").find("#geopkgConfigFile").val();
	selectFileByRemote("gpkg",function(filePath){
		$(obj).parents("#geopkgFileDiv").find("#geopkgConfigFile").val(filePath);
		isPrjSelectShow();
	},geoPackageFilePath);
}
function getGeoPackageFilePath(container) {
	var parent="";
	if(container){
		parent = container+" "
	}
	var filePath=$(parent+ "#geoPackageDiv #geopkgFileDiv #geopkgConfigFile").val();
	return filePath;
}
function isPrjSelectShow(container){
	var parent="";
	if(container){
		parent = container+" "
	}
	var filePath=$(parent+ "#geoPackageDiv #geopkgFileDiv #geopkgConfigFile").val();
	if(!getGeoPackageType(filePath)||getGeoPackageType(filePath)=="Tiles"){
		$(parent+ "#geoPackageDiv #geopkgPrjDiv").hide();
	}else{
		$(parent+ "#geoPackageDiv #geopkgPrjDiv").show();
	}
}
function getGeoPackageType(filePath) {
	var providerUrl = getRootUrl() + "geopackageinfo.rjson?expected=type&filePath="+filePath;
	var type = sendRequestWithResponse("GET", providerUrl, null);
	if(type.length == 1){
		return type[0];
	}
	return null;
}
function setGeoPackagePath(connStr,container) {
	var parent="";
	if(container){
		parent=container+" ";
	}
	$(parent+"#geoPackageDiv #geopkgFileDiv #geopkgConfigFile").val(connStr);
}
function  setGeoPackageConfig(configValues,container){
	var parent="";
	if(container){
		parent=container+" ";
	}
	$(parent+"#geoPackageDiv #geopkgFileDiv #geopkgConfigFile").val(configValues.filePath);
	$(parent+"#geoPackageDiv #geopkgPrjDiv #prjSelect").append("<option value="+ configValues.defaultMapPrjCoordSys +">"+configValues.defaultMapPrjCoordSys+"</option>");
}
function prjSelectFocus(container){
	var parent="";
	if(container){
		parent=container+" ";
	}
	var filePath = getGeoPackageFilePath(parent);
	var Url = getRootUrl() + "geopackageinfo.rjson?expected=prjcoordsys&filePath="+filePath;
	var prjs = sendRequestWithResponse("GET", Url, null);
	for(var i=0;i<prjs.length;i++){
		if($(parent+"#geoPackageDiv #geopkgPrjDiv #prjSelect option[value="+prjs[i]+"]").length>0){
			continue;
		}
		$(parent+"#geoPackageDiv #geopkgPrjDiv #prjSelect").append("<option value='"+prjs[i]+"'>"+prjs[i]+"</option>");
	}
}/**
 * 三维网络数据集信息前台界面的一个辅助器。 主要负责把三维网络数据集的信息更新到界面上，在前端页面中根据数据集信息选择配置，也不是纯手输入。
 * @param workspacePath 工作空间路径。
 * @param uiContainer 界面元素的容器选择器。
 */
SuperMapServer.Manager.NetWork3DUIAssistant = function(workspacePath,uiContainer){
	var me = this;
	this.workspacePath = workspacePath;
	this.workspaceToolUrl = getRootUrl() + "workspaceTool.json";
	this.$container = $(uiContainer);
	this.fields = [];
	this.nodeFields = [];
	/**
	 * 约定了数据源，数据集，及其它配置的id，所以只需要传uiContainer.
	 */
	this.$container.find("a#weightFieldInfo3Ds").click(function(){
		setTimeout(function(){
			me._replaceToWeightFields();
			},
		500);
	});
}

/**
 * 更新界面元素。 
 */
SuperMapServer.Manager.NetWork3DUIAssistant.prototype.updateUI = function(){
	this._requestDataSourcesToUI();
}

/**
 * 获取工作空间内所有的数据源名，并显示到界面上。
 */
SuperMapServer.Manager.NetWork3DUIAssistant.prototype._requestDataSourcesToUI = function(){
	var me = this;
	var requestUrl = this.workspaceToolUrl+"?workspacePath="+this.workspacePath+"&expected=datasources";
	var datasourceNames = sendRequestWithResponse("GET",requestUrl,null);
	var $datasource = this.$container.find("#datasourceName");
	if(this._replaceToSelect($datasource, datasourceNames)){
		$datasource = this.$container.find("#datasourceName");
		$datasource.change(function(){
			me._requestDatasetsToUI($(this).val());
		});
		$datasource.change();
	}
}

/**
 * 获取工作空间内所有的三维网络数据集名，并显示到界面上。
 */
SuperMapServer.Manager.NetWork3DUIAssistant.prototype._requestDatasetsToUI = function(datasource){
	var me = this;
	var requestUrl = this.workspaceToolUrl+"?workspacePath="+this.workspacePath+"&expected=network3dDatasets&datasourceName="+datasource;
	var datasetNames = sendRequestWithResponse("GET",requestUrl,null);
	var $datasetName = this.$container.find("#datasetName");
	if(this._replaceToSelect($datasetName, datasetNames)){
		$datasetName = this.$container.find("#datasetName");
		$datasetName.change(function(){
			me._requestFieldInfoToUI();
		});
		$datasetName.change();
	}
}

/**
 * 根据数据源以及数据集获取字段信息。
 */
SuperMapServer.Manager.NetWork3DUIAssistant.prototype._requestFieldInfoToUI = function(){
	var datasourceName = this.$container.find("#datasourceName").val();
	var datasetName = this.$container.find("#datasetName").val();
	var requestUrl = this.workspaceToolUrl+ "?workspacePath=" + this.workspacePath + "&datasourceName=" + datasourceName + "&datasetName=" + datasetName + "&expected=fields";
	var fields = sendRequestWithResponse("GET",requestUrl,null);
	
	var requestUrl = this.workspaceToolUrl+ "?workspacePath=" + this.workspacePath + "&datasourceName=" + datasourceName + "&datasetName=" + datasetName + "&expected=fieldsOfChild";
	var nodeFields = sendRequestWithResponse("GET",requestUrl,null);
	
	this.fields = fields;
	this.nodeFields = nodeFields;
	
	this._replaceToSelect(this.$container.find("#edgeIDField"), fields,"SMEDGEID");
	this._replaceToSelect(this.$container.find("#nodeIDField"), nodeFields,"SMNODEID");
	this._replaceToSelect(this.$container.find("#fNodeIDfield"), fields,"SMFNODE");
	this._replaceToSelect(this.$container.find("#tNodeIDField"), fields,"SMTNODE");
	
	if(this._getWeightFields().length==0){
		this.$container.find("a#weightFieldInfo3Ds").click();
	}
	this._replaceToWeightFields();
}

/**
 * 根据字段信息，将权值字段的界面元素替换成可选择的项。
 */
SuperMapServer.Manager.NetWork3DUIAssistant.prototype._replaceToWeightFields = function(){
	if(!this._requestArrayIsRight(this.fields)){
		return ;
	}
	
	/**
	 * 更新权值字段
	 */
	var $weightFields= this._getWeightFields();
	for(var i=0;i<$weightFields.length;i++){
		var $item = $weightFields[i];
		this._replaceToSelect($item, this.fields,"SMLENGTH");
	}
}

/**
 * 获取配置权值字段信息的相关元素。
 */
SuperMapServer.Manager.NetWork3DUIAssistant.prototype._getWeightFields = function(){
	var $array = [];
	/**
	 * 更新权值字段
	 */
	var $inputs= this.$container.find("input");
	for(var i=0;i<$inputs.length;i++){
		var $item = $($inputs[i]);
		var id = $item.attr("id");
		if(!id.indexOf("WeightFieldInfo")==0){//以WeightFieldInfo开始
			continue;
		}
		if(id.indexOf("_name")>0){//名字自己输入，不需要选择。
			continue;
		}
		$array[$array.length] = $item;
	}
	return $array;
}

/**
 * 判断数组是否正确的。
 */
SuperMapServer.Manager.NetWork3DUIAssistant.prototype._requestArrayIsRight = function(obj){
	if(!obj){
		return false;
	}
	if(obj.length==0){
		return false;
	}
	if(obj["error"]){
		return false;
	}
	return true;
}

/**
 * 将界面元素用select元素替换
 * @param $orginObj 被替换的元素。
 * @param array 数据。
 * @returns 是否成功替换为select
 */
SuperMapServer.Manager.NetWork3DUIAssistant.prototype._replaceToSelect = function($orignObj,array,defaultValue){
	if(!this._requestArrayIsRight(array)){
		return false;
	}
	var originValue = $orignObj.val();
	if(!originValue||$.trim(originValue)==""){
		originValue = defaultValue;
	}
	var id=$orignObj.attr("id");
	
	var $newObj = $("<select id='"+id+"' name='"+id+"'></select>");
	$newObj.attr("class",$orignObj.attr("class"));
	$newObj.attr("style",$orignObj.attr("style"));
	for(var i=0;i<array.length;i++){
		var $option = $("<option value='"+array[i]+"'>"+array[i]+"</option>");
		if(this._toLowerCase(array[i])==this._toLowerCase(originValue)){
			$option.attr("selected","selected");
		}
		$newObj.append($option);
	}
	$orignObj.replaceWith($newObj);
	return true;
}

SuperMapServer.Manager.NetWork3DUIAssistant.prototype._toLowerCase = function(str){
	if(!str){
		return "";
	}
	return str.toLowerCase();
}

/**
 * 获取快速发布时的提供者配置。
 */
SuperMapServer.Manager.NetWork3DUIAssistant.prototype.getFacilityAnalyst3DProviderConfigForQuickPublish = function(){
	var setting = {};
	var items = this.$container.find("select,input");
	for(var i=0;i<items.length;i++){
		var $item = $(items[i]);
		var id = $item.attr("id");
		if(id=="WeightFieldInfo"){
			setting.weightFieldInfo3Ds = [{
				name:$item.val(),
				ftWeightField:$item.val(),
				tfWeightField:$item.val()
			}];
			continue;
		}
		setting[id] = $item.val();
	}
	return setting;
}

SuperMapServer.Manager.AGSNetworkServiceManager = function() {
	this.serviceURLCache = "";
	this.response = null;
	enableToolTip($('.configSettings #token'), AGSNetworkRes.Token);
	enableToolTip($('.configSettings #httpReferer'), AGSNetworkRes.HTTPReferer);
}
SuperMapServer.Manager.AGSNetworkServiceManager.prototype.setColSize = function(
		col) {
	var tem = "col-xs-{col} col-sm-{col} col-md-{col} col-lg-{col}";
	$(".configSettings :text").attr('class', tem.replace(/{col}/g, col));
	$(".configSettings select").attr('class', tem.replace(/{col}/g, col));
}
SuperMapServer.Manager.AGSNetworkServiceManager.prototype.bind = function() {
	var me = this;
	$(".configSettings #restServiceRootURL").blur(
			function() {
				var restServiceRootURL = $(
						'.configSettings #restServiceRootURL').val();
				if (restServiceRootURL == me.serviceURLCache) {
					return;
				}
				me.serviceURLCache = restServiceRootURL;
				me.refreashAll();

			});
	$('#networkLink #computerLink').click(function() {
		me.initService();
	})
	$("#networkContent #networkDataset").change(
			function() {
				var datasetName = $("#networkContent #networkDataset").val();
				if (!datasetName) {
					return;
				}
				$('#networkContent #serviceAreaLayer').empty();
				$('#networkContent #closestFacilityLayer').empty();
				$('#networkContent #routeLayer').empty();
				var layers = me.response[datasetName];
				for ( var name in layers) {
					if (layers[name] == "ServiceAreaLayer") {
						$('#networkContent #serviceAreaLayer')[0].options
								.add(new Option(name, name));
					}
					if (layers[name] == "ClosestFacilityLayer") {
						$('#networkContent #closestFacilityLayer')[0].options
								.add(new Option(name, name));
					}
					if (layers[name] == "RouteLayer") {
						$('#networkContent #routeLayer')[0].options
								.add(new Option(name, name));
					}
				}
			});
}
SuperMapServer.Manager.AGSNetworkServiceManager.prototype.initService = function() {
	this.refreashAll();
	var token = $('.configSettings #token').val();
	var HTTPreferer = $('.configSettings #httpReferer').val();
	var url = $('.configSettings #restServiceRootURL').val();
	this.response = this.getNetworkInfo(url, token, HTTPreferer);
	if (!this.response) {
		SuperMapServer.Dialog.alert("Get network service info failed");
		return false;
	}
	if (this.response.succeed == false) {
		SuperMapServer.Dialog.alert(this.response.error.errorMsg);
		return false;
	}
	for ( var dataset in this.response) {
		$('#networkContent #networkDataset')[0].options.add(new Option(dataset,
				dataset));
	}
	$("#networkContent #networkDataset").change();
};
SuperMapServer.Manager.AGSNetworkServiceManager.prototype.refreashAll = function() {
	$('#networkContent #networkDataset').empty();
	$('#networkContent #serviceAreaLayer').empty();
	$('#networkContent #closestFacilityLayer').empty();
	$('#networkContent #routeLayer').empty();
}

SuperMapServer.Manager.AGSNetworkServiceManager.prototype.getNetworkInfo = function(
		restServiceRootURL, token, HTTPreferer) {
	var networkUrl = getRootUrl()
			+ "agsnetworkserviceinfo.rjson?restServiceRootURL="
			+ restServiceRootURL + "&AGSToken=" + token + "&AGSHttpReferer="
			+ HTTPreferer;
	var json = sendRequestWithResponse("GET", networkUrl, null);
	return json;
}
SuperMapServer.Manager.AGSNetworkServiceManager.prototype.getConfigFromUI = function() {
	var setting = {};
	var restServiceRootURL = $('.configSettings #restServiceRootURL').val();
	var token = $('.configSettings #token').val();
	var HTTPreferer = $('.configSettings #httpReferer').val();
	var datasetName = $("#networkContent #networkDataset").val();
	var serviceAreaLayer = $('#networkContent #serviceAreaLayer').val();
	var closestFacilityLayer = $('#networkContent #closestFacilityLayer').val();
	var routeLayer = $('#networkContent #routeLayer').val();
	if (!restServiceRootURL || !datasetName) {
		SuperMapServer.Dialog
				.alert("please check rest service URL or netWork Dataset Name!");
		return;
	}
	setting.restServiceRootURL = restServiceRootURL;
	setting.token = token;
	setting.httpReferer = HTTPreferer;
	setting.networkDataset = datasetName;
	setting.serviceAreaLayer = serviceAreaLayer;
	setting.closestFacilityLayer = closestFacilityLayer;
	setting.routeLayer = routeLayer;
	return setting;
}
SuperMapServer.Manager.AGSNetworkServiceManager.prototype.fillConfigToUI = function(
		setting) {
	if (!setting) {
		return;
	}
	if (!setting.restServiceRootURL || !setting.networkDataset) {
		SuperMapServer.Dialog
				.alert("please check rest service URL or netWork Dataset Name!");
		return;
	}
	this.refreashAll();
	var datasetName = setting.networkDataset;
	var serviceAreaLayer = setting.serviceAreaLayer;
	var closestFacilityLayer = setting.closestFacilityLayer;
	var routeLayer = setting.routeLayer;
	this.serviceURLCache = setting.restServiceRootURL;
	$('.configSettings #restServiceRootURL').val(setting.restServiceRootURL);
	$('.configSettings #token').val(setting.token);
	$('.configSettings #httpReferer').val(setting.httpReferer);
	$("#networkContent #networkDataset")[0].options.add(new Option(datasetName,
			datasetName));
	$('#networkContent #serviceAreaLayer')[0].options.add(new Option(
			serviceAreaLayer, serviceAreaLayer));
	$('#networkContent #closestFacilityLayer')[0].options.add(new Option(
			closestFacilityLayer, closestFacilityLayer));
	$('#networkContent #routeLayer')[0].options.add(new Option(routeLayer,
			routeLayer));
};var addTileStorage;
SuperMapServer.AddTileStorage = function(outputPath){
	this.storageobj = {};
	this.toAddElement;
	this.groupIndex = 0;
	this.init();
	this.bindEvent();
	this.tileSourceInfoConfig = new SuperMapServer.TileSourceInfoConfig("#createNewStorageDlg");
	this.tileSourceInfoConfig.init();
}

SuperMapServer.AddTileStorage.prototype.openAddTileStorage = function(cacheTypes,toAdd,defaultCacheType){
	$('#createNewStorageDlg').dialog('open');
	if(cacheTypes){
		$('#createNewStorageDlg #tileSourceType').empty();
		for(var i = 0; i < cacheTypes.length; i++){
			$("#createNewStorageDlg #tileSourceType")[0].options.add(new Option(cacheTypes[i], cacheTypes[i]));
		}
	}
	if(defaultCacheType){
		$('#tileSourceType').val(defaultCacheType);
	}
	$("#createNewStorageDlg #tileSourceType").change();
	addTileStorage.toAddElement = toAdd;
}

SuperMapServer.AddTileStorage.prototype.init = function(){
	$('#createNewStorageDlg').dialog({
		title : TileServerRes.addStorageAddress,
		autoOpen : false,
		modal : true,
		width: 650,
		minWidth : 500,
		position : 'center',
		resizable : false
	});

}

SuperMapServer.AddTileStorage.prototype.bindEvent = function(){
	// 单击确定关闭，添加存储
	$('#createNewStorageDlg #addNewStorageOK').click(function() {
		var msg = addTileStorage.getStorageConfig();
		if(!msg.succeed) {
			SuperMapServer.Dialog.alert(msg.error);
			return false;
		}

		if(!addTileStorage.sendPostAddstorage()){
			return false;
		}
		$('#createNewStorageDlg').dialog('close');
		// 从storages资源获取存储的配置信息，写入界面
		$('#createNewStorageDlg #storageID').empty();
		addTileStorage.setStorageToElement();
	});
	// 点击取消关闭对话框
	$('#createNewStorageDlg #addNewStorageCancle').click(function() {
		$('#createNewStorageDlg').dialog('close');
	});
}

SuperMapServer.AddTileStorage.prototype.sendPostAddstorage = function(){
	var result = sendRequestWithResponse("POST", getRootUrl()+"storages.json", addTileStorage.storageobj);
	if(result.succeed != undefined && !result.succeed) {
		SuperMapServer.Dialog.alert(result.error.errorMsg);
		return false;
	}
	return true;
}

SuperMapServer.AddTileStorage.prototype.getStorageConfig = function() {
	var msg = {};
	msg.succeed = true;
	var storageID = $("#createNewStorageDlg #storageID").val();
	if(storageID == null || storageID.length <= 0){
		msg.succeed = false;
		msg.error = TileServerRes.pleaseEnterStorageID;
		return msg;
	}
	addTileStorage.storageobj.id = storageID;
	msg=this.tileSourceInfoConfig.validateParam();
	if(!msg.succeed){
		return msg;
	}
	addTileStorage.storageobj.tileSourceInfo = this.tileSourceInfoConfig.getTileSourceInfo();
	return msg;
}

SuperMapServer.AddTileStorage.prototype.setStorageToElement = function(){
	if(addTileStorage.toAddElement){
		var $addObj = $("<option value='"+addTileStorage.storageobj.id+"'>"+addTileStorage.storageobj.id+"</option>");
		$(addTileStorage.toAddElement[0]).append($addObj);
		$addObj.attr("selected","selected");
		$(addTileStorage.toAddElement[0]).change();
	}
}

$(document).ready(function() {
	var outputPath = "/home/SuperMap/supermap-iserver-10.1.0-linux64/webapps/iserver/output";
	addTileStorage = addTileStorage ? addTileStorage :  new SuperMapServer.AddTileStorage(outputPath);
});

//cacheTypes:显示可以增加的缓存类型[],toAdd:添加成功后赋值给指定的元素,defaultCacheType:默认选则的类型
function openAddStorageDlg(cacheTypes,toAdd,defaultCacheType) {
	addTileStorage.openAddTileStorage(cacheTypes,toAdd,defaultCacheType);
}

var tileSourcePublishTileset;
var tilesetInfos = new Map();
var tilesetMetaDatas = new Map();

function newTilesetLabel(tilesetSetting){
	if(!tilesetSetting){
		return;
	}
	var tilesourceInfo = tilesetSetting.tilesourceInfo;
	if(!tilesourceInfo){
		return;
	}
	switch (tilesourceInfo.type) {
	case "MongoDB":
		 return tilesetSetting.mapName + "_" + tilesourceInfo.type + "_" + tilesourceInfo.database;
	case "SMTiles":
	case "UGCV5":
		 return tilesetSetting.mapName + "_" + tilesourceInfo.type + "_" + getFileNameWithoutSuffix(tilesourceInfo.outputPath);
	default:  
		break;
	}
	return null; 
};

function addTilesetsInfo(target, tilesetSetting){
	if(!target.startsWith("#")){
		target = "#" + target;
	}
	if(!tilesetSetting){
		return;
	}
	var tilesourceInfo = tilesetSetting.tilesourceInfo;
	if(tilesourceInfo){
		var temp = newTilesetLabel(tilesetSetting);
		tilesetInfos.set(temp, tilesetSetting);
		if($(target)[0].tagName === "SELECT"){
			var optionHtml = "<option value=" + temp + " mapname=" + tilesetSetting.mapName + " title=" + temp + " ondblclick=showTilesetInfo(event,'" + tilesourceInfo.type + "','"+temp +"')>";
			optionHtml += temp;
			optionHtml += "</option>";
			$(target).append(optionHtml);
		} else if($(target)[0].tagName === "LABEL"){
			$(target).html(temp);
			$(target).attr("value", tilesourceInfo.type);
			$(target).attr("mapname", tilesetSetting.mapName);
		}
	}
};

function changeCombiningMode(obj) {
	var mode = $(obj).val();
	if("Default" === mode){
		$("#customScalesParams").hide();
		$("#baseTilesetParams").hide();
	} else if("BaseTileset" === mode){
		$("#customScalesParams").hide();
		$("#baseTilesetParams").show();
	} else {
		$("#customScalesParams").show();
		$("#baseTilesetParams").hide(); 
	}
};

function openTiesetDialog(target, evtTarget, currentTileset, currentMapName, tileType){
    if (!tileSourcePublishTileset) {
       	tileSourcePublishTileset = new SuperMapServer.PublishTileset("#publishDbTilesetDiv");
    	tileSourcePublishTileset.init();
    }
    var title;
	switch (tileType) {
	case "MongoDB":
        tileSourcePublishTileset.switchView("MongoDB");
        title = MultiTilesRes.selectMongoDB;
  		$("#multiTilesetDialog #publishDbTilesetDiv #mongoDBStoreConfig").show().siblings().hide();
  		$("#multiTilesetDialog #publishDbTilesetDiv #storageSelectDiv").show();
  		// 隐藏掉“添加复制集”这个checkbox，对于多瓦片的发布来说，没有作用。
  		$('#multiTilesetDialog #isReplicationSet').parent().hide();
		break;
	case "SMTiles":
		tileSourcePublishTileset.switchView(TileSourceView.SMTiles);
		title = MultiTilesRes.selectSMTiles;
	  	$("#multiTilesetDialog #publishDbTilesetDiv #smtilesTilesetConfig").show().siblings().hide();
	  	break;
	case "UGCV5":
        tileSourcePublishTileset.switchView(TileSourceView.UGCV5);
        title = MultiTilesRes.selectUGCV5;
        $("#multiTilesetDialog #publishDbTilesetDiv #ugcv5TilesetConfig").show().siblings().hide();
		break;
	default:
		break;
	}
	
    var tileSourceDialog =  $('#multiTilesetDialog').dialog();
    tileSourceDialog.dialog({
		title : title,
		autoOpen : false,
		width : 821,
		minWidth : 726,
		maxHeight : 700,
		modal : true,
		position : 'center',
		resizable : false
	});
    // target:当用户配置完后在multi中显示的元素对象，可以是select也可以是label
    // evtTarget：触发弹出瓦片源配置dialog的元素，可以使按钮也可以是option也可以是label
    // currentTileset：弹出瓦片源配置dialog时的当前tileset的信息，只有是option和label触发dialog时才会有值
    // currentMapName：弹出瓦片源配置dialog时的当前tileset的地图名，只有是option和label触发dialog时才会有值
    // type：当前dialog所代表的切片类型，不同切片集的dialog不一样
    tileSourceDialog.dialog("open").data("target", target).data("evtTarget", evtTarget).data("currentTileset", currentTileset).data("currentMapName", currentMapName).data("tileType", tileType);
	$("#multiTilesetDialog #tilesetsDiv").hide();
	$("#multiTilesetDialog #tilesetConnInfoDiv").show();
	$("#multiTilesetDialog #publishDbTilesetDiv").show();
	$("#multiTilesetDialog #publishDbTilesetDiv #tileSourceDiv").show();
};

// 为了兼容火狐，点击事件直接传入，而不使用this.event
function addTileSet(oEvent, tileType, obj){
	var type = $(tileType).val();
	openTiesetDialog(obj, oEvent.target, null, null, type);
};

function addTileDialogNext(obj) {
	// TODO 当没有对连接信息做修改时，不需要发送请求再去获取metaData
	var type = $("#" + obj).data("tileType");
	var currentTileset = $("#" + obj).data("currentTileset");
	var currentMapName = $("#" + obj).data("currentMapName");
	var currentTilesetMetaData;
	var tilesourceInfo = {};
	switch (type) {
	case "MongoDB":
		var mongoDBServer = $("#" + obj + " #publishDbTilesetDiv #mongoDBServer").val().trim();
		if(!mongoDBServer){
			SuperMapServer.Dialog.alert(TileServerRes.ipCannotBeNull);
			return false;
		}
		var mongoDBDatabase = $("#" + obj + " #publishDbTilesetDiv #mongoDBDatabase").val().trim();
		var mongoDBUsername = $("#" + obj + " #publishDbTilesetDiv #mongoDBUsername").val().trim();
		var mongoDBPassword = $("#" + obj + " #publishDbTilesetDiv #mongoDBPassword").val().trim();
		var tilesourceInfo = {};
		tilesourceInfo.type = "MongoDB";
		tilesourceInfo.database = mongoDBDatabase;
		tilesourceInfo.serverAdresses = [];
		tilesourceInfo.serverAdresses.push(mongoDBServer);
		tilesourceInfo.username = mongoDBUsername;
		tilesourceInfo.password = mongoDBPassword;
		break;
	case "SMTiles":
		var smtilesFilePath = $("#" + obj + " #publishDbTilesetDiv #smtilesFilePath").val().trim();
		if(!smtilesFilePath){
			SuperMapServer.Dialog.alert(MultiTilesRes.smtilesFilePathNotNull);
			return false;
		}
		tilesourceInfo.type = "SMTiles";
		tilesourceInfo.outputPath = smtilesFilePath;
		$("#" + obj + " .dialogButtonContainer").css("float: left;");
		break;
	case "UGCV5":
		var ugcV5ConfigFilePath = $("#" + obj + " #publishDbTilesetDiv #ugcV5ConfigFilePath").val().trim();
		if(!ugcV5ConfigFilePath){
			SuperMapServer.Dialog.alert(MultiTilesRes.UGCV5FilePathNotNull);
			return false;
		}
		tilesourceInfo.type = "UGCV5";
		tilesourceInfo.outputPath = ugcV5ConfigFilePath;
		break;
	default:
		break;
	}
	var tilesetInfosUrl = getIServerUrl()+"/manager/tilesetinfos.json?returnContent=true&isGetRequest=true";
	var result = sendRequestWithResponse("POST",tilesetInfosUrl, tilesourceInfo);
	if(result.length == 0){
		SuperMapServer.Dialog.alert(MultiTilesRes.queryNoTiles);
		return false;
	} else if(result.errorMsg){
		// 连接失败时给出提示
		SuperMapServer.Dialog.alert(MultiTilesRes.connectTileSourceFailed);
		return false;
	}

	$("#multiTilesetDialog #tilesetConnInfoDiv").hide();
	$("#multiTilesetDialog #tilesetsDiv").show();
	tilesetMetaDatas.clear();
	// 情况备选的select
	$("#" + obj + " #selectTilesets").empty();
	var asvailableTilesets = [];
	for(var i = 0; i < result.length; i++){
		var info = result[i];
		if(!info.metaData){
			continue;
		}
		if("Image" != info.metaData.tileType){
			continue;
		}
		asvailableTilesets.push(info);
		$("#multiTilesetDialog #selectTilesets").append("<option value="+info.name+">" + info.metaData.mapName+"</option>");
		tilesetMetaDatas.set(info.name, info.metaData);
	}
	var currentTileset = $("#" + obj).data("currentTileset");
	var currentTilesetMetaData;
	var tilesetName;
	if(currentTileset){
		var tilesetSetting = tilesetInfos.get(currentTileset);
		currentTilesetMetaData = tilesetMetaDatas.get(tilesetSetting.tilesetName);
		tilesetName = tilesetSetting.tilesetName;
	} else if(asvailableTilesets.length > 0){
		currentTilesetMetaData = asvailableTilesets[0].metaData;
		tilesetName = asvailableTilesets[0].name;
	}
	showSelectedTilesetInfo(obj, tilesetName, currentTilesetMetaData);
};

function changeSelectTilesets(obj){
	var value = $("#" + obj + " #selectTilesets").val();
	var metaData = tilesetMetaDatas.get(value);
	showSelectedTilesetInfo(obj, value, metaData);
};

function showSelectedTilesetInfo(obj, tilesetName, metaData){
	$("#multiTilesetDialog #tilesetConnInfoDiv").hide();
	$("#multiTilesetDialog #selectedTilesetInfo").show();
	$("#multiTilesetDialog #selectTilesets").val(tilesetName);
	if(!metaData){
		$("#multiTilesetDialog #selectedTilesetInfo #bounds").html("");
		$("#multiTilesetDialog #selectedTilesetInfo #epsgCode").html("");
		$("#multiTilesetDialog #selectedTilesetInfo #tileFormat").html("");
		$("#multiTilesetDialog #selectedTilesetInfo #tileSize").html("");
		$("#multiTilesetDialog #selectedTilesetInfo #transparent").html("");
		return;
	}
	var bounds = metaData.bounds;
	$("#multiTilesetDialog #selectedTilesetInfo #bounds").html("[" + bounds.left + ", " + bounds.bottom + ", " + bounds.right + ", " + bounds.top + "]");
	if(metaData.prjCoordSys){
		$("#multiTilesetDialog #selectedTilesetInfo #epsgCode").html(metaData.prjCoordSys.epsgCode);
	} else {
		$("#multiTilesetDialog #selectedTilesetInfo #epsgCode").html("");
	}
	$("#multiTilesetDialog #selectedTilesetInfo #tileFormat").html(metaData.tileFormat);
	$("#multiTilesetDialog #selectedTilesetInfo #tileSize").html(metaData.tileWidth + "x" + metaData.tileHeight);
	if(metaData.transparent == true){
		$("#multiTilesetDialog #selectedTilesetInfo #transparent").html(MultiTilesRes.trueFlag);
	} else {
		$("#multiTilesetDialog #selectedTilesetInfo #transparent").html(MultiTilesRes.falseFlag);
	}
};

function addTileDialogPrev(obj){
	$("#multiTilesetDialog #tilesetsDiv").hide();
	$("#multiTilesetDialog #tilesetConnInfoDiv").show();
};
  
function addTileDialogOK(obj, type){
	var type = $("#" + obj).data("tileType");
	var tilesetSetting = {};
	var tilesourceInfo = {};
	var tilesetName = $("#" + obj + " #selectTilesets").val();
	var mapName = $("#" + obj + " #selectTilesets :selected").text();
	tilesetSetting.tilesourceInfo = tilesourceInfo;
	if(!mapName){
		SuperMapServer.Dialog.alert(MultiTilesRes.notSelectTileset);
		return false;
	}
	tilesetSetting.mapName = mapName;
	tilesetSetting.tilesetName = tilesetName;
	switch (type) {
	case "MongoDB":
		var mongoDBServer = $("#" + obj + " #publishDbTilesetDiv #mongoDBServer").val().trim();
		if(!mongoDBServer){
			SuperMapServer.Dialog.alert(TileServerRes.ipCannotBeNull);
			return false;
		}
		var mongoDBDatabase = $("#" + obj + " #publishDbTilesetDiv #mongoDBDatabase").val().trim();
		var mongoDBUsername = $("#" + obj + " #publishDbTilesetDiv #mongoDBUsername").val().trim();
		var mongoDBPassword = $("#" + obj + " #publishDbTilesetDiv #mongoDBPassword").val().trim();
    	tilesourceInfo.type = "MongoDB";
    	tilesourceInfo.database = mongoDBDatabase;
    	tilesourceInfo.serverAdresses = [];
    	tilesourceInfo.serverAdresses.push(mongoDBServer);
    	tilesourceInfo.username = mongoDBUsername;
    	tilesourceInfo.password = mongoDBPassword;
		break;
	case "SMTiles":
		var smtilesFilePath = $("#" + obj + " #publishDbTilesetDiv #smtilesFilePath").val().trim();
		if(!smtilesFilePath){
			SuperMapServer.Dialog.alert(MultiTilesRes.smtilesFilePathNotNull);
			return false;
		}
		tilesourceInfo.type = "SMTiles";
		tilesourceInfo.outputPath = smtilesFilePath;
		break;
	case "UGCV5":
		var ugcV5ConfigFilePath = $("#" + obj + " #publishDbTilesetDiv #ugcV5ConfigFilePath").val().trim();
		if(!ugcV5ConfigFilePath){
			SuperMapServer.Dialog.alert(MultiTilesRes.UGCV5FilePathNotNull);
			return false;
		}
		tilesourceInfo.type = "UGCV5";
		tilesourceInfo.outputPath = ugcV5ConfigFilePath;
		break;
	default:
		break;
	}
	var targetVal = $("#" + obj).data("target");
	var evtTarget = $("#" + obj).data("evtTarget");
	var tileType = $("#" + obj).data("tileType");
	if(evtTarget.tagName === "BUTTON") {
		addTilesetsInfo(targetVal, tilesetSetting);
	} else if(evtTarget.tagName === "OPTION" || evtTarget.tagName === "LABEL"){
		var temp = newTilesetLabel(tilesetSetting);
		evtTarget.value = temp;
		evtTarget.title = temp;
		evtTarget.innerHTML = temp;
	}
	tilesetInfos.set(newTilesetLabel(tilesetSetting), tilesetSetting);
	$("#" + obj).dialog('close');
};

function showBaseTilesetInfo(oEvent){
	var tileType = oEvent.target.getAttribute("value");
	var currentTileset = oEvent.target.innerHTML;
	var currentMapName = oEvent.target.getAttribute("mapname");
	showTilesetInfo(oEvent, tileType, currentTileset, currentMapName);
};

function showTilesetInfo(oEvent, tileType, currentTileset, currentMapName){
	openTiesetDialog(null, oEvent.target, currentTileset, currentMapName, tileType);
	
	var tilesetSetting = tilesetInfos.get(currentTileset);
	var tilesourceInfo = tilesetSetting.tilesourceInfo;
	if(tilesetSetting){
		$("#multiTilesetDialog #mapName").val(tilesetSetting.mapName);
	}
	switch (tileType) {
	case "MongoDB":
		$("#multiTilesetDialog #tilesetsDiv").hide();
	  	$("#multiTilesetDialog #tilesetConnInfoDiv").show();
  		$("#multiTilesetDialog #publishDbTilesetDiv").show();
  		$("#multiTilesetDialog #publishDbTilesetDiv #tileSourceDiv").show();
  		$("#multiTilesetDialog #publishDbTilesetDiv #mongoDBStoreConfig").show().siblings().hide();
  		$("#multiTilesetDialog #publishDbTilesetDiv #storageSelectDiv").show();
		$("#multiTilesetDialog #storagesSelect").val("");
		$("#multiTilesetDialog #mongoDBServer").val(tilesourceInfo.serverAdresses[0]);
		$("#multiTilesetDialog #mongoDBServer").attr("disabled", false);
		$("#multiTilesetDialog #mongoDBDatabase").val(tilesourceInfo.database);
		$("#multiTilesetDialog #mongoDBDatabase").attr("disabled", false);
		$("#multiTilesetDialog #mongoDBUsername").val(tilesourceInfo.username);
		$("#multiTilesetDialog #mongoDBUsername").attr("disabled", false);
		$("#multiTilesetDialog #mongoDBPassword").val(tilesourceInfo.password);
		$("#multiTilesetDialog #mongoDBPassword").attr("disabled", false);
		break;
	case "SMTiles":
	  	$("#multiTilesetDialog #publishDbTilesetDiv #smtilesFilePath").val(tilesourceInfo.outputPath);
		break;
	case "UGCV5":
	  	$("#multiTilesetDialog #publishDbTilesetDiv #ugcV5ConfigFilePath").val(tilesourceInfo.outputPath);
		break;
	default:
		break;
	}
};

function doAddCustomScale(){
	var value = $("#customScalesParams #customScale").val();
	var temp = value.split(":");
	var customScale;
	if(temp.length == 1){
		customScale = Number(temp[0]);
	} else{
		customScale = Number(temp[0]) / Number(temp[1]);
	}
	if(customScale >= 1 || customScale <= 0){
		SuperMapServer.Dialog.alert(MultiTilesRes.customScaleIllegal);
		return false;
	}
	$("#customScalesParams #customScales").append("<option value="+customScale+">" + customScale+"</option>")
};

function addTileDialogCancel(obj){
	$("#" + obj).dialog('close');
};

function removeOption(obj){
	var selectedOptions = $("#" + obj + " option");
	for ( var i = 0; i < selectedOptions.length; i++) {
		if (selectedOptions.eq(i).prop('selected')) {
			selectedOptions.eq(i).remove();
		}
	}
	return;
};

function moveToUpOption(obj){
	var selIndex =  $("#"+obj)[0].selectedIndex;
	if(selIndex <= 0){
		return ;
	}
	$("#"+ obj +" option:selected").insertBefore($("#"+ obj +" option:selected").prev("option"));
	return;
};

function moveToDownOption(obj){
	var selIndex =  $("#"+ obj)[0].selectedIndex;
	if(selIndex < 0){
		return ;
	}
	var optionNum = $("#" + obj +" option").length;
	if(selIndex > optionNum-2){
		return ;
	}
	$("#"+ obj +" option:selected").insertAfter($("#"+ obj +" option:selected").next("option"));
	return;
};

function removeBaseTileset(){
	$("#baseTilesetParams #baseTileset").html("");
};

function setMultiTilesProviderConfig(container, config){
	if(!container){
		container = "";
	}
	config.name = $(container+" #name").val();
	if(!config.name){
		SuperMapServer.Dialog.alert(MultiTilesRes.mapNameNull);
		return false;
	}
	config.combiningMode = $(container+" #combiningMode").val();
	var tilesets = [];
	$(container+" #tileSets option").each(function(){
		var value = $(this).val();
		var tilesetSetting = tilesetInfos.get(value);
		tilesets.push(tilesetSetting);
	});
	if(tilesets.length == 0){
		SuperMapServer.Dialog.alert(MultiTilesRes.tilesetsNull);
		return false;
	}
	config.tilesets = tilesets;
	if(config.combiningMode == "BaseTileset"){
		var baseTilesetVal = $(container+" #baseTileset").html();
		var baseTileset = tilesetInfos.get(baseTilesetVal);
		config.baseTileset = baseTileset;
		config.customScales = [];
	} else if(config.combiningMode == "CustomScales"){
		var customScales = [];
		$(container+" #customScales option").each(function(){
			var value = $(this).val();
    		customScales.push(value);
		});
		config.customScales = customScales;
		config.baseTileset = null;
	} else {
		config.baseTileset = null;
		config.customScales = [];
	}
	return config;
};
</script>
<script type="text/javascript"
	src="http://192.168.10.244:8090/iserver/manager/static/js/jquery.lazyload.min.js"></script>
<script type="text/javascript" src="http://192.168.10.244:8090/iserver/manager/static/js/SuperMapServer.js"></script>
<!--[if IE]>
<script type="text/javascript" src="http://192.168.10.244:8090/iserver/manager/static/libs/excanvas.min.js"></script>
<![endif]-->
<script type="text/javascript" src="http://192.168.10.244:8090/iserver/manager/static/js/jquery.flot.min.js"></script>
<script type="text/javascript" src="http://192.168.10.244:8090/iserver/manager/static/js/jquery.flot.time.min.js"></script>
<script type="text/javascript" src="http://192.168.10.244:8090/iserver/manager/static/js/jquery.flot.pie.min.js"></script>
<script type="text/javascript" src="http://192.168.10.244:8090/iserver/manager/static/js/updateResource.js"></script>
<script type="text/javascript" src="http://192.168.10.244:8090/iserver/manager/static/js/workspaceDialogContent.js"></script>
<script type="text/javascript" src="http://192.168.10.244:8090/iserver/manager/static/js/arcgisDialogContent.js"></script>
<script type="text/javascript" src="http://192.168.10.244:8090/iserver/manager/static/js/smtilesDialogContent.js"></script>
<script type="text/javascript" src="http://192.168.10.244:8090/iserver/manager/static/js/zxytilesDialogContent.js"></script>
<script type="text/javascript" src="http://192.168.10.244:8090/iserver/manager/static/js/dataProviderDelayCommitSetting.js"></script>
<script type="text/javascript" src="http://192.168.10.244:8090/iserver/manager/static/js/dataProviderFilteredDatasourceInfo.js"></script>
<script type="text/javascript" src="http://192.168.10.244:8090/iserver/manager/static/js/addressMatchProviderSetting.js"></script>
<script type="text/javascript" src="http://192.168.10.244:8090/iserver/manager/static/js/serviceWSS.js"></script>
<script type="text/javascript" src="http://192.168.10.244:8090/iserver/manager/static/js/streamingServiceSetting.js"></script>
<style>
.subnav {
	padding-left: 20px;
}

h1,h2,h3 {
	margin-top: 10px;
}

#tabLeft {
	background-color: #f7f5fa;
}

#mainContent {
	height: auto;
}

.expand {
	padding-left: 10px;
}

.page-header {
	padding-bottom: 5px;
	margin: 0px 0 10px;
}

.miniline {
	border-width: 1px;
	margin-top: 5px;
	margin-bottom: 5px;
}

.generalSetting {
	padding-left: 0px;
}

#cacheDiv div.form-group {
	margin-left: 20px;
}
/*---liucy20140424---*/
/*base*/
.clearfix:after {
	content: ".";
	display: block;
	height: 0;
	clear: both;
	visibility: hidden
}

.clearfix { /*display:inline-block*/

}

* html .clearfix {
	height: 1%;
}

.
Clearfix {
	display: block;
}

.fl {
	float: left;
}

.pr {
	position: relative;
}

.mb-30 {
	margin-bottom: -30px;
}
/*page*/
.page-header h5 {
	padding-top: 15px;
}

.left-menu {
	z-index: 1;
}

.menu_listTop {
	padding-top: 60px;
}

.menu_listTop105 {
	padding-top: 105px;
}

.button_line {
	position: fixed;
	bottom: 0;
	width: 100%;
	background: #F7F5FA;
	/* z-index: 100; */
}

.button_block {
	margin: 0 auto;
	width: 185px;
	padding: 5px 0;
}

.tabContent {
	float: right;
	margin-top: -10px;
}

#interfacesDiv label {
	float: none;
	vertical-align: middle;
}

.providerBtn {
	position: absolute;
	right: 0;
	bottom: -10px;
}
.remove-label {
	display: inline-block;
	background: url("http://192.168.10.244:8090/iserver/manager/static/img/delete_gray.gif") no-repeat 100% 50%;
	width: 8px;
	height: 8px;
	text-indent: -9999px;
	outline: none;
}

.necessaryLabel{
	color:red
}

#fastdfsStoreConfig td{
	vertical-align: Top;
}
#mongoDBStoreConfig td {
	vertical-align: Top;
}
.dashLine {
	margin-left: 0px;
	margin-top:10px;
	width: 100%;
	height: 0;
	border-top: 1px dashed #EEE;
}

#createNewStorageDlg .parameter label{
	width:15em;
}
</style>
<script type="text/javascript" src="http://192.168.10.244:8090/iserver/manager/static/js/confirm.js"></script>
<script type="text/javascript" src="http://192.168.10.244:8090/iserver/manager/static/js/pinyin.js"></script>
<script type="text/javascript" src="http://192.168.10.244:8090/iserver/manager/static/js/configForm.js"></script>
</head>
<body>
<div id="topWrapper">
    <iframe id='KcLogoutFrame' name='KcLogoutFrame' style='display:none' frameborder='0'></iframe>
    <iframe id='KcLoginStatusIframe' name='KcLoginStatusIframe' style='display:none' frameborder='0'></iframe>
    <div id="topWrapper_header">
        <div class="fixedWidth">
            <div style="display: block; float: right; position: relative; top: 32px;padding-right:10px">
                <select id="language" onchange="selectLanguage(this.value)">
                    <option value="en-US">English</option>
                    <option value="zh-CN" selected="selected">简体中文</option>
                </select>
            </div>
            <div id="helpLink" style="display: block;">
                            <a id="pageHelp" href="http://192.168.10.244:8090/iserver/manager/../../iserver/help/html/zh/index.htm" target="_blank">帮助</a>
            </div>
            <div id="logoutLink" class="logoutLink" style="display: block;">
                <a href="javascript: showprofile(); ">
            <span id="userprofile">
                <span id="gbi4m1" style="max-width: 50px;overflow: hidden;display: inline-block;text-overflow: ellipsis;" title="admin">admin</span>
                <span id="gbma" class="gbma" style="top: -7px;"></span>
            </span>
                </a>
                <div class="gbm" id="profiledlg" style="padding-top:5px;display:none">
                    <span style="color:black;padding-left:8px;">admin</span>
                    <hr style="align=center"/>
                    <table id="ptable" style="width:100%;text-align:left;margin-top:-5px;">
                        <tr>
                            <td>
                                <table align="center" cellspacing="0px" width="90%">
                                    <tr>
                                        <td align="left"><a href="http://192.168.10.244:8090/iserver/manager/../services/security/profile">详细信息</a></td>
                                        <td align="right"><a href="javascript:userLogout()">退出</a></td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                </div>
                <div class="gbm" id="profiledlg" style="display: none; ">
                    <a href="http://192.168.10.244:8090/iserver/manager/../services/security/profile">详细信息</a>
                    <a href="javascript:userLogout()">退出</a>
                </div>
            </div>

            <div id="tabsContainer">
                <ul class="tabs">
          <li id="overview_tab" class="first">
            <p> <a id="overviewLink" class="tabs" href="http://192.168.10.244:8090/iserver/manager">首 页</a> </p>
          </li>
          <li id="server_tab" class="">
            <p> <a id="serviceLink" class="tabs" href="http://192.168.10.244:8090/iserver/manager/serviceConfigIndex">服 务</a> </p>
          </li>
<!-- 		  <li id="cacheStorage_tab" class="">
            <p> <a id="cacheStorageLink" class="tabs" href="http://192.168.10.244:8090/iserver/manager/storages">切片存储</a> </p>
          </li> -->
          <li id="cluster_tab" class="">
            <p> <a id="clusterLink" class="tabs" href="http://192.168.10.244:8090/iserver/manager/cluster">集 群</a> </p>
          </li>
          <li id="log_tab" class="">
            <p> <a id="logLink" class="tabs" href="http://192.168.10.244:8090/iserver/manager/logs?logLevel=INFO&count=20">日 志</a> </p>
          </li>
          <li id="security_tab" >
            <p> <a id="securityLink" class="tabs" href="http://192.168.10.244:8090/iserver/manager/security">安 全</a> </p>
          </li>
		  <li id="serverstatus_tab" class="">
            <p> <a id="serverstatusLink" class="tabs" href="http://192.168.10.244:8090/iserver/manager/serverstatus">监控与统计</a> </p>
          </li>
          <!--<li id="proxyNode_tab" class="">
            <p> <a id="proxyNodeLink" class="tabs" href="http://192.168.10.244:8090/iserver/manager/proxyNode">代理</a> </p>
          </li>-->
          <!--<li id="messageQueue_tab" class="">
            <p> <a id="messageQueueLink" class="tabs" href="http://192.168.10.244:8090/iserver/manager/messagequeue">消息队列</a> </p>
          </li>-->
          <li id="backupAndRestore_tab" class="">
            <p> <a id="backupAndRestoreLink" class="tabs" href="http://192.168.10.244:8090/iserver/manager/backup">备份与恢复</a> </p>
          </li>
          <li id="scheduledtasks_tab" class="">
            <p> <a id="scheduledtasksLink" class="tabs" href="http://192.168.10.244:8090/iserver/manager/scheduledRestart">计划任务</a> </p>
          </li>
          <li id="iserverInfo_tab" class="">
            <p> <a id="iserverInfoLink" class="tabs" href="http://192.168.10.244:8090/iserver/manager/licenseInfo">许可</a> </p>
          </li>
          <li id="iserverSetting_tab" class="last">
            <p> <a id="iserverSettingLink" class="tabs" href="http://192.168.10.244:8090/iserver/manager/globalsettings">全局设置</a> </p>
          </li>                </ul>
            </div>
            <!-- <div class="clr"/> -->
        </div>
    </div>
    <div id="topWrapper_bottom" class="fixedWidth">

        <ul id="main_navigation" style="display:block;">
            <li class="selected last"></li>
        </ul>
        <!--<div class="clr"/> -->
    </div>
</div>
<script type="text/javascript">
    var kcConfigUrl = "http://192.168.10.244:8090/iserver/manager/security/briefkeycloakconfig.json";
    var logoutUrl = "http://192.168.10.244:8090/iserver/manager/../services/security/logout";
    var kcConfig = null;
    var currentUserName = "admin";
    function getKcConfig() {
        $.ajax({
            url: kcConfigUrl,
            success: function (res) {
                kcConfig = res;
                if (kcConfig.enable && currentUserName !== "GUEST") {
                    kcSingleSignOutCheck();
                }
            }
        })
    }
    function userLogout(e) {
        if (kcConfig && kcConfig.enable) {
            var kcLogoutUrl = kcConfig.baseUri + "/realms/" + kcConfig.realm + "/protocol/openid-connect/logout";
            $("#KcLogoutFrame").attr("src", kcLogoutUrl);
        }
        window.open(logoutUrl, "_self")
    }
    function kcSingleSignOutCheck() {
        var kcLoginStatusUrl = kcConfig.baseUri + "/realms/" + kcConfig.realm + "/protocol/openid-connect/login-status-iframe.html";
        $("#KcLoginStatusIframe").attr("src", kcLoginStatusUrl);
        window.addEventListener("message", this.onMessage, false);
        setTimeout(kcStatePost, 500);
    }
    function kcStatePost(){
        var client_id = getCookie("kc_client_id");
        var session_state = getCookie("kc_session_state");
        var KcLoginStatusIframe = document.getElementById("KcLoginStatusIframe");
        if(KcLoginStatusIframe && client_id && session_state){
            var info = client_id+" "+session_state;
            KcLoginStatusIframe.contentWindow.postMessage(info, kcConfig.baseUri.replace("/auth", ""));
        }
    }
    function onMessage(e){
        if(typeof(e.data) === "string" && e.data === "changed" && currentUserName !== "GUEST"){
            window.open(logoutUrl, "_self");
        }
    }
    function getCookie(name) {
        var arr;
        var reg = new RegExp("(^| )" + name + "=([^;]*)(;|$)");
        if (arr = document.cookie.match(reg)) {
            return unescape(arr[2]);
        } else {
            return null;
        }
    }
    function correctPNG() {
        for (var i = 0; i < document.images.length; i++) {
            var img = document.images[i];
            var imgName = img.src.toUpperCase();
            if (imgName.substring(imgName.length - 3, imgName.length) == "PNG") {
                var imgID = (img.id) ? "id='" + img.id + "'" : "";
                var imgClass = (img.className) ? "class='" + img.className + "'" : "";
                var imgTitle = (img.title) ? "title='" + img.title + "'" : "title='" + img.alt + "'";
                var imgStyle = "display:inline-block;" + img.style.cssText;
                if (img.align == "left") imgStyle = "float:left;" + imgStyle;
                if (img.align == "right") imgStyle = "float:right;" + imgStyle;
                if (img.parentElement.href) imgStyle = "cursor:hand;" + imgStyle;
                var strNewHTML = "<span " + imgID + imgClass + imgTitle + "style=\"" + "width:" + img.width + "px; height:" + img.height + "px;"
                        + imgStyle + ";" + "filter:progid:DXImageTransform.Microsoft.AlphaImageLoader" + "(src=\'" + img.src + "\', sizingMethod='scale');\"</span>"
                img.outerHTML = strNewHTML;
                i = i - 1;
            }
        }
    }

    function getUrlParam(name) {
        //获取URL指定名字的查询字符串值
        var reg = new RegExp("[?&]" + name + "=([^?&]*)[&]?", "i");
        var match;
        match = location.search.match(reg);
        return match == null ? "" : match[1];
    }

    if (navigator.userAgent.indexOf("MSIE") > -1 && parseInt($.browser.version) < 7) {
        window.attachEvent("onload", correctPNG);
    }
    function globalhide(event) {
        event = (event == null) ? window.event : event;
        var profile = document.getElementById("profiledlg");
        var userspan = document.getElementById("gbi4m1");
        var gbma = document.getElementById("gbma");
        var target_test = event.target ? event.target : event.srcElement;
        (target_test != profile) && (target_test != userspan) && (target_test != gbma) ? hide() : null;
    }
    document.onclick = globalhide;
    function showprofile() {
        if (document.getElementById("profiledlg").style.display == "none") {
            show();
        } else {
            hide();
        }
    }
    function show() {
        document.getElementById("logoutLink").className = "logoutLink_click";
        document.getElementById("profiledlg").style.display = "";
        document.getElementById("profiledlg").focus();
    }
    function hide() {
        document.getElementById("logoutLink").className = "logoutLink";
        document.getElementById("profiledlg").style.display = "none";
    }
    //设置语言...开始
    function setCookie(c_name, value, expiredays) {
        var exdate = new Date()
        exdate.setDate(exdate.getDate() + expiredays)
        var protocol = window.location.protocol;
        var secure = "";
        if (protocol === "https:") {
            secure = ";secure=true";
        }
        cookieVal = c_name + "=" + escape(value) + ((expiredays == null) ? "" : ";expires=" + exdate.toGMTString()) + ";path=/" + secure;
        document.cookie = cookieVal;
    }
    function delCookie(name) {
        var date = new Date();
        date.setTime(date.getTime() - 10000);
        document.cookie = name + "=a;expires=" + date.toGMTString() + ";path=/";
    }
    function selectLanguage(language) {
        delCookie("language");
        setCookie("language", language, 3600 * 24 * 31);
        window.location.reload();
    };
    document.getElementById("language").value = "zh-CN";
    //设置语言...结束
    getKcConfig();
</script><div id="mainContent"><!--1-->
<div id="content"><!--3-->
	<div class="tableContainer"><!--2-->
			<div id="tabs" class="ui-tabs"><!--4-->
<ul id="menu" class="tabs-nav" >
	    <li ><a href="http://192.168.10.244:8090/iserver/manager/serviceConfigIndex">概  述</a></li>
	<li class="tabs-selected"><a href="http://192.168.10.244:8090/iserver/manager/services">服务管理</a></li>
	<li ><a href="http://192.168.10.244:8090/iserver/manager/workspaces">工作空间</a></li>
	<li ><a href="http://192.168.10.244:8090/iserver/manager/interfaces">服务接口</a></li>
	<li ><a href="http://192.168.10.244:8090/iserver/manager/scsAndscsets">服务组件(集合)</a></li>
	<li ><a href="http://192.168.10.244:8090/iserver/manager/spsAndspsets">服务提供者(集合)</a></li>
	<li ><a href="http://192.168.10.244:8090/iserver/manager/multiworkers/infos">多进程</a></li>
	<li ><a href="http://192.168.10.244:8090/iserver/manager/proxyNodes">代 理</a></li>
	
	<li class="dropdown ">
		<a class="dropdown-toggle" data-toggle="dropdown" href="#">
			高级
			<span class="caret" ></span>
		</a>
		<ul class="clear dropdown-menu" style="padding:0 0;">
				<li><a href="http://192.168.10.244:8090/iserver/manager/multiworkers/setting" style=''>多进程配置</a></li>
				<li><a href="http://192.168.10.244:8090/iserver/manager/serverChart" style=''>关系图&nbsp;&nbsp;&nbsp;</a></li>
				<li><a href="http://192.168.10.244:8090/iserver/manager/metaInfo" style=''>类型元信息</a></li>
				<li><a href="http://192.168.10.244:8090/iserver/manager/httpCache" style=''>HTTP缓存</a></li>
				<li><a href="http://192.168.10.244:8090/iserver/manager/tilesetupdatejobs" style=''>切片更新</a></li>
		</ul>
	</li>
	
</ul>
				<div class="row" style="padding-top:10px;clear:both;float:left;width:100%" id="serviceDiv" ><!--5-->
					<div id="left-menu" class="col-md-2 col-sm-2 col-xs-2" style="min-width:130px">
						<div  id="tabLeft">
								    <ul class="nav nav-stacked nav-pills" >
								        <li class="active" >
								            <a id="menu_home" href="#home">基本信息</a>
								        </li>
								        <li id="providerTab">
								            <a id="menu_provider" href="#provider" >服务提供者</a>
								        </li>
								         <li id="serviceSetTab">
								            <a id="menu_serviceSet" href="#serviceSet" >服务列表</a>
								        </li>
								        <li id="dataflowserverTab" style="display:none">
								            <a id="menu_dataflowserver" href="#dataflowserver" >WSS配置</a>
								        </li>
								        <li id="streamingapplicationTab"  style="display:none">
								            <a id="menu_streamingapplication" href="#streamingapplication" >流数据应用运行状态</a>
								        </li>	
								        <li id="streamingserverTab"  style="display:none">
								            <a id="menu_streamingserver" href="#streamingserver" >流数据服务配置</a>
								        </li>	
								        <li id="interfacesTab">
								            <a id="menu_interfaces" href="#interfaces" >服务接口</a>
								        </li>
								         <li id="cacheTab">
								            <a id="menu_cache" href="#cache" >缓存</a>
								        </li>
								        <li id="securityTab">
								            <a id="menu_security" href="#security" >安全</a>
								        </li>
								    </ul>
						</div>
					</div>
					<!--liucy <div id="tabContent" data-spy="scroll" data-target="#tabLeft" style="float:right;background-color:#f5f5f5;" class="col-md-10 col-sm-10"> -->
					<div id="tabContent" class="col-md-10 col-sm-10 col-xs-10 tabContent">
<div class="page-header"  style='margin-top: 0px;'><h5 id="home">基本信息</h5></div>
<div style="display:inline-block;width:100%">
    <div id="HomeDiv">
        <div class="parameter">
            <label>服务名称：</label>
            <span id="serviceName"></span>
        </div>
        <div class="parameter">
            <label>服务别名：</label>
            <span id="serviceAlias"></span>
            <input type="text" class="col-xs-3 col-sm-3 col-md-3 col-lg-3" id="componentAlias" name="componentAlias" style="display:none">
            <span title="修改" class="glyphicon glyphicon-edit aliasIcon instanceIcon"></span>
        </div>
        <div style="clear:both;"></div>
        <div class="clear parameter">
            <label>服务类型：
            </label>
            <span id="serviceType"></span>
        </div>
        <div style="clear:both;"></div>
        <div class="clear parameter instanceCount" style="display:none">
            <label>实例数量：
            </label>
            <span id="instanceCountSpan"></span><span title="修改" class="glyphicon glyphicon-edit instanceCountIcon instanceIcon"></span>
            <input type="text" id="instanceCount" name="instanceCount" class="col-xs-3 col-sm-3 col-md-3 col-lg-3"  style="display:none"></input>
        </div>
        <div style="clear:both;"></div>
        <div class="parameter">
            <label>服务地址：</label>
            <div id="instanceAddress" style="margin-left:231px">
            </div>
        </div>
        <div style="clear:both;"></div>
        <div id="configDiv" style="display:none"></div>
    </div>
    <div style="display:none" id="thumbnailsDiv"><img class="pull-right" style="width:180px;height:180px;border:1px solid #CCCCCC;float:right" id="thumbnails"/></div>
</div>

<div class="modal fade" id="testModal" role="dialog"
	aria-labellebdy='myModalLabel' aria-hidden='true'>
	<div class='modal-dialog' style='margin: 10% auto;'>
		<div class='modal-content'>
			<div class='modal-header'>
				<button type='button' class='close' data-dismiss='modal'
					aria-hidden='true'>x</button>
				<h4 class='modal-title' id='myModalLabel'>访问统计</h4>
			</div>
			<div class='modal-body' id='graphDiv'
				style='padding: 0; min-height: 100%; min-width: 100%;'>
				<table style="width: 100%; height: 100%;">
					<tr>
						<td style="width: 1%; min-width: 2px; height: 100%;"></td>
						<td style="width: 32%; min-width: 260px; height: 100%;">
							<table style="width: 100%; min-width: 260px; height: 100%;">
								<tr style="width: 100%; min-width: 260px; height: 80%">
									<td style="vertical-align: bottom; width: 100%"><div
											id="statisticsDiv_InstanceName"
											style="width: 100%; min-width: 260px; height: 80%; min-height: 350px;"></div>
									</td>
								</tr>
								<tr style="width: 100%; min-width: 260px; height: 20%">
									<td
										style="vertical-align: top; text-align: center; width: 100%"><label
										id="InstanceNameStatisticsLabel" style="width: 94%;">服务实例访问统计图</label>
									</td>
								</tr>
							</table></td>
						<td style="width: 2%; min-width: 2px; height: 100%;"></td>
						<td style="width: 32%; min-width: 260px; height: 100%;">
							<table style="width: 100%; min-width: 260px; height: 100%;">
								<tr style="width: 100%; min-width: 260px; height: 80%">
									<td style="vertical-align: bottom; width: 100%"><div
											id="statisticsDiv_UserName"
											style="width: 100%; min-width: 260px; height: 80%; min-height: 350px;"></div>
									</td>
								</tr>
								<tr style="width: 100%; min-width: 260px; height: 20%">
									<td
										style="vertical-align: top; text-align: center; width: 100%"><label
										id="ProxyNodeStatisticsLabel" style="width: 96%;">用户访问统计图</label>
									</td>
								</tr>
							</table></td>
						<td style="width: 1%; min-width: 2px; height: 100%;"></td>
					</tr>
				</table>
			</div>
		</div>

	</div>
</div>

<div class="page-header" id='providerHead'><h5 id="provider" class="pr">服务提供者
     <div class="pull-right providerBtn">
         <a class="btn btn-primary" id="bindProvider">
             <i class="glyphicon glyphicon-plus glyphicon glyphicon-white"></i>绑定服务提供者</a>
     </div>
</h5></div>
<div id="providerDiv">
</div>
<div id="updateIndexContainer" style="display:none;">
   	<div>
	<!-- label占位 -->
	<label></label>
	<button id="updateIndexButton" class="btn btn-primary btn-ok" onClick="updateIndex()">更新索引</button>
	<button id="appendIndexButton" class="btn btn-primary btn-ok" onClick="appendIndex()">追加索引</button>
</div>	


<div id="appendIndexDlg" class="commonDialog" style="display:none">
	<div id="appendIndexSettingDiv" style="display:block">
		<div>
			<div id="fileWorkspace">
				<div class='parameter'>
					<label id="thePathOfFileWorkspace">工作空间路径:</label>
					<span id="remoteFileSystem">
						<input name="remotePath" id="remotePath" type="text"/>
								    				<input id="localBrowse" name="localBrowse" title="服务不在本地，请使用远程浏览" type="button" class="btn btn-default" onclick="return browseLocally();" disabled="true" value="本地浏览..."/>
						<input id="fileBrowser" name="fileBrowser" type="button" onclick="showFileChooser(this);"  class="btn btn-default" value="远程浏览..."/>
					</span>
					<div id="localFileSystem" style="display:none">
						<input name="localFile" id="localFile" type="file" disabled="true" onchange="resetWorkspacePath(this);" style="width:375px;"/>
					</div>
				</div>
			</div>
			<div id="wkspPass" class="parameter">
	    		<label for="workspacePassword" id="thePasswordOfFileWorkspace">工作空间密码：</label>
				<input id="workspacePassword" name="workspacePassword" type="password"/>
			</div>
		</div>
		
		<div id="getMessageDiv" class="parameter">
			<a onClick="getDatasourceInfo('#appendIndexSettingDiv')" style="padding-left: 10px;"><font color="#0076A1">从工作空间获取数据源信息</font></a>
			<span id = 'failedMessage' style='padding-left: 60px; width: 90%; color: rgb(255, 0, 0);'></span>
		</div>
		
		<div id="datasourceNameDiv" class="parameter" style="display:block">
			<label id="datasourceNameLabel">数据源名称:
				<span class="necessary" title="必填项">*</span>			
			</label>
			<input id="datasourceNameByAddMatch" class="col-xs-4 col-sm-4 col-md-4 col-lg-4" name="datasourceNameByAddMatch" type="text"/>
		</div>
  		<div id="datasetNamesDiv" class="parameter" style="display:block">
			<label id="datasetNamesLabel">数据集名称:
				<span class="necessary" title="必填项">*</span>				
			</label>
			<input id="datasetNames" name="datasetNames" class="col-xs-4 col-sm-4 col-md-4 col-lg-4" type="text"/>
		</div>
	</div>	
 	<div class="dialogButtonContainer">
 		<button id="dialogCancel" class="btn btn-default">取消</button>
 		<button id="dialogOK" class="btn btn-primary">确定</button>
  	</div>
</div>

<script type="text/javascript" src="http://192.168.10.244:8090/iserver/manager/static/js/addressMatchProvider-updateIndex.js"></script></div>
<div id="bindProviderDialog" name="bindProviderDialog" class="commonDialog" style="display:none;" >
    <table class='dataTable' id="unuseProviders" name="unuseProviders">
      <thead>
        <tr>
          <th width='70%' class="text-left">服务提供者名称</th>
          <th width='30%' class="text-left"><input type='checkbox' class='allSelect'/>选择</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  <div class="dialogButtonContainer">
    <button class="dialogCancel btn btn-default" id="editComponentDialogCancel">取消</button>
    <button class="dialogOK btn btn-primary" id="editComponentDialogOK">确定</button>
  </div>
</div>
<div id="addProviderDialog" name="addProviderDialog" class="commonDialog" style="display:none;">
  <div class='parameter'>
    <label>服务提供者类型: <span class="necessary" title="必填项"> * </span></label>
    <select name="type" id="type" class="col-xs-4 col-sm-4 col-md-4 col-lg-4"></select>
  </div>
  <div class='parameter'>
    <label>服务提供者名称:<span class="necessary" title="必填项"> * </span></label>
    <input type="text"  id="providerName" class="col-xs-4 col-sm-4 col-md-4 col-lg-4" name="providerName"/>
  </div>
  <div style="clear:both;"></div>
  <div class="configSettings"></div>
  <div class="dialogButtonContainer">
    <button class="dialogCancel btn btn-default" id="addProviderDialogCancel">取消</button>
    <button class="btn btn-primary" id="addProviderDialogOK">确定</button>
  </div>
  </div>
  
  <script type="text/javascript" src="http://192.168.10.244:8090/iserver/manager/static/js/addressMatchProvider-updateIndex.js"></script>


<div class="page-header" id="setHeader"><h5 id="serviceSet">服务
 <small>
        <div class="pull-right">
            <a class="btn btn-primary" id="bindService">
                <i class="glyphicon glyphicon-plus glyphicon glyphicon-white" style="margin-top:3px;margin-right:5px;"></i>绑定服务</a>
        </div>
    </small></h5></div>
<div id="serviceSetDiv"></div>
<!-- 往服务组件集合添加服务组件的对话框 -->
<div id="addToComponentDialog" class="commonDialog" style="display:none;">
	<table class='dataTable' id="componentNotInSet" name="componentNotInSet">
      <thead>
        <tr>
          <th width='40%' class="text-left">服务组件名称</th>
          <th width='40%' class="text-left">服务组件类型</th>
          <th width='20%' class="text-left"><input type='checkbox' class='allSelect'/>选择</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  <div class="dialogButtonContainer">
    <button class="dialogCancel btn btn-default" id="editComponentDialogCancel">取消</button>
    <button class="dialogOK btn btn-primary" id="editComponentDialogOK">确定</button>
  </div>
</div><div class="page-header" id='dataflowserverHead' style='clear:both;display:none'><h5 id="dataflowserver">WSS配置</h5></div>
<div id="dataFlowServerSettingDiv" style="display:none;width:100%">
       	<div style="clear:both;"></div>
		<div class="parameter">
			<label style="width: 100%;">WSS设置是全局变量，一旦修改，所有的DataFlow服务都会生效</label>	
		</div>
        <div style="clear:both;"></div>
        <div class="parameter">
			<label> 
				<span>端口:</span>
				<span class="necessary" title="必填项">*</span>			
			</label>
			<input id="port" class="col-xs-4 col-sm-4 col-md-4 col-lg-4" name="port" type="port"/>
       	</div>
		<div style="clear:both;"></div>
     	<div id="enabledDiv" class="parameter" style="display:block">
			<label>开启WSS配置：</label>
			<input type="checkbox" id="isSSL" name="isSSL" onclick="isSSLClick(this)"/>
		</div>
		<div id="dataFlowSSLServerSettingDiv" style='display: block;'>
        	<div class="parameter">
				<label> 
					<span>keyStore路径:</span>
					<span class="necessary" title="必填项">*</span>			
				</label>
				<input id="keyStorePath" class="col-xs-4 col-sm-4 col-md-4 col-lg-4" name="keyStorePath" type="text"/>
        	</div>
        	<div style="clear:both;"></div>
        	<div class="parameter">
				<label> 
					<span>keyStore密码:</span>
					<span class="necessary" title="必填项">*</span>			
				</label>
				<input id="keyStorePassword" class="col-xs-4 col-sm-4 col-md-4 col-lg-4" name="keyStorePassword" type="password"/>
        	</div>
    	</div>
</div>
<div class="page-header" id='streamingapplicationHead' style='clear:both;display:none'><h5 id="streamingapplication">流数据应用运行状态</h5></div>
<div id="streamingapplicationDiv" style="display:none;width:100%">
		<div class="parameter">
			<label>
				<span id="statusLabel">运行状态:</span> 
			</label>
			<label>
				<span id="status"></span> 
			</label>
		</div>
		<div class="parameter" style='display:none'>
			<label>
				<span>运行信息:</span> 
			</label>
			<label id="streamingApplicationRunningInfo" style="width:60%" dock="fill" autosize="false"></label>		
		</div>
</div>
<div class="page-header" id='streamingserverHead' style='clear:both;display:none'><h5 id="streamingserver">流数据服务配置</h5></div>
<div id="streamingServerSettingDiv" style="display:none;width:100%">
		<div class="parameter">
			<label>
				<span id="configResourceLabel">配置信息来源:</span> 
			</label>
			<select id="configResourceSelect" class="col-md-4" onchange="changeConfigResourceSelect(this)">
				<option selected="selected" value="configJsonPath">配置文件路径</option>
				<option value="configJsonContent">配置信息</option>
			</select>
		</div>
	  	<div id="configJsonPathDiv" class="parameter" style="display:block">
			<label>
				<span id="dictionaryPathLabel">配置文件路径:</span> 
			</label>
			<span id="remoteFileSystem">
				<input id="configJsonPath" name="configJsonPath" class="col-xs-4 col-sm-4 col-md-4 col-lg-4" type="text" placeholder="后缀名为.streaming的文件"/>
						    		<input id="configJsonPathLocalBrowse" name="configJsonPathLocalBrowse" title="服务不在本地，请使用远程浏览" type="button" class="btn btn-default" onclick="return browseLocally();" disabled="true" value="本地浏览..."/>
				<input id="configJsonPathFileBrowser" name="configJsonPathFileBrowser" type="button" onclick="showStreamingServicePathFileChooser(this);"  class="btn btn-default" value="远程浏览..."/>
			</span>
		</div>
	  	<div id="configJsonContentDiv" class="parameter" style="display:none">
			<label>
				<span id="configJsonContentLabel">配置信息:</span> 
			</label>
			<textarea name="configJsonContent" id="configJsonContent" style="width:60%" rows="10" cols="100"></textarea>		
		</div>
		<div class="parameter" style="display:block">
			<a href="http://192.168.10.244:8090/iserver/manager/streaming/streamingconfiger/spatialanalyst-changchun">配置流处理模型</a>
		</div>
</div>
  <div class="page-header" id="interfacesHeader" style="clear:both;"><h5 id="interfaces">服务接口</h5></div>
 <div id="interfacesDiv" class="clearfix" style='width:100%; margin-bottom:25px;'>
 </div><div class="page-header" id="cacheHeader">
	<h5 id="cache">缓存</h5>
</div>
<div id="cacheDiv" style="margin-bottom:20px;">
	<div id="cacheImage" style="display: none;">
		<form class="form-horizontal" role="form">
			<fieldset>
				<h4 class="allwaysShow">
					<small style='color: #333'>
						<div class="checkbox">
							<input type="checkbox" class="cacheSwitch" name="Image"
								id="useImageCache" /> <label for="useImageCache">是否启用地图瓦片缓存</label>
								<img class="tipmark" title="启用后，服务会优先使用指定存储位置下的地图瓦片缓存，如果瓦片不存在则会按照配置的缓存类型进行动态缓存。" />
						</div>
					</small>
				</h4>
				<div class="form-group" style="display: none;">
					<label for="imageCacheType">缓存类型：</label> <select
						id="selectImageCacheType" class="selectStorage col-sm-4">
					</select> <a id="importStorageLink" class="FastDFS MongoDB OTS addButton"
						style="padding-left: 20px; color: rgb(2, 84, 208); display: inline;"
						href="#">导入存储位置 </a>
				</div>
				<div style="display: none" class="form-group">
					<label>存储ID：</label> <select id="importStorageID" class="col-sm-4">
					</select> <a
						style="padding-left: 20px; color: rgb(2, 84, 208); display: inline;"
						class="addButton" id="addStorageLink">添加存储位置</a>
				</div>
				<div style="display: none" class="form-group SMTiles">
					<label for="outputPath">存储位置：</label> <input type="text"
						id="outputPath" class="cacheParameter col-sm-4"
						value="/home/SuperMap/supermap-iserver-10.1.0-linux64/webapps/iserver/output/sqlite" />
				</div>
				<div style="display: none" class="form-group GDP">
					<label for="directoryPath">存储位置：</label>
					<input type="text" id="directoryPath" class="cacheParameter col-sm-4"
						value="/home/SuperMap/supermap-iserver-10.1.0-linux64/webapps/iserver/output/cache/gdp" />
				</div>
				<div style="display: none" class="form-group GDP">
					<label for="cacheVersion">缓存版本：</label>
					<select id='cacheVersion' class="cacheParameter col-sm-4"><option value='3.1'>3.1</option><option value='5.0'>5.0</option></select>
				</div>
				<div style="display: none" class="form-group FastDFS MongoDB OTS">
					<label for="fDsMDBStrageDes">存储位置：</label>
					<div id="fDsMDBStrageDes" class="col-sm-4"></div>
				</div>
				<div style="display: none" class="form-group UGC">
					<label for="cacheVersion">缓存版本：</label>
					<select id="cacheVersion" class="cacheParameter col-sm-4">
						<option value="4.0">4.0</option>
						<option value="5.0">5.0</option>
						<option value="3.1">3.1</option>
					</select>
				</div>
				<div style="display: none" class="form-group UGC">
					<label for="expired">首选PNG缓存图片类型：</label>
					<select name="select" class="cacheParameter col-sm-4" id="preferedPNGType">
						<option value="PNG">PNG</option>
						<option value="PNG8">PNG8</option>
					</select>
				</div>
				<div  style="display:none" class="form-group SMTiles FastDFS MongoDB OTS">
					<label></label>
					<span class="col-sm-2"></span>
					<a class="col-sm-2" href="" id="importTilesLink" target='_blank'>更新切片</a>
				</div>
			</fieldset>
		</form>
	</div>
	<div id="cacheUTFGrid" style="display: none;">
		<form class="form-horizontal" role="form">
			<fieldset>
				<h4 class="allwaysShow">
					<small style='color: #333'>
						<div class="checkbox">

							<input type="checkbox" class="cacheSwitch" id="useUTFGridCache"
								name="UTFGrid" /> <label for="useUTFGridCache"> 是否启用属性瓦片缓存
							</label>
							<img class="tipmark" title="启用后，服务会优先使用指定存储位置下的属性瓦片缓存，如果瓦片不存在则会进行动态缓存。涉及资源：utfGrid。" />
						</div> </small>
				</h4>
				<div class="form-group UTFGrid">
					<label for="ouputPath">存储位置：</label> <input type="text"
						id="outputPath" class="cacheParameter col-sm-4"
						value="/home/SuperMap/supermap-iserver-10.1.0-linux64/webapps/iserver/output/sqlite" />
				</div>
			</fieldset>
		</form>
	</div>
	<div id="cacheVector" style="display: none;">
		<form class="form-horizontal" role="form">
			<fieldset>
				<h4 class="allwaysShow">
					<small style='color: #333'>
						<div class="checkbox">
							<input type="checkbox" class="cacheSwitch" id="useVectorCache"name="Vector" />
							<label for="useVectorCache"> 是否启用矢量瓦片缓存 </label>
							<img class="tipmark" title="启用后，服务会优先使用指定存储位置下的矢量瓦片缓存，如果瓦片不存在则会进行动态缓存。涉及资源：tileFeature。" />
						</div>
					</small>
				</h4>
				<div id = "cacheVectorMongoDBCard" class="form-group" style="display: none;color: red;">
					<div class="col-sm-8">
						<label></label>
						<span style="font-size:11px;color:red;">MongoDB只支持MVT矢量瓦片缓存</span>
					</div>
				</div>
				<div class="form-group" style="display: none;">
					<label for="cacheVectorType">缓存类型：</label>
					<select id="selectVectorCacheType" class="selectStorage col-sm-4"></select>
					<a id="importStorageLink" class="FastDFS MongoDB OTS addButton"
						style="padding-left: 20px; color: rgb(2, 84, 208); display: inline;" href="#">导入存储位置 </a>
				</div>
				<div style="display: none" class="form-group">
					<label>存储ID：</label> <select id="importVectorStorageID" class="col-sm-4">
					</select> <a
						style="padding-left: 20px; color: rgb(2, 84, 208); display: inline;"
						class="addButton" id="addStorageLink">添加存储位置</a>
				</div>
				<div style="display: none" class="form-group FastDFS MongoDB OTS">
					<label for="fDsMDBStrageDes">存储位置：</label>
					<div id="fDsMDBStrageDes" class="col-sm-4"></div>
				</div>
				<div style="display: none" class="form-group SVTiles">
					<label for="ouputPath">存储位置：</label>
					<input type="text" id="outputPath" class="cacheParameter col-sm-4" value="/home/SuperMap/supermap-iserver-10.1.0-linux64/webapps/iserver/output/sqlite" />
				</div>
			</fieldset>
		</form>
	</div>
	<div id="cacheRestRequest" style="display: none;">
		<form class="form-horizontal" role="form">
			<fieldset>
				<h4 class="allwaysShow">
					<small style='color: #333'>
						<div class="checkbox">
							<label> <input type="checkbox" class="cacheSwitch"
								id="useRestRequestCache" name="RestRequest" /> 是否启用请求缓存 </label>
						</div> </small>
				</h4>
				<div style="display: none" class="form-group RestRequest">
					<label for="maxSizeOnDisk">磁盘最大容量：</label> <input
						id="maxSizeOnDisk" type="text" class="cacheParameter col-sm-4" />
				</div>
				<div style="display: none" class="form-group RestRequest">
					<label for="timeToLiveSeconds">存活时间：</label> <input
						id="timeToLiveSeconds" type="text" class="cacheParameter col-sm-4" />
				</div>
				<div style="display: none" class="form-group RestRequest">
					<label for="timeToIdleSeconds">闲置时间：</label> <input
						id="timeToIdleSeconds" type="text" class="cacheParameter col-sm-4" />
				</div>
			</fieldset>
		</form>
	</div>
	<div id="advanceSettingsDiv" style="display: none">
		<h4>
			<small style='color: #333'>
				<div class="header"
					style="font-size: 102%; padding: 10px 10px 0pt 30px;">
					高级设置 <a id="advancedSettingA_map-World"><img
						src="http://192.168.10.244:8090/iserver/manager/static/img/downArrowhead.png">
					</a>
				</div> </small>
		</h4>
		<div id="advanceSettingsContent" style="display: none">
			<form class="form-horizontal" role="form">
				<fieldset>
					<div id="cacheReadOnlyDiv" style="display: none" class="form-group">
						<label for="cacheReadOnly">缓存是否只读：</label> <input type="checkbox"
							id="cacheReadOnly" /> <img class="tipmark"
							title="该选项目前对于UGC类型的缓存无效。" />
					</div>
					<div id="expiredDiv" style="display: none" class="form-group">
						<label for="expired">缓存存活时间：</label> <input type="text"
							id="expired" class="col-sm-4" /> <img class="tipmark"
							title="从缓存创建开始计算缓存存活时间。时间单位为分钟，0代表缓存永不过期。 该选项目前对于UGC类型的缓存无效。" />
					</div>
				</fieldset>
			</form>
		</div>
	</div>
	<div id="cacheRealSpace" style="display: none;">
		<form class="form-horizontal" role="form">
			<fieldset>
				<div class="form-group" >
					<label for="realSpaceOutputPath" style="padding-left:0">三维服务缓存目录：</label> <input type="text"
						id="output" class="cacheParameter col-sm-4"
						value="/home/SuperMap/supermap-iserver-10.1.0-linux64/webapps/iserver/output" />
				</div>
			</fieldset>
		</form>
	</div>
	<div id="addStorageDiv"><!--  -->
<div id="createNewStorageDlg" class="commonDialog" style="display:none;">
		 <div class='parameter'>
		    <label>存储 ID：
		    <span class="necessary" title="必填项"> * </span>
		    </label>
		   <span id="componentSpan">
		    	<input id="storageID" type="text" class="col-md-3"/>
			</span>
		 </div>
<div class='parameter' id="tileSourceTypeParameter" style="overflow:hidden;">
  <label>
  	切片存储类型:
    <span class="necessary" title="必填项"> * </span>
  </label>
  <select name="tileSourceType" id="tileSourceType" class="col-xs-3 col-sm-3 col-md-3 col-lg-3">
	 <option value="MongoDB">MongoDB</option>
	 <option value="FastDFS">FastDFS</option>
	 <option value="OTS">OTS</option>
	 <!-- 这里只提供添加一些复杂一些存储的功能,较为简单的存储让用户直接指定路径 -->
	 <!--<option value="MBTiles">MBTiles</option>-->
	 <!--<option value="UTFGrid">UTFGrid</option>-->
	 <!--<option value="SVTiles">SVTiles</option>-->
	 <!-- <option value="UGCV5">UGCV5</option> -->
  </select>
	<a class="helpLink MongoDB" target="_blank" href="http://192.168.10.244:8090/iserver/manager/../help/index.htm#Subject_introduce/Cache/MapCache/distribute_MapTile/MongDB_install_config/MongDBconfig.htm" >如何准备MongoDB环境</a>
	<a class="helpLink FastDFS" target="_blank" href="http://192.168.10.244:8090/iserver/manager/../help/index.htm#Subject_introduce/Cache/MapCache/distribute_MapTile/FastDFS_install_config/FastDFSconfig.htm" style="display:none;">如何准备FastDFS环境</a>
	<!-- todo OTS-->
	<a class="helpLink OTS" target="_blank" href="http://192.168.10.244:8090/iserver/manager/../help/index.htm#Subject_introduce/Cache/MapCache/distribute_MapTile/use_OTS.htm"  style="display:none;">如何准备OTS环境</a>
</div>
<div>

</div>

<div id="fastdfsStoreConfig" class="FastDFS" style="display:none">
	<div class='parameter'>
  			<label><span id="fastDFSTrackerLabel" title="FastDFS tracker server 的地址，包括ip 和端口，如 192.168.1.2:2334" >FDFS Trackers：</span><span class="necessaryLabel" title="必须填"> * </span></label>
  			<input id="tracker" type="text" class="col-xs-3 col-sm-3 col-md-3 col-lg-3 pull-left" placeholder="{ip}:{port}"/>
		<input type="button" class="btn btn-default btn-sm" id="addTracker" value="添加"/><br/>
	</div>
	<div class='parameter'>
		<label>&nbsp;</label>
		<select name="fdfsTrackers" id="fdfsTrackers" size=3 multiple="true" class="col-xs-3 col-sm-3 col-md-3 col-lg-3 pull-left"></select>
		<br/><input type="button" class="btn btn-default btn-sm" id="delTracker" value="移除"/>
	</div>
	<div class='parameter'>
		<label><span id="FDHTGroupsLable" title="FastDHT group server 的地址，包括ip 和端口，如 192.168.1.2:2334">FDHT Groups：</span><span class="necessaryLabel" title="必填项"> * </span></label>
		<input type="button" id="addGroup" class="btn btn-default btn-sm" value="添加Group" />
	</div>

	<div class='parameter'>
		<ul id="fdhtGroups" style="overflow:visible;margin-left:15em;"></ul>
	</div>
</div>

<div id="ugcV5StoreConfig" class="UGCV5" style="display:none">
	<div class='parameter'>
		<label><span >UGC5.0切片位置：</span><span class="necessary" title="必须填"> * </span></label>
		<input id="ugcV5OutputPath" type="text"class="col-xs-3" placeholder="sci,inf文件所在目录"/>
		<input type="button" class="btn btn-default btn-sm" id="browserUGCSCIFile" value="浏览"/><br/>
	</div>
</div>

<div id="mbtilesUTFGridSVtilesStoreConfig" class="SMTiles UTFGrid SVTiles" style="display:none">
	<div class='parameter'>
		<label><span >缓存位置：</span><span class="necessary" title="必须填"> * </span></label>
		<input id="outputPath" type="text"class="col-xs-3 col-sm-3 col-md-3 col-lg-3"/>
	</div>
</div>

<div id="mongoDBStoreConfig" class="MongoDB"  style="display:block">
	<div class='parameter'>
		<label><span title="MongoDB的描述信息" >服务地址：</span><span id="mongodbServerLable" title="MongoDB 服务的地址，包括ip 和端口，如 192.168.112.251:27017"></span><span class="necessaryLabel" title="必须填"> * </span></label>
		<input id="mongoDBServer" type="text" class="col-xs-3 col-sm-3 col-md-3 col-lg-3" placeholder="{ip}:{port}"/>
		<div id="hostTip" class="col-md-12 parameter" ><span style="margin-left:5px;font-size:11px;color:red;">当设置{ip}为localhost时，该切片存储仅可在本机使用</span></div>
		<input type="button" style="display:none;" class="replicationSet btn btn-default btn-sm" id="addMongoDBServer" value="添加"/>
	</div>
	<div class='parameter replicationSet' id="replicationSetDiv" style="display:none;">
	    <label>&nbsp;</label>
		<select name="mongoDBServers" id="mongoDBServers" size=3 multiple="true" class="col-xs-3 col-sm-3 col-md-3 col-lg-3"></select>
		<input type="button" class="btn btn-default btn-sm" id="delMongoDBServer" value="移除"/>
	</div>
	<div class="parameter">
		<label><span id="isReplicationSetLabel"  title="复制集是一组具有相同数据的mongod 实例。其中有一个mongod实例是主节点(Primary)，接受所有的写操作，所有其他实例作为二级节点(Secondary)，自动从主节点进行数据同步，以保证和主节点具有相同的数据。一个复制集只能有一个主节点，因为只有一个节点可以接受写操作。复制集中的多个副本的数据具有严格的一致性。">添加复制集：</span></label>
		<input type="checkbox" id="isReplicationSet">
	</div>
	<div class="parameter">
		<label>数据库：</label>
		<input id="mongoDBDatabase" type="text" value="smtiles" class="col-xs-3 col-sm-3 col-md-3 col-lg-3" />
	</div>
	<div class="parameter">
		<label>用户名：</label>
		<input id="mongoDBUsername" type="text" class="col-xs-3 col-sm-3 col-md-3 col-lg-3" />
	</div>
	<div class="parameter">
		<label>密码：</label>
		<input id="mongoDBPassword" type="password" class="col-xs-3 col-sm-3 col-md-3 col-lg-3" />
	</div>
</div>

<div id="oTSStoreConfig" class="OTS"  style="display:none">
	<div class="parameter">
		<label>
			<span id="instanceNameLable" title="阿里云Table Store控制台管理页面创建的实例名称。">实例名称：</span>
			<span class="necessary" title="必须填"> * </span>
		</label>
		<input id="instanceName" type="text" class="col-xs-3 col-sm-3 col-md-3 col-lg-3" />
	</div>
	<div class="parameter">
		<label>
			<span id="otsNodeNameLable" title="阿里云服务节点，创建实例时所选择的地址；如：cn-hangzhou" >节点名称：</span>
			<span class="necessary" title="必须填"> * </span>
		</label>
		<input id="otsNodeName" type="text" class="col-xs-3 col-sm-3 col-md-3 col-lg-3" />
	</div>
	<div class="parameter">
		<label>
			<span id="fromPublicLable" title="访问的OTS服务地址，公网：http://<instanceName>.<nodeName>.ots.aliyuncs.com、非公网：http://<instanceName>.<nodeName>.ots-internal.aliyuncs.com。">是否公网访问：</span>
		</label>
		<input id="fromPublic" type="checkbox"/>
	</div>
	<div class="parameter">
		<label>
			<span >accessKeyId：</span>
			<span class="necessary" title="必须填"> * </span>
		</label>
		<input id="accessKeyId" type="text" class="col-xs-3 col-sm-3 col-md-3 col-lg-3" />
	</div>
	<div class="parameter">
		<label>
			<span >accessKeySecret：</span>
			<span class="necessary" title="必须填"> * </span>
		</label>
		<input id="accessKeySecret" type="text" class="col-xs-3 col-sm-3 col-md-3 col-lg-3" />
	</div>
</div>

<div id="mbtilesUGCV5UTFGridSVtilesStoreConfig" style="display: none">
	<table style="border-collapse: separate; border-spacing: 0px;">
		<tr>
			<td>
				<label>
					<span>切片存储位置：</span>
					<span class="necessary" title="必须填"> * </span>
				</label>
			</td>
			<td style="padding-left: -10px;">
				<input id="outputPath"	type="text" class="col-md-3" />
			</td>
		</tr>
	</table>
</div>

<!-- 添加 或编辑 FDHT Groups -->
<div id="fdhtGroupsDialog" class="commonDialog" style="display:none;">
	<div style="padding: 10px 10px 0px 10px;">
		<div class="row">
			<input id="groupElement" type="text" class="col-xs-8 col-sm-8 col-md-8 col-lg-8" placeholder="{ip}:{port}"/>
			<input type="button" class="btn btn-default btn-sm col-xs-2 col-sm-2 col-md-2 col-lg-2" id="addGroupElement" value="添加"/><br/>
		</div>
		<div class="row" style="margin-top:10px;">
			<select name="fdhtGroupRow" id="fdhtGroupRow" size=3 multiple="true"  class="col-xs-8 col-sm-8 col-md-8 col-lg-8"></select>
			<input type="button" class="btn btn-default btn-sm col-xs-2 col-sm-2 col-md-2 col-lg-2" id="delGroupElement" value="移除"/>
		</div>

	</div>
	<div class="dialogButtonContainer">
		<button class="dialogCancel btn btn-default" id="dialogCancelForfdhtGroupsDialog">取消</button>
		<button class="dialogOK btn btn-primary" id="dialogOK">确定</button>
	</div>
</div>

<div id="ugcv5TilesetConfig" class="UGCV5Tileset" style="display:none;">
	<div class='parameter'>
		<label><span >UGC5.0切片配置文件：</span><span class="necessary" title="必须填"> * </span></label>
		<input id="ugcV5ConfigFilePath" type="text"class="col-xs-5"  placeholder="sci或inf文件路径" />
		<input type="button" class="btn btn-default btn-sm" id="broswerConfigFileBtn" value="浏览"/><br/>
	</div>
</div>

<div id="smtilesTilesetConfig" class="SMTilesTileset" style="display:none;">
	<div class='parameter'>
		<label><span >SMTiles文件：</span><span class="necessary" title="必须填"> * </span></label>
		<input id="smtilesFilePath" type="text"class="col-xs-5" placeholder="smtiles或mbtiles文件路径" />
		<input type="button" class="btn btn-default btn-sm" id="broswerSMTilesFileBtn" value="浏览"/><br/>
	</div>
</div>	    <div class="dashLine" style="margin-left:10px;"></div>
		<div class="line"></div>
	    <div id="doCacheDiv" class="dialogButtonContainer" style="text-align:center;font-size:14px;">
			<input type='button' class="dialogOK btn btn-default" id="addNewStorageOK" value="添加存储位置" />
			<input type='button' class="dialogCancel btn btn-default" id="addNewStorageCancle" value="取消" />
		</div>
</div>

</div>
</div>
<div class="page-header" id="securityHeader"><h5 id="security">安全</h5></div>
<div id="securityDiv">
<div id="authenticateDiv">
<h4 id="security"><small style="color:#333">针对各服务实例进行用户访问授权设置</small></h4>
</div>
</div>
<div id="authenticateDialog" name="authenticateDialog" class="commonDialog" style="display:none;">
	<label style='width:auto'>服务实例 </label><span id="instanceName"></span>授权配置：<span id="authorizeTips" style="color:#FF0000"></span>
	<div style="clear:both;"></div>
	<div class="parameter"  style='padding-left:25px'>
	  		<label class="radio" style='float:none;'><input type='radio' id='typePublic' checked='true' name='authorizedtype' value="PUBLIC" />匿名用户可访问</label>
	  		<label class="radio" style='float:none;'><input type='radio' id='typePrivate' name='authorizedtype' value="PRIVATE" />指定用户可访问</label>
	</div>

  	<div class="parameter" id="assignUsersAccess" style='padding-left:35px'>
	  	<div>
			<label class="checkbox" style='float:none;'><input type="checkbox" id="typeAuthenticated"  value="AUTHENTICATED"/>登录的所有用户都可访问</label>
		</div>
	
		<div id="dependRolesDiv" name="dependRolesDiv">
			<div id="dependRoles">
				<span>设置可访问服务实例的角色</span>
				<table class="text-left" style="width:95%;margin-top:10px;">
					<thead>
					    <tr>
					    <th width='42%'  class="text-left">供选择的角色:</th>
						<th width='16%'></th>
						<th width='42%'  class="text-left">选中的角色:</th>
						</tr>
					</thead>
					<tbody>
					<td>
						<select name="unusedRoles" id="unusedRoles" size=10 multiple="true" style="width:100%"></select>
					</td>
					<td class="text-center">
						<button id="addSingle" onClick="moveSelectedItem('unusedRoles', 'usedRoles')" class="btn btn-default btn-sm" >添加<i class="glyphicon glyphicon-chevron-right glyphicon glyphicon-blank" style="margin-left:5px;"></i></button><br><br>
					    <button id="removeSingle" onClick="moveSelectedItem('usedRoles', 'unusedRoles')" class="btn btn-default btn-sm" ><i class="glyphicon glyphicon-chevron-left glyphicon glyphicon-blank" style="margin-right:5px;"></i>移除</button><br><br>
					<td>
						<select name="usedRoles" id="usedRoles" size=10 multiple="true" style="width:100%"></select>
					</td>
					</tbody>
				</table>
			</div>
		</div>
	
		<div class="parameter">
			<label class="checkbox" style='float:none;'><input type="checkbox" id="deniedRolesCheckBox" />设置禁止访问服务实例的角色</label>
		</div>
		
		<div id="deniedRolesDiv" name="deniedRolesDiv"  style="display:none;">
			<div class="parameter">
			    <table class="text-left" style="width:95%;">
					<thead>
					    <tr>
						    <th width='42%'  class="text-left">供选择的角色:</th>
							<th width='16%'></th>
							<th width='42%'  class="text-left">选中的角色:</th>
						</tr>
					</thead>
					<tbody>
					<td>
						<select name="allRoles" id="allRoles" size=10 multiple="true" style="width:100%"></select>
					</td>
					<td class="text-center">
						<button id="addSingleDenied" onClick="moveSelectedItem('allRoles', 'deniedRoles')" class="btn btn-default btn-sm" >添加<i class="glyphicon glyphicon-chevron-right glyphicon glyphicon-blank" style="margin-left:5px;"></i></button><br><br>
				        <button id="removeSingleDenied" onClick="moveSelectedItem('deniedRoles', 'allRoles')" class="btn btn-default btn-sm"><i class="glyphicon glyphicon-chevron-left glyphicon glyphicon-blank" style="margin-right:5px;"></i>移除</button><br><br>
					<td>
						<select name="deniedRoles" id="deniedRoles" size=10 multiple="true" style="width:100%"></select>
					</td>
					</tbody>
				</table>
			</div>
		</div>
	
	</div>
	<div class="dialogButtonContainer">
	    <button class="dialogCancel btn btn-default" id="instanceDialogCancel" name="dialogCancel">取消</button>
	    <button class="btn btn-primary" id="instanceRoledialogOK" name="dialogOK">确定</button>
	</div>
	</div>						<!--liucy<div style="height:500px"></div>-->
					</div>
				</div><!--5-->
			</div><!--4-->
		</div><!--3-->
	</div><!--2-->
</div><!--1-->
<!--liucy<div class="container text-center"> -->
<div class="button_line">
	<div class="button_block">
		<button class="btn btn-primary btn-ok" id="button_Save">保存</button>
		<button class="btn btn-default btn-cancel" id="button_Cancel">取消</button>
	</div>
</div>

<textarea id='addressMatchProviderSettingContainer' style='display:NONE'>
 <div style="clear:both;"></div>
   <div id="addressMatchProviderSettingDiv" style="display:block"  step="ServiceChoice">
   		 <div class="generalSetting" style="display: block;">
	  	<div id="dictionaryPathDiv" class="parameter" style="display:block">
			<label>
				<span id="dictionaryPathLabel">地址字典:</span> 
				<img class="tipmark" title="地址字典文件路径，后缀为“.dct”。地址字典文件中规定了中文分词规则，分词是把中文的汉字序列切分成有意义的词，例如：我是一个学生，分词后的结果：我/是/一个/学生。地址字典就是这些有意义的词的集合。SuperMap iServer 已提供内置地址字典，您也可以通过 SuperMap iobject Java 为您的数据定制地址字典。" 
					src="/iserver/manager/static/img/popUpControl.gif" style="margin-left:10px;" aria-describedby="ui-tooltip-7"/>
			</label>
			<span id="remoteFileSystem">
				<input id="dictionaryPath" name="dictionaryPath" type="text" value="./WEB-INF/config/addressMatchDictionary.dct"/>
						    		<input id="dictPathLocalBrowse" name="dictPathLocalBrowse" title="服务不在本地，请使用远程浏览" type="button" class="btn btn-default" onclick="return browseLocally();" disabled="true" value="本地浏览..."/>
				<input id="dictPathFileBrowser" name="dictPathFileBrowser" type="button" onclick="showDictPathFileChooser(this);"  class="btn btn-default" value="远程浏览..."/>
			</span>
		</div>
		 <div id="datasourceNameDiv" class="parameter" style="display:block">
			<label> 
				<span id="datasourceNameLabel">数据源:</span>
				<img class="tipmark" title="参与地址匹配数据的数据源名称。" 
				src="/iserver/manager/static/img/popUpControl.gif" style="margin-left:10px;" aria-describedby="ui-tooltip-7"/>
			</label>
			<input id="datasourceNameByAddMatch" class="col-xs-4 col-sm-4 col-md-4 col-lg-4" name="datasourceNameByAddMatch" type="text"/>
		</div>
		<div style="clear:both;"></div>	
  		<div id="datasetNamesDiv" class="parameter" style="display:block">
			<label> 
				<span id="datasetNamesLabel">数据集:</span>
				<img class="tipmark" title="参与地址匹配的数据集的名称。" 
				src="/iserver/manager/static/img/popUpControl.gif" style="margin-left:10px;" aria-describedby="ui-tooltip-7"/>
			</label>
			<input id="datasetNames" name="datasetNames" class="col-xs-4 col-sm-4 col-md-4 col-lg-4" type="text"/>
		</div>
  		<div id="searchFieldsDiv" class="parameter" style="display:block">
			<label> 
				<span id="searchFieldsLabel">查询字段:</span>
				<img class="tipmark" title="参与地址匹配的字段，最终返回的地点名称与设置的字段顺序相同。例如：设置“province,city,county,ADDRESS,NAME”字段，返回地点名称为“新疆维吾尔自治区巴音郭楞蒙古自治州库尔勒市明祥小区内三建中学”。" 
				src="/iserver/manager/static/img/popUpControl.gif" style="margin-left:10px;" aria-describedby="ui-tooltip-7"/>
			</label>
			<input id="searchFields" name="searchFields" class="col-xs-4 col-sm-4 col-md-4 col-lg-4" type="text"/>
		</div>
  		<div id="indexDirDiv" class="parameter" style="display:block">
			<label>
				<span id="indexDirLabel">索引目录:</span>
				<img class="tipmark" title="指定地址索引目录。系统将对参与分析的数据集中，指定的参与匹配的字段中的内容建立索引，同时对其进行分词，这一过程是基于传入的字典进行的。" 
				src="/iserver/manager/static/img/popUpControl.gif" style="margin-left:10px;" aria-describedby="ui-tooltip-7"/>
			</label>
			<input id="indexDir" name="indexDir" class="col-xs-4 col-sm-4 col-md-4 col-lg-4" type="text"/>
		</div>
  		<div id="geoDecodingRadiusDiv" class="parameter" style="display:block">
			<label> 
				<span id="geoDecodingRadiusLabel">查询半径:</span> 
				<img class="tipmark" title="用于设置查询范围，设置后用户将获得指定半径内的结果。使用反向地址匹配时有效，单位与索引的投影系统单位一致。如果查询半径未设置，则使用默认值，以度为单位时，查询半径默认为0.01度；以米为单位时，查询半径默认为500米。" 				
				src="/iserver/manager/static/img/popUpControl.gif" style="margin-left:10px;" aria-describedby="ui-tooltip-7"/>
			</label>
			<input id="geoDecodingRadius" name="geoDecodingRadius" class="col-xs-4 col-sm-4 col-md-4 col-lg-4" type="text" value="-1"/>
		</div>	
  		<div id="filterFieldsDiv" class="parameter" style="display:block">
			<label>
				<span id="filterFieldsLabel">分组字段:</span>  
				<img class="tipmark" title="设置分组字段，例如“province,city,county”。用户使用地址匹配功能时，将依照设置的字段指定查询区域。" 
				src="/iserver/manager/static/img/popUpControl.gif" style="margin-left:10px;" aria-describedby="ui-tooltip-7"/>
			</label>
			<input id="filterFields" name="filterFields" class="col-xs-4 col-sm-4 col-md-4 col-lg-4" type="text" value="city"/>
		</div>	
  		<div id="maxReturnDiv" class="parameter" style="display:block">
			<label>
				<span id="maxReturnLabel">最大结果数:</span> 
				<img class="tipmark" title="显示地址匹配结果的最大数量。"
				src="/iserver/manager/static/img/popUpControl.gif" style="margin-left:10px;" aria-describedby="ui-tooltip-7"/>
			</label>
			<input id="maxReturn" name="maxReturn" class="col-xs-4 col-sm-4 col-md-4 col-lg-4" type="text" value="-1"/>
		</div>		
</div>   		  <div style="clear:both;"></div>
<div id="addressMath-advancedSettingLabel" style="font-family:微软雅黑;font-size: 102%;font-weight: bold;padding: 5px;position: relative;">
	<label>providerRes.advanceSetting</label>
	<a id="advancedSettingA" href="#">
		<img id="upDownArrow" style="padding-left: 5px;border-style: none;">
	</a>
</div>
<div id="addressMath-advancedSetting" class="advancedSetting" style="display: none;">
  		<div id="binDistanceDiv" class="parameter" style="display:block">
			<label> 
				<span id="binDistanceLabel">网格间距:</span>
				<img class="tipmark" title="创建索引时，设置网格间距，单位与数据集的单位一致。如果设置-1，则使用默认值" 
				src="/iserver/manager/static/img/popUpControl.gif" style="margin-left:10px;" aria-describedby="ui-tooltip-7"/>
			</label>
			<input id="binDistance" name="binDistance" class="col-xs-4 col-sm-4 col-md-4 col-lg-4" type="text" value="-1"/>
		</div>	
  		<div id="updateIndexDiv" class="parameter" style="display:block">
			<label>
				<span id="updateIndexLabel">定时更新索引:</span>
				<img class="tipmark" title="是否定时更新索引。包括指定时间更新和间隔更新。" 
				src="/iserver/manager/static/img/popUpControl.gif" style="margin-left:10px;" aria-describedby="ui-tooltip-7"/>
			</label>
			<input type="checkbox" id="updateIndex" name="updateIndex" type="text"/>
		</div>	
		
		<div id="updateIndexSettingDiv" style="display:none">
			<div style="clear:both;"></div>	
			<div class="parameter">
				<label>更新时间:</label>
				<select id="hour" name="hour" style="margin-right:5px;" value="3"></select>
				时
				<select id="minute" name="minute" style="margin-right:5px;" value="0"></select>
				分
			</div>
		   	<div style="clear:both;"></div>	
			<div class="parameter">
				<div>
					<label>更新周期:</label>
					<label class="radio-inline" style="width:90px;">
						<input id="appointedDateRadio" type="radio" value="appointedDate" name="modeRadio" checked="checked"/>指定日期
					</label>
					<label class="radio-inline" style="width:90px;">
						<input id="intervalDateRadio" type="radio" value="intervalDate" name="modeRadio"/>间隔时间
					</label>
				</div>
				<div style="clear:both;"></div>	
				<div id="intervalSet" style="display:none">
					<label></label>
					<label class="radio-inline" style="width:90px;">
						<input id="everydayRadio" type="radio" value="everyday" name="addressMatchRadio" checked="checked" />每天
					</label>
					<label class="radio-inline" style="width:90px;">
						<input id="everyweekRadio" type="radio" value="everyweek" name="addressMatchRadio"/>每周
					</label>
				</div>
				<div style="clear:both;"></div>	
				<div id="dayOfWeek" class="row inline control-group" style="margin-left:230px;display:none;margin-right:0px">
					<div class="row" style="margin-left:0px;">
						<label class="checkbox-inline" style="width:80px;"><input type="checkbox" value="1"/>星期日</label>
						<label class="checkbox-inline" style="width:80px;"><input type="checkbox" value="2"/>星期一</label>
						<label class="checkbox-inline" style="width:80px;"><input type="checkbox" value="3"/>星期二</label>
						<label class="checkbox-inline" style="width:80px;"><input type="checkbox" value="4"/>星期三</label>
					</div>
					<div class="row" style="margin-left:0px;">
						<label class="checkbox-inline" style="width:80px;"><input type="checkbox" value="5"/>星期四</label>
						<label class="checkbox-inline" style="width:80px;"><input type="checkbox" value="6"/>星期五</label>
						<label class="checkbox-inline" style="width:80px;"><input type="checkbox" value="7"/>星期六</label>
					</div>
				</div>
				<div style="clear:both;"></div>	
				<div>
					<div id="appointedSet" style="display:block">
						<label></label>
						<div class="col-md-offset-2">
							<input type="text" readonly="true" id="datepicker" class="col-xs-4 col-sm-4 col-md-4 col-lg-4"></input>
						</div>
					</div>
				</div>
			</div>	
		</div>	
</div>   </div>
</textarea>
<textarea id='dataProviderDelayCommitSettingContainer' style='display:NONE'>
 <div style="clear:both;">
  <div id="dataProviderDelayCommitDiv" style="display:block"  step="ServiceChoice">
  	<div id='dataProviderDelayCommit'>
  		<div id="enabledDiv" class="parameter" style="display:block">
			<label id="dataService_delayCommitLabel">开启延迟提交：</label>
			<input type="checkbox" id="enabled" name="enabled"/>
		</div>
   		<div style="clear:both;"></div>
   		<div id="commitModeDiv" style='display: none;'>
			<div style="clear:both;"></div>
   		    <div class="parameter">	
        		<label>记录详细日志：</label>
				<input type="checkbox" id="logEntireErrorMsg" name="logEntireErrorMsg"/>
  			</div>
   			<div style="clear:both;"></div>	
   			<div class="parameter">
        		<label>提交方式：</label>
        		<select id="commitMode" name="commitMode" style="width:182px;">
        			<option value="INTERVALUPDATE" selected="selected">间隔提交</option>
					<option value="SPECIFICTIME">定时提交</option>
				</select>
			</div>
			<div id="IntervalUpdateModeDiv" style="display:block">
   			<div style="clear:both;"></div>	
			<div class="parameter">
				<label>最大请求数：</label>
				<input id="countToCommit" name="countToCommit" type="text" value="1000"></input>
			</div>
   			<div style="clear:both;"></div>
			<div class="parameter">
				<label>提交间隔（秒）：</label>
				<input id="updateInterval" name="updateInterval" type="text" value="3600"></input>
			</div>
			</div>
			<div id="SpecificTimeModeDiv" style="display:none">
   			<div style="clear:both;"></div>	
			<div class="parameter">
				<label>提交时间：</label>
				<select id="hour" name="hour" style="margin-right:5px;" value="3"></select>
				时
				<select id="minute" name="minute" style="margin-right:5px;" value="0"></select>
				分
			</div>
   			<div style="clear:both;"></div>	
			<div class="parameter">
				<div>
					<label>提交周期：</label>
					<label class="radio-inline" style="width:90px;">
						<input type="radio" value="everyday" name="repeatRadio" checked="checked" />每天
					</label>
					<label class="radio-inline" style="width:90px;">
						<input type="radio" value="everyweek" name="repeatRadio"/>每周
					</label>
				</div>	
				<div style="clear:both;"></div>	
					<div id="dayOfWeek" class="row inline control-group" style="margin-left:230px;display:none;margin-right:0px">
						<div class="row" style="margin-left:0px;">
							<label class="checkbox-inline" style="width:80px;"><input type="checkbox" value="1"/>星期日</label>
							<label class="checkbox-inline" style="width:80px;"><input type="checkbox" value="2"/>星期一</label>
							<label class="checkbox-inline" style="width:80px;"><input type="checkbox" value="3"/>星期二</label>
							<label class="checkbox-inline" style="width:80px;"><input type="checkbox" value="4"/>星期三</label>
						</div>
						<div class="row" style="margin-left:0px;">
							<label class="checkbox-inline" style="width:80px;"><input type="checkbox" value="5"/>星期四</label>
							<label class="checkbox-inline" style="width:80px;"><input type="checkbox" value="6"/>星期五</label>
							<label class="checkbox-inline" style="width:80px;"><input type="checkbox" value="7"/>星期六</label>
						</div>
					</div>
				</div>
			</div>
		</div>	
   	</div>
  </div>
 </div></textarea>
<textarea id='dataProviderFilteredDatasourceInfoContainer' style='display:NONE'>
 <div style="clear:both;">
  <div id="datasourceInfosDiv" style="display:block"  step="ServiceChoice">
  	<div id='datasourceInfos'>
  		<div id="enabledDiv" class="parameter" style="display:block">
			<label id="dataService_delayCommitLabel" title="不启用时发布所有数据集"><u>选择发布数据集</u>：</label>
			<input type="checkbox" id="filteredEnabled" name="filteredEnabled"/>
		</div>
   		<div style="clear:both;"></div>
   		<div id="datasourceInfoDiv" style='display: none;'>
		</div>	
   	</div>
  </div>
 </div></textarea>
<textarea id='workspaceDialogContentContainer' style='display:NONE'>
<link rel="stylesheet" type="text/css" href="http://192.168.10.244:8090/iserver/manager/static/filemanager/scripts/jquery.filetree/jqueryFileTree.css" />
<div class='parameter' id="dataType" style="display:none">
	<label id="theTypeOfData">数据类型：</label>
	<select name='dataTypeSel' id='dataTypeSel' style="width:182px;" onchange='changeDataType(this);'>
		<option id='workspaceOption' name='workspaceOption' selected='true' value='workspace'>工作空间</option>
		<option id='dataSourceOption' name='dataSourceOption' value='dataSource'>数据源</option>
	</select>
</div>
<div class='parameter' id="workspace">
	<label id="theTypeOfFileWorkspace">工作空间类型：</label>
	<select name='workspaceTypeSel' id='workspaceTypeSel' style="width:182px;" onchange='changeWorkspaceType(this);'>
		<option id='fileWorkspaceOption' name='fileWorkspaceOption' selected='true' value='fileWorkspace'>文件型</option>
		<option id='oracleWorkspaceOption' name= 'oracleWorkspaceOption' value='oracleWorkspace'>Oracle工作空间</option>
		<option id='sqlWorkspaceOption' name='sqlWorkspaceOption' value='sqlWorkspace'>SQL工作空间</option>
		<option id='pgsqlWorkspaceOption' name='pgsqlWorkspaceOption' value='pgsqlWorkspace'>PGSQL工作空间</option>
		<option id='DMWorkspaceOption' name='DMWorkspaceOption' value='DMWorkspace'>DM工作空间</option>
	</select>
</div>
<div class='parameter' id="dataSource" style="display:none">
	<label id="theTypeOfDataSource">数据源类型：</label>
	<select name='dataSourceTypeSel' id='dataSourceTypeSel' style="width:182px;" onchange='changeWorkspaceType(this);'>
		<option id='pgsqlDataSourceOption' name='pgsqlDataSourceOption' value='pgsqlDataSource'>PGSQL数据源</option>
		<option id='pggisDataSourceOption' name='pggisDataSourceOption' value='pggisDataSource'>POSTGIS数据源</option>
		<option id ='udbDataSourceOption' name = 'udbDataSourceOption' value = 'udbDataSource'>本地UDB数据源</option>
	</select>
</div>

<div id="fileWorkspace">
	<div class='parameter'>
		<label id="thePathOfFileWorkspace">工作空间路径:</label>
		<span id="remoteFileSystem">
		<input name="remotePath" id="remotePath" type="text"/>
		    <input id="localBrowse" name="localBrowse" title="服务不在本地，请使用远程浏览" type="button" class="btn btn-default" onclick="return browseLocally();" disabled="true" value="本地浏览..."/>
		<input id="fileBrowser" name="fileBrowser" type="button" onclick="showFileChooser(this);"  class="btn btn-default" value="远程浏览..."/>
		</span>
		<div id="localFileSystem" style="display:none">
		<input name="localFile" id="localFile" type="file" disabled="true" onchange="resetWorkspacePath(this);" style="width:375px;"/>
		</div>
	</div>
	<div id="wkspPass" class="parameter">
	    <label for="workspacePassword" id="thePasswordOfFileWorkspace">工作空间密码：</label>
		<input id="workspacePassword" name="workspacePassword" type="password"/>
	</div>
</div>
<div style="clear:both;">
	<div id="oracleWorkspace" style="display:None;">
		<div class='parameter'><label class="serverName">服务器名称：</label><input type='text' id='orclServer' /></div>
		<div class='parameter'><label class= "workspaceName">工作空间名称：</label><input type='text' id='orclName' /></div>
		<div class='parameter'><label class="databaseName">数据库名称(可选)：</label><input type='text' id='orclDatabase' /></div>
		<div class='parameter'><label class="userName">用户名：</label><input type='text' id='orclUser' /></div>
		<div class='parameter'><label class="password">密     码：</label><input type='password' id='orclPSW' /></div>
		<div style="clear:both;"></div>
	</div>
	<div id="sqlWorkspace" style="display:None;">
			<div class='parameter'><label class="serverName">服务器名称：</label><input type='text' id='sqlServer'/></div>
			<div class='parameter'><label class= "workspaceName">工作空间名称：</label><input type='text' id='sqlName'/></div>
			<div class='parameter'><label class="databaseName">数据库名称：</label><input type='text' id='sqlDatabase'/></div>
			<div class='parameter'><label class="userName">用户名：</label><input type='text' id='sqlUser'/></div>
			<div class='parameter'><label class="password">密     码：</label><input type='password' id='sqlPSW'/></div>
			<div class='parameter'><label class="driver">驱     动：</label><input type='text' id='sqlDriver' value='SQL Server'/></div>
			<div style="clear:both;"></div>
	</div>
	<div id="pgsqlWorkspace" style="display:None;">
			<div class='parameter'><label class="serverName">服务器名称：</label><input type='text' id='pgsqlServer'/></div>
			<div class='parameter'><label class= "workspaceName">工作空间名称：</label><input type='text' id='pgsqlName'/></div>
			<div class='parameter'><label class="databaseName">数据库名称：</label><input type='text' id='pgsqlDatabase'/></div>
			<div class='parameter'><label class="userName">用户名：</label><input type='text' id='pgsqlUser'/></div>
			<div class='parameter'><label class="password">密     码：</label><input type='password' id='pgsqlPSW'/></div>
			<div class='parameter'><label class="driver">驱     动：</label><input type='text' id='pgsqlDriver' value='pgSQL Server'/></div>
			<div style="clear:both;"></div>
	</div>
	<div id="DMWorkspace" style="display:None;">
		<div class='parameter'><label class="serverName">服务器名称：</label><input type='text' id='DMServer'/></div>
		<div class='parameter'><label class= "workspaceName">工作空间名称：</label><input type='text' id='DMName'/></div>
		<div class='parameter'><label class="databaseName">数据库名称：</label><input type='text' id='DMDatabase'/></div>
		<div class='parameter'><label class="userName">用户名：</label><input type='text' id='DMUser'/></div>
		<div class='parameter'><label class="password">密     码：</label><input type='password' id='DMPSW'/></div>
		<div style="clear:both;"></div>
	</div>
	<div id="pgsqlDataSource" style="display:None;">
			<div class='parameter'><label class="serverName">服务器名称：</label><input type='text' id='pgServer'/></div>
			<div class='parameter'><label class= "workspaceName">数据源名称：</label><input type='text' id='pgName'/></div>
			<div class='parameter'><label class="databaseName">数据库名称：</label><input type='text' id='pgDatabase'/></div>
			<div class='parameter'><label class="userName">用户名：</label><input type='text' id='pgUser'/></div>
			<div class='parameter'><label class="password">密     码：</label><input type='password' id='pgPSW'/></div>
			<div class='parameter'><label class="driver">驱     动：</label><input type='text' id='pgDriver' value='pgSQL Server'/></div>
			<input type='hidden' id='pgOpenLinkTable' value='false'/>
			<input type='hidden' id='pgConnect' value='true' />
			<input type='hidden' id='pgExclusive' value='false'/>
			<input type='hidden' id='pgReadOnly' value='false'/>
			<div style="clear:both;"></div>
	</div>
	<div id="pggisDataSource" style="display:None;">
			<div class='parameter'><label class="serverName">服务器名称：</label><input type='text' id='pggisServer'/></div>
			<div class='parameter'><label class= "workspaceName">数据源名称：</label><input type='text' id='pggisName'/></div>
			<div class='parameter'><label class="databaseName">数据库名称：</label><input type='text' id='pggisDatabase'/></div>
			<div class='parameter'><label class="userName">用户名：</label><input type='text' id='pggisUser'/></div>
			<div class='parameter'><label class="password">密     码：</label><input type='password' id='pggisPSW'/></div>
			<div class='parameter'><label class="driver">驱     动：</label><input type='text' id='pggisDriver' value='POSTGIS'/></div>
			<input type='hidden' id='pggisOpenLinkTable' value='false'/>
			<input type='hidden' id='pggisConnect' value='true' />
			<input type='hidden' id='pggisExclusive' value='false'/>
			<input type='hidden' id='pggisReadOnly' value='false'/>
			<div style="clear:both;"></div>
	</div>
	<div id="udbDataSource" style="display:None;">
			<div class='parameter'><label class="serverName">数据源路径：</label><input type='text' id='udbServer'/></div>
			<div class='parameter'><label class= "workspaceName">数据源名称：</label><input type='text' id='udbName'/></div>
			<div class='parameter' id = "udbDataBaseDiv" style="display:none"><label class="databaseName">数据库名称：</label><input type='text' id='udbDatabase'/></div>
			<div class='parameter' id = "udbUserNameDiv" style="display:none"><label class="userName">用户名：</label><input type='text' id='udbUser'/></div>
			<div class='parameter' id = "udbPassDiv" style="display:none"><label class="password">密     码：</label><input type='password' id='udbPSW'/></div>
			<div class='parameter'><label class="driver">驱     动：</label><input type='text' id='udbDriver' value='UDB'/></div>
			<input type='hidden' id='udbOpenLinkTable' value='false'/>
			<input type='hidden' id='udbConnect' value='true' />
			<input type='hidden' id='udbExclusive' value='false'/>
			<input type='hidden' id='udbReadOnly' value='false'/>
			<div style="clear:both;"></div>
	</div>
</div>
<div style="clear:both;">
	<div id="isMultiInstanceDiv" class="parameter" style="display:None">
		<label id="isMultiInstanceLabel">启用多实例：</label>
		<input type="checkbox" id="isMultiInstance" name="isMultiInstance"/>
	</div>
	<div id="instanceCountDiv" class="parameter" style="display:None">
     	<label id="instanceCountLabel">实例数量：</label>
     	<input id="instanceCount" name="instanceCount" type="text"/>
	</div>
</div></textarea>
<textarea id='smtilesDialogContentContainer' style='display:NONE'>
<link rel="stylesheet" type="text/css" href="http://192.168.10.244:8090/iserver/manager/static/filemanager/scripts/jquery.filetree/jqueryFileTree.css" />
<div id="fileMBTiles">
	<div class='parameter' style="padding-left:0;">
	    <label id="thePathOfSMTiles">文件路径:</label>
	    <span id="remoteMBTilesSystem">
	    <input id="smtilesFilePath"  name="smtilesFilePath" type="text" class="col-md-3" change="smtilesPathChange(this)" />
	    <input id="localSMTilesBrowse" name="localSMTilesBrowse" title="" class="btn btn-default" type="button" onclick="return smtilesBrowseLocally(this);" value="本地浏览..."/>
	    <input id="fileSMTilesBrowse" name="fileSMTilesBrowse" title="" class="btn btn-default" type="button" onclick="selectSMTilesFile(this);" value="远程浏览..."/>
	    </span>
	    <div id="localSMTilesFileSystem" style="display:none">
	         <input id="fileBrowserMBTiles" name="fileBrowserMBTiles" disabled="true" type="file" onchange="resetMBTilesPath(this);"  style="width:375px;"/>
	    </div>
	</div>
</div></textarea>
<textarea id='zxytilesDialogContentContainer' style='display:NONE'>
<link rel="stylesheet" type="text/css" href="http://192.168.10.244:8090/iserver/manager/static/filemanager/scripts/jquery.filetree/jqueryFileTree.css" />
<div id="fileZXYTiles">
	<div class='parameter' style="padding-left:0;">
	    <label id="thePathOfZXYTiles">文件路径:</label>
	    <span id="remoteZXYTilesSystem">
	    <input id="zxytilesFilePath"  name="zxytilesFilePath" type="text" class="col-md-3" change="zxytilesPathChange(this)" />
	    <input id="localZXYTilesBrowse" name="localZXYMTilesBrowse" title="" class="btn btn-default" type="button" onclick="return zxytilesBrowseLocally(this);" value="本地浏览..."/>
	    <input id="fileZXYTilesBrowse" name="fileZXYTilesBrowse" title="" class="btn btn-default" type="button" onclick="selectZXYTilesFile(this);" value="远程浏览..."/>
	    </span>
	    <div id="localZXYTilesFileSystem" style="display:none">
	         <input id="fileBrowserZXYTiles" name="fileBrowserZXYTiles" disabled="true" type="file" onchange="resetZXYTilesPath(this);"  style="width:375px;"/>
	    </div>
	</div>
</div></textarea>
<textarea id='tpkDialogContentContainer' style='display:NONE'>
<div id="tilePackagefile">
  <div class='parameter' style="padding-left:0;">
    <label id="tilePackagePathLabel">TPK文件路径:</label>
    <span id="remoteTilePackageSystem">
    <input id="tpkFilePath"  name="tpkFilePath" type="text" class="col-md-3"/>
    <input id="tpkLocalBrowse" name="tpkLocalBrowse" title="" class="btn btn-default" type="button" onclick="return tpkBrowseLocally(this);" value="本地浏览..."/>
    <input id="tpkRemoteBrowse" name="tpkRemoteBrowse" title="" class="btn btn-default" type="button" onclick="selectTPKFile(this);" value="远程浏览..."/>
    </span>
    <div id="localTilePackageSystem" style="display:none">
         <input id="tpkFileBrowser" name="tpkFileBrowser" disabled="true" type="file" onchange="resetTilePackagePath(this);"  style="width:375px;"/>
    </div>
  </div>
  <div class='parameter' style="padding-left:0;">
		<label id="tmpFileLabel">生成临时文件：</label>
		<input type="checkbox" id="tmpFile" name="tmpFile"/>
  </div>
</div>
<div style="clear:both;">
	<div id="instanceCountDiv" class="parameter" style="display:None">
     	<label id="instanceCountLabel">实例数量：</label>
     	<input id="instanceCount" name="instanceCount" type="text" class="col-md-3"/>
	</div>
</div></textarea>
<textarea id='vtpkDialogContentContainer' style='display:NONE'>
<div id="vectorTilePackagefile">
  <div class='parameter' style="padding-left:0;">
    <label id="vectorTilePackagePathLabel">VTPK文件路径:</label>
    <span id="remoteVectorTilePackageSystem">
    <input id="vtpkFilePath"  name="vtpkFilePath" type="text" class="col-md-3"/>
    <input id="vtpkLocalBrowse" name="vtpkLocalBrowse" title="" class="btn btn-default" type="button" onclick="return vtpkBrowseLocally(this);" value="本地浏览..."/>
    <input id="vtpkRemoteBrowse" name="vtpkRemoteBrowse" title="" class="btn btn-default" type="button" onclick="selectVTPKFile(this);" value="远程浏览..."/>
    </span>
    <div id="localVectorTilePackageSystem" style="display:none">
         <input id="vtpkFileBrowser" name="vtpkFileBrowser" disabled="true" type="file" onchange="resetVectorTilePackagePath(this);"  style="width:375px;"/>
    </div>
  </div>
</div></textarea>
<textarea id='arcgisDialogContentContainer' style='display:NONE'>
<div style="clear:both;">
	<div id="arcgisServiceInfo">
      		<div class='parameter' id='arcgisserviceAddress'>
      			<label id="arcgisserviceAddressLable" class="col-xs-4 text-right" for="arcgisservice_url">ArcGIS REST地图服务地址：</label>
      			<input name="arcgisservice_url" type="text" id="arcgisservice_url" class="col-xs-6" placeholder="{restServiceRoot}/{mapName}/MapServer" />
  			</div>
  			<div class="parameter">
  				<label class="col-xs-4 text-right" >
  					安全认证方式：
  				</label>
  				<select id="arcgisSercurityType" onchange="onarcgisSercurityTypeChange()" class="col-xs-6"> 
  					<option value="default">不使用安全认证</option>
  					<option value="userPwd">用户名/密码</option>
  					<option value="token">Token</option>
  				</select>
  			</div>
   			<div class='clear parameter userPwd' id='arcgisuserName' style="display:none">
      			<label id="arcgisuserNameLable" class="col-xs-4 text-right" for="arcgisservice_username">用户名：</label>
      			<input name="arcgisservice_username" type="text" id="arcgisservice_username" class="col-xs-6"/>
  			</div>
  			<div class='clear parameter userPwd' id='arcgispassword' style="display:none">
      			<label id="arcgispasswordLable" class="col-xs-4 text-right" for="arcgisservice_password">密码：</label>
      			<input name="arcgisservice_password" type="password" id="arcgisservice_password" class="col-xs-6"/>
  			</div>
  			<div class='clear parameter userPwd' id='arcgistokenUrl' style="display:none">
      			<label id="arcgispasswordLable" class="col-xs-4 text-right" for="arcgisservice_password">ArcGIS Token服务地址：</label>
      			<input name="arcgisservice_tokenUrl" type="text" id="arcgisservice_tokenUrl" class="col-xs-6" placeholder="http://{myserver}:{port}/arcgis/tokens" />
  			</div>
  			<div class='clear parameter token' id='arcgistoken' style="display:none">
      			<label id="arcgispasswordLable" class="col-xs-4 text-right" for="arcgisservice_password">Token：</label>
      			<input name="arcgisservice_token" type="text" id="arcgisservice_token" class="col-xs-6"/>
  			</div>
  			<div class='clear parameter token' id='arcgisHttpReferer' style="display:none">
      			<label id="arcgisHttpRefererLabel" class="col-xs-4 text-right" for="arcgisservice_password">HTTP referer：</label>
      			<input name="arcgisservice_HttpReferer" type="text" id="arcgisservice_HttpReferer" class="col-xs-6" placeholder="HTTP referer"/>
  			</div>
    </div>
    <div style="clear:both;"></div>
</div></textarea>
<textarea id="iserverCachesProviderConfigContainer" style="display:none">
<div id="publishTileset" style="clear: both;">
	<div id="tileSourceDiv"><div class='parameter' id="tileSourceTypeParameter" style="overflow:hidden;">
  <label>
  	切片存储类型:
    <span class="necessary" title="必填项"> * </span>
  </label>
  <select name="tileSourceType" id="tileSourceType" class="col-xs-3 col-sm-3 col-md-3 col-lg-3">
	 <option value="MongoDB">MongoDB</option>
	 <option value="FastDFS">FastDFS</option>
	 <option value="OTS">OTS</option>
	 <!-- 这里只提供添加一些复杂一些存储的功能,较为简单的存储让用户直接指定路径 -->
	 <!--<option value="MBTiles">MBTiles</option>-->
	 <!--<option value="UTFGrid">UTFGrid</option>-->
	 <!--<option value="SVTiles">SVTiles</option>-->
	 <!-- <option value="UGCV5">UGCV5</option> -->
  </select>
	<a class="helpLink MongoDB" target="_blank" href="http://192.168.10.244:8090/iserver/manager/../help/index.htm#Subject_introduce/Cache/MapCache/distribute_MapTile/MongDB_install_config/MongDBconfig.htm" >如何准备MongoDB环境</a>
	<a class="helpLink FastDFS" target="_blank" href="http://192.168.10.244:8090/iserver/manager/../help/index.htm#Subject_introduce/Cache/MapCache/distribute_MapTile/FastDFS_install_config/FastDFSconfig.htm" style="display:none;">如何准备FastDFS环境</a>
	<!-- todo OTS-->
	<a class="helpLink OTS" target="_blank" href="http://192.168.10.244:8090/iserver/manager/../help/index.htm#Subject_introduce/Cache/MapCache/distribute_MapTile/use_OTS.htm"  style="display:none;">如何准备OTS环境</a>
</div>
<div>

</div>
<div class='parameter' id="storageSelectDiv"  style="overflow:hidden;">
	<label>
		分布式切片库：
	</label>
	<select id="storagesSelect" class="col-xs-3 col-sm-3 col-md-3 col-lg-3">
	</select>
</div>

<div id="fastdfsStoreConfig" class="FastDFS" style="display:none">
	<div class='parameter'>
  			<label><span id="fastDFSTrackerLabel" title="FastDFS tracker server 的地址，包括ip 和端口，如 192.168.1.2:2334" >FDFS Trackers：</span><span class="necessaryLabel" title="必须填"> * </span></label>
  			<input id="tracker" type="text" class="col-xs-3 col-sm-3 col-md-3 col-lg-3 pull-left" placeholder="{ip}:{port}"/>
		<input type="button" class="btn btn-default btn-sm" id="addTracker" value="添加"/><br/>
	</div>
	<div class='parameter'>
		<label>&nbsp;</label>
		<select name="fdfsTrackers" id="fdfsTrackers" size=3 multiple="true" class="col-xs-3 col-sm-3 col-md-3 col-lg-3 pull-left"></select>
		<br/><input type="button" class="btn btn-default btn-sm" id="delTracker" value="移除"/>
	</div>
	<div class='parameter'>
		<label><span id="FDHTGroupsLable" title="FastDHT group server 的地址，包括ip 和端口，如 192.168.1.2:2334">FDHT Groups：</span><span class="necessaryLabel" title="必填项"> * </span></label>
		<input type="button" id="addGroup" class="btn btn-default btn-sm" value="添加Group" />
	</div>

	<div class='parameter'>
		<ul id="fdhtGroups" style="overflow:visible;margin-left:15em;"></ul>
	</div>
</div>

<div id="ugcV5StoreConfig" class="UGCV5" style="display:none">
	<div class='parameter'>
		<label><span >UGC5.0切片位置：</span><span class="necessary" title="必须填"> * </span></label>
		<input id="ugcV5OutputPath" type="text"class="col-xs-3" placeholder="sci,inf文件所在目录"/>
		<input type="button" class="btn btn-default btn-sm" id="browserUGCSCIFile" value="浏览"/><br/>
	</div>
</div>

<div id="mbtilesUTFGridSVtilesStoreConfig" class="SMTiles UTFGrid SVTiles" style="display:none">
	<div class='parameter'>
		<label><span >缓存位置：</span><span class="necessary" title="必须填"> * </span></label>
		<input id="outputPath" type="text"class="col-xs-3 col-sm-3 col-md-3 col-lg-3"/>
	</div>
</div>

<div id="mongoDBStoreConfig" class="MongoDB"  style="display:block">
	<div class='parameter'>
		<label><span title="MongoDB的描述信息" >服务地址：</span><span id="mongodbServerLable" title="MongoDB 服务的地址，包括ip 和端口，如 192.168.112.251:27017"></span><span class="necessaryLabel" title="必须填"> * </span></label>
		<input id="mongoDBServer" type="text" class="col-xs-3 col-sm-3 col-md-3 col-lg-3" placeholder="{ip}:{port}"/>
		<div id="hostTip" class="col-md-12 parameter" ><span style="margin-left:5px;font-size:11px;color:red;">当设置{ip}为localhost时，该切片存储仅可在本机使用</span></div>
		<input type="button" style="display:none;" class="replicationSet btn btn-default btn-sm" id="addMongoDBServer" value="添加"/>
	</div>
	<div class='parameter replicationSet' id="replicationSetDiv" style="display:none;">
	    <label>&nbsp;</label>
		<select name="mongoDBServers" id="mongoDBServers" size=3 multiple="true" class="col-xs-3 col-sm-3 col-md-3 col-lg-3"></select>
		<input type="button" class="btn btn-default btn-sm" id="delMongoDBServer" value="移除"/>
	</div>
	<div class="parameter">
		<label><span id="isReplicationSetLabel"  title="复制集是一组具有相同数据的mongod 实例。其中有一个mongod实例是主节点(Primary)，接受所有的写操作，所有其他实例作为二级节点(Secondary)，自动从主节点进行数据同步，以保证和主节点具有相同的数据。一个复制集只能有一个主节点，因为只有一个节点可以接受写操作。复制集中的多个副本的数据具有严格的一致性。">添加复制集：</span></label>
		<input type="checkbox" id="isReplicationSet">
	</div>
	<div class="parameter">
		<label>数据库：</label>
		<input id="mongoDBDatabase" type="text" value="smtiles" class="col-xs-3 col-sm-3 col-md-3 col-lg-3" />
	</div>
	<div class="parameter">
		<label>用户名：</label>
		<input id="mongoDBUsername" type="text" class="col-xs-3 col-sm-3 col-md-3 col-lg-3" />
	</div>
	<div class="parameter">
		<label>密码：</label>
		<input id="mongoDBPassword" type="password" class="col-xs-3 col-sm-3 col-md-3 col-lg-3" />
	</div>
</div>

<div id="oTSStoreConfig" class="OTS"  style="display:none">
	<div class="parameter">
		<label>
			<span id="instanceNameLable" title="阿里云Table Store控制台管理页面创建的实例名称。">实例名称：</span>
			<span class="necessary" title="必须填"> * </span>
		</label>
		<input id="instanceName" type="text" class="col-xs-3 col-sm-3 col-md-3 col-lg-3" />
	</div>
	<div class="parameter">
		<label>
			<span id="otsNodeNameLable" title="阿里云服务节点，创建实例时所选择的地址；如：cn-hangzhou" >节点名称：</span>
			<span class="necessary" title="必须填"> * </span>
		</label>
		<input id="otsNodeName" type="text" class="col-xs-3 col-sm-3 col-md-3 col-lg-3" />
	</div>
	<div class="parameter">
		<label>
			<span id="fromPublicLable" title="访问的OTS服务地址，公网：http://<instanceName>.<nodeName>.ots.aliyuncs.com、非公网：http://<instanceName>.<nodeName>.ots-internal.aliyuncs.com。">是否公网访问：</span>
		</label>
		<input id="fromPublic" type="checkbox"/>
	</div>
	<div class="parameter">
		<label>
			<span >accessKeyId：</span>
			<span class="necessary" title="必须填"> * </span>
		</label>
		<input id="accessKeyId" type="text" class="col-xs-3 col-sm-3 col-md-3 col-lg-3" />
	</div>
	<div class="parameter">
		<label>
			<span >accessKeySecret：</span>
			<span class="necessary" title="必须填"> * </span>
		</label>
		<input id="accessKeySecret" type="text" class="col-xs-3 col-sm-3 col-md-3 col-lg-3" />
	</div>
</div>

<div id="mbtilesUGCV5UTFGridSVtilesStoreConfig" style="display: none">
	<table style="border-collapse: separate; border-spacing: 0px;">
		<tr>
			<td>
				<label>
					<span>切片存储位置：</span>
					<span class="necessary" title="必须填"> * </span>
				</label>
			</td>
			<td style="padding-left: -10px;">
				<input id="outputPath"	type="text" class="col-md-3" />
			</td>
		</tr>
	</table>
</div>

<!-- 添加 或编辑 FDHT Groups -->
<div id="fdhtGroupsDialog" class="commonDialog" style="display:none;">
	<div style="padding: 10px 10px 0px 10px;">
		<div class="row">
			<input id="groupElement" type="text" class="col-xs-8 col-sm-8 col-md-8 col-lg-8" placeholder="{ip}:{port}"/>
			<input type="button" class="btn btn-default btn-sm col-xs-2 col-sm-2 col-md-2 col-lg-2" id="addGroupElement" value="添加"/><br/>
		</div>
		<div class="row" style="margin-top:10px;">
			<select name="fdhtGroupRow" id="fdhtGroupRow" size=3 multiple="true"  class="col-xs-8 col-sm-8 col-md-8 col-lg-8"></select>
			<input type="button" class="btn btn-default btn-sm col-xs-2 col-sm-2 col-md-2 col-lg-2" id="delGroupElement" value="移除"/>
		</div>

	</div>
	<div class="dialogButtonContainer">
		<button class="dialogCancel btn btn-default" id="dialogCancelForfdhtGroupsDialog">取消</button>
		<button class="dialogOK btn btn-primary" id="dialogOK">确定</button>
	</div>
</div>

<div id="ugcv5TilesetConfig" class="UGCV5Tileset" style="display:none;">
	<div class='parameter'>
		<label><span >UGC5.0切片配置文件：</span><span class="necessary" title="必须填"> * </span></label>
		<input id="ugcV5ConfigFilePath" type="text"class="col-xs-5"  placeholder="sci或inf文件路径" />
		<input type="button" class="btn btn-default btn-sm" id="broswerConfigFileBtn" value="浏览"/><br/>
	</div>
</div>

<div id="smtilesTilesetConfig" class="SMTilesTileset" style="display:none;">
	<div class='parameter'>
		<label><span >SMTiles文件：</span><span class="necessary" title="必须填"> * </span></label>
		<input id="smtilesFilePath" type="text"class="col-xs-5" placeholder="smtiles或mbtiles文件路径" />
		<input type="button" class="btn btn-default btn-sm" id="broswerSMTilesFileBtn" value="浏览"/><br/>
	</div>
</div></div>
	<div id="mapSelector" style="display: none;">
		<div class="parameter">
			<label for="mapSelect">发布的地图： <!--
			<span id="refreshMaps" style="cursor:pointer;display:none;" title="更改配置后刷新地图" class="glyphicon glyphicon-refresh" ></span>
			 -->
			</label> <select id="mapsSelect" class="col-xs-5">
				<option value="_all">全部</option>
			</select>
		</div>
	</div>
	<div id="realspaceTilesetSelector" style="display:none;">
		<div class="parameter">
			<label>发布的三维图层： </label>
			<ul class="dropdown-menu col-xs-5" role="menu" style="display:block;height:180px;overflow:scroll;position:relative;padding-left:10px;z-index:100">
				<!-- <li role="presentation" class="checkbox"><label role="menuitem"><input type="checkbox" />beijing@China</label></li> -->
			</ul>
		</div>
	</div>
</div></textarea>
<textarea id="multiTilesProviderConfigConfigContainer" style="display:none">
<div id="multiTilesMapDiv">
	<div class="parameter">
		<label>
			<span>地图名：</span>
			<img style="display:none;"  class="tipmark" title="用户自定义的地图名，切片集整合后生成的新地图的地图名。" src="/iserver/manager/static/img/popUpControl.gif" style="margin-left:10px;"/>
			<span class="necessaryLabel" title="必须填"> * </span>
		</label>
		<input name="name" id="name" type="text" style="width:220px;">
	</div>
	<div class="parameter">
		<label><a target="_blank" style="color:#0254D0" href="/../../iserver/help/html/zh/index.htm#Server_Service_Management/quickPublish/Publish_MultiTile.htm">合并模式：<span class="necessary" title="必填项"> * </span></a></label>
		<select name="combiningMode" id="combiningMode" style="width:220px;" onchange="changeCombiningMode(this)">
			<option selected="true" value="Default">默认模式</option>
			<option value="BaseTileset">底图模式</option>
			<option value="CustomScales">自定义模式</option>
		</select>
	</div>
	<div class="parameter">
		<label>
			<span>切片集集合：</span>
			<img style="display:none;" class="tipmark" title="参与整合的切片集，排在前面的切片会覆盖掉后面的切片，因此最好使用透明的切片集，避免后面的切片不可见。注意：切片集的投影和切片大小需保持一致。" src="/iserver/manager/static/img/popUpControl.gif" style="margin-left:10px;"/>
			<span class="necessaryLabel" title="必须填"> * </span>
		</label>		
		<div id="tileTypeDiv" style="margin-left: 230px; margin-right: 0px; padding-left: 25px;">
			<select name="tileType" id="tileType" style="width:220px;">
				<option selected="true" value="MongoDB">MongoDB</option>
				<option value="SMTiles">SMTiles</option>
				<option value="UGCV5">UGCV5</option>
			</select>
			<button type="button" class="btn btn-default" id="addButton" onclick="addTileSet(event,'#tileType', 'tileSets')">添加</button>
		</div>
		<div id="tileSetsDiv" style="margin-left: 230px; margin-right: 0px; padding-left: 25px;">
			<select name="tileSets" size="5" class="col-xs-4 col-sm-4 col-md-4 col-lg-4" style="float:left;width:220px;" multiple="multiple" id="tileSets">
			</select>
			<table style="width:120px;height:100px;">
				<tbody>
					<tr>
						<td><input type="button"  onclick="removeOption('tileSets');" class="btn btn-default" value="移除"></td>
					</tr>
					<tr>
						<td><input type="button" onclick="moveToUpOption('tileSets');" class="btn btn-default" value="上移"></td>
					</tr>
					<tr>
						<td><input type="button" onclick="moveToDownOption('tileSets');" class="btn btn-default" value="下移"></td>
					</tr>
				</tbody>
			</table> 			
		</div>
	</div>
	<div id="customScalesParams" style="clear:both;display:none;">
		<div class="parameter">
			<label>
				<span>自定义比例尺：</span>
				<img style="display:none;" class="tipmark" title="用户自定义的比例尺数组，新地图的可见比例尺以自定义比例尺为准。" src="/iserver/manager/static/img/popUpControl.gif" style="margin-left:10px;"/>
			</label>			
			<div id="customScaleDiv" style="margin-left: 230px; margin-right: 0px; padding-left: 25px;">
				<input class="new span4" type="text" id="customScale">
				<button type="button" class="btn btn-default" id="addCustomScale" onclick="doAddCustomScale()">添加</button>
			</div>
			<div id="customScalesDiv" style="margin-left: 230px; margin-right: 0px; padding-left: 25px;">
				<select name="customScales" size="5" class="col-xs-4 col-sm-4 col-md-4 col-lg-4" style="float:left;width:220px;" multiple="multiple" id="customScales">
				</select>
				<table style="width:120px;height:100px;">
					<tbody>
						<tr>
							<td><input type="button"  onclick="removeOption('customScales');" class="btn btn-default" value="移除"></td>
						</tr>
						<tr>
							<td><input type="button" onclick="moveToUpOption('customScales');" class="btn btn-default" value="上移"></td>
						</tr>
						<tr>
							<td><input type="button" onclick="moveToDownOption('customScales');" class="btn btn-default" value="下移"></td>
						</tr>
					</tbody>
				</table> 			
			</div>
		</div>
	</div>
	<div id="baseTilesetParams" style="clear:both;display:none;">
		<div class="parameter">
			<label>
				<span>底图瓦片集：</span>
				<img style="display:none;" class="tipmark" title="参与整合的底图瓦片集，位于新地图的最下层，新地图的可见比例尺等属性以底图瓦片集为准。注意：切片集的投影和切片大小需保持一致。" src="/iserver/manager/static/img/popUpControl.gif" style="margin-left:10px;"/>
			</label>			
			<div id="baseTilesetDiv" style="margin-left: 230px; margin-right: 0px; padding-left: 25px;">
				<select name="baseTilesetSelect" id="baseTilesetSelect" style="width:220px;">
					<option selected="true" value="MongoDB">MongoDB</option>
					<option value="SMTiles">SMTiles</option>
					<option value="UGCV5">UGCV5</option>
				</select>
				<button type="button" class="btn btn-default" id="addBaseTilesetButton" onclick="addTileSet(event,'#baseTilesetSelect', 'baseTileset');">设置底图</button>
				<button type="button" class="btn btn-default" id="removeBaseTilesetButton" onclick="removeBaseTileset();">删除底图</button>
			</div>
		</div>
		<div class="parameter">
			<label></label>
			<label id="baseTileset" ondblclick="showBaseTilesetInfo(event)"></label>
		</div>
	</div>    			    
</div>

<div id="multiTilesetDialog" name="multiTilesetDialog" class="commonDialog" style="display:none;">
	<div id="tilesetConnInfoDiv">
		<div id="publishDbTilesetDiv" style="display:none;">
			<div id="publishTileset" style="clear: both;">
	<div id="tileSourceDiv"><div class='parameter' id="tileSourceTypeParameter" style="overflow:hidden;">
  <label>
  	切片存储类型:
    <span class="necessary" title="必填项"> * </span>
  </label>
  <select name="tileSourceType" id="tileSourceType" class="col-xs-3 col-sm-3 col-md-3 col-lg-3">
	 <option value="MongoDB">MongoDB</option>
	 <option value="FastDFS">FastDFS</option>
	 <option value="OTS">OTS</option>
	 <!-- 这里只提供添加一些复杂一些存储的功能,较为简单的存储让用户直接指定路径 -->
	 <!--<option value="MBTiles">MBTiles</option>-->
	 <!--<option value="UTFGrid">UTFGrid</option>-->
	 <!--<option value="SVTiles">SVTiles</option>-->
	 <!-- <option value="UGCV5">UGCV5</option> -->
  </select>
	<a class="helpLink MongoDB" target="_blank" href="http://192.168.10.244:8090/iserver/manager/../help/index.htm#Subject_introduce/Cache/MapCache/distribute_MapTile/MongDB_install_config/MongDBconfig.htm" >如何准备MongoDB环境</a>
	<a class="helpLink FastDFS" target="_blank" href="http://192.168.10.244:8090/iserver/manager/../help/index.htm#Subject_introduce/Cache/MapCache/distribute_MapTile/FastDFS_install_config/FastDFSconfig.htm" style="display:none;">如何准备FastDFS环境</a>
	<!-- todo OTS-->
	<a class="helpLink OTS" target="_blank" href="http://192.168.10.244:8090/iserver/manager/../help/index.htm#Subject_introduce/Cache/MapCache/distribute_MapTile/use_OTS.htm"  style="display:none;">如何准备OTS环境</a>
</div>
<div>

</div>
<div class='parameter' id="storageSelectDiv"  style="overflow:hidden;">
	<label>
		分布式切片库：
	</label>
	<select id="storagesSelect" class="col-xs-3 col-sm-3 col-md-3 col-lg-3">
	</select>
</div>

<div id="fastdfsStoreConfig" class="FastDFS" style="display:none">
	<div class='parameter'>
  			<label><span id="fastDFSTrackerLabel" title="FastDFS tracker server 的地址，包括ip 和端口，如 192.168.1.2:2334" >FDFS Trackers：</span><span class="necessaryLabel" title="必须填"> * </span></label>
  			<input id="tracker" type="text" class="col-xs-3 col-sm-3 col-md-3 col-lg-3 pull-left" placeholder="{ip}:{port}"/>
		<input type="button" class="btn btn-default btn-sm" id="addTracker" value="添加"/><br/>
	</div>
	<div class='parameter'>
		<label>&nbsp;</label>
		<select name="fdfsTrackers" id="fdfsTrackers" size=3 multiple="true" class="col-xs-3 col-sm-3 col-md-3 col-lg-3 pull-left"></select>
		<br/><input type="button" class="btn btn-default btn-sm" id="delTracker" value="移除"/>
	</div>
	<div class='parameter'>
		<label><span id="FDHTGroupsLable" title="FastDHT group server 的地址，包括ip 和端口，如 192.168.1.2:2334">FDHT Groups：</span><span class="necessaryLabel" title="必填项"> * </span></label>
		<input type="button" id="addGroup" class="btn btn-default btn-sm" value="添加Group" />
	</div>

	<div class='parameter'>
		<ul id="fdhtGroups" style="overflow:visible;margin-left:15em;"></ul>
	</div>
</div>

<div id="ugcV5StoreConfig" class="UGCV5" style="display:none">
	<div class='parameter'>
		<label><span >UGC5.0切片位置：</span><span class="necessary" title="必须填"> * </span></label>
		<input id="ugcV5OutputPath" type="text"class="col-xs-3" placeholder="sci,inf文件所在目录"/>
		<input type="button" class="btn btn-default btn-sm" id="browserUGCSCIFile" value="浏览"/><br/>
	</div>
</div>

<div id="mbtilesUTFGridSVtilesStoreConfig" class="SMTiles UTFGrid SVTiles" style="display:none">
	<div class='parameter'>
		<label><span >缓存位置：</span><span class="necessary" title="必须填"> * </span></label>
		<input id="outputPath" type="text"class="col-xs-3 col-sm-3 col-md-3 col-lg-3"/>
	</div>
</div>

<div id="mongoDBStoreConfig" class="MongoDB"  style="display:block">
	<div class='parameter'>
		<label><span title="MongoDB的描述信息" >服务地址：</span><span id="mongodbServerLable" title="MongoDB 服务的地址，包括ip 和端口，如 192.168.112.251:27017"></span><span class="necessaryLabel" title="必须填"> * </span></label>
		<input id="mongoDBServer" type="text" class="col-xs-3 col-sm-3 col-md-3 col-lg-3" placeholder="{ip}:{port}"/>
		<div id="hostTip" class="col-md-12 parameter" ><span style="margin-left:5px;font-size:11px;color:red;">当设置{ip}为localhost时，该切片存储仅可在本机使用</span></div>
		<input type="button" style="display:none;" class="replicationSet btn btn-default btn-sm" id="addMongoDBServer" value="添加"/>
	</div>
	<div class='parameter replicationSet' id="replicationSetDiv" style="display:none;">
	    <label>&nbsp;</label>
		<select name="mongoDBServers" id="mongoDBServers" size=3 multiple="true" class="col-xs-3 col-sm-3 col-md-3 col-lg-3"></select>
		<input type="button" class="btn btn-default btn-sm" id="delMongoDBServer" value="移除"/>
	</div>
	<div class="parameter">
		<label><span id="isReplicationSetLabel"  title="复制集是一组具有相同数据的mongod 实例。其中有一个mongod实例是主节点(Primary)，接受所有的写操作，所有其他实例作为二级节点(Secondary)，自动从主节点进行数据同步，以保证和主节点具有相同的数据。一个复制集只能有一个主节点，因为只有一个节点可以接受写操作。复制集中的多个副本的数据具有严格的一致性。">添加复制集：</span></label>
		<input type="checkbox" id="isReplicationSet">
	</div>
	<div class="parameter">
		<label>数据库：</label>
		<input id="mongoDBDatabase" type="text" value="smtiles" class="col-xs-3 col-sm-3 col-md-3 col-lg-3" />
	</div>
	<div class="parameter">
		<label>用户名：</label>
		<input id="mongoDBUsername" type="text" class="col-xs-3 col-sm-3 col-md-3 col-lg-3" />
	</div>
	<div class="parameter">
		<label>密码：</label>
		<input id="mongoDBPassword" type="password" class="col-xs-3 col-sm-3 col-md-3 col-lg-3" />
	</div>
</div>

<div id="oTSStoreConfig" class="OTS"  style="display:none">
	<div class="parameter">
		<label>
			<span id="instanceNameLable" title="阿里云Table Store控制台管理页面创建的实例名称。">实例名称：</span>
			<span class="necessary" title="必须填"> * </span>
		</label>
		<input id="instanceName" type="text" class="col-xs-3 col-sm-3 col-md-3 col-lg-3" />
	</div>
	<div class="parameter">
		<label>
			<span id="otsNodeNameLable" title="阿里云服务节点，创建实例时所选择的地址；如：cn-hangzhou" >节点名称：</span>
			<span class="necessary" title="必须填"> * </span>
		</label>
		<input id="otsNodeName" type="text" class="col-xs-3 col-sm-3 col-md-3 col-lg-3" />
	</div>
	<div class="parameter">
		<label>
			<span id="fromPublicLable" title="访问的OTS服务地址，公网：http://<instanceName>.<nodeName>.ots.aliyuncs.com、非公网：http://<instanceName>.<nodeName>.ots-internal.aliyuncs.com。">是否公网访问：</span>
		</label>
		<input id="fromPublic" type="checkbox"/>
	</div>
	<div class="parameter">
		<label>
			<span >accessKeyId：</span>
			<span class="necessary" title="必须填"> * </span>
		</label>
		<input id="accessKeyId" type="text" class="col-xs-3 col-sm-3 col-md-3 col-lg-3" />
	</div>
	<div class="parameter">
		<label>
			<span >accessKeySecret：</span>
			<span class="necessary" title="必须填"> * </span>
		</label>
		<input id="accessKeySecret" type="text" class="col-xs-3 col-sm-3 col-md-3 col-lg-3" />
	</div>
</div>

<div id="mbtilesUGCV5UTFGridSVtilesStoreConfig" style="display: none">
	<table style="border-collapse: separate; border-spacing: 0px;">
		<tr>
			<td>
				<label>
					<span>切片存储位置：</span>
					<span class="necessary" title="必须填"> * </span>
				</label>
			</td>
			<td style="padding-left: -10px;">
				<input id="outputPath"	type="text" class="col-md-3" />
			</td>
		</tr>
	</table>
</div>

<!-- 添加 或编辑 FDHT Groups -->
<div id="fdhtGroupsDialog" class="commonDialog" style="display:none;">
	<div style="padding: 10px 10px 0px 10px;">
		<div class="row">
			<input id="groupElement" type="text" class="col-xs-8 col-sm-8 col-md-8 col-lg-8" placeholder="{ip}:{port}"/>
			<input type="button" class="btn btn-default btn-sm col-xs-2 col-sm-2 col-md-2 col-lg-2" id="addGroupElement" value="添加"/><br/>
		</div>
		<div class="row" style="margin-top:10px;">
			<select name="fdhtGroupRow" id="fdhtGroupRow" size=3 multiple="true"  class="col-xs-8 col-sm-8 col-md-8 col-lg-8"></select>
			<input type="button" class="btn btn-default btn-sm col-xs-2 col-sm-2 col-md-2 col-lg-2" id="delGroupElement" value="移除"/>
		</div>

	</div>
	<div class="dialogButtonContainer">
		<button class="dialogCancel btn btn-default" id="dialogCancelForfdhtGroupsDialog">取消</button>
		<button class="dialogOK btn btn-primary" id="dialogOK">确定</button>
	</div>
</div>

<div id="ugcv5TilesetConfig" class="UGCV5Tileset" style="display:none;">
	<div class='parameter'>
		<label><span >UGC5.0切片配置文件：</span><span class="necessary" title="必须填"> * </span></label>
		<input id="ugcV5ConfigFilePath" type="text"class="col-xs-5"  placeholder="sci或inf文件路径" />
		<input type="button" class="btn btn-default btn-sm" id="broswerConfigFileBtn" value="浏览"/><br/>
	</div>
</div>

<div id="smtilesTilesetConfig" class="SMTilesTileset" style="display:none;">
	<div class='parameter'>
		<label><span >SMTiles文件：</span><span class="necessary" title="必须填"> * </span></label>
		<input id="smtilesFilePath" type="text"class="col-xs-5" placeholder="smtiles或mbtiles文件路径" />
		<input type="button" class="btn btn-default btn-sm" id="broswerSMTilesFileBtn" value="浏览"/><br/>
	</div>
</div></div>
	<div id="mapSelector" style="display: none;">
		<div class="parameter">
			<label for="mapSelect">发布的地图： <!--
			<span id="refreshMaps" style="cursor:pointer;display:none;" title="更改配置后刷新地图" class="glyphicon glyphicon-refresh" ></span>
			 -->
			</label> <select id="mapsSelect" class="col-xs-5">
				<option value="_all">全部</option>
			</select>
		</div>
	</div>
	<div id="realspaceTilesetSelector" style="display:none;">
		<div class="parameter">
			<label>发布的三维图层： </label>
			<ul class="dropdown-menu col-xs-5" role="menu" style="display:block;height:180px;overflow:scroll;position:relative;padding-left:10px;z-index:100">
				<!-- <li role="presentation" class="checkbox"><label role="menuitem"><input type="checkbox" />beijing@China</label></li> -->
			</ul>
		</div>
	</div>
</div>		</div>
	  	<div class="dialogButtonContainer">
	    	<button class="dialogCancel btn btn-default" id="addTileDialogCancel" onclick="addTileDialogCancel('multiTilesetDialog');">取消</button>
	    	<button class="btn btn-primary" id="addTileDialogNext" onclick="addTileDialogNext('multiTilesetDialog');">下一步</button>
	  	</div>
	</div>
	<div id="tilesetsDiv" style="display:none;">
		<div class="parameter">
			<label>选择的切片集：<span class="necessary" title="必填项"> * </span></label>
			<select id="selectTilesets" class="col-xs-4 col-sm-4 col-md-4 col-lg-4" onchange="changeSelectTilesets('multiTilesetDialog');">
			</select>
		</div>
		<div id="selectedTilesetInfo" class="parameter" style="display:none;">
			<div class="parameter">
				<label>地图范围：</label>
				<label id="bounds"></label>
			</div>
			<div class="parameter">
				<label>EPSG：</label>
				<label id="epsgCode"></label>
			</div>
			<div class="parameter">
				<label>图片格式：</label>
				<label id="tileFormat"></label>
			</div>
			<div class="parameter">
				<label>切片大小：</label>
				<label id="tileSize"></label>
			</div>
			<div class="parameter">
				<label>透明：</label>
				<label id="transparent"></label>
			</div>
		</div>
	  	<div class="dialogButtonContainer">
	    	<button class="dialogCancel btn btn-default" id="addTileDialogCancel" onclick="addTileDialogCancel('multiTilesetDialog');">取消</button>
	    	<button class="btn btn-primary" id="addTileDialogOK" onclick="addTileDialogOK('multiTilesetDialog');">确定</button>
	    	<button id="addTileDialogPrev" class="btn btn-default" style="display: block;" onclick="addTileDialogPrev('multiTilesetDialog');">上一步</button>
	  	</div>
	</div>	
</div>

<script type="text/javascript">
SuperMapServer.PublishTileset = function(container){
    //	this.tileStoragesUrl = getIServerUrl()+"/manager/storages.json";
    this.tilesetInfosUrl = getIServerUrl()+"/manager/tilesetinfos.json?returnContent=true&isGetRequest=true";
    this.tileStorages = null;
    this.tileSourceInfoForPublish;
    this.mapName=null;
    this.ugcSciFile = null;
    this.tileSetName = null;
    this.tileSourceInfo= null;
    /**
     * 地图切片集集合。
     */
    this.tilesetInfos = [];
    /**
     * 三维切片集集合。
     */
    this.realspaceTilesetInfos = [];
    this.container = container+" ";
    this.tileSourceInfoChanged = false;
    this.forProviderConfig = false;
    this.providerConfig = null;
    this.tilesetCapabilities = null;
} ;

var TilesetCapability={
        Map:"Map",
        Realspace:"Realspace"
    };

var TileSourceView = {
		SMTiles:"SMTiles",
		UGCV5:"UGCV5",
        MongoDB:"MongoDB",
        OTS:"OTS",
        FastDFS:"FastDFS",
        ALL:"all"
};

SuperMapServer.PublishTileset.prototype = {
    init:function(options){
        this.tileSourceInfoForPublish = new SuperMapServer.TileSourceInfoConfig(this.container+"#tileSourceDiv");
        this.tileSourceInfoForPublish.ugcv5SCIFileHandler=this.ugcv5SCIFileHandler;
        this.tileSourceInfoForPublish.init();
        this.initEvents();
        $(this.container+"#storageSelectDiv #storagesSelect").change();
        $("#publishTilesetDiv :text").attr("class","col-xs-4 col-sm-4 col-md-4 col-lg-4");
        $("#publishTilesetDiv :password").attr("class","col-xs-4 col-sm-4 col-md-4 col-lg-4");
        $("#publishTilesetDiv select").attr("class","col-xs-4 col-sm-4 col-md-4 col-lg-4");
        if(options&&options.tilesetCapabilities&&options.tilesetCapabilities.length>0){
            this.tilesetCapabilities = options&&options.tilesetCapabilities;
        }else{
            this.tilesetCapabilities=[TilesetCapability.Map];
        }
    },
    initEvents:function(){
        var me=this;
        $(this.container+"#tileSourceDiv #tileSourceType").change(function(){
            $(me.container+"#mapsSelect").html("");
        });
        $(me.container+"#publishTileset #mapSelector #mapsSelect").change(function(){
            me.showMapInfo();
        });
        $(this.container+"#refreshMaps").click(function(){
            me.refreshTilesets();
            me.tileSourceInfoChanged = false;
        });
    },
    initEventsForProvider:function(){
        var me = this;
        this.tileSourceInfoForPublish.tileSourceChangedHandler = function(){
            me.tileSourceInfoChanged = true;
            $(me.container+"#mapsSelect").html("");
            $(me.container+"#realspaceTilesetSelector .dropdown-menu").html("");
        };
        $(this.container+"#mapsSelect").focus(function(){
            if(me.tileSourceInfoChanged&&$(this).html()==""){
                if(!me.refreshTilesets()){
                    $(this).append("<option value='_all'>"+publishServiceCommonRes.publishAllTileset+"</option>");
                }
                me.tileSourceInfoChanged = false;
            }
        });
        $(this.container+"#realspaceTilesetSelector .dropdown-menu").click(function(){
            if(me.tileSourceInfoChanged&&$(this).html()==""){
                if(!me.refreshTilesets()){
                    $(this).append("<option value='_all'>"+publishServiceCommonRes.publishAllTileset+"</option>");
                }
                me.tileSourceInfoChanged = false;
            }
        });
        me.tileSourceInfoChanged = true;
    },
    refreshTilesets:function(){
        var msg = this.tileSourceInfoForPublish.validateParam();
        if(!msg.succeed){
            SuperMapServer.Dialog.alert(msg.error);
            return false ;
        }
        this.tileSourceInfo = this.tileSourceInfoForPublish.getTileSourceInfo();
        this.initForTilesetSelect();
        return true;
    },
    show:function(){
        this.showTileSourceInfo();
        this.showTilesetSelector();
    },
    showTileSourceInfo:function(){
        $(this.container+"#tileSourceDiv").show();
        $(this.container+"#publishTileset").show();
    },
    showTilesetSelector:function(){
        $(this.container+"#publishTileset").show();

        if(this._tilesetCapabilitiy(TilesetCapability.Map)&&this.tilesetInfos&&this.tilesetInfos.length>0){
            $(this.container+"#mapSelector").show();
        }else{
            $(this.container+"#mapSelector").hide();
        }

        if(this._tilesetCapabilitiy(TilesetCapability.Realspace)&&this.realspaceTilesetInfos&&this.realspaceTilesetInfos.length>0){
            $(this.container+"#realspaceTilesetSelector").show();
        }else{
            $(this.container+"#realspaceTilesetSelector").hide();
        }
    },
    hideTileSourceInfo:function(){
        $(this.container+"#tileSourceDiv").hide();
    },
    hideTilesetSelector:function(){
        $(this.container+"#mapSelector").hide();
        $(this.container+"#realspaceTilesetSelector").hide();
    },
    ugcv5SCIFileHandler:function(sciFile){
        this.ugcSciFile = sciFile;
    },
    initForTilesetSelect:function(){
        $(this.container+"#mapSelect").html("");
        var msg = this.tileSourceInfoForPublish.validateParam();
        if(!msg.succeed){
            SuperMapServer.Dialog.alert(msg.error);
            return false;
        }
        this.tileSourceInfo = this.tileSourceInfoForPublish.getTileSourceInfo();
        var result;
        if("MongoDB" === this.tileSourceInfo.type){
        	result = sendRequestWithResponse("POST",this.tilesetInfosUrl + "&refresh=true",this.tileSourceInfo);
        } else {
        	result = sendRequestWithResponse("POST",this.tilesetInfosUrl,this.tileSourceInfo);
        }
        if(!checkResult(result)){
            return false;
        }
        var _mapTilesetInfos = [];
        var _realspaceTilesetInfos = [];
        _mapTilesetInfos=getMapTilesetInfos(result);
        _realspaceTilesetInfos = getRealspaceTilesetInfos(result);
        // 暂时OTS切片不支持发布为三维地图，这里把三维地图的存储对象_realspaceTilesetInfos置为空
        if(this.tileSourceInfo.type == "OTS"){
            _realspaceTilesetInfos = [];
        }

        var hasContent = (this._tilesetCapabilitiy(TilesetCapability.Map)&&_mapTilesetInfos.length>0)||(this._tilesetCapabilitiy(TilesetCapability.Realspace)&&_realspaceTilesetInfos.length>0);
        if(!hasContent){
            return false;
        }
        this.tilesetInfos = _mapTilesetInfos;
        this.realspaceTilesetInfos = _realspaceTilesetInfos;
        this.updateTilesetInfosToUI();

        return true;
    },
    updateTilesetInfosToUI:function(){
        if(this._tilesetCapabilitiy(TilesetCapability.Map)&&this.tilesetInfos.length>0){
            $(this.container+"#mapSelector").show();
            var $select = $(this.container+"#publishTileset #mapSelector #mapsSelect");
            $select.html("");
            $select.append("<option value='_all'>"+publishServiceCommonRes.publishAllTileset+"</option>");
            $(this.tilesetInfos).each(function(index,tileSetInfo){
                $select.append("<option value='"+index+"'>"+tileSetInfo.metaData.mapName+"</option>");
            });
        }else{
            $(this.container+"#mapSelector").hide();
        }

        if(this._tilesetCapabilitiy(TilesetCapability.Realspace)&&this.realspaceTilesetInfos.length>0){
            $(this.container+"#realspaceTilesetSelector").show();
            var $ul = $(this.container+"#realspaceTilesetSelector .dropdown-menu");
            $ul.html("");
            $(this.realspaceTilesetInfos).each(function(index,tilesetInfo){
                var displayName = tilesetInfo.metaData.mapName;
                if(!displayName){
                    displayName = tilesetInfo.metaData.tilesetName;
                }
                var title = TileTypeRes[tilesetInfo.metaData.tileType];
                var $item = $('<li role="presentation" name="'+tilesetInfo.name+'" class="checkbox"><label role="menuitem"><input type="checkbox" />'+displayName+'</label></li>');
                $item.attr("title",title);
                $ul.append($item);
            });
        }else{
            $(this.container+"#realspaceTilesetSelector").hide();
        }
    },
    getTileSourceInfo:function(){
        if(!this.tileSourceInfo){
            this.tileSourceInfo = this.tileSourceInfoForPublish.getTileSourceInfo();
        }
        return this.tileSourceInfo;
    },
    getTileSetInfos:function(){
    	return this.tilesetInfos;
    },
    getProviderConfig:function(config){
        //只是地图提供者。
        var msg=this.tileSourceInfoForPublish.validateParam();
        if(!msg.succeed){
            SuperMapServer.Dialog.alert(msg.error);
            return null;
        }
        if(!config){
            config= {};
        }
        var tileSourceInfo = this.getTileSourceInfo();
        for(var proName in tileSourceInfo){
            if(proName=="type"){
                continue;
            }
            config[proName] = tileSourceInfo[proName];
        }
        if(this._tilesetCapabilitiy(TilesetCapability.Map)){
            var tilesetIndex = $(this.container+"#publishTileset #mapSelector #mapsSelect").val();
            if(tilesetIndex=="_all"){
                config.mapName=null;
                config.tilesetName=null;
                return config;
            }
            if(tilesetIndex&&tilesetIndex>=0){
                config.mapName = this.tilesetInfos[tilesetIndex].metaData.mapName;
                config.tilesetName = this.tilesetInfos[tilesetIndex].name;
            }
        }
        if(this._tilesetCapabilitiy(TilesetCapability.Realspace)){
            config.tilesetNames = this.getRealspaceTilesetNames();
        }

        return config;
    },
    /**
     * 地图Provider初使化。
     */
    initForProviderConfig:function(providerConfig){
        this.forProviderConfig;
        this.providerConfig = providerConfig;
        this.showTilesetSelector();
        this.showTileSourceInfo();
        this.initEventsForProvider();
        $(this.container+"#refreshMaps").show();
        $(this.container+"#mapsSelect").addClass("col-xs-3");
        $(this.container+"#ugcV5OutputPath").addClass("col-xs-3");
        $(this.container+"#realspaceTilesetSelector .dropdown-menu").addClass("col-xs-3");
        if(!providerConfig){
            this.initForTilesetSelect();
            return ;
        }
        this.tileSourceInfo = $.extend({"type":$(this.container+"#tileSourceType").val()},providerConfig);
        $(this.container+"#tileSourceType").children("[value='"+this.tileSourceInfo.type+"']").attr("selected","selected");
        $(this.container+"#tileSourceType").change();
        this.tileSourceInfoForPublish.updateTileSourceInfoToUI(this.tileSourceInfo);
        $(this.container+"#storageSelectDiv #storagesSelect").val("");
        this.tileSourceInfoForPublish.setInputDisable(false);

        this.initForTilesetSelect();
        if(this._tilesetCapabilitiy(TilesetCapability.Map)){
            this.updateProviderMapNameToUI(providerConfig.mapName,providerConfig.tilesetName);
            $(this.container+"#mapsSelect").change();
        }
        if(this._tilesetCapabilitiy(TilesetCapability.Realspace)){
            this.updateRealspaceTilesetNamesToUI(providerConfig.tilesetNames);
        }

        this.tileSourceInfoChanged = false;
    },
    updateProviderMapNameToUI:function(mapName,tileSetName){
        if(this.isBlank(mapName)&&this.isBlank(tileSetName)){
            return ;
        }
        var $mapSelect = $(this.container+"#publishTileset #mapSelector #mapsSelect");
        if(this.isBlank(tileSetName)){
            $mapSelect.append("<option value='-1' selected='selected'>"+mapName+"</option>");
            return ;
        }
        if(!this.tilesetInfos){
            return ;
        }
        $(this.tilesetInfos).each(function(index,elem){
            if(elem.name==tileSetName){
                $mapSelect.find("option[value='"+index+"']").attr("selected","selected");
                return false;
            }
        });
    },
    updateRealspaceTilesetNamesToUI:function(tilesetNames){
        if(!tilesetNames||tilesetNames.length<0){
            return ;
        }
        var me = this;
        $(tilesetNames).each(function(index,tilesetName){
            $(me.container+"#realspaceTilesetSelector .dropdown-menu li[name='"+tilesetName+"'] input[type='checkbox']").prop("checked",true);
        });
    },
    isBlank:function(string){
        if(string==undefined||string==null){
            return true;
        }
        if($.trim(string)==""){
            return true;
        }
        return false;
    },
    showMapInfo:function(){
        var $mapSelect = $(this.container+"#publishTileset #mapSelector #mapsSelect");
        var tilesetIndex = $mapSelect.val();
        var des = "";
        if(tilesetIndex&&tilesetIndex>=0){
            var metaData = this.tilesetInfos[tilesetIndex].metaData;
            var bounds= [metaData.bounds.left.toFixed(3),metaData.bounds.bottom.toFixed(3),metaData.bounds.right.toFixed(3),metaData.bounds.top.toFixed(3)];
            des+=TileSetDesRes.mapBounds+PunctuationRes.Colon+"["+bounds.join(", ")+"]"+PunctuationRes.Comma;
            des+=TileSetDesRes.format+PunctuationRes.Colon+metaData.tileFormat+PunctuationRes.Comma;
            des+=TileSetDesRes.tileSize+PunctuationRes.Colon+metaData.tileWidth+"x"+metaData.tileHeight+PunctuationRes.Comma;
            des+=TileSetDesRes.transparent+PunctuationRes.Colon+this.booleanToString(metaData.transparent)+PunctuationRes.Comma;
            des+=TileSetDesRes.scalesCount+PunctuationRes.Colon+metaData.scaleDenominators.length+PunctuationRes.Period;
        }
        enableToolTip($mapSelect,des,"left");
    },
    booleanToString:function(value){
        if(value){
            return TileSetDesRes.yes;
        }
        return TileSetDesRes.no;
    },
    switchView:function(view){
        if(view==TileSourceView.SMTiles||view==TileSourceView.UGCV5||view==TileSourceView.MongoDB||view==TileSourceView.FastDFS||view==TileSourceView.OTS){
            $(this.container+"#tileSourceType option[selected='selected']").removeAttr("selected");
            $(this.container+"#tileSourceType option[value='"+view+"']").show().attr("selected","selected").show();
            $(this.container+"#tileSourceType")[0].value=view;
            $(this.container+"#tileSourceTypeParameter").hide();
        } else {
            $(this.container+"#tileSourceType").children().show();
            $(this.container+"#tileSourceTypeParameter").show();
        }
        $(this.container+"#tileSourceType").change();
    },
    _tilesetCapabilitiy:function(value){
        return this.tilesetCapabilities.contains(value);
    },
    /**
     * 是否包含地图内容。
     */
    hasMapContent:function(){
        return this.tilesetCapabilities.contains(TilesetCapability.Map)&&this.tilesetInfos&&this.tilesetInfos.length>0;
    },
    /**
     * 是否包含三维内容 。
     */
    hasRealspaceContent:function(){
        return this.tilesetCapabilities.contains(TilesetCapability.Realspace)&&this.getRealspaceTilesetNames().length>0;
    },
    getRealspaceTilesetNames:function(){
        var names = [];
        var $lis = $(this.container+"#realspaceTilesetSelector .dropdown-menu li");
        $lis.each(function(index,li){
            var $li = $(li);
            if($li.find("input[type='checkbox']").is(":checked")){
                names.push($li.attr("name"));
            }
        });
        return names;
    },
    getOneRealspaceTilesetDisplayedName:function(){
        return $(this.container+"#realspaceTilesetSelector .dropdown-menu li input[type='checkbox']:checked").parent().text();
    }

};

function checkResult(result){
    if(!result||result.succeed==false){
        this.tilesetInfos = null;
        if(!result){
            SuperMapServer.Dialog.alert(publishServiceCommonRes.alertErrorTileSourceInfoConfigError);
        }else{
            SuperMapServer.Dialog.alert(result.error.errorMsg);
        }
        return false;
    }
    if(result.length==0){
        SuperMapServer.Dialog.alert(publishServiceCommonRes.alertErrorNotContainTileSetInTileSourceInfo);
        return false;
    }
    return true;
}
function getMapTilesetInfos(result){
    var _mapTilesetInfos = [];
    for(var i=0;i<result.length;i++){
        var tilesetInfo = result[i];
        if(["Image", "Vector"].contains(tilesetInfo.metaData.tileType)){
            _mapTilesetInfos.push(tilesetInfo);
        }
    }
    return _mapTilesetInfos;
}
function getRealspaceTilesetInfos(result){
    var _realspaceTilesetInfos = [];
    for(var i=0;i<result.length;i++){
        var tilesetInfo = result[i];
        if(["Image","Terrain","RealspaceImage","OSGB","ThreeDTiles"].contains(tilesetInfo.metaData.tileType)){
            _realspaceTilesetInfos.push(tilesetInfo);
        }
    }
    return _realspaceTilesetInfos;
}
</script>
</textarea>
<textarea id='geoPackageConfigContainer' style='display:NONE'>
<div id="geoPackageDiv">
       <div class="parameter" id="geopkgFileDiv">
      		<label>GeoPackage文件:<span class="necessary" title="必填项"> * </span>
      		</label>
			<input id="geopkgConfigFile" type="text" class="col-xs-4" placeholder="后缀名为.gpkg的文件" onchange="isPrjSelectShow()"/>
			<input id="browserGeopkgConfigFile" type="button" class="btn btn-default" onclick="selectGeoPackageFile(this)" value="远程浏览..." />
      	</div>
      	<div class="parameter" id="geopkgPrjDiv">
      		<label>地图默认投影:<span class="necessary" title="必填项"> * </span>
      		</label>
			<select id="prjSelect" class="col-xs-4" onfocus="prjSelectFocus()"></select>
      	</div>
</div></textarea>
<textarea id="AGSNetworkAnalystProviderConfigContainer" style="display:none">
<div class="configSettings">
	<div id='commonConfig'>
    	<div class="parameter"><label>ArcGIS REST网络分析服务地址: <span class="necessary" title="必填项"> * </span></label><input
            type="text" class="col-xs-4 col-sm-4 col-md-4 col-lg-4" id="restServiceRootURL"
            name="restServiceRootURL" placeholder="{restroot}/{serviceName}/NAServer"  value="">
    	</div>
    	<div style="clear:both;"></div>
    	<div class="parameter"><label>Token: </label>
        	<input type="text" class="col-xs-4 col-sm-4 col-md-4 col-lg-4" id="token" name="token" value="">
    	</div>
    	<div style="clear:both;"></div>
    	<div class="parameter"><label>HTTP referer: </label>
        	<input type="text" class="col-xs-4 col-sm-4 col-md-4 col-lg-4" id="httpReferer" name="httpReferer" value="">
    	</div>
    	<div style="clear:both;"></div>
    </div>
    <div class="parameter" id='networkLink'><label> </label>
    	<a id='computerLink'>加载服务信息</a>
    </div>
    <div id='networkContent'>
    	<div class="parameter">
        	<label>网络数据集: <span class="necessary" title="必填项"> * </span></label>
        	<select name="select" class="col-xs-4 col-sm-4 col-md-4 col-lg-4" id="networkDataset"></select>
    	</div>
    	<div style="clear:both;"></div>
    	<div class="parameter"><label>路径分析图层: </label>
        	<select name="select" class="col-xs-4 col-sm-4 col-md-4 col-lg-4" id="routeLayer"></select></div>
    	<div style="clear:both;"></div>
    	<div class="parameter"><label>服务区分析图层: </label>
        	<select name="select" class="col-xs-4 col-sm-4 col-md-4 col-lg-4" id="serviceAreaLayer"></select></div>
    	<div style="clear:both;"></div>
    	<div class="parameter"><label>最近设施查找图层: </label>
        	<select name="select" class="col-xs-4 col-sm-4 col-md-4 col-lg-4" id="closestFacilityLayer"></select></div>
    	<div style="clear:both;"></div>
    </div>
</div></textarea>
</body>
</html>